<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>BeepBox</title>
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="format-detection" content="telephone=no" />
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" rel="stylesheet" media="none" onload="if (this.media != 'all') this.media='all';" /> <!-- this is a trick to load CSS asynchronously. -->
	<style type="text/css">
		body {
			margin: auto;
			background: #000;
			font-family: 'Roboto', sans-serif;
			font-size: large;
			line-height: 1.3;
			color: #fff;
		}
		h1 {
			font-size: 30px;
			text-align: center;
		}
		.centerDiv {
			margin: 0px auto;
		}
		a {
			color: #98f;
		}
		.donation form {
			display: inline;
		}
		.donation input[type="submit"] {
			-webkit-appearance: none;
			appearance: none;
			background: none;
			border: none;
			font-family: inherit;
			font-size: inherit;
			color: #98f;
			text-decoration: none;
			cursor: pointer;
			padding: 0;
			margin: 0;
		}
		#beepboxEditorContainer {
			min-height: 645px;
		}
		
		/* wide screen */
		@media (min-width: 701px) {
			body {
				width: 700px;
			}
			.column-container {
				display: flex;
				justify-content: space-between;
			}
			/* .instructions-column {
				width: 375px;
			}
			.twitter-column {
				width: 300px;
			} */
		}
		
		/* narrow screen */
		@media (max-width: 700px) {
			body {
				width: 100vw;
			}
			p, .donation {
				margin: 1em 0.5em;
			}
			.column-container {
				display: flex;
				flex-direction: column;
				align-items: center;
			}
		}
	</style>
</head>

<body>
	<div id="beepboxEditorContainer"></div>
	
	<h1>
		BeepBox Offline
	</h1>
	<p id="introduction">
		BeepBox is an online (and offline!) tool for sketching and sharing instrumental melodies. 
	</p>
	<p>
		All song data is packaged into the URL at the top of your browser. 
		When you make changes to the song, the URL is updated to reflect your changes. 
		When you are satisfied with your song, just copy and paste the URL to save and share your song! 
	</p>
    <div class="donation">
		BeepBox is a passion project, and will always be free to use. If you find it valuable and have the means, any gratuity via
		<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
			<input type="hidden" name="cmd" value="_donations" />
			<input type="hidden" name="business" value="QZJTX9GRYEV9N" />
			<input type="hidden" name="currency_code" value="USD" />
			<input type="submit" name="submit" value="Paypal"/>
		</form>
		would be appreciated!
    </div>
	
	<div class="column-container">
		<div class="instructions-column">
			<h1>
				Instructions
			</h1>
			<p>
				You can add or remove notes by clicking on the gray rows at the top. 
				BeepBox automatically plays the notes out loud for you. Try it!
			</p>
			<p>
				Notes go into patterns, and you can edit one pattern at a time.
				Those numbered boxes at the bottom of the editor are the different patterns you can edit.
				<span id="bar-editing">
					Click the other boxes to move to a different part of the song, or click the arrows on the currently selected box to swap which pattern is played during that part of the song.
				</span>
			</p>
			<p>
				BeepBox can play several rows of patterns simultaneously, and each row has its own set of patterns. 
				Most rows can play melodies or harmonies, but the bottom row is for drums.
			</p>
			<p>
				The purple loop underneath the numbered boxes controls which part of the song is currently repeating. 
				Move the loop to listen to a different part of the song, or drag the ends to expand the loop to include the whole song. 
			</p>
			<div id="keyboard-instructions">
				<p>
					When BeepBox has focus (click on its interface above), you can use these keyboard shortcuts: <br/>
				</p>
				<ul>
					<li>Spacebar: Pause or Resume</li>
					<li>Z: Undo</li>
					<li>Y or Shift Z: Redo</li>
					<li>C: Copy the current pattern</li>
					<li>V: Paste the current pattern</li>
					<li>[ ]: Move the playhead backward and forward</li>
					<li>Arrow Keys: Change which bar is selected</li>
					<li>1-8: Reassign a pattern to the currently selected bar</li>
					<li>- +: Shift the notes in the pattern up or down</li>
				</ul>
			</div>
			<p>
				In the note pattern editor, you can click and drag horizontally on a note to adjust its duration.
				You can also click above or below an existing note to add more notes to be played simultaneously, which is called a chord. 
			</p>
			<p>
				ADVANCED: Drag vertically from an existing note to bend its pitch, or drag vertically from above or below the note to adjust its volume.
			</p>
			<p>
				BeepBox has many more features. 
				Try playing with the buttons and menus on the right side to find out what it can do!
				You can also click on the label next to each option for a description of what it does.
			</p>
			<h1>
				About
			</h1>
			<p>
				BeepBox is developed by <a href="http://www.johnnesky.com">John Nesky</a>, also known as <a href="https://twitter.com/shaktool">@shaktool</a>. 
			</p>
			<p>
				BeepBox does not claim ownership over songs created with it, so original songs belong to their authors. 
			</p>
			<p>
				Neither John Nesky nor BeepBox assume responsibility for any copyrighted material played on BeepBox. No songs are ever received, recorded, or distributed by BeepBox's servers. All song data is contained in the URL after the hash (#) mark, and BeepBox running inside your browser converts that data into sound waves.
			</p>
			<p>
				You can download and use <a href="https://github.com/johnnesky/beepbox">the source code</a> under the MIT license.
			</p>
		</div>
	</div>

	<script type="text/javascript">

if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent) ) {
	document.getElementById("introduction").innerHTML = "BeepBox is an online tool for sketching and sharing instrumental melodies. Make sure that your volume is turned up, then press the play button!";
	document.getElementById("keyboard-instructions").style.display = "none";
	document.getElementById("bar-editing").innerHTML = "Tap the other boxes to move to a different part of the song, or tap on the currently selected box to swap which pattern is played during that part of the song.";
}

var beepbox;!function(t){class e{}function i(t){let e=0;for(let i=0;i<t.length;i++)e+=t[i];const i=e/t.length;let s=0,n=0;for(let e=0;e<t.length;e++)s+=n,n=t[e]-i,t[e]=s;return t.push(0),new Float64Array(t)}function s(i){let s=e.chipNoises[i].samples;if(null==s){if(s=new Float32Array(e.chipNoiseLength+1),e.chipNoises[i].samples=s,0==i){let t=1;for(let i=0;i<e.chipNoiseLength;i++){s[i]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=16384),t=e}}else if(1==i)for(let t=0;t<e.chipNoiseLength;t++)s[t]=2*Math.random()-1;else if(2==i){let t=1;for(let i=0;i<e.chipNoiseLength;i++){s[i]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=32768),t=e}}else if(3==i){let t=1;for(let i=0;i<e.chipNoiseLength;i++){s[i]=2*(1&t)-1;let e=t>>1;1==(t+e&1)&&(e+=40),t=e}}else{if(4!=i)throw new Error("Unrecognized drum index: "+i);n(s,10,11,1,1,0),n(s,11,14,.6578,.6578,0),t.inverseRealFourierTransform(s,e.chipNoiseLength),t.scaleElementsByFactor(s,1/Math.sqrt(e.chipNoiseLength))}s[e.chipNoiseLength]=s[0]}return s}function n(t,i,n,o,h,r){const a=0|Math.pow(2,i),l=Math.min(e.chipNoiseLength>>1,0|Math.pow(2,n)),c=s(0);let f=0;for(let s=a;s<l;s++){let a=o+(h-o)*(Math.log(s)/Math.LN2-i)/(n-i),l=Math.pow(2,(a-1)*e.spectrumMax+1)*a;f+=l*=Math.pow(s/2048,r),l*=c[s];const u=.61803398875*s*s*Math.PI*2;t[s]=Math.cos(u)*l,t[e.chipNoiseLength-s]=Math.sin(u)*l}return f}function o(t){const e={};for(let i=0;i<t.length;i++){const s=t[i];s.index=i,e[s.name]=s}const i=t;return i.dictionary=e,i}e.versionDisplayName="BeepBox 3.0",e.scales=o([{name:"easy :)",flags:[!0,!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!1]},{name:"easy :(",flags:[!0,!1,!1,!0,!1,!0,!1,!0,!1,!1,!0,!1]},{name:"island :)",flags:[!0,!1,!1,!1,!0,!0,!1,!0,!1,!1,!1,!0]},{name:"island :(",flags:[!0,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!1]},{name:"blues :)",flags:[!0,!1,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1]},{name:"blues :(",flags:[!0,!1,!1,!0,!1,!0,!0,!0,!1,!1,!0,!1]},{name:"normal :)",flags:[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0]},{name:"normal :(",flags:[!0,!1,!0,!0,!1,!0,!1,!0,!0,!1,!0,!1]},{name:"dbl harmonic :)",flags:[!0,!0,!1,!1,!0,!0,!1,!0,!0,!1,!1,!0]},{name:"dbl harmonic :(",flags:[!0,!1,!0,!0,!1,!1,!0,!0,!0,!1,!1,!0]},{name:"enigma",flags:[!0,!1,!0,!1,!0,!1,!0,!1,!0,!1,!0,!1]},{name:"expert",flags:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]}]),e.keys=o([{name:"C",isWhiteKey:!0,basePitch:12},{name:"C♯",isWhiteKey:!1,basePitch:13},{name:"D",isWhiteKey:!0,basePitch:14},{name:"D♯",isWhiteKey:!1,basePitch:15},{name:"E",isWhiteKey:!0,basePitch:16},{name:"F",isWhiteKey:!0,basePitch:17},{name:"F♯",isWhiteKey:!1,basePitch:18},{name:"G",isWhiteKey:!0,basePitch:19},{name:"G♯",isWhiteKey:!1,basePitch:20},{name:"A",isWhiteKey:!0,basePitch:21},{name:"A♯",isWhiteKey:!1,basePitch:22},{name:"B",isWhiteKey:!0,basePitch:23}]),e.blackKeyNameParents=[-1,1,-1,1,-1,1,-1,-1,1,-1,1,-1],e.tempoMin=30,e.tempoMax=300,e.reverbRange=4,e.beatsPerBarMin=3,e.beatsPerBarMax=16,e.barCountMin=1,e.barCountMax=128,e.patternsPerChannelMin=1,e.patternsPerChannelMax=64,e.instrumentsPerChannelMin=1,e.instrumentsPerChannelMax=10,e.partsPerBeat=24,e.ticksPerPart=2,e.rhythms=o([{name:"÷3 (triplets)",stepsPerBeat:3,ticksPerArpeggio:4,arpeggioPatterns:[[0],[0,0,1,1],[0,1,2,1],[0,1,2,3]],roundUpThresholds:[5,12,18]},{name:"÷4 (standard)",stepsPerBeat:4,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,0,1,1],[0,1,2,1],[0,1,2,3]],roundUpThresholds:[3,9,17,21]},{name:"÷6",stepsPerBeat:6,ticksPerArpeggio:4,arpeggioPatterns:[[0],[0,1],[0,1,2,1],[0,1,2,3]],roundUpThresholds:null},{name:"÷8",stepsPerBeat:8,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,1],[0,1,2,1],[0,1,2,3]],roundUpThresholds:null},{name:"freehand",stepsPerBeat:24,ticksPerArpeggio:3,arpeggioPatterns:[[0],[0,1],[0,1,2,1],[0,1,2,3]],roundUpThresholds:null}]),e.instrumentTypeNames=["chip","FM","noise","spectrum","drumset","harmonics","PWM"],e.instrumentTypeHasSpecialInterval=[!0,!0,!1,!1,!1,!0,!1],e.instrumentTypeHasChorus=[!0,!0,!0,!1,!1,!0,!0],e.chipWaves=o([{name:"rounded",volume:.94,samples:i([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2])},{name:"triangle",volume:1,samples:i([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-.2,-5/15,-7/15,-.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-.6,-7/15,-5/15,-.2,-1/15])},{name:"square",volume:.5,samples:i([1,-1])},{name:"1/4 pulse",volume:.5,samples:i([1,-1,-1,-1])},{name:"1/8 pulse",volume:.5,samples:i([1,-1,-1,-1,-1,-1,-1,-1])},{name:"sawtooth",volume:.65,samples:i([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31])},{name:"double saw",volume:.5,samples:i([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2])},{name:"double pulse",volume:.4,samples:i([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1])},{name:"spiky",volume:.4,samples:i([1,-1,1,-1,1,0])}]),e.chipNoises=o([{name:"retro",volume:.25,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"white",volume:1,basePitch:69,pitchFilterMult:8,isSoft:!0,samples:null},{name:"clang",volume:.4,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"buzz",volume:.3,basePitch:69,pitchFilterMult:1024,isSoft:!1,samples:null},{name:"hollow",volume:1.5,basePitch:96,pitchFilterMult:1,isSoft:!0,samples:null}]),e.filterCutoffMaxHz=8e3,e.filterCutoffMinHz=1,e.filterMax=.95,e.filterMaxResonance=.95,e.filterCutoffRange=11,e.filterResonanceRange=8,e.transitions=o([{name:"seamless",isSeamless:!0,attackSeconds:0,releases:!1,releaseTicks:1,slides:!1,slideTicks:3},{name:"hard",isSeamless:!1,attackSeconds:0,releases:!1,releaseTicks:3,slides:!1,slideTicks:3},{name:"soft",isSeamless:!1,attackSeconds:.025,releases:!1,releaseTicks:3,slides:!1,slideTicks:3},{name:"slide",isSeamless:!0,attackSeconds:.025,releases:!1,releaseTicks:3,slides:!0,slideTicks:3},{name:"cross fade",isSeamless:!1,attackSeconds:.04,releases:!0,releaseTicks:6,slides:!1,slideTicks:3},{name:"hard fade",isSeamless:!1,attackSeconds:0,releases:!0,releaseTicks:48,slides:!1,slideTicks:3},{name:"medium fade",isSeamless:!1,attackSeconds:.0125,releases:!0,releaseTicks:72,slides:!1,slideTicks:3},{name:"soft fade",isSeamless:!1,attackSeconds:.06,releases:!0,releaseTicks:96,slides:!1,slideTicks:6}]),e.vibratos=o([{name:"none",amplitude:0,periodsSeconds:[.14],delayParts:0},{name:"light",amplitude:.15,periodsSeconds:[.14],delayParts:0},{name:"delayed",amplitude:.3,periodsSeconds:[.14],delayParts:18},{name:"heavy",amplitude:.45,periodsSeconds:[.14],delayParts:0},{name:"shaky",amplitude:.1,periodsSeconds:[.11,.17798,.33],delayParts:0}]),e.intervals=o([{name:"union",spread:0,offset:0,volume:.7,sign:1},{name:"shimmer",spread:.016,offset:0,volume:.8,sign:1},{name:"hum",spread:.045,offset:0,volume:1,sign:1},{name:"honky tonk",spread:.09,offset:0,volume:1,sign:1},{name:"dissonant",spread:.25,offset:0,volume:.9,sign:1},{name:"fifth",spread:3.5,offset:3.5,volume:.9,sign:1},{name:"octave",spread:6,offset:6,volume:.8,sign:1},{name:"bowed",spread:.02,offset:0,volume:1,sign:-1}]),e.effectsNames=["none","reverb","chorus","chorus & reverb"],e.volumeRange=8,e.volumeLogScale=-.5,e.chords=o([{name:"harmony",harmonizes:!0,customInterval:!1,arpeggiates:!1,isCustomInterval:!1,strumParts:0},{name:"strum",harmonizes:!0,customInterval:!1,arpeggiates:!1,isCustomInterval:!1,strumParts:1},{name:"arpeggio",harmonizes:!1,customInterval:!1,arpeggiates:!0,isCustomInterval:!1,strumParts:0},{name:"custom interval",harmonizes:!0,customInterval:!0,arpeggiates:!0,isCustomInterval:!0,strumParts:0}]),e.operatorCount=4,e.algorithms=o([{name:"1←(2 3 4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3,4],[],[],[]]},{name:"1←(2 3←4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3],[],[4],[]]},{name:"1←2←(3 4)",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2],[3,4],[],[]]},{name:"1←(2 3)←4",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2,3],[4],[4],[]]},{name:"1←2←3←4",carrierCount:1,associatedCarrier:[1,1,1,1],modulatedBy:[[2],[3],[4],[]]},{name:"1←3 2←4",carrierCount:2,associatedCarrier:[1,2,1,2],modulatedBy:[[3],[4],[],[]]},{name:"1 2←(3 4)",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[],[3,4],[],[]]},{name:"1 2←3←4",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[],[3],[4],[]]},{name:"(1 2)←3←4",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[3],[3],[4],[]]},{name:"(1 2)←(3 4)",carrierCount:2,associatedCarrier:[1,2,2,2],modulatedBy:[[3,4],[3,4],[],[]]},{name:"1 2 3←4",carrierCount:3,associatedCarrier:[1,2,3,3],modulatedBy:[[],[],[4],[]]},{name:"(1 2 3)←4",carrierCount:3,associatedCarrier:[1,2,3,3],modulatedBy:[[4],[4],[4],[]]},{name:"1 2 3 4",carrierCount:4,associatedCarrier:[1,2,3,4],modulatedBy:[[],[],[],[]]}]),e.operatorCarrierInterval=[0,.04,-.073,.091],e.operatorAmplitudeMax=15,e.operatorFrequencies=o([{name:"1×",mult:1,hzOffset:0,amplitudeSign:1},{name:"~1×",mult:1,hzOffset:1.5,amplitudeSign:-1},{name:"2×",mult:2,hzOffset:0,amplitudeSign:1},{name:"~2×",mult:2,hzOffset:-1.3,amplitudeSign:-1},{name:"3×",mult:3,hzOffset:0,amplitudeSign:1},{name:"4×",mult:4,hzOffset:0,amplitudeSign:1},{name:"5×",mult:5,hzOffset:0,amplitudeSign:1},{name:"6×",mult:6,hzOffset:0,amplitudeSign:1},{name:"7×",mult:7,hzOffset:0,amplitudeSign:1},{name:"8×",mult:8,hzOffset:0,amplitudeSign:1},{name:"9×",mult:9,hzOffset:0,amplitudeSign:1},{name:"11×",mult:11,hzOffset:0,amplitudeSign:1},{name:"13×",mult:13,hzOffset:0,amplitudeSign:1},{name:"16×",mult:16,hzOffset:0,amplitudeSign:1},{name:"20×",mult:20,hzOffset:0,amplitudeSign:1}]),e.envelopes=o([{name:"custom",type:0,speed:0},{name:"steady",type:1,speed:0},{name:"punch",type:2,speed:0},{name:"flare 1",type:3,speed:32},{name:"flare 2",type:3,speed:8},{name:"flare 3",type:3,speed:2},{name:"twang 1",type:4,speed:32},{name:"twang 2",type:4,speed:8},{name:"twang 3",type:4,speed:2},{name:"swell 1",type:5,speed:32},{name:"swell 2",type:5,speed:8},{name:"swell 3",type:5,speed:2},{name:"tremolo1",type:6,speed:4},{name:"tremolo2",type:6,speed:2},{name:"tremolo3",type:6,speed:1},{name:"tremolo4",type:7,speed:4},{name:"tremolo5",type:7,speed:2},{name:"tremolo6",type:7,speed:1},{name:"decay 1",type:8,speed:10},{name:"decay 2",type:8,speed:7},{name:"decay 3",type:8,speed:4}]),e.feedbacks=o([{name:"1⟲",indices:[[1],[],[],[]]},{name:"2⟲",indices:[[],[2],[],[]]},{name:"3⟲",indices:[[],[],[3],[]]},{name:"4⟲",indices:[[],[],[],[4]]},{name:"1⟲ 2⟲",indices:[[1],[2],[],[]]},{name:"3⟲ 4⟲",indices:[[],[],[3],[4]]},{name:"1⟲ 2⟲ 3⟲",indices:[[1],[2],[3],[]]},{name:"2⟲ 3⟲ 4⟲",indices:[[],[2],[3],[4]]},{name:"1⟲ 2⟲ 3⟲ 4⟲",indices:[[1],[2],[3],[4]]},{name:"1→2",indices:[[],[1],[],[]]},{name:"1→3",indices:[[],[],[1],[]]},{name:"1→4",indices:[[],[],[],[1]]},{name:"2→3",indices:[[],[],[2],[]]},{name:"2→4",indices:[[],[],[],[2]]},{name:"3→4",indices:[[],[],[],[3]]},{name:"1→3 2→4",indices:[[],[],[1],[2]]},{name:"1→4 2→3",indices:[[],[],[2],[1]]},{name:"1→2→3→4",indices:[[],[1],[2],[3]]}]),e.chipNoiseLength=32768,e.spectrumBasePitch=24,e.spectrumControlPoints=30,e.spectrumControlPointsPerOctave=7,e.spectrumControlPointBits=3,e.spectrumMax=(1<<e.spectrumControlPointBits)-1,e.harmonicsControlPoints=28,e.harmonicsRendered=64,e.harmonicsControlPointBits=3,e.harmonicsMax=(1<<e.harmonicsControlPointBits)-1,e.harmonicsWavelength=2048,e.pulseWidthRange=8,e.pitchChannelCountMin=1,e.pitchChannelCountMax=6,e.noiseChannelCountMin=0,e.noiseChannelCountMax=3,e.noiseInterval=6,e.drumCount=12,e.pitchOctaves=7,e.windowOctaves=3,e.scrollableOctaves=e.pitchOctaves-e.windowOctaves,e.windowPitchCount=12*e.windowOctaves+1,e.maxPitch=12*e.pitchOctaves,e.maximumTonesPerChannel=8,e.sineWaveLength=256,e.sineWaveMask=e.sineWaveLength-1,e.sineWave=function(){const t=new Float64Array(e.sineWaveLength+1);for(let i=0;i<e.sineWaveLength+1;i++)t[i]=Math.sin(i*Math.PI*2/e.sineWaveLength);return t}(),t.Config=e,t.getDrumWave=s,t.drawNoiseSpectrum=n,t.toNameMap=o}(beepbox||(beepbox={})),beepbox||(beepbox={}),function(t){class e{static valueToPreset(t){const i=t>>6,s=63&t;return e.presetCategories[i].presets[s]}static midiProgramToPresetValue(t){for(let i=0;i<e.presetCategories.length;i++){const s=e.presetCategories[i];for(let e=0;e<s.presets.length;e++){const n=s.presets[e];if(n.generalMidi&&n.midiProgram==t)return(i<<6)+e}}return null}static nameToPresetValue(t){for(let i=0;i<e.presetCategories.length;i++){const s=e.presetCategories[i];for(let e=0;e<s.presets.length;e++){if(s.presets[e].name==t)return(i<<6)+e}}return null}}e.presetCategories=t.toNameMap([{name:"Custom Instruments",presets:t.toNameMap([{name:"chip wave",customType:0},{name:"FM (expert)",customType:1},{name:"basic noise",customType:2},{name:"spectrum",customType:3},{name:"drumset",customType:4},{name:"harmonics",customType:5},{name:"pulse width",customType:6}])},{name:"Retro Presets",presets:t.toNameMap([{name:"square wave",midiProgram:80,settings:{type:"chip",transition:"seamless",effects:"none",chord:"arpeggio",filterCutoffHz:4e3,filterResonance:0,filterEnvelope:"steady",wave:"square",interval:"union",vibrato:"none"}},{name:"triangle wave",midiProgram:71,settings:{type:"chip",transition:"seamless",effects:"none",chord:"arpeggio",filterCutoffHz:4e3,filterResonance:0,filterEnvelope:"steady",wave:"triangle",interval:"union",vibrato:"none"}},{name:"square lead",midiProgram:80,generalMidi:!0,settings:{type:"chip",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",wave:"square",interval:"hum",vibrato:"none"}},{name:"sawtooth lead 1",midiProgram:81,generalMidi:!0,settings:{type:"chip",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",wave:"sawtooth",interval:"shimmer",vibrato:"none"}},{name:"sawtooth lead 2",midiProgram:81,settings:{type:"chip",effects:"reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:5657,filterResonance:29,filterEnvelope:"steady",wave:"sawtooth",interval:"hum",vibrato:"light"}},{name:"chip noise",midiProgram:116,isNoise:!0,settings:{type:"noise",transition:"hard",effects:"none",chord:"arpeggio",filterCutoffHz:4e3,filterResonance:0,filterEnvelope:"steady",wave:"retro"}},{name:"FM twang",midiProgram:32,settings:{type:"FM",transition:"hard",effects:"none",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"twang 2"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"FM bass",midiProgram:36,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"custom interval",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"2×",amplitude:11,envelope:"custom"},{frequency:"1×",amplitude:7,envelope:"twang 2"},{frequency:"1×",amplitude:9,envelope:"twang 3"},{frequency:"20×",amplitude:3,envelope:"twang 2"}]}},{name:"FM flute",midiProgram:73,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"twang 2"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"FM organ",midiProgram:16,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"custom interval",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"delayed",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:7,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"custom"},{frequency:"1×",amplitude:11,envelope:"steady"},{frequency:"2×",amplitude:11,envelope:"steady"}]}}])},{name:"Keyboard Presets",presets:t.toNameMap([{name:"grand piano",midiProgram:0,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"twang 3",interval:"shimmer",vibrato:"none",harmonics:[100,86,86,86,86,71,71,57,0,57,29,43,57,57,57,43,43,0,29,43,43,43,43,43,43,29,0,29]}},{name:"bright piano",midiProgram:1,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"twang 3",interval:"shimmer",vibrato:"none",harmonics:[86,100,100,100,86,71,0,86,86,71,71,71,57,0,57,71,57,43,43,43,0,43,43,43,43,43,43,43]}},{name:"electric grand",midiProgram:2,generalMidi:!0,settings:{type:"chip",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 3",wave:"1/8 pulse",interval:"shimmer",vibrato:"none"}},{name:"honky-tonk piano",midiProgram:3,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:5657,filterResonance:29,filterEnvelope:"twang 2",interval:"honky tonk",vibrato:"none",harmonics:[100,100,86,71,86,71,43,71,43,43,57,57,57,29,57,43,43,43,43,43,29,43,43,43,29,29,29,29]}},{name:"electric piano 1",midiProgram:4,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[86,100,100,71,71,57,57,43,43,43,29,29,29,14,14,14,0,0,0,0,0,57,0,0,0,0,0,0]}},{name:"electric piano 2",midiProgram:5,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"custom"},{frequency:"1×",amplitude:9,envelope:"steady"},{frequency:"16×",amplitude:6,envelope:"twang 3"}]}},{name:"harpsichord",midiProgram:6,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"4⟲",feedbackAmplitude:9,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"steady"},{frequency:"3×",amplitude:6,envelope:"steady"},{frequency:"5×",amplitude:7,envelope:"steady"}]}},{name:"clavinet",midiProgram:7,generalMidi:!0,settings:{type:"FM",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:5657,filterResonance:0,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"3⟲",feedbackAmplitude:6,feedbackEnvelope:"twang 2",operators:[{frequency:"3×",amplitude:15,envelope:"custom"},{frequency:"~1×",amplitude:6,envelope:"steady"},{frequency:"8×",amplitude:4,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"dulcimer",midiProgram:15,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 2",interval:"shimmer",vibrato:"none",harmonics:[100,100,100,86,100,86,57,100,100,86,100,86,100,86,100,71,57,71,71,100,86,71,86,86,100,86,86,86]}}])},{name:"Idiophone Presets",presets:t.toNameMap([{name:"celesta",midiProgram:8,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"~1×",amplitude:11,envelope:"custom"},{frequency:"8×",amplitude:6,envelope:"custom"},{frequency:"20×",amplitude:3,envelope:"twang 1"},{frequency:"3×",amplitude:1,envelope:"twang 2"}]}},{name:"glockenspiel",midiProgram:9,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:2,feedbackEnvelope:"decay 1",operators:[{frequency:"1×",amplitude:7,envelope:"custom"},{frequency:"5×",amplitude:11,envelope:"custom"},{frequency:"8×",amplitude:7,envelope:"custom"},{frequency:"20×",amplitude:2,envelope:"twang 1"}]}},{name:"music box 1",midiProgram:10,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[100,0,0,100,0,0,0,0,0,0,100,0,0,0,0,0,0,0,0,86,0,0,0,0,0,0,71,0]}},{name:"music box 2",midiProgram:10,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,57,57,0,0,0,0,0,0,57,0,0,0,14,14,14,14,14,14,43,14,14,14,14,14,14,14,14]}},{name:"vibraphone",midiProgram:11,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→2→3→4",feedbackAmplitude:3,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"~1×",amplitude:9,envelope:"custom"},{frequency:"9×",amplitude:3,envelope:"custom"},{frequency:"4×",amplitude:9,envelope:"custom"}]}},{name:"marimba",midiProgram:12,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"decay 1",vibrato:"none",algorithm:"1 2←(3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"4×",amplitude:6,envelope:"custom"},{frequency:"13×",amplitude:6,envelope:"twang 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"kalimba",midiProgram:108,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"decay 1",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:11,envelope:"custom"},{frequency:"5×",amplitude:3,envelope:"twang 2"},{frequency:"20×",amplitude:3,envelope:"twang 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"xylophone",midiProgram:13,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"6×",amplitude:9,envelope:"custom"},{frequency:"11×",amplitude:9,envelope:"custom"},{frequency:"20×",amplitude:6,envelope:"twang 1"}]}},{name:"tubular bell",midiProgram:14,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 3",interval:"hum",vibrato:"none",harmonics:[43,71,0,100,0,100,0,86,0,0,86,0,14,71,14,14,57,14,14,43,14,14,43,14,14,43,14,14]}},{name:"bell synth",midiProgram:14,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"~2×",amplitude:10,envelope:"custom"},{frequency:"7×",amplitude:6,envelope:"twang 3"},{frequency:"20×",amplitude:1,envelope:"twang 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"rain drop",midiProgram:96,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"6×",amplitude:4,envelope:"custom"},{frequency:"20×",amplitude:3,envelope:"twang 1"},{frequency:"1×",amplitude:6,envelope:"tremolo1"}]}},{name:"crystal",midiProgram:98,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"delayed",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:4,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"3×",amplitude:7,envelope:"custom"},{frequency:"6×",amplitude:4,envelope:"custom"},{frequency:"13×",amplitude:4,envelope:"custom"}]}},{name:"tinkle bell",midiProgram:112,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→2→3→4",feedbackAmplitude:5,feedbackEnvelope:"twang 3",operators:[{frequency:"~2×",amplitude:7,envelope:"custom"},{frequency:"5×",amplitude:7,envelope:"custom"},{frequency:"7×",amplitude:7,envelope:"custom"},{frequency:"16×",amplitude:7,envelope:"custom"}]}},{name:"agogo",midiProgram:113,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"decay 1",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→4",feedbackAmplitude:15,feedbackEnvelope:"decay 1",operators:[{frequency:"2×",amplitude:9,envelope:"custom"},{frequency:"5×",amplitude:6,envelope:"custom"},{frequency:"8×",amplitude:9,envelope:"custom"},{frequency:"13×",amplitude:11,envelope:"custom"}]}}])},{name:"Guitar Presets",presets:t.toNameMap([{name:"nylon guitar",midiProgram:24,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"3⟲",feedbackAmplitude:6,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"5×",amplitude:2,envelope:"steady"},{frequency:"7×",amplitude:4,envelope:"steady"}]}},{name:"steel guitar",midiProgram:25,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[100,100,86,71,71,71,86,86,71,57,43,43,43,57,57,57,57,57,43,43,43,43,43,43,43,43,43,43]}},{name:"jazz guitar",midiProgram:26,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[100,100,86,71,57,71,71,43,57,71,57,43,29,29,29,29,29,29,29,29,14,14,14,14,14,14,14,0]}},{name:"clean guitar",midiProgram:27,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",interval:"union",vibrato:"none",harmonics:[86,100,100,100,86,57,86,100,100,100,71,57,43,71,86,71,57,57,71,71,71,71,57,57,57,57,57,43]}},{name:"muted guitar",midiProgram:28,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:7,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:4,envelope:"twang 3"},{frequency:"4×",amplitude:4,envelope:"twang 2"},{frequency:"16×",amplitude:4,envelope:"twang 1"}]}}])},{name:"Picked Bass Presets",presets:t.toNameMap([{name:"acoustic bass",midiProgram:32,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,86,71,71,71,71,57,57,57,57,43,43,43,43,43,29,29,29,29,29,29,14,14,14,14,14,14,14]}},{name:"fingered bass",midiProgram:33,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,86,71,57,71,43,57,29,29,29,29,29,29,14,14,14,14,14,14,14,14,14,14,14,14,14,14,0]}},{name:"picked bass",midiProgram:34,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"3⟲",feedbackAmplitude:4,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:5,envelope:"steady"},{frequency:"11×",amplitude:1,envelope:"twang 3"},{frequency:"1×",amplitude:9,envelope:"steady"}]}},{name:"fretless bass",midiProgram:35,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:1e3,filterResonance:14,filterEnvelope:"flare 2",interval:"union",vibrato:"none",harmonics:[100,100,86,71,71,57,57,71,71,71,57,57,57,57,57,57,57,43,43,43,43,43,43,43,43,29,29,14]}},{name:"slap bass 1",midiProgram:36,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:4e3,filterResonance:0,filterEnvelope:"twang 1",interval:"union",vibrato:"none",harmonics:[100,100,100,100,86,71,57,29,29,43,43,57,71,57,29,29,43,57,57,57,43,43,43,57,71,71,71,71]}},{name:"slap bass 2",midiProgram:37,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:5657,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"3⟲",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"3×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:7,envelope:"steady"},{frequency:"13×",amplitude:3,envelope:"steady"},{frequency:"1×",amplitude:11,envelope:"steady"}]}},{name:"bass synth 1",midiProgram:38,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"strum",filterCutoffHz:4e3,filterResonance:43,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"3⟲ 4⟲",feedbackAmplitude:9,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"1×",amplitude:14,envelope:"twang 1"},{frequency:"~1×",amplitude:13,envelope:"twang 2"}]}},{name:"bass synth 2",midiProgram:39,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:1e3,filterResonance:57,filterEnvelope:"punch",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1→2",feedbackAmplitude:4,feedbackEnvelope:"twang 3",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"1×",amplitude:9,envelope:"steady"},{frequency:"3×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"bass & lead",midiProgram:87,generalMidi:!0,settings:{type:"chip",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:4e3,filterResonance:86,filterEnvelope:"twang 2",wave:"sawtooth",interval:"shimmer",vibrato:"none"}}])},{name:"Picked String Presets",presets:t.toNameMap([{name:"pizzicato strings",midiProgram:45,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:7,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"3×",amplitude:10,envelope:"custom"},{frequency:"6×",amplitude:8,envelope:"custom"},{frequency:"~1×",amplitude:10,envelope:"steady"}]}},{name:"harp",midiProgram:46,generalMidi:!0,settings:{type:"FM",transition:"hard fade",effects:"reverb",chord:"strum",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"3⟲",feedbackAmplitude:6,feedbackEnvelope:"twang 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"4×",amplitude:6,envelope:"custom"},{frequency:"~2×",amplitude:3,envelope:"steady"},{frequency:"1×",amplitude:6,envelope:"steady"}]}},{name:"sitar",midiProgram:104,generalMidi:!0,settings:{type:"FM",transition:"hard fade",effects:"reverb",chord:"strum",filterCutoffHz:8e3,filterResonance:57,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:14,envelope:"twang 3"},{frequency:"9×",amplitude:3,envelope:"twang 3"},{frequency:"16×",amplitude:9,envelope:"swell 3"}]}},{name:"banjo",midiProgram:105,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"2⟲",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"steady"},{frequency:"11×",amplitude:3,envelope:"twang 3"},{frequency:"1×",amplitude:11,envelope:"steady"}]}},{name:"ukulele",midiProgram:105,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"3⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 1",operators:[{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"9×",amplitude:4,envelope:"twang 2"},{frequency:"1×",amplitude:11,envelope:"steady"}]}},{name:"shamisen",midiProgram:106,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:14,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"3⟲",feedbackAmplitude:9,feedbackEnvelope:"twang 3",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"steady"},{frequency:"16×",amplitude:4,envelope:"twang 3"},{frequency:"1×",amplitude:7,envelope:"steady"}]}},{name:"koto",midiProgram:107,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 2",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 2",operators:[{frequency:"~1×",amplitude:12,envelope:"custom"},{frequency:"6×",amplitude:10,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"twang 3"},{frequency:"~2×",amplitude:8,envelope:"twang 3"}]}}])},{name:"Distortion Presets",presets:t.toNameMap([{name:"overdrive guitar",midiProgram:29,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1→2",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"~1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"steady"},{frequency:"1×",amplitude:7,envelope:"twang 3"},{frequency:"1×",amplitude:4,envelope:"swell 3"}]}},{name:"distortion guitar",midiProgram:30,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:57,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1→2",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"~1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:11,envelope:"steady"},{frequency:"1×",amplitude:9,envelope:"swell 1"},{frequency:"~2×",amplitude:5,envelope:"swell 3"}]}},{name:"charango synth",midiProgram:84,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:5657,filterResonance:0,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1→2→3→4",feedbackAmplitude:8,feedbackEnvelope:"twang 3",operators:[{frequency:"3×",amplitude:13,envelope:"custom"},{frequency:"~1×",amplitude:5,envelope:"steady"},{frequency:"4×",amplitude:6,envelope:"steady"},{frequency:"3×",amplitude:7,envelope:"steady"}]}},{name:"guitar harmonics",midiProgram:31,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3)←4",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:12,envelope:"custom"},{frequency:"16×",amplitude:5,envelope:"swell 1"},{frequency:"1×",amplitude:2,envelope:"punch"},{frequency:"~1×",amplitude:12,envelope:"twang 1"}]}},{name:"distorted synth 1",midiProgram:30,settings:{type:"PWM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"steady",pulseWidth:17.6875,pulseEnvelope:"punch",vibrato:"none"}},{name:"distorted synth 2",midiProgram:30,settings:{type:"FM",effects:"reverb",transition:"seamless",chord:"custom interval",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:7,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:13,envelope:"steady"},{frequency:"1×",amplitude:11,envelope:"swell 1"},{frequency:"1×",amplitude:0,envelope:"flare 1"}]}},{name:"distorted synth 3",midiProgram:30,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"delayed",algorithm:"1←(2 3 4)",feedbackType:"1→2",feedbackAmplitude:3,feedbackEnvelope:"steady",operators:[{frequency:"~1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:11,envelope:"steady"},{frequency:"1×",amplitude:12,envelope:"swell 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}}])},{name:"Bellows Presets",presets:t.toNameMap([{name:"drawbar organ 1",midiProgram:16,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[86,86,0,86,0,0,0,86,0,0,0,0,0,0,0,86,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"drawbar organ 2",midiProgram:16,midiSubharmonicOctaves:1,settings:{type:"harmonics",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[86,29,71,86,71,14,0,100,0,0,0,86,0,0,0,71,0,0,0,57,0,0,0,29,0,0,0,0]}},{name:"percussive organ",midiProgram:17,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"punch",vibrato:"light",algorithm:"1 2 3 4",feedbackType:"1→3 2→4",feedbackAmplitude:7,feedbackEnvelope:"decay 1",operators:[{frequency:"1×",amplitude:7,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"custom"},{frequency:"3×",amplitude:8,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"custom"}]}},{name:"rock organ",midiProgram:18,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",effects:"chorus & reverb",transition:"hard",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"punch",vibrato:"delayed",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:2,feedbackEnvelope:"flare 1",operators:[{frequency:"1×",amplitude:9,envelope:"custom"},{frequency:"4×",amplitude:9,envelope:"custom"},{frequency:"6×",amplitude:9,envelope:"custom"},{frequency:"2×",amplitude:5,envelope:"steady"}]}},{name:"pipe organ",midiProgram:19,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",transition:"cross fade",effects:"reverb",chord:"harmony",filterCutoffHz:5657,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:5,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:8,envelope:"custom"},{frequency:"2×",amplitude:9,envelope:"custom"},{frequency:"4×",amplitude:9,envelope:"custom"},{frequency:"8×",amplitude:8,envelope:"custom"}]}},{name:"reed organ",midiProgram:20,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[71,86,100,86,71,100,57,71,71,71,43,43,43,71,43,71,57,57,57,57,57,57,57,29,43,29,29,14]}},{name:"accordion",midiProgram:21,generalMidi:!0,settings:{type:"chip",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:5657,filterResonance:0,filterEnvelope:"swell 1",wave:"double saw",interval:"honky tonk",vibrato:"none"}},{name:"bandoneon",midiProgram:23,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 1",interval:"hum",vibrato:"none",harmonics:[86,86,86,57,71,86,57,71,71,71,57,43,57,43,71,43,71,57,57,43,43,43,57,43,43,29,29,29]}},{name:"bagpipe",midiProgram:109,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:5657,filterResonance:43,filterEnvelope:"punch",interval:"hum",vibrato:"none",harmonics:[71,86,86,100,100,86,57,100,86,71,71,71,57,57,57,71,57,71,57,71,43,57,57,43,43,43,43,43]}}])},{name:"String Presets",presets:t.toNameMap([{name:"violin",midiProgram:40,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:6,feedbackEnvelope:"swell 1",operators:[{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"6×",amplitude:7,envelope:"custom"},{frequency:"11×",amplitude:5,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"}]}},{name:"viola",midiProgram:41,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:8,feedbackEnvelope:"swell 1",operators:[{frequency:"2×",amplitude:11,envelope:"custom"},{frequency:"7×",amplitude:7,envelope:"custom"},{frequency:"13×",amplitude:4,envelope:"custom"},{frequency:"1×",amplitude:5,envelope:"steady"}]}},{name:"cello",midiProgram:42,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:6,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:11,envelope:"custom"},{frequency:"3×",amplitude:9,envelope:"custom"},{frequency:"8×",amplitude:7,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"}]}},{name:"contrabass",midiProgram:43,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2)←3←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"16×",amplitude:5,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"steady"},{frequency:"6×",amplitude:3,envelope:"swell 1"}]}},{name:"fiddle",midiProgram:110,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"steady",vibrato:"delayed",algorithm:"(1 2)←(3 4)",feedbackType:"3⟲ 4⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 1",operators:[{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"8×",amplitude:8,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"16×",amplitude:3,envelope:"steady"}]}},{name:"tremolo strings",midiProgram:44,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:0,filterEnvelope:"tremolo4",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1→2→3→4",feedbackAmplitude:12,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:8,envelope:"custom"},{frequency:"~2×",amplitude:8,envelope:"custom"},{frequency:"4×",amplitude:8,envelope:"custom"},{frequency:"7×",amplitude:8,envelope:"custom"}]}},{name:"strings",midiProgram:48,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"4⟲",feedbackAmplitude:5,feedbackEnvelope:"twang 3",operators:[{frequency:"4×",amplitude:9,envelope:"custom"},{frequency:"3×",amplitude:9,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"steady"},{frequency:"7×",amplitude:3,envelope:"swell 1"}]}},{name:"slow strings",midiProgram:49,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:1414,filterResonance:0,filterEnvelope:"swell 2",vibrato:"none",algorithm:"(1 2)←(3 4)",feedbackType:"4⟲",feedbackAmplitude:6,feedbackEnvelope:"flare 3",operators:[{frequency:"4×",amplitude:10,envelope:"custom"},{frequency:"3×",amplitude:10,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"steady"},{frequency:"7×",amplitude:4,envelope:"swell 1"}]}},{name:"strings synth 1",midiProgram:50,generalMidi:!0,settings:{type:"chip",volume:60,transition:"soft fade",effects:"chorus & reverb",chord:"harmony",filterCutoffHz:1414,filterResonance:43,filterEnvelope:"steady",wave:"sawtooth",interval:"hum",vibrato:"delayed"}},{name:"strings synth 2",midiProgram:51,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:12,feedbackEnvelope:"swell 1",operators:[{frequency:"3×",amplitude:6,envelope:"custom"},{frequency:"2×",amplitude:7,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"custom"},{frequency:"1×",amplitude:9,envelope:"custom"}]}},{name:"orchestra hit",midiProgram:55,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"FM",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"decay 1",vibrato:"delayed",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:14,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"3×",amplitude:12,envelope:"custom"},{frequency:"4×",amplitude:14,envelope:"custom"}]}}])},{name:"Vocal Presets",presets:t.toNameMap([{name:"choir soprano",midiProgram:94,generalMidi:!0,settings:{type:"harmonics",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2828,filterResonance:57,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[86,100,86,43,14,14,57,71,57,14,14,14,14,14,43,57,43,14,14,14,14,14,14,14,0,0,0,0]}},{name:"choir tenor",midiProgram:52,generalMidi:!0,settings:{type:"harmonics",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2828,filterResonance:86,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[86,100,100,86,71,57,29,14,14,14,29,43,43,43,29,14,14,14,0,0,0,0,0,0,0,0,0,0]}},{name:"choir bass",midiProgram:52,settings:{type:"harmonics",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2828,filterResonance:86,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[71,86,86,100,86,100,57,43,14,14,14,14,29,29,43,43,43,43,43,29,29,29,29,14,14,14,0,0]}},{name:"solo soprano",midiProgram:85,settings:{type:"harmonics",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:71,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[86,100,86,43,14,14,57,71,57,14,14,14,14,14,43,57,43,14,14,14,14,14,14,14,0,0,0,0]}},{name:"solo tenor",midiProgram:85,settings:{type:"harmonics",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:86,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[86,100,100,86,71,57,29,14,14,14,29,43,43,43,29,14,14,14,0,0,0,0,0,0,0,0,0,0]}},{name:"solo bass",midiProgram:85,settings:{type:"harmonics",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:86,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[71,86,86,100,86,100,57,43,14,14,14,14,29,29,43,43,43,43,43,29,29,29,29,14,14,14,0,0]}},{name:"voice ooh",midiProgram:53,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:1414,filterResonance:57,filterEnvelope:"steady",interval:"union",vibrato:"shaky",harmonics:[100,57,43,43,14,14,0,0,0,14,29,29,14,0,14,29,29,14,0,0,0,0,0,0,0,0,0,0]}},{name:"voice synth",midiProgram:54,generalMidi:!0,settings:{type:"chip",transition:"medium fade",effects:"chorus & reverb",chord:"harmony",filterCutoffHz:4e3,filterResonance:57,filterEnvelope:"steady",wave:"rounded",interval:"union",vibrato:"light"}},{name:"vox synth lead",midiProgram:85,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",vibrato:"light",algorithm:"(1 2 3)←4",feedbackType:"1→2→3→4",feedbackAmplitude:2,feedbackEnvelope:"punch",operators:[{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"9×",amplitude:5,envelope:"custom"},{frequency:"20×",amplitude:1,envelope:"custom"},{frequency:"~1×",amplitude:4,envelope:"steady"}]}},{name:"tiny robot",midiProgram:85,settings:{type:"FM",transition:"slide",effects:"reverb",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"delayed",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"twang 3",operators:[{frequency:"2×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:7,envelope:"punch"},{frequency:"~1×",amplitude:7,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"yowie",midiProgram:85,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:86,filterEnvelope:"tremolo5",vibrato:"none",algorithm:"1←2←(3 4)",feedbackType:"1⟲",feedbackAmplitude:12,feedbackEnvelope:"tremolo3",operators:[{frequency:"2×",amplitude:12,envelope:"custom"},{frequency:"16×",amplitude:5,envelope:"steady"},{frequency:"1×",amplitude:5,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"mouse",midiProgram:85,settings:{type:"FM",effects:"reverb",transition:"slide",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"light",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:5,feedbackEnvelope:"flare 2",operators:[{frequency:"2×",amplitude:13,envelope:"custom"},{frequency:"5×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"gumdrop",midiProgram:85,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"2×",amplitude:15,envelope:"punch"},{frequency:"4×",amplitude:15,envelope:"punch"},{frequency:"7×",amplitude:15,envelope:"punch"},{frequency:"1×",amplitude:10,envelope:"twang 1"}]}},{name:"echo drop",midiProgram:102,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"punch",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"~2×",amplitude:11,envelope:"custom"},{frequency:"~1×",amplitude:5,envelope:"steady"},{frequency:"11×",amplitude:2,envelope:"steady"},{frequency:"16×",amplitude:5,envelope:"swell 3"}]}},{name:"dark choir",midiProgram:85,settings:{type:"spectrum",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 1",spectrum:[43,14,14,14,14,14,14,100,14,14,14,57,14,14,100,14,43,14,43,14,14,43,14,29,14,29,14,14,29,0]}}])},{name:"Brass Presets",presets:t.toNameMap([{name:"trumpet",midiProgram:56,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:9,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"1×",amplitude:5,envelope:"flare 2"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"trombone",midiProgram:57,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"2⟲",feedbackAmplitude:7,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"tuba",midiProgram:58,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"2⟲",feedbackAmplitude:8,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"muted trumpet",midiProgram:59,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"swell 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:5,feedbackEnvelope:"flare 2",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:5,envelope:"steady"},{frequency:"9×",amplitude:5,envelope:"steady"},{frequency:"13×",amplitude:9,envelope:"swell 1"}]}},{name:"french horn",midiProgram:60,generalMidi:!0,settings:{type:"FM",transition:"soft",effects:"reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"steady",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:3,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"swell 1"},{frequency:"~1×",amplitude:8,envelope:"flare 2"}]}},{name:"brass section",midiProgram:61,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"punch",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:6,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"swell 1"},{frequency:"~1×",amplitude:10,envelope:"swell 1"}]}},{name:"brass synth 1",midiProgram:62,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:11,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:12,envelope:"flare 1"},{frequency:"~1×",amplitude:8,envelope:"flare 2"}]}},{name:"brass synth 2",midiProgram:63,generalMidi:!0,settings:{type:"FM",transition:"soft",effects:"reverb",chord:"harmony",filterCutoffHz:4e3,filterResonance:43,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:9,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"flare 1"},{frequency:"~1×",amplitude:7,envelope:"flare 1"}]}},{name:"pulse brass",midiProgram:62,settings:{type:"PWM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 1",pulseWidth:50,pulseEnvelope:"flare 3",vibrato:"none"}}])},{name:"Reed Presets",presets:t.toNameMap([{name:"soprano sax",midiProgram:64,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"4⟲",feedbackAmplitude:5,feedbackEnvelope:"swell 1",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"4×",amplitude:4,envelope:"swell 1"},{frequency:"1×",amplitude:7,envelope:"steady"},{frequency:"5×",amplitude:4,envelope:"punch"}]}},{name:"alto sax",midiProgram:65,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:4,feedbackEnvelope:"punch",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"4×",amplitude:6,envelope:"swell 1"},{frequency:"1×",amplitude:12,envelope:"steady"}]}},{name:"tenor sax",midiProgram:66,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"1⟲",feedbackAmplitude:6,feedbackEnvelope:"swell 1",operators:[{frequency:"2×",amplitude:12,envelope:"custom"},{frequency:"3×",amplitude:7,envelope:"steady"},{frequency:"1×",amplitude:3,envelope:"steady"},{frequency:"8×",amplitude:3,envelope:"steady"}]}},{name:"baritone sax",midiProgram:67,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"swell 2",operators:[{frequency:"1×",amplitude:12,envelope:"custom"},{frequency:"8×",amplitude:4,envelope:"steady"},{frequency:"4×",amplitude:5,envelope:"steady"},{frequency:"1×",amplitude:4,envelope:"punch"}]}},{name:"sax synth",midiProgram:64,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"light",algorithm:"1←(2 3 4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:4,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"shehnai",midiProgram:111,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"light",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:3,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"oboe",midiProgram:68,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"swell 1",vibrato:"none",algorithm:"1 2←(3 4)",feedbackType:"2⟲",feedbackAmplitude:2,feedbackEnvelope:"tremolo5",operators:[{frequency:"1×",amplitude:7,envelope:"custom"},{frequency:"4×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"6×",amplitude:2,envelope:"steady"}]}},{name:"english horn",midiProgram:69,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2←(3 4)",feedbackType:"2⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"4×",amplitude:12,envelope:"custom"},{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"1×",amplitude:8,envelope:"punch"},{frequency:"8×",amplitude:4,envelope:"steady"}]}},{name:"bassoon",midiProgram:70,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:707,filterResonance:57,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"2×",amplitude:11,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"steady"},{frequency:"6×",amplitude:6,envelope:"swell 1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"clarinet",midiProgram:71,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:1414,filterResonance:14,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[100,43,86,57,86,71,86,71,71,71,71,71,71,43,71,71,57,57,57,57,57,57,43,43,43,29,14,0]}},{name:"harmonica",midiProgram:22,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:5657,filterResonance:29,filterEnvelope:"swell 1",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:9,feedbackEnvelope:"tremolo5",operators:[{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"steady"},{frequency:"~2×",amplitude:2,envelope:"twang 3"},{frequency:"1×",amplitude:0,envelope:"steady"}]}}])},{name:"Flute Presets",presets:t.toNameMap([{name:"flute",midiProgram:73,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"4⟲",feedbackAmplitude:7,feedbackEnvelope:"decay 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"2×",amplitude:4,envelope:"steady"},{frequency:"1×",amplitude:3,envelope:"steady"},{frequency:"~1×",amplitude:1,envelope:"punch"}]}},{name:"recorder",midiProgram:74,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"swell 2",interval:"union",vibrato:"none",harmonics:[100,43,57,43,57,43,43,43,43,43,43,43,43,29,29,29,29,29,29,29,14,14,14,14,14,14,14,0]}},{name:"whistle",midiProgram:78,generalMidi:!0,settings:{type:"harmonics",effects:"chorus & reverb",transition:"soft",chord:"harmony",filterCutoffHz:2e3,filterResonance:43,filterEnvelope:"steady",interval:"union",vibrato:"delayed",harmonics:[100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"ocarina",midiProgram:79,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"steady",interval:"union",vibrato:"none",harmonics:[100,14,57,14,29,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"piccolo",midiProgram:72,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:5657,filterResonance:43,filterEnvelope:"steady",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"4⟲",feedbackAmplitude:15,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"~2×",amplitude:3,envelope:"punch"},{frequency:"~1×",amplitude:5,envelope:"punch"}]}},{name:"shakuhachi",midiProgram:77,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"steady",vibrato:"delayed",algorithm:"1←(2 3←4)",feedbackType:"3→4",feedbackAmplitude:15,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"2×",amplitude:3,envelope:"punch"},{frequency:"~1×",amplitude:4,envelope:"twang 1"},{frequency:"20×",amplitude:15,envelope:"steady"}]}},{name:"pan flute",midiProgram:75,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"soft",chord:"harmony",filterCutoffHz:8e3,filterResonance:43,filterEnvelope:"steady",spectrum:[100,0,0,0,0,0,0,14,0,0,0,71,0,0,14,0,57,0,29,14,29,14,14,29,14,29,14,14,29,14]}},{name:"blown bottle",midiProgram:76,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:5657,filterResonance:57,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:7,feedbackEnvelope:"twang 1",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"3×",amplitude:4,envelope:"custom"},{frequency:"6×",amplitude:2,envelope:"custom"},{frequency:"11×",amplitude:2,envelope:"custom"}]}},{name:"calliope",midiProgram:82,generalMidi:!0,settings:{type:"spectrum",transition:"cross fade",effects:"reverb",chord:"harmony",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"steady",spectrum:[100,0,0,0,0,0,0,86,0,0,0,71,0,0,57,0,43,0,29,14,14,29,14,14,14,14,14,14,14,14]}},{name:"chiffer",midiProgram:83,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"punch",spectrum:[86,0,0,0,0,0,0,71,0,0,0,71,0,0,57,0,57,0,43,14,14,43,14,29,14,29,29,29,29,14]}},{name:"breath noise",midiProgram:121,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"cross fade",chord:"strum",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 1",spectrum:[71,0,0,0,0,0,0,29,0,0,0,71,0,0,29,0,100,29,14,29,100,29,100,14,14,71,0,29,0,0]}}])},{name:"Pad Presets",presets:t.toNameMap([{name:"new age pad",midiProgram:88,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:8e3,filterResonance:43,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲ 2⟲",feedbackAmplitude:3,feedbackEnvelope:"swell 3",operators:[{frequency:"2×",amplitude:14,envelope:"custom"},{frequency:"~1×",amplitude:4,envelope:"swell 2"},{frequency:"6×",amplitude:3,envelope:"twang 3"},{frequency:"13×",amplitude:3,envelope:"steady"}]}},{name:"warm pad",midiProgram:89,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"swell 3",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:7,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:6,envelope:"swell 1"},{frequency:"1×",amplitude:0,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"polysynth pad",midiProgram:90,generalMidi:!0,settings:{type:"chip",transition:"hard fade",effects:"chorus & reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"twang 3",wave:"sawtooth",interval:"hum",vibrato:"delayed"}},{name:"space voice pad",midiProgram:91,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:71,filterEnvelope:"steady",vibrato:"none",algorithm:"(1 2 3)←4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:5,feedbackEnvelope:"swell 2",operators:[{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"2×",amplitude:8,envelope:"custom"},{frequency:"3×",amplitude:7,envelope:"custom"},{frequency:"11×",amplitude:1,envelope:"punch"}]}},{name:"bowed glass pad",midiProgram:92,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:10,envelope:"custom"},{frequency:"2×",amplitude:12,envelope:"custom"},{frequency:"3×",amplitude:7,envelope:"twang 3"},{frequency:"7×",amplitude:4,envelope:"flare 3"}]}},{name:"metallic pad",midiProgram:93,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 3",vibrato:"none",algorithm:"1←3 2←4",feedbackType:"1⟲ 2⟲",feedbackAmplitude:13,feedbackEnvelope:"twang 3",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"~1×",amplitude:9,envelope:"custom"},{frequency:"1×",amplitude:7,envelope:"swell 2"},{frequency:"11×",amplitude:7,envelope:"steady"}]}},{name:"sweep pad",midiProgram:95,generalMidi:!0,settings:{type:"chip",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:86,filterEnvelope:"flare 3",wave:"sawtooth",interval:"hum",vibrato:"none"}},{name:"atmosphere",midiProgram:99,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"hard fade",chord:"strum",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"steady",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"3⟲ 4⟲",feedbackAmplitude:3,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:14,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"swell 3"},{frequency:"3×",amplitude:7,envelope:"twang 2"},{frequency:"1×",amplitude:7,envelope:"twang 3"}]}},{name:"brightness",midiProgram:100,generalMidi:!0,settings:{type:"harmonics",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 3",interval:"octave",vibrato:"none",harmonics:[100,86,86,86,43,57,43,71,43,43,43,57,43,43,57,71,57,43,29,43,57,57,43,29,29,29,29,14]}},{name:"goblins",midiProgram:101,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:1414,filterResonance:14,filterEnvelope:"swell 2",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"1⟲",feedbackAmplitude:10,feedbackEnvelope:"flare 3",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"4×",amplitude:5,envelope:"swell 3"},{frequency:"1×",amplitude:10,envelope:"tremolo1"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"sci-fi",midiProgram:103,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"medium fade",chord:"harmony",filterCutoffHz:5657,filterResonance:14,filterEnvelope:"twang 3",vibrato:"none",algorithm:"(1 2)←3←4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:8,feedbackEnvelope:"twang 3",operators:[{frequency:"~1×",amplitude:13,envelope:"custom"},{frequency:"2×",amplitude:10,envelope:"custom"},{frequency:"5×",amplitude:5,envelope:"twang 3"},{frequency:"11×",amplitude:8,envelope:"tremolo5"}]}},{name:"flutter pad",midiProgram:90,settings:{type:"FM",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:86,filterEnvelope:"twang 3",vibrato:"delayed",algorithm:"(1 2)←(3 4)",feedbackType:"1⟲ 2⟲ 3⟲",feedbackAmplitude:9,feedbackEnvelope:"steady",operators:[{frequency:"1×",amplitude:13,envelope:"custom"},{frequency:"5×",amplitude:7,envelope:"custom"},{frequency:"7×",amplitude:5,envelope:"tremolo1"},{frequency:"~1×",amplitude:6,envelope:"punch"}]}},{name:"feedback pad",midiProgram:89,settings:{type:"FM",effects:"reverb",transition:"soft fade",chord:"custom interval",filterCutoffHz:8e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1 2 3 4",feedbackType:"1⟲ 2⟲ 3⟲ 4⟲",feedbackAmplitude:7,feedbackEnvelope:"swell 2",operators:[{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"1×",amplitude:15,envelope:"custom"},{frequency:"~1×",amplitude:15,envelope:"custom"}]}}])},{name:"Drum Presets",presets:t.toNameMap([{name:"standard drumset",midiProgram:116,isNoise:!0,settings:{type:"drumset",effects:"reverb",drums:[{filterEnvelope:"twang 1",spectrum:[57,71,71,86,86,86,71,71,71,71,57,57,57,57,43,43,43,43,29,29,29,29,29,29,29,29,29,29,29,29]},{filterEnvelope:"twang 1",spectrum:[0,0,0,100,71,71,57,86,57,57,57,71,43,43,57,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43]},{filterEnvelope:"twang 1",spectrum:[0,0,0,0,100,57,43,43,29,57,43,29,71,43,43,43,43,57,43,43,43,43,43,43,43,43,29,43,43,43]},{filterEnvelope:"twang 1",spectrum:[0,0,0,0,0,71,57,43,43,43,57,57,43,29,57,43,43,43,29,43,57,43,43,43,43,43,43,29,43,43]},{filterEnvelope:"decay 2",spectrum:[0,14,29,43,86,71,29,43,43,43,43,29,71,29,71,29,43,43,43,43,57,43,43,57,43,43,43,57,57,57]},{filterEnvelope:"decay 1",spectrum:[0,0,14,14,14,14,29,29,29,43,43,43,57,57,57,71,71,71,71,71,71,71,71,57,57,57,57,43,43,43]},{filterEnvelope:"twang 3",spectrum:[43,43,43,71,29,29,43,43,43,29,43,43,43,29,29,43,43,29,29,29,57,14,57,43,43,57,43,43,57,57]},{filterEnvelope:"decay 3",spectrum:[29,43,43,43,43,29,29,43,29,29,43,29,14,29,43,29,43,29,57,29,43,57,43,71,43,71,57,57,71,71]},{filterEnvelope:"twang 3",spectrum:[43,29,29,43,29,29,29,57,29,29,29,57,43,43,29,29,57,43,43,43,71,43,43,71,57,71,71,71,71,71]},{filterEnvelope:"decay 3",spectrum:[57,57,57,43,57,57,43,43,57,43,43,43,71,57,43,57,86,71,57,86,71,57,86,100,71,86,86,86,86,86]},{filterEnvelope:"flare 1",spectrum:[0,0,14,14,14,14,29,29,29,43,43,43,57,57,71,71,86,86,100,100,100,100,100,100,100,100,86,57,29,0]},{filterEnvelope:"decay 2",spectrum:[14,14,14,14,29,14,14,29,14,43,14,43,57,86,57,57,100,57,43,43,57,100,57,43,29,14,0,0,0,0]}]}},{name:"steel pan",midiProgram:114,generalMidi:!0,settings:{type:"FM",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"decay 2",vibrato:"none",algorithm:"1←(2 3←4)",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"~1×",amplitude:14,envelope:"custom"},{frequency:"7×",amplitude:3,envelope:"flare 1"},{frequency:"3×",amplitude:5,envelope:"flare 2"},{frequency:"4×",amplitude:4,envelope:"swell 2"}]}},{name:"steel pan synth",midiProgram:114,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"twang 1",vibrato:"none",algorithm:"1 2 3←4",feedbackType:"1⟲",feedbackAmplitude:5,feedbackEnvelope:"flare 1",operators:[{frequency:"~1×",amplitude:12,envelope:"custom"},{frequency:"2×",amplitude:15,envelope:"custom"},{frequency:"4×",amplitude:14,envelope:"flare 1"},{frequency:"~1×",amplitude:3,envelope:"flare 2"}]}},{name:"timpani",midiProgram:47,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"twang 2",spectrum:[100,0,0,0,86,0,0,71,0,14,43,14,43,43,0,29,43,29,29,29,43,29,43,29,43,43,43,43,43,43]}},{name:"dark strike",midiProgram:47,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:29,filterEnvelope:"twang 2",spectrum:[0,0,0,0,14,14,14,29,29,43,43,86,43,43,43,29,86,29,29,29,86,29,14,14,14,14,0,0,0,0]}},{name:"woodblock",midiProgram:115,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-2.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:14,filterEnvelope:"twang 1",spectrum:[0,14,29,43,43,57,86,86,71,57,57,43,43,57,86,86,43,43,71,57,57,57,57,57,86,86,71,71,71,71]}},{name:"taiko drum",midiProgram:116,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:29,filterEnvelope:"twang 1",spectrum:[71,100,100,43,43,71,71,43,43,43,43,43,43,57,29,57,43,57,43,43,57,43,43,43,43,43,43,43,43,43]}},{name:"melodic drum",midiProgram:117,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-1.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2828,filterResonance:43,filterEnvelope:"twang 1",spectrum:[100,71,71,57,57,43,43,71,43,43,43,57,43,43,57,43,43,43,43,29,29,29,29,29,29,29,29,29,29,29]}},{name:"drum synth",midiProgram:118,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-2,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:4e3,filterResonance:43,filterEnvelope:"decay 1",spectrum:[100,86,71,57,43,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29]}},{name:"tom-tom",midiProgram:116,isNoise:!0,midiSubharmonicOctaves:-1,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"twang 1",spectrum:[100,29,14,0,0,86,14,43,29,86,29,14,29,57,43,43,43,43,57,43,43,43,29,57,43,43,43,43,43,43]}},{name:"metal pipe",midiProgram:117,isNoise:!0,midiSubharmonicOctaves:-1.5,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:8e3,filterResonance:14,filterEnvelope:"twang 2",spectrum:[29,43,86,43,43,43,43,43,100,29,14,14,100,14,14,0,0,0,0,0,14,29,29,14,0,0,14,29,0,0]}}])},{name:"Novelty Presets",presets:t.toNameMap([{name:"guitar fret noise",midiProgram:120,generalMidi:!0,settings:{type:"spectrum",effects:"reverb",transition:"hard",chord:"harmony",filterCutoffHz:8e3,filterResonance:86,filterEnvelope:"flare 1",spectrum:[0,0,0,0,0,0,0,0,0,0,0,0,0,14,0,0,0,29,14,0,0,43,0,43,0,71,43,0,57,0]}},{name:"fifth saw lead",midiProgram:86,generalMidi:!0,midiSubharmonicOctaves:1,settings:{type:"chip",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2828,filterResonance:57,filterEnvelope:"twang 3",wave:"sawtooth",interval:"fifth",vibrato:"none"}},{name:"fifth swell",midiProgram:86,midiSubharmonicOctaves:1,settings:{type:"chip",effects:"chorus & reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:57,filterEnvelope:"swell 3",wave:"sawtooth",interval:"fifth",vibrato:"none"}},{name:"soundtrack",midiProgram:97,generalMidi:!0,settings:{type:"chip",effects:"chorus & reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"flare 3",wave:"sawtooth",interval:"fifth",vibrato:"none"}},{name:"reverse cymbal",midiProgram:119,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-3,settings:{type:"spectrum",effects:"none",transition:"soft",chord:"harmony",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"swell 3",spectrum:[29,57,57,29,57,57,29,29,43,29,29,43,29,29,57,57,14,57,14,57,71,71,57,86,57,100,86,86,86,86]}},{name:"seashore",midiProgram:122,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-3,settings:{type:"spectrum",transition:"soft fade",effects:"reverb",chord:"harmony",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"swell 3",spectrum:[14,14,29,29,43,43,43,57,57,57,57,57,57,71,71,71,71,71,71,71,71,71,71,71,71,71,71,71,71,57]}},{name:"bird tweet",midiProgram:123,generalMidi:!0,settings:{type:"harmonics",effects:"reverb",transition:"soft",chord:"strum",filterCutoffHz:2828,filterResonance:0,filterEnvelope:"decay 1",interval:"hum",vibrato:"heavy",harmonics:[0,0,14,100,14,0,0,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},{name:"telephone ring",midiProgram:124,generalMidi:!0,settings:{type:"FM",effects:"reverb",transition:"hard",chord:"arpeggio",filterCutoffHz:4e3,filterResonance:14,filterEnvelope:"tremolo4",vibrato:"none",algorithm:"1←(2 3 4)",feedbackType:"1⟲",feedbackAmplitude:2,feedbackEnvelope:"steady",operators:[{frequency:"2×",amplitude:12,envelope:"custom"},{frequency:"1×",amplitude:4,envelope:"tremolo1"},{frequency:"20×",amplitude:1,envelope:"steady"},{frequency:"1×",amplitude:0,envelope:"steady"}]}},{name:"helicopter",midiProgram:125,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-.5,settings:{type:"spectrum",effects:"reverb",transition:"seamless",chord:"arpeggio",filterCutoffHz:1414,filterResonance:14,filterEnvelope:"tremolo4",spectrum:[14,43,43,57,57,57,71,71,71,71,86,86,86,86,86,86,86,86,86,86,86,71,71,71,71,71,71,71,57,57]}},{name:"applause",midiProgram:126,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-3,settings:{type:"spectrum",effects:"reverb",transition:"soft fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"swell 3",spectrum:[14,14,29,29,29,43,43,57,71,71,86,86,86,71,71,57,57,57,71,86,86,86,86,86,71,71,57,57,57,57]}},{name:"gunshot",midiProgram:127,generalMidi:!0,isNoise:!0,midiSubharmonicOctaves:-2,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"strum",filterCutoffHz:1414,filterResonance:29,filterEnvelope:"twang 1",spectrum:[14,29,43,43,57,57,57,71,71,71,86,86,86,86,86,86,86,86,86,86,86,71,71,71,71,57,57,57,57,43]}},{name:"scoot",midiProgram:92,settings:{type:"chip",transition:"hard",effects:"reverb",chord:"harmony",filterCutoffHz:707,filterResonance:86,filterEnvelope:"flare 1",wave:"sawtooth",interval:"shimmer",vibrato:"none"}},{name:"buzz saw",midiProgram:30,settings:{type:"FM",effects:"reverb",transition:"soft",chord:"custom interval",filterCutoffHz:2e3,filterResonance:0,filterEnvelope:"steady",vibrato:"none",algorithm:"1←2←3←4",feedbackType:"1⟲",feedbackAmplitude:0,feedbackEnvelope:"steady",operators:[{frequency:"5×",amplitude:13,envelope:"custom"},{frequency:"1×",amplitude:10,envelope:"steady"},{frequency:"~1×",amplitude:6,envelope:"steady"},{frequency:"11×",amplitude:12,envelope:"steady"}]}},{name:"mosquito",midiProgram:93,settings:{type:"PWM",effects:"reverb",transition:"cross fade",chord:"harmony",filterCutoffHz:2828,filterResonance:57,filterEnvelope:"steady",pulseWidth:4.40625,pulseEnvelope:"tremolo6",vibrato:"shaky"}},{name:"breathing",midiProgram:126,isNoise:!0,midiSubharmonicOctaves:-1,settings:{type:"spectrum",effects:"reverb",transition:"hard fade",chord:"harmony",filterCutoffHz:2e3,filterResonance:14,filterEnvelope:"swell 2",spectrum:[14,14,14,29,29,29,29,29,43,29,29,43,43,43,29,29,71,43,86,86,57,100,86,86,86,86,71,86,71,57]}},{name:"klaxon synth",midiProgram:125,isNoise:!0,midiSubharmonicOctaves:-1,settings:{type:"noise",effects:"reverb",transition:"slide",chord:"harmony",filterCutoffHz:2e3,filterResonance:86,filterEnvelope:"steady",wave:"buzz"}}])}]),e.pitchColors=t.toNameMap([{name:"cyan",channelDim:"#0099a1",channelBright:"#25f3ff",noteDim:"#00bdc7",noteBright:"#92f9ff"},{name:"yellow",channelDim:"#a1a100",channelBright:"#ffff25",noteDim:"#c7c700",noteBright:"#ffff92"},{name:"orange",channelDim:"#c75000",channelBright:"#ff9752",noteDim:"#ff771c",noteBright:"#ffcdab"},{name:"green",channelDim:"#00a100",channelBright:"#50ff50",noteDim:"#00c700",noteBright:"#a0ffa0"},{name:"purple",channelDim:"#d020d0",channelBright:"#ff90ff",noteDim:"#e040e0",noteBright:"#ffc0ff"},{name:"blue",channelDim:"#7777b0",channelBright:"#a0a0ff",noteDim:"#8888d0",noteBright:"#d0d0ff"}]),e.noiseColors=t.toNameMap([{name:"gray",channelDim:"#6f6f6f",channelBright:"#aaaaaa",noteDim:"#a7a7a7",noteBright:"#e0e0e0"},{name:"brown",channelDim:"#996633",channelBright:"#ddaa77",noteDim:"#cc9966",noteBright:"#f0d0bb"},{name:"azure",channelDim:"#4a6d8f",channelBright:"#77aadd",noteDim:"#6f9fcf",noteBright:"#bbd7ff"}]),t.EditorConfig=e}(beepbox||(beepbox={})),function(t){function e(t){if(!function(t){return!(!t||t&t-1)}(t))throw new Error("FFT array length must be a power of 2.");return Math.round(Math.log(t)/Math.log(2))}t.scaleElementsByFactor=function(t,e){for(let i=0;i<t.length;i++)t[i]*=e},t.inverseRealFourierTransform=function(t,i){const s=e(i);if(i<4)throw new Error("FFT array length must be at least 4.");for(let e=s-1;e>=2;e--){const s=1<<e,n=s>>1,o=s<<1,h=2*Math.PI/o,r=Math.cos(h),a=Math.sin(h),l=2*r;for(let e=0;e<i;e+=o){const i=e,o=i+n,h=i+s,c=h+n,f=h+s,u=t[i],d=t[h];t[i]=u+d,t[o]*=2,t[h]=u-d,t[c]*=2;let m=r,p=-a,y=1,g=0;for(let e=1;e<n;e++){const s=i+e,n=h-e,o=h+e,r=f-e,a=t[s],c=t[n],u=t[o],d=t[r],v=a-c,b=u+d;t[s]=a+c,t[n]=d-u,t[o]=v*m-b*p,t[r]=b*m+v*p;const w=l*m-y,M=l*p-g;y=m,g=p,m=w,p=M}}}for(let e=0;e<i;e+=4){const i=e+1,s=e+2,n=e+3,o=t[e],h=2*t[i],r=t[s],a=2*t[n],l=o+r,c=o-r;t[e]=l+h,t[i]=l-h,t[s]=c+a,t[n]=c-a}!function(t,i){const s=e(i);if(s>16)throw new Error("FFT array length must not be greater than 2^16.");const n=16-s;for(let e=0;e<i;e++){let i;if((i=((i=(61680&(i=(52428&(i=(43690&e)>>1|(21845&e)<<1))>>2|(13107&i)<<2))>>4|(3855&i)<<4)>>8|(255&i)<<8)>>n)>e){let s=t[e];t[e]=t[i],t[i]=s}}}(t,i)}}(beepbox||(beepbox={})),function(t){t.Deque=class{constructor(){this.t=1,this.i=[void 0],this.s=0,this.o=0,this.h=0}pushFront(t){this.h>=this.t&&this.l(),this.o=this.o-1&this.s,this.i[this.o]=t,this.h++}pushBack(t){this.h>=this.t&&this.l(),this.i[this.o+this.h&this.s]=t,this.h++}popFront(){if(this.h<=0)throw new Error("No elements left to pop.");const t=this.i[this.o];return this.i[this.o]=void 0,this.o=this.o+1&this.s,this.h--,t}popBack(){if(this.h<=0)throw new Error("No elements left to pop.");this.h--;const t=this.o+this.h&this.s,e=this.i[t];return this.i[t]=void 0,e}peakFront(){if(this.h<=0)throw new Error("No elements left to pop.");return this.i[this.o]}peakBack(){if(this.h<=0)throw new Error("No elements left to pop.");return this.i[this.o+this.h-1&this.s]}count(){return this.h}set(t,e){if(t<0||t>=this.h)throw new Error("Invalid index");this.i[this.o+t&this.s]=e}get(t){if(t<0||t>=this.h)throw new Error("Invalid index");return this.i[this.o+t&this.s]}remove(t){if(t<0||t>=this.h)throw new Error("Invalid index");if(t<=this.h>>1){for(;t>0;)this.set(t,this.get(t-1)),t--;this.popFront()}else{for(t++;t<this.h;)this.set(t-1,this.get(t)),t++;this.popBack()}}l(){if(this.t>=1073741824)throw new Error("Capacity too big.");this.t=this.t<<1;const t=this.i,e=new Array(this.t),i=0|this.h,s=0|this.o;for(let n=0;n<i;n++)e[n]=t[s+n&this.s];for(let t=i;t<this.t;t++)e[t]=void 0;this.o=0,this.i=e,this.s=this.t-1}}}(beepbox||(beepbox={})),function(t){class e{constructor(t,e,i,s){this.u=[],this.m=0;for(let n=i;n<s;n++){const i=t[e.charCodeAt(n)];this.u.push(i>>5&1),this.u.push(i>>4&1),this.u.push(i>>3&1),this.u.push(i>>2&1),this.u.push(i>>1&1),this.u.push(1&i)}}read(t){let e=0;for(;t>0;)e<<=1,e+=this.u[this.m++],t--;return e}readLongTail(t,e){let i=t,s=e;for(;this.u[this.m++];)i+=1<<s,s++;for(;s>0;)s--,this.u[this.m++]&&(i+=1<<s);return i}readPartDuration(){return this.readLongTail(1,3)}readLegacyPartDuration(){return this.readLongTail(1,2)}readPinCount(){return this.readLongTail(1,0)}readPitchInterval(){return this.read(1)?-this.readLongTail(1,3):this.readLongTail(1,3)}}class i{constructor(){this.u=[]}write(t,e){for(t--;t>=0;)this.u.push(e>>>t&1),t--}writeLongTail(t,e,i){if(i<t)throw new Error("value out of bounds");i-=t;let s=e;for(;i>=1<<s;)this.u.push(1),i-=1<<s,s++;for(this.u.push(0);s>0;)s--,this.u.push(i>>>s&1)}writePartDuration(t){this.writeLongTail(1,3,t)}writePinCount(t){this.writeLongTail(1,0,t)}writePitchInterval(t){t<0?(this.write(1,1),this.writeLongTail(1,3,-t)):(this.write(1,0),this.writeLongTail(1,3,t))}concat(t){this.u=this.u.concat(t.u)}encodeBase64(t,e){for(let i=0;i<this.u.length;i+=6){const s=this.u[i]<<5|this.u[i+1]<<4|this.u[i+2]<<3|this.u[i+3]<<2|this.u[i+4]<<1|this.u[i+5];e.push(t[s])}return e}lengthBase64(){return Math.ceil(this.u.length/6)}}function s(t,e,i){return{interval:t,time:e,volume:i}}function n(t,e,i){return i<=(e-=1)?i>=t?i:t:e}t.makeNotePin=s;class o{constructor(t,e,i,n,o=!1){this.pitches=[t],this.pins=[s(0,0,n),s(0,i-e,o?0:n)],this.start=e,this.end=i}pickMainInterval(){let t=0,e=0;for(let i=1;i<this.pins.length;i++){const s=this.pins[i-1],n=this.pins[i];if(s.interval==n.interval){const i=n.time-s.time;t<i&&(t=i,e=s.interval)}}if(0==t){let t=0;for(let i=0;i<this.pins.length;i++){const s=this.pins[i];t<s.volume&&(t=s.volume,e=s.interval)}}return e}}t.Note=o;class h{constructor(){this.notes=[],this.instrument=0}cloneNotes(){const t=[];for(const e of this.notes){const i=new o(-1,e.start,e.end,3);i.pitches=e.pitches.concat(),i.pins=[];for(const t of e.pins)i.pins.push(s(t.interval,t.time,t.volume));t.push(i)}return t}reset(){this.notes.length=0,this.instrument=0}}t.Pattern=h;class r{constructor(t){this.frequency=0,this.amplitude=0,this.envelope=0,this.reset(t)}reset(e){this.frequency=0,this.amplitude=e<=1?t.Config.operatorAmplitudeMax:0,this.envelope=0==e?0:1}}t.Operator=r;class a{constructor(t){this.spectrum=[],this.v=null,this.M=!1,this.reset(t)}reset(e){for(let i=0;i<t.Config.spectrumControlPoints;i++)if(e)this.spectrum[i]=Math.round(t.Config.spectrumMax*(1/Math.sqrt(1+i/3)));else{const e=0==i||7==i||11==i||14==i||16==i||18==i||21==i||23==i||i>=25;this.spectrum[i]=e?Math.max(0,Math.round(t.Config.spectrumMax*(1-i/30))):0}this.M=!1}markCustomWaveDirty(){this.M=!1}getCustomWave(e){if(!this.M||null==this.v){let s=t.Config.chipNoiseLength;null!=this.v&&this.v.length==s+1||(this.v=new Float32Array(s+1));const n=this.v;for(let t=0;t<s;t++)n[t]=0;const o=14,h=.25,r=[0,1/7,Math.log(5/4)/Math.LN2,3/7,Math.log(1.5)/Math.LN2,5/7,6/7];function i(i){return e+Math.floor(i/t.Config.spectrumControlPointsPerOctave)+r[(i+t.Config.spectrumControlPointsPerOctave)%t.Config.spectrumControlPointsPerOctave]}let a=1;for(let e=0;e<t.Config.spectrumControlPoints+1;e++){const s=e<=0?0:this.spectrum[e-1],r=e>=t.Config.spectrumControlPoints?this.spectrum[t.Config.spectrumControlPoints-1]:this.spectrum[e],l=i(e-1);let c=i(e);e>=t.Config.spectrumControlPoints&&(c=o+(c-o)*h),0==s&&0==r||(a+=.02*t.drawNoiseSpectrum(n,l,c,s/t.Config.spectrumMax,r/t.Config.spectrumMax,-.5))}this.spectrum[t.Config.spectrumControlPoints-1]>0&&(a+=.02*t.drawNoiseSpectrum(n,o+(i(t.Config.spectrumControlPoints)-o)*h,o,this.spectrum[t.Config.spectrumControlPoints-1]/t.Config.spectrumMax,0,-.5)),t.inverseRealFourierTransform(n,s),t.scaleElementsByFactor(n,5/(Math.sqrt(s)*Math.pow(a,.75))),n[s]=n[0],this.M=!0}return this.v}}t.SpectrumWave=a;class l{constructor(){this.harmonics=[],this.v=null,this.M=!1,this.reset()}reset(){for(let e=0;e<t.Config.harmonicsControlPoints;e++)this.harmonics[e]=0;this.harmonics[0]=t.Config.harmonicsMax,this.harmonics[3]=t.Config.harmonicsMax,this.harmonics[6]=t.Config.harmonicsMax,this.M=!1}markCustomWaveDirty(){this.M=!1}getCustomWave(){if(!this.M||null==this.v){let e=t.Config.harmonicsWavelength;const i=t.getDrumWave(0);null!=this.v&&this.v.length==e+1||(this.v=new Float32Array(e+1));const s=this.v;for(let t=0;t<e;t++)s[t]=0;const n=-.25;let o=1;for(let h=0;h<t.Config.harmonicsRendered;h++){const r=h+1;let a=h<t.Config.harmonicsControlPoints?this.harmonics[h]:this.harmonics[t.Config.harmonicsControlPoints-1];h>=t.Config.harmonicsControlPoints&&(a*=1-(h-t.Config.harmonicsControlPoints)/(t.Config.harmonicsRendered-t.Config.harmonicsControlPoints));const l=a/t.Config.harmonicsMax;let c=Math.pow(2,a-t.Config.harmonicsMax+1)*Math.sqrt(l);h<t.Config.harmonicsControlPoints&&(o+=c),c*=Math.pow(r,n),c*=i[h+589],s[e-r]=c}t.inverseRealFourierTransform(s,e);const h=1/Math.pow(o,.7);let r=0,a=0;for(let t=0;t<s.length;t++)r+=a,a=s[t]*h,s[t]=r;s[e]=s[0],this.M=!0}return this.v}}t.HarmonicsWave=l;class c{constructor(e){this.type=0,this.preset=0,this.chipWave=2,this.chipNoise=1,this.filterCutoff=6,this.filterResonance=0,this.filterEnvelope=1,this.transition=1,this.vibrato=0,this.interval=0,this.effects=0,this.chord=1,this.volume=0,this.pulseWidth=t.Config.pulseWidthRange-1,this.pulseEnvelope=1,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=1,this.operators=[],this.harmonicsWave=new l,this.drumsetEnvelopes=[],this.drumsetSpectrumWaves=[],this.spectrumWave=new a(e);for(let e=0;e<t.Config.operatorCount;e++)this.operators[e]=new r(e);for(let e=0;e<t.Config.drumCount;e++)this.drumsetEnvelopes[e]=t.Config.envelopes.dictionary["twang 2"].index,this.drumsetSpectrumWaves[e]=new a(!0)}setTypeAndReset(e,i){switch(this.type=e,this.preset=e,this.volume=0,e){case 0:this.chipWave=2,this.filterCutoff=6,this.filterResonance=0,this.filterEnvelope=t.Config.envelopes.dictionary.steady.index,this.transition=1,this.vibrato=0,this.interval=0,this.effects=1,this.chord=2;break;case 1:this.transition=1,this.vibrato=0,this.effects=1,this.chord=3,this.filterCutoff=10,this.filterResonance=0,this.filterEnvelope=1,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=t.Config.envelopes.dictionary.steady.index;for(let t=0;t<this.operators.length;t++)this.operators[t].reset(t);break;case 2:this.chipNoise=1,this.transition=1,this.effects=0,this.chord=2,this.filterCutoff=10,this.filterResonance=0,this.filterEnvelope=t.Config.envelopes.dictionary.steady.index;break;case 3:this.transition=1,this.effects=1,this.chord=0,this.filterCutoff=10,this.filterResonance=0,this.filterEnvelope=t.Config.envelopes.dictionary.steady.index,this.spectrumWave.reset(i);break;case 4:this.effects=0;for(let e=0;e<t.Config.drumCount;e++)this.drumsetEnvelopes[e]=t.Config.envelopes.dictionary["twang 2"].index,this.drumsetSpectrumWaves[e].reset(i);break;case 5:this.filterCutoff=10,this.filterResonance=0,this.filterEnvelope=t.Config.envelopes.dictionary.steady.index,this.transition=1,this.vibrato=0,this.interval=0,this.effects=1,this.chord=0,this.harmonicsWave.reset();break;case 6:this.filterCutoff=10,this.filterResonance=0,this.filterEnvelope=t.Config.envelopes.dictionary.steady.index,this.transition=1,this.vibrato=0,this.interval=0,this.effects=1,this.chord=2,this.pulseWidth=t.Config.pulseWidthRange-1,this.pulseEnvelope=t.Config.envelopes.dictionary["twang 2"].index;break;default:throw new Error("Unrecognized instrument type: "+e)}}toJsonObject(){const e={type:t.Config.instrumentTypeNames[this.type],volume:20*(5-this.volume),effects:t.Config.effectsNames[this.effects]};if(this.preset!=this.type&&(e.preset=this.preset),4!=this.type&&(e.transition=t.Config.transitions[this.transition].name,e.chord=this.getChord().name,e.filterCutoffHz=Math.round(t.Config.filterCutoffMaxHz*Math.pow(2,this.getFilterCutoffOctaves())),e.filterResonance=Math.round(100*this.filterResonance/(t.Config.filterResonanceRange-1)),e.filterEnvelope=this.getFilterEnvelope().name),2==this.type)e.wave=t.Config.chipNoises[this.chipNoise].name;else if(3==this.type){e.spectrum=[];for(let i=0;i<t.Config.spectrumControlPoints;i++)e.spectrum[i]=Math.round(100*this.spectrumWave.spectrum[i]/t.Config.spectrumMax)}else if(4==this.type){e.drums=[];for(let i=0;i<t.Config.drumCount;i++){const s=[];for(let e=0;e<t.Config.spectrumControlPoints;e++)s[e]=Math.round(100*this.drumsetSpectrumWaves[i].spectrum[e]/t.Config.spectrumMax);e.drums[i]={filterEnvelope:this.getDrumsetEnvelope(i).name,spectrum:s}}}else if(0==this.type)e.wave=t.Config.chipWaves[this.chipWave].name,e.interval=t.Config.intervals[this.interval].name,e.vibrato=t.Config.vibratos[this.vibrato].name;else if(6==this.type)e.pulseWidth=Math.round(50*Math.pow(.5,.5*(t.Config.pulseWidthRange-this.pulseWidth-1))*32)/32,e.pulseEnvelope=t.Config.envelopes[this.pulseEnvelope].name,e.vibrato=t.Config.vibratos[this.vibrato].name;else if(5==this.type){e.interval=t.Config.intervals[this.interval].name,e.vibrato=t.Config.vibratos[this.vibrato].name,e.harmonics=[];for(let i=0;i<t.Config.harmonicsControlPoints;i++)e.harmonics[i]=Math.round(100*this.harmonicsWave.harmonics[i]/t.Config.harmonicsMax)}else{if(1!=this.type)throw new Error("Unrecognized instrument type");{const i=[];for(const e of this.operators)i.push({frequency:t.Config.operatorFrequencies[e.frequency].name,amplitude:e.amplitude,envelope:t.Config.envelopes[e.envelope].name});e.vibrato=t.Config.vibratos[this.vibrato].name,e.algorithm=t.Config.algorithms[this.algorithm].name,e.feedbackType=t.Config.feedbacks[this.feedbackType].name,e.feedbackAmplitude=this.feedbackAmplitude,e.feedbackEnvelope=t.Config.envelopes[this.feedbackEnvelope].name,e.operators=i}}return e}fromJsonObject(e,i){void 0==e&&(e={});let s=t.Config.instrumentTypeNames.indexOf(e.type);-1==s&&(s=i?2:0),this.setTypeAndReset(s,i),void 0!=e.preset&&(this.preset=e.preset>>>0),void 0!=e.volume?this.volume=n(0,t.Config.volumeRange,Math.round(5-(0|e.volume)/20)):this.volume=0;const o={binary:0,sudden:1,smooth:2},h=e.transition||e.envelope;if(this.transition=void 0!=o[h]?o[h]:t.Config.transitions.findIndex(t=>t.name==h),-1==this.transition&&(this.transition=1),this.effects=t.Config.effectsNames.indexOf(e.effects),-1==this.effects&&(this.effects=2==this.type?0:1),void 0!=e.filterCutoffHz?this.filterCutoff=n(0,t.Config.filterCutoffRange,Math.round(t.Config.filterCutoffRange-1+2*Math.log((0|e.filterCutoffHz)/t.Config.filterCutoffMaxHz)/Math.LN2)):this.filterCutoff=0==this.type?6:10,void 0!=e.filterResonance?this.filterResonance=n(0,t.Config.filterResonanceRange,Math.round((t.Config.filterResonanceRange-1)*(0|e.filterResonance)/100)):this.filterResonance=0,this.filterEnvelope=t.Config.envelopes.findIndex(t=>t.name==e.filterEnvelope),-1==this.filterEnvelope&&(this.filterEnvelope=t.Config.envelopes.dictionary.steady.index),void 0!=e.filter){const t=[10,6,3,0,8,5,2],i=[1,1,1,1,18,19,20],s=["none","bright","medium","soft","decay bright","decay medium","decay soft"],n={"sustain sharp":1,"sustain medium":2,"sustain soft":3,"decay sharp":4};let o=void 0!=n[e.filter]?n[e.filter]:s.indexOf(e.filter);-1==o&&(o=0),this.filterCutoff=t[o],this.filterEnvelope=i[o],this.filterResonance=0}const r=["none","vibrato light","vibrato delayed","vibrato heavy"];if(2==this.type)this.chipNoise=t.Config.chipNoises.findIndex(t=>t.name==e.wave),-1==this.chipNoise&&(this.chipNoise=1),this.chord=t.Config.chords.findIndex(t=>t.name==e.chord),-1==this.chord&&(this.chord=2);else if(3==this.type){if(void 0!=e.spectrum)for(let i=0;i<t.Config.spectrumControlPoints;i++)this.spectrumWave.spectrum[i]=Math.max(0,Math.min(t.Config.spectrumMax,Math.round(t.Config.spectrumMax*+e.spectrum[i]/100)));this.chord=t.Config.chords.findIndex(t=>t.name==e.chord),-1==this.chord&&(this.chord=0)}else if(4==this.type){if(void 0!=e.drums)for(let i=0;i<t.Config.drumCount;i++){const s=e.drums[i];if(void 0!=s&&(void 0!=s.filterEnvelope&&(this.drumsetEnvelopes[i]=t.Config.envelopes.findIndex(t=>t.name==s.filterEnvelope),-1==this.drumsetEnvelopes[i]&&(this.drumsetEnvelopes[i]=t.Config.envelopes.dictionary["twang 2"].index)),void 0!=s.spectrum))for(let e=0;e<t.Config.spectrumControlPoints;e++)this.drumsetSpectrumWaves[i].spectrum[e]=Math.max(0,Math.min(t.Config.spectrumMax,Math.round(t.Config.spectrumMax*+s.spectrum[e]/100)))}}else if(5==this.type){if(void 0!=e.harmonics)for(let i=0;i<t.Config.harmonicsControlPoints;i++)this.harmonicsWave.harmonics[i]=Math.max(0,Math.min(t.Config.harmonicsMax,Math.round(t.Config.harmonicsMax*+e.harmonics[i]/100)));void 0!=e.interval&&(this.interval=t.Config.intervals.findIndex(t=>t.name==e.interval),-1==this.interval&&(this.interval=0)),void 0!=e.vibrato&&(this.vibrato=t.Config.vibratos.findIndex(t=>t.name==e.vibrato),-1==this.vibrato&&(this.vibrato=0)),this.chord=t.Config.chords.findIndex(t=>t.name==e.chord),-1==this.chord&&(this.chord=0)}else if(6==this.type)void 0!=e.pulseWidth?this.pulseWidth=n(0,t.Config.pulseWidthRange,Math.round(Math.log(+e.pulseWidth/50)/Math.LN2/.5-1+8)):this.pulseWidth=t.Config.pulseWidthRange-1,void 0!=e.pulseEnvelope&&(this.pulseEnvelope=t.Config.envelopes.findIndex(t=>t.name==e.pulseEnvelope),-1==this.pulseEnvelope&&(this.pulseEnvelope=t.Config.envelopes.dictionary.steady.index)),void 0!=e.vibrato&&(this.vibrato=t.Config.vibratos.findIndex(t=>t.name==e.vibrato),-1==this.vibrato&&(this.vibrato=0)),this.chord=t.Config.chords.findIndex(t=>t.name==e.chord),-1==this.chord&&(this.chord=0);else if(0==this.type){const i={triangle:1,square:2,"pulse wide":3,"pulse narrow":4,sawtooth:5,"double saw":6,"double pulse":7,spiky:8,plateau:0};if(this.chipWave=void 0!=i[e.wave]?i[e.wave]:t.Config.chipWaves.findIndex(t=>t.name==e.wave),-1==this.chipWave&&(this.chipWave=1),void 0!=e.interval)this.interval=t.Config.intervals.findIndex(t=>t.name==e.interval),-1==this.interval&&(this.interval=0);else if(void 0!=e.chorus){const i={fifths:5,octaves:6};this.interval=void 0!=i[e.chorus]?i[e.chorus]:t.Config.intervals.findIndex(t=>t.name==e.chorus),-1==this.interval&&(this.interval=0)}void 0!=e.vibrato?(this.vibrato=t.Config.vibratos.findIndex(t=>t.name==e.vibrato),-1==this.vibrato&&(this.vibrato=0)):void 0!=e.effect&&(this.vibrato=r.indexOf(e.effect),-1==this.vibrato&&(this.vibrato=0)),this.chord=t.Config.chords.findIndex(t=>t.name==e.chord),-1==this.chord&&(this.chord=2),"custom harmony"==e.chorus&&(this.interval=2,this.chord=3)}else{if(1!=this.type)throw new Error("Unrecognized instrument type.");{void 0!=e.vibrato?(this.vibrato=t.Config.vibratos.findIndex(t=>t.name==e.vibrato),-1==this.vibrato&&(this.vibrato=0)):void 0!=e.effect&&(this.vibrato=r.indexOf(e.effect),-1==this.vibrato&&(this.vibrato=0)),this.chord=t.Config.chords.findIndex(t=>t.name==e.chord),-1==this.chord&&(this.chord=3),this.algorithm=t.Config.algorithms.findIndex(t=>t.name==e.algorithm),-1==this.algorithm&&(this.algorithm=0),this.feedbackType=t.Config.feedbacks.findIndex(t=>t.name==e.feedbackType),-1==this.feedbackType&&(this.feedbackType=0),void 0!=e.feedbackAmplitude?this.feedbackAmplitude=n(0,t.Config.operatorAmplitudeMax+1,0|e.feedbackAmplitude):this.feedbackAmplitude=0;const i={"pluck 1":6,"pluck 2":7,"pluck 3":8};this.feedbackEnvelope=void 0!=i[e.feedbackEnvelope]?i[e.feedbackEnvelope]:t.Config.envelopes.findIndex(t=>t.name==e.feedbackEnvelope),-1==this.feedbackEnvelope&&(this.feedbackEnvelope=0);for(let s=0;s<t.Config.operatorCount;s++){const o=this.operators[s];let h=void 0;e.operators&&(h=e.operators[s]),void 0==h&&(h={}),o.frequency=t.Config.operatorFrequencies.findIndex(t=>t.name==h.frequency),-1==o.frequency&&(o.frequency=0),void 0!=h.amplitude?o.amplitude=n(0,t.Config.operatorAmplitudeMax+1,0|h.amplitude):o.amplitude=0,o.envelope=void 0!=i[h.envelope]?i[h.envelope]:t.Config.envelopes.findIndex(t=>t.name==h.envelope),-1==o.envelope&&(o.envelope=0)}}}}static frequencyFromPitch(t){return 440*Math.pow(2,(t-69)/12)}static drumsetIndexReferenceDelta(e){return c.frequencyFromPitch(t.Config.spectrumBasePitch+6*e)/44100}static k(t){return 15+Math.log(c.drumsetIndexReferenceDelta(t))/Math.LN2}warmUp(){if(2==this.type)t.getDrumWave(this.chipNoise);else if(5==this.type)this.harmonicsWave.getCustomWave();else if(3==this.type)this.spectrumWave.getCustomWave(8);else if(4==this.type)for(let e=0;e<t.Config.drumCount;e++)this.drumsetSpectrumWaves[e].getCustomWave(c.k(e))}getDrumWave(){if(2==this.type)return t.getDrumWave(this.chipNoise);if(3==this.type)return this.spectrumWave.getCustomWave(8);throw new Error("Unhandled instrument type in getDrumWave")}getDrumsetWave(t){if(4==this.type)return this.drumsetSpectrumWaves[t].getCustomWave(c.k(t));throw new Error("Unhandled instrument type in getDrumWave")}getTransition(){return 4==this.type?t.Config.transitions.dictionary["hard fade"]:t.Config.transitions[this.transition]}getChord(){return 4==this.type?t.Config.chords.dictionary.harmony:t.Config.chords[this.chord]}getFilterCutoffOctaves(){return 4==this.type?0:.5*(this.filterCutoff-(t.Config.filterCutoffRange-1))}getFilterIsFirstOrder(){return 4!=this.type&&0==this.filterResonance}getFilterResonance(){return 4==this.type?1:this.filterResonance}getFilterEnvelope(){if(4==this.type)throw new Error("Can't getFilterEnvelope() for drumset.");return t.Config.envelopes[this.filterEnvelope]}getDrumsetEnvelope(e){if(4!=this.type)throw new Error("Can't getDrumsetEnvelope() for non-drumset.");return t.Config.envelopes[this.drumsetEnvelopes[e]]}}t.Instrument=c;class f{constructor(){this.octave=0,this.instruments=[],this.patterns=[],this.bars=[]}}t.Channel=f;class u{constructor(t){this.channels=[],void 0!=t?this.fromBase64String(t):this.initToDefault(!0)}getChannelCount(){return this.pitchChannelCount+this.noiseChannelCount}getChannelIsNoise(t){return t>=this.pitchChannelCount}initToDefault(t=!0){if(this.scale=0,this.key=0,this.loopStart=0,this.loopLength=4,this.tempo=150,this.reverb=0,this.beatsPerBar=8,this.barCount=16,this.patternsPerChannel=8,this.rhythm=1,this.instrumentsPerChannel=1,t){this.pitchChannelCount=3,this.noiseChannelCount=1;for(let t=0;t<this.getChannelCount();t++){this.channels.length<=t&&(this.channels[t]=new f);const e=this.channels[t];e.octave=3-t;for(let t=0;t<this.patternsPerChannel;t++)e.patterns.length<=t?e.patterns[t]=new h:e.patterns[t].reset();e.patterns.length=this.patternsPerChannel;const i=t>=this.pitchChannelCount;for(let t=0;t<this.instrumentsPerChannel;t++)e.instruments.length<=t&&(e.instruments[t]=new c(i)),e.instruments[t].setTypeAndReset(i?2:0,i);e.instruments.length=this.instrumentsPerChannel;for(let t=0;t<this.barCount;t++)e.bars[t]=1;e.bars.length=this.barCount}this.channels.length=this.getChannelCount()}}toBase64String(){let e,s=[];const n=u.q;s.push(n[u.N]),s.push(110,n[this.pitchChannelCount],n[this.noiseChannelCount]),s.push(115,n[this.scale]),s.push(107,n[this.key]),s.push(108,n[this.loopStart>>6],n[63&this.loopStart]),s.push(101,n[this.loopLength-1>>6],n[this.loopLength-1&63]),s.push(116,n[this.tempo>>6],n[63&this.tempo]),s.push(109,n[this.reverb]),s.push(97,n[this.beatsPerBar-1]),s.push(103,n[this.barCount-1>>6],n[this.barCount-1&63]),s.push(106,n[this.patternsPerChannel-1]),s.push(105,n[this.instrumentsPerChannel-1]),s.push(114,n[this.rhythm]),s.push(111);for(let t=0;t<this.getChannelCount();t++)s.push(n[this.channels[t].octave]);for(let e=0;e<this.getChannelCount();e++)for(let o=0;o<this.instrumentsPerChannel;o++){const h=this.channels[e].instruments[o];if(s.push(84,n[h.type]),s.push(118,n[h.volume]),s.push(117,n[h.preset>>6],n[63&h.preset]),s.push(113,n[h.effects]),4!=h.type&&(s.push(100,n[h.transition]),s.push(102,n[h.filterCutoff]),s.push(121,n[h.filterResonance]),s.push(122,n[h.filterEnvelope]),s.push(67,n[h.chord])),0==h.type)s.push(119,n[h.chipWave]),s.push(99,n[h.vibrato]),s.push(104,n[h.interval]);else if(1==h.type){s.push(99,n[h.vibrato]),s.push(65,n[h.algorithm]),s.push(70,n[h.feedbackType]),s.push(66,n[h.feedbackAmplitude]),s.push(86,n[h.feedbackEnvelope]),s.push(81);for(let e=0;e<t.Config.operatorCount;e++)s.push(n[h.operators[e].frequency]);s.push(80);for(let e=0;e<t.Config.operatorCount;e++)s.push(n[h.operators[e].amplitude]);s.push(69);for(let e=0;e<t.Config.operatorCount;e++)s.push(n[h.operators[e].envelope])}else if(2==h.type)s.push(119,n[h.chipNoise]);else if(3==h.type){s.push(83);const e=new i;for(let i=0;i<t.Config.spectrumControlPoints;i++)e.write(t.Config.spectrumControlPointBits,h.spectrumWave.spectrum[i]);e.encodeBase64(n,s)}else if(4==h.type){s.push(122);for(let e=0;e<t.Config.drumCount;e++)s.push(n[h.drumsetEnvelopes[e]]);s.push(83);const e=new i;for(let i=0;i<t.Config.drumCount;i++)for(let s=0;s<t.Config.spectrumControlPoints;s++)e.write(t.Config.spectrumControlPointBits,h.drumsetSpectrumWaves[i].spectrum[s]);e.encodeBase64(n,s)}else if(5==h.type){s.push(99,n[h.vibrato]),s.push(104,n[h.interval]),s.push(72);const e=new i;for(let i=0;i<t.Config.harmonicsControlPoints;i++)e.write(t.Config.harmonicsControlPointBits,h.harmonicsWave.harmonics[i]);e.encodeBase64(n,s)}else{if(6!=h.type)throw new Error("Unknown instrument type.");s.push(99,n[h.vibrato]),s.push(87,n[h.pulseWidth],n[h.pulseEnvelope])}}s.push(98),e=new i;let o=0;for(;1<<o<this.patternsPerChannel+1;)o++;for(let t=0;t<this.getChannelCount();t++)for(let i=0;i<this.barCount;i++)e.write(o,this.channels[t].bars[i]);e.encodeBase64(n,s),s.push(112),e=new i;let h=0;for(;1<<h<this.instrumentsPerChannel;)h++;for(let s=0;s<this.getChannelCount();s++){const o=this.getChannelIsNoise(s),r=o?0:12*this.channels[s].octave;let a=(o?4:12)+r;const l=o?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],c=[];for(let t=0;t<l.length;t++)l[t]+=r;for(const o of this.channels[s].patterns)if(e.write(h,o.instrument),o.notes.length>0){e.write(1,1);let s=0;for(const t of o.notes){t.start>s&&(e.write(2,0),e.writePartDuration(t.start-s));const o=new i;for(let e=1;e<t.pitches.length;e++)o.write(1,1);t.pitches.length<4&&o.write(1,0),o.writePinCount(t.pins.length-1),o.write(2,t.pins[0].volume);let h=0,r=t.pitches[0],f=r;const u=[];for(let e=1;e<t.pins.length;e++){const i=t.pins[e],s=r+i.interval;f!=s?(o.write(1,1),u.push(s),f=s):o.write(1,0),o.writePartDuration(i.time-h),h=i.time,o.write(2,i.volume)}const d=String.fromCharCode.apply(null,o.encodeBase64(n,[])),m=c.indexOf(d);-1==m?(e.write(2,1),e.concat(o)):(e.write(1,1),e.writeLongTail(0,0,m),c.splice(m,1)),c.unshift(d),c.length>10&&c.pop();const p=t.pitches.concat(u);for(let i=0;i<p.length;i++){const s=p[i],n=l.indexOf(s);if(-1==n){let t=0,i=a;if(i<s)for(;i!=s;)i++,-1==l.indexOf(i)&&t++;else for(;i!=s;)i--,-1==l.indexOf(i)&&t--;e.write(1,0),e.writePitchInterval(t)}else e.write(1,1),e.write(3,n),l.splice(n,1);l.unshift(s),l.length>8&&l.pop(),a=i==t.pitches.length-1?t.pitches[0]:s}s=t.end}s<this.beatsPerBar*t.Config.partsPerBeat&&(e.write(2,0),e.writePartDuration(this.beatsPerBar*t.Config.partsPerBeat-s))}else e.write(1,0)}let r=e.lengthBase64(),a=[];for(;r>0;)a.unshift(n[63&r]),r>>=6;s.push(n[a.length]),Array.prototype.push.apply(s,a),e.encodeBase64(n,s);if(s.length<64e3)return String.fromCharCode.apply(null,s);{let t="";for(let e=0;e<s.length;e+=64e3)t+=String.fromCharCode.apply(null,s.slice(e,e+64e3));return t}}fromBase64String(i){if(null==i||""==i)return void this.initToDefault(!0);let r=0;for(;i.charCodeAt(r)<=32;)r++;if(35==i.charCodeAt(r)&&r++,123==i.charCodeAt(r))return void this.fromJsonObject(JSON.parse(0==r?i:i.substring(r)));const a=u.R[i.charCodeAt(r++)];if(-1==a||a>u.N||a<u.P)return;const l=a<3,d=a<4,m=a<5,p=a<6,y=a<7,g=u.R;if(this.initToDefault(p),l){for(const t of this.channels)t.instruments[0].transition=0;this.channels[3].instruments[0].chipNoise=0}let v=0,b=-1;for(;r<i.length;){const a=i.charCodeAt(r++);let u;if(110==a){this.pitchChannelCount=g[i.charCodeAt(r++)],this.noiseChannelCount=g[i.charCodeAt(r++)],this.pitchChannelCount=n(t.Config.pitchChannelCountMin,t.Config.pitchChannelCountMax+1,this.pitchChannelCount),this.noiseChannelCount=n(t.Config.noiseChannelCountMin,t.Config.noiseChannelCountMax+1,this.noiseChannelCount);for(let t=this.channels.length;t<this.getChannelCount();t++)this.channels[t]=new f;this.channels.length=this.getChannelCount()}else if(115==a)this.scale=g[i.charCodeAt(r++)],l&&10==this.scale&&(this.scale=11);else if(107==a)this.key=n(0,t.Config.keys.length,y?11-g[i.charCodeAt(r++)]:g[i.charCodeAt(r++)]);else if(108==a)this.loopStart=m?g[i.charCodeAt(r++)]:(g[i.charCodeAt(r++)]<<6)+g[i.charCodeAt(r++)];else if(101==a)this.loopLength=m?g[i.charCodeAt(r++)]:(g[i.charCodeAt(r++)]<<6)+g[i.charCodeAt(r++)]+1;else if(116==a)this.tempo=d?[95,120,151,190][g[i.charCodeAt(r++)]]:y?[88,95,103,111,120,130,140,151,163,176,190,206,222,240,259][g[i.charCodeAt(r++)]]:g[i.charCodeAt(r++)]<<6|g[i.charCodeAt(r++)],this.tempo=n(t.Config.tempoMin,t.Config.tempoMax+1,this.tempo);else if(109==a)this.reverb=g[i.charCodeAt(r++)],this.reverb=n(0,t.Config.reverbRange,this.reverb);else if(97==a)this.beatsPerBar=l?[6,7,8,9,10][g[i.charCodeAt(r++)]]:g[i.charCodeAt(r++)]+1,this.beatsPerBar=Math.max(t.Config.beatsPerBarMin,Math.min(t.Config.beatsPerBarMax,this.beatsPerBar));else if(103==a){this.barCount=(g[i.charCodeAt(r++)]<<6)+g[i.charCodeAt(r++)]+1,this.barCount=Math.max(t.Config.barCountMin,Math.min(t.Config.barCountMax,this.barCount));for(let t=0;t<this.getChannelCount();t++){for(let e=this.channels[t].bars.length;e<this.barCount;e++)this.channels[t].bars[e]=1;this.channels[t].bars.length=this.barCount}}else if(106==a){this.patternsPerChannel=g[i.charCodeAt(r++)]+1,this.patternsPerChannel=Math.max(t.Config.patternsPerChannelMin,Math.min(t.Config.patternsPerChannelMax,this.patternsPerChannel));for(let t=0;t<this.getChannelCount();t++){for(let e=this.channels[t].patterns.length;e<this.patternsPerChannel;e++)this.channels[t].patterns[e]=new h;this.channels[t].patterns.length=this.patternsPerChannel}}else if(105==a){this.instrumentsPerChannel=g[i.charCodeAt(r++)]+1,this.instrumentsPerChannel=Math.max(t.Config.instrumentsPerChannelMin,Math.min(t.Config.instrumentsPerChannelMax,this.instrumentsPerChannel));for(let t=0;t<this.getChannelCount();t++){const e=t>=this.pitchChannelCount;for(let i=this.channels[t].instruments.length;i<this.instrumentsPerChannel;i++)this.channels[t].instruments[i]=new c(e);if(this.channels[t].instruments.length=this.instrumentsPerChannel,p)for(let i=0;i<this.instrumentsPerChannel;i++)this.channels[t].instruments[i].setTypeAndReset(e?2:0,e)}}else if(114==a)this.rhythm=g[i.charCodeAt(r++)];else if(111==a)if(l)u=g[i.charCodeAt(r++)],this.channels[u].octave=n(0,t.Config.scrollableOctaves+1,g[i.charCodeAt(r++)]);else for(u=0;u<this.getChannelCount();u++)this.channels[u].octave=n(0,t.Config.scrollableOctaves+1,g[i.charCodeAt(r++)]);else if(84==a){++b>=this.instrumentsPerChannel&&(v++,b=0);const t=this.channels[v].instruments[b],e=n(0,7,g[i.charCodeAt(r++)]);t.setTypeAndReset(e,v>=this.pitchChannelCount)}else if(117==a){const t=g[i.charCodeAt(r++)]<<6|g[i.charCodeAt(r++)];this.channels[v].instruments[b].preset=t}else if(119==a)if(l){const e=[1,2,3,4,5,6,7,8,0];u=g[i.charCodeAt(r++)],this.channels[u].instruments[0].chipWave=n(0,t.Config.chipWaves.length,0|e[g[i.charCodeAt(r++)]])}else if(p){const e=[1,2,3,4,5,6,7,8,0];for(u=0;u<this.getChannelCount();u++)for(let s=0;s<this.instrumentsPerChannel;s++)u>=this.pitchChannelCount?this.channels[u].instruments[s].chipNoise=n(0,t.Config.chipNoises.length,g[i.charCodeAt(r++)]):this.channels[u].instruments[s].chipWave=n(0,t.Config.chipWaves.length,0|e[g[i.charCodeAt(r++)]])}else if(y){const e=[1,2,3,4,5,6,7,8,0];v>=this.pitchChannelCount?this.channels[v].instruments[b].chipNoise=n(0,t.Config.chipNoises.length,g[i.charCodeAt(r++)]):this.channels[v].instruments[b].chipWave=n(0,t.Config.chipWaves.length,0|e[g[i.charCodeAt(r++)]])}else v>=this.pitchChannelCount?this.channels[v].instruments[b].chipNoise=n(0,t.Config.chipNoises.length,g[i.charCodeAt(r++)]):this.channels[v].instruments[b].chipWave=n(0,t.Config.chipWaves.length,g[i.charCodeAt(r++)]);else if(102==a)if(y){const t=[10,6,3,0,8,5,2],e=[1,1,1,1,18,19,20],s=["none","bright","medium","soft","decay bright","decay medium","decay soft"];if(l){u=g[i.charCodeAt(r++)];const o=this.channels[u].instruments[0],h=[1,3,4,5][n(0,s.length,g[i.charCodeAt(r++)])];o.filterCutoff=t[h],o.filterEnvelope=e[h],o.filterResonance=0}else if(p)for(u=0;u<this.getChannelCount();u++)for(let o=0;o<this.instrumentsPerChannel;o++){const h=this.channels[u].instruments[o];if(u<this.pitchChannelCount){const o=n(0,s.length,g[i.charCodeAt(r++)]+1);h.filterCutoff=t[o],h.filterEnvelope=e[o],h.filterResonance=0}else h.filterCutoff=10,h.filterEnvelope=1,h.filterResonance=0}else{const o=n(0,s.length,g[i.charCodeAt(r++)]),h=this.channels[v].instruments[b];h.filterCutoff=t[o],h.filterEnvelope=e[o],h.filterResonance=0}}else{this.channels[v].instruments[b].filterCutoff=n(0,t.Config.filterCutoffRange,g[i.charCodeAt(r++)])}else if(121==a)this.channels[v].instruments[b].filterResonance=n(0,t.Config.filterResonanceRange,g[i.charCodeAt(r++)]);else if(122==a){const e=this.channels[v].instruments[b];if(4==e.type)for(let s=0;s<t.Config.drumCount;s++)e.drumsetEnvelopes[s]=n(0,t.Config.envelopes.length,g[i.charCodeAt(r++)]);else e.filterEnvelope=n(0,t.Config.envelopes.length,g[i.charCodeAt(r++)])}else if(87==a){const e=this.channels[v].instruments[b];e.pulseWidth=n(0,t.Config.pulseWidthRange,g[i.charCodeAt(r++)]),e.pulseEnvelope=n(0,t.Config.envelopes.length,g[i.charCodeAt(r++)])}else if(100==a)if(l)u=g[i.charCodeAt(r++)],this.channels[u].instruments[0].transition=n(0,t.Config.transitions.length,g[i.charCodeAt(r++)]);else if(p)for(u=0;u<this.getChannelCount();u++)for(let e=0;e<this.instrumentsPerChannel;e++)this.channels[u].instruments[e].transition=n(0,t.Config.transitions.length,g[i.charCodeAt(r++)]);else this.channels[v].instruments[b].transition=n(0,t.Config.transitions.length,g[i.charCodeAt(r++)]);else if(99==a)if(l){const t=[0,3,2,0],e=[1,1,1,13];u=g[i.charCodeAt(r++)];const s=n(0,t.length,g[i.charCodeAt(r++)]),o=this.channels[u].instruments[0];o.vibrato=t[s],o.filterEnvelope=1==o.filterEnvelope?e[s]:o.filterEnvelope}else if(p){const t=[0,1,2,3,0,0],e=[1,1,1,1,16,13];for(u=0;u<this.getChannelCount();u++)for(let s=0;s<this.instrumentsPerChannel;s++){const o=n(0,t.length,g[i.charCodeAt(r++)]),h=this.channels[u].instruments[s];h.vibrato=t[o],h.filterEnvelope=1==h.filterEnvelope?e[o]:h.filterEnvelope}}else if(y){const t=[0,1,2,3,0,0],e=[1,1,1,1,16,13],s=n(0,t.length,g[i.charCodeAt(r++)]),o=this.channels[v].instruments[b];o.vibrato=t[s],o.filterEnvelope=1==o.filterEnvelope?e[s]:o.filterEnvelope}else{const e=n(0,t.Config.vibratos.length,g[i.charCodeAt(r++)]);this.channels[v].instruments[b].vibrato=e}else if(104==a)if(l)u=g[i.charCodeAt(r++)],this.channels[u].instruments[0].interval=n(0,t.Config.intervals.length,g[i.charCodeAt(r++)]);else if(p)for(u=0;u<this.getChannelCount();u++)for(let e=0;e<this.instrumentsPerChannel;e++){const s=g[i.charCodeAt(r++)];let o=n(0,t.Config.intervals.length,s);8==s&&(o=2,this.channels[u].instruments[e].chord=3),this.channels[u].instruments[e].interval=o}else if(y){const e=g[i.charCodeAt(r++)];let s=n(0,t.Config.intervals.length,e);8==e&&(s=2,this.channels[v].instruments[b].chord=3),this.channels[v].instruments[b].interval=s}else this.channels[v].instruments[b].interval=n(0,t.Config.intervals.length,g[i.charCodeAt(r++)]);else if(67==a)this.channels[v].instruments[b].chord=n(0,t.Config.chords.length,g[i.charCodeAt(r++)]);else if(113==a)this.channels[v].instruments[b].effects=n(0,t.Config.effectsNames.length,g[i.charCodeAt(r++)]);else if(118==a)if(l){u=g[i.charCodeAt(r++)];const e=this.channels[u].instruments[0];e.volume=n(0,t.Config.volumeRange,g[i.charCodeAt(r++)]),5==e.volume&&(e.volume=t.Config.volumeRange-1)}else if(p)for(u=0;u<this.getChannelCount();u++)for(let e=0;e<this.instrumentsPerChannel;e++){const s=this.channels[u].instruments[e];s.volume=n(0,t.Config.volumeRange,g[i.charCodeAt(r++)]),5==s.volume&&(s.volume=t.Config.volumeRange-1)}else if(y){const e=this.channels[v].instruments[b];e.volume=n(0,t.Config.volumeRange,g[i.charCodeAt(r++)]),5==e.volume&&(e.volume=t.Config.volumeRange-1)}else{this.channels[v].instruments[b].volume=n(0,t.Config.volumeRange,g[i.charCodeAt(r++)])}else if(65==a)this.channels[v].instruments[b].algorithm=n(0,t.Config.algorithms.length,g[i.charCodeAt(r++)]);else if(70==a)this.channels[v].instruments[b].feedbackType=n(0,t.Config.feedbacks.length,g[i.charCodeAt(r++)]);else if(66==a)this.channels[v].instruments[b].feedbackAmplitude=n(0,t.Config.operatorAmplitudeMax+1,g[i.charCodeAt(r++)]);else if(86==a)this.channels[v].instruments[b].feedbackEnvelope=n(0,t.Config.envelopes.length,g[i.charCodeAt(r++)]);else if(81==a)for(let e=0;e<t.Config.operatorCount;e++)this.channels[v].instruments[b].operators[e].frequency=n(0,t.Config.operatorFrequencies.length,g[i.charCodeAt(r++)]);else if(80==a)for(let e=0;e<t.Config.operatorCount;e++)this.channels[v].instruments[b].operators[e].amplitude=n(0,t.Config.operatorAmplitudeMax+1,g[i.charCodeAt(r++)]);else if(69==a)for(let e=0;e<t.Config.operatorCount;e++)this.channels[v].instruments[b].operators[e].envelope=n(0,t.Config.envelopes.length,g[i.charCodeAt(r++)]);else if(83==a){const s=this.channels[v].instruments[b];if(3==s.type){const n=Math.ceil(t.Config.spectrumControlPoints*t.Config.spectrumControlPointBits/6),o=new e(g,i,r,r+n);for(let e=0;e<t.Config.spectrumControlPoints;e++)s.spectrumWave.spectrum[e]=o.read(t.Config.spectrumControlPointBits);s.spectrumWave.markCustomWaveDirty(),r+=n}else{if(4!=s.type)throw new Error("Unhandled instrument type for spectrum song tag code.");{const n=Math.ceil(t.Config.drumCount*t.Config.spectrumControlPoints*t.Config.spectrumControlPointBits/6),o=new e(g,i,r,r+n);for(let e=0;e<t.Config.drumCount;e++){for(let i=0;i<t.Config.spectrumControlPoints;i++)s.drumsetSpectrumWaves[e].spectrum[i]=o.read(t.Config.spectrumControlPointBits);s.drumsetSpectrumWaves[e].markCustomWaveDirty()}r+=n}}}else if(72==a){const s=this.channels[v].instruments[b],n=Math.ceil(t.Config.harmonicsControlPoints*t.Config.harmonicsControlPointBits/6),o=new e(g,i,r,r+n);for(let e=0;e<t.Config.harmonicsControlPoints;e++)s.harmonicsWave.harmonics[e]=o.read(t.Config.harmonicsControlPointBits);s.harmonicsWave.markCustomWaveDirty(),r+=n}else if(98==a){let t;if(l){u=g[i.charCodeAt(r++)];const s=g[i.charCodeAt(r++)];t=Math.ceil(.5*s);const n=new e(g,i,r,r+t);for(let t=0;t<s;t++)this.channels[u].bars[t]=n.read(3)+1}else if(m){let s=0;for(;1<<s<this.patternsPerChannel;)s++;t=Math.ceil(this.getChannelCount()*this.barCount*s/6);const n=new e(g,i,r,r+t);for(u=0;u<this.getChannelCount();u++)for(let t=0;t<this.barCount;t++)this.channels[u].bars[t]=n.read(s)+1}else{let s=0;for(;1<<s<this.patternsPerChannel+1;)s++;t=Math.ceil(this.getChannelCount()*this.barCount*s/6);const n=new e(g,i,r,r+t);for(u=0;u<this.getChannelCount();u++)for(let t=0;t<this.barCount;t++)this.channels[u].bars[t]=n.read(s)}r+=t}else if(112==a){let n=0;if(l)u=g[i.charCodeAt(r++)],r++,n=g[i.charCodeAt(r++)],n<<=6,n+=g[i.charCodeAt(r++)];else{u=0;let t=g[i.charCodeAt(r++)];for(;t>0;)n<<=6,n+=g[i.charCodeAt(r++)],t--}const h=new e(g,i,r,r+n);r+=n;let a=0;for(;1<<a<this.instrumentsPerChannel;)a++;for(;;){const e=this.getChannelIsNoise(u),i=e?0:12*this.channels[u].octave;let n=null,r=null,c=(e?4:12)+i;const f=e?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],d=[];for(let t=0;t<f.length;t++)f[t]+=i;for(let e=0;e<this.patternsPerChannel;e++){const i=this.channels[u].patterns[e];if(i.reset(),i.instrument=h.read(a),!l&&0==h.read(1))continue;let m=0;const p=i.notes;for(;m<this.beatsPerBar*t.Config.partsPerBeat;){const e=1==h.read(1);let i=!1,a=0;if(e?a=h.readLongTail(0,0):i=1==h.read(1),e||i){let i,l,u;if(e)i=d[a],d.splice(a,1);else{for((i={}).pitchCount=1;i.pitchCount<4&&1==h.read(1);)i.pitchCount++;i.pinCount=h.readPinCount(),i.initialVolume=h.read(2),i.pins=[],i.length=0,i.bendCount=0;for(let e=0;e<i.pinCount;e++)(l={}).pitchBend=1==h.read(1),l.pitchBend&&i.bendCount++,i.length+=y?h.readLegacyPartDuration()*t.Config.partsPerBeat/t.Config.rhythms[this.rhythm].stepsPerBeat:h.readPartDuration(),l.time=i.length,l.volume=h.read(2),i.pins.push(l)}d.unshift(i),d.length>10&&d.pop(),(n=new o(0,m,m+i.length,i.initialVolume)).pitches=[],n.pins.length=1;const g=[];for(let t=0;t<i.pitchCount+i.bendCount;t++){if(1==h.read(1)){const t=h.read(3);u=f[t],f.splice(t,1)}else{const t=h.readPitchInterval();u=c;let e=t;for(;e>0;){for(u++;-1!=f.indexOf(u);)u++;e--}for(;e<0;){for(u--;-1!=f.indexOf(u);)u--;e++}}f.unshift(u),f.length>8&&f.pop(),t<i.pitchCount?n.pitches.push(u):g.push(u),c=t==i.pitchCount-1?n.pitches[0]:u}g.unshift(n.pitches[0]);for(const t of i.pins)t.pitchBend&&g.shift(),r=s(g[0]-n.pitches[0],t.time,t.volume),n.pins.push(r);m=n.end,p.push(n)}else{m+=y?h.readLegacyPartDuration()*t.Config.partsPerBeat/t.Config.rhythms[this.rhythm].stepsPerBeat:h.readPartDuration()}}}if(l)break;if(++u>=this.getChannelCount())break}}}}toJsonObject(e=!0,i=1,s=!0){const n=[];for(let o=0;o<this.getChannelCount();o++){const h=[],r=this.getChannelIsNoise(o);for(let t=0;t<this.instrumentsPerChannel;t++)h.push(this.channels[o].instruments[t].toJsonObject());const a=[];for(const e of this.channels[o].patterns){const i=[];for(const s of e.notes){const e=[];for(const i of s.pins)e.push({tick:(i.time+s.start)*t.Config.rhythms[this.rhythm].stepsPerBeat/t.Config.partsPerBeat,pitchBend:i.interval,volume:Math.round(100*i.volume/3)});i.push({pitches:s.pitches,points:e})}a.push({instrument:e.instrument+1,notes:i})}const l=[];if(e)for(let t=0;t<this.loopStart;t++)l.push(this.channels[o].bars[t]);for(let t=0;t<i;t++)for(let t=this.loopStart;t<this.loopStart+this.loopLength;t++)l.push(this.channels[o].bars[t]);if(s)for(let t=this.loopStart+this.loopLength;t<this.barCount;t++)l.push(this.channels[o].bars[t]);n.push({type:r?"drum":"pitch",octaveScrollBar:this.channels[o].octave,instruments:h,patterns:a,sequence:l})}return{format:u.S,version:u.N,scale:t.Config.scales[this.scale].name,key:t.Config.keys[this.key].name,introBars:this.loopStart,loopBars:this.loopLength,beatsPerBar:this.beatsPerBar,ticksPerBeat:t.Config.rhythms[this.rhythm].stepsPerBeat,beatsPerMinute:this.tempo,reverb:this.reverb,channels:n}}fromJsonObject(e){if(this.initToDefault(!0),!e)return;if(this.scale=11,void 0!=e.scale){const i={"romani :)":8,"romani :(":9},s=void 0!=i[e.scale]?i[e.scale]:t.Config.scales.findIndex(t=>t.name==e.scale);-1!=s&&(this.scale=s)}if(void 0!=e.key)if("number"==typeof e.key)this.key=(e.key+1200>>>0)%t.Config.keys.length;else if("string"==typeof e.key){const t=e.key,i=t.charAt(0).toUpperCase(),s=t.charAt(1).toLowerCase();let n={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[i];const o={"#":1,"♯":1,b:-1,"♭":-1}[s];void 0!=n&&(void 0!=o&&(n+=o),n<0&&(n+=12),n%=12,this.key=n)}void 0!=e.beatsPerMinute&&(this.tempo=n(t.Config.tempoMin,t.Config.tempoMax+1,0|e.beatsPerMinute)),void 0!=e.reverb&&(this.reverb=n(0,t.Config.reverbRange,0|e.reverb)),void 0!=e.beatsPerBar&&(this.beatsPerBar=Math.max(t.Config.beatsPerBarMin,Math.min(t.Config.beatsPerBarMax,0|e.beatsPerBar)));let i=4;void 0!=e.ticksPerBeat&&(i=0|e.ticksPerBeat||4,this.rhythm=t.Config.rhythms.findIndex(t=>t.stepsPerBeat==i),-1==this.rhythm&&(this.rhythm=1));let r=1,a=1,l=1;if(e.channels)for(const t of e.channels)t.instruments&&(r=Math.max(r,0|t.instruments.length)),t.patterns&&(a=Math.max(a,0|t.patterns.length)),t.sequence&&(l=Math.max(l,0|t.sequence.length));this.instrumentsPerChannel=r,this.patternsPerChannel=a,this.barCount=l,void 0!=e.introBars&&(this.loopStart=n(0,this.barCount,0|e.introBars)),void 0!=e.loopBars&&(this.loopLength=n(1,this.barCount-this.loopStart+1,0|e.loopBars));const u=[],d=[];if(e.channels)for(let r=0;r<e.channels.length;r++){let a=e.channels[r];const l=new f;let m=!1;(m=void 0!=a.type?"drum"==a.type:r>=3)?d.push(l):u.push(l),void 0!=a.octaveScrollBar&&(l.octave=n(0,t.Config.scrollableOctaves+1,0|a.octaveScrollBar));for(let t=l.instruments.length;t<this.instrumentsPerChannel;t++)l.instruments[t]=new c(m);l.instruments.length=this.instrumentsPerChannel;for(let t=l.patterns.length;t<this.patternsPerChannel;t++)l.patterns[t]=new h;l.patterns.length=this.patternsPerChannel;for(let t=0;t<this.barCount;t++)l.bars[t]=1;l.bars.length=this.barCount;for(let t=0;t<this.instrumentsPerChannel;t++){l.instruments[t].fromJsonObject(a.instruments[t],m)}for(let e=0;e<this.patternsPerChannel;e++){const h=l.patterns[e];let r=void 0;if(a.patterns&&(r=a.patterns[e]),void 0!=r&&(h.instrument=n(0,this.instrumentsPerChannel,(0|r.instrument)-1),r.notes&&r.notes.length>0)){const e=Math.min(this.beatsPerBar*t.Config.partsPerBeat,r.notes.length>>>0);let n=0;for(let a=0;a<r.notes.length&&!(a>=e);a++){const e=r.notes[a];if(!(e&&e.pitches&&e.pitches.length>=1&&e.points&&e.points.length>=2))continue;const l=new o(0,0,0,0);l.pitches=[],l.pins=[];for(let t=0;t<e.pitches.length;t++){const i=0|e.pitches[t];if(-1==l.pitches.indexOf(i)&&(l.pitches.push(i),l.pitches.length>=4))break}if(l.pitches.length<1)continue;let c=n,f=0;for(let n=0;n<e.points.length;n++){const o=e.points[n];if(void 0==o||void 0==o.tick)continue;const h=void 0==o.pitchBend?0:0|o.pitchBend,r=Math.round(+o.tick*t.Config.partsPerBeat/i),a=void 0==o.volume?3:Math.max(0,Math.min(3,Math.round(3*(0|o.volume)/100)));if(!(r>this.beatsPerBar*t.Config.partsPerBeat)){if(0==l.pins.length){if(r<c)continue;l.start=r,f=h}else if(r<=c)continue;c=r,l.pins.push(s(h-f,r-l.start,a))}}if(l.pins.length<2)continue;l.end=l.pins[l.pins.length-1].time+l.start;const u=m?t.Config.drumCount-1:t.Config.maxPitch;let d=u,p=0;for(let t=0;t<l.pitches.length;t++)l.pitches[t]+=f,(l.pitches[t]<0||l.pitches[t]>u)&&(l.pitches.splice(t,1),t--),l.pitches[t]<d&&(d=l.pitches[t]),l.pitches[t]>p&&(p=l.pitches[t]);if(!(l.pitches.length<1)){for(let t=0;t<l.pins.length;t++){const e=l.pins[t];e.interval+d<0&&(e.interval=-d),e.interval+p>u&&(e.interval=u-p),t>=2&&e.interval==l.pins[t-1].interval&&e.interval==l.pins[t-2].interval&&e.volume==l.pins[t-1].volume&&e.volume==l.pins[t-2].volume&&(l.pins.splice(t-1,1),t--)}h.notes.push(l),n=l.end}}}}for(let t=0;t<this.barCount;t++)l.bars[t]=a.sequence?Math.min(this.patternsPerChannel,a.sequence[t]>>>0):0}u.length>t.Config.pitchChannelCountMax&&(u.length=t.Config.pitchChannelCountMax),d.length>t.Config.noiseChannelCountMax&&(d.length=t.Config.noiseChannelCountMax),this.pitchChannelCount=u.length,this.noiseChannelCount=d.length,this.channels.length=0,Array.prototype.push.apply(this.channels,u),Array.prototype.push.apply(this.channels,d)}getPattern(t,e){const i=this.channels[t].bars[e];return 0==i?null:this.channels[t].patterns[i-1]}getPatternInstrument(t,e){const i=this.getPattern(t,e);return null==i?0:i.instrument}getBeatsPerMinute(){return this.tempo}}u.S="BeepBox",u.P=2,u.N=7,u.q=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95],u.R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,63,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0],t.Song=u;class d{constructor(){this.pitches=[0,0,0,0],this.pitchCount=0,this.chordSize=0,this.drumsetPitch=0,this.note=null,this.prevNote=null,this.nextNote=null,this.prevNotePitchIndex=0,this.nextNotePitchIndex=0,this.active=!1,this.noteStart=0,this.noteEnd=0,this.noteLengthTicks=0,this.ticksSinceReleased=0,this.liveInputSamplesHeld=0,this.lastInterval=0,this.lastVolume=0,this.sample=0,this.phases=[],this.phaseDeltas=[],this.volumeStarts=[],this.volumeDeltas=[],this.volumeStart=0,this.volumeDelta=0,this.phaseDeltaScale=0,this.pulseWidth=0,this.pulseWidthDelta=0,this.filter=0,this.filterScale=0,this.filterSample0=0,this.filterSample1=0,this.vibratoScale=0,this.intervalMult=0,this.intervalVolumeMult=1,this.feedbackOutputs=[],this.feedbackMult=0,this.feedbackDelta=0,this.reset()}reset(){for(let e=0;e<t.Config.operatorCount;e++)this.phases[e]=0,this.feedbackOutputs[e]=0;this.sample=0,this.filterSample0=0,this.filterSample1=0,this.liveInputSamplesHeld=0}}class m{constructor(e=null){this.samplesPerSecond=44100,this.song=null,this.liveInputPressed=!1,this.liveInputPitches=[0],this.liveInputChannel=0,this.enableIntro=!0,this.enableOutro=!1,this.loopCount=-1,this.volume=1,this.playheadInternal=0,this.bar=0,this.beat=0,this.part=0,this.tick=0,this.tickSampleCountdown=0,this.paused=!0,this.tonePool=new t.Deque,this.activeTones=[],this.releasedTones=[],this.liveInputTones=new t.Deque,this.limit=0,this.samplesForChorus=null,this.samplesForChorusReverb=null,this.samplesForReverb=null,this.chorusDelayLine=new Float32Array(1024),this.chorusDelayPos=0,this.chorusPhase=0,this.reverbDelayLine=new Float32Array(16384),this.reverbDelayPos=0,this.reverbFeedback0=0,this.reverbFeedback1=0,this.reverbFeedback2=0,this.reverbFeedback3=0,this.audioCtx=null,this.scriptNode=null,this.audioProcessCallback=(t=>{const e=t.outputBuffer,i=e.getChannelData(0);if(this.paused)for(let t=0;t<e.length;t++)i[t]=0;else this.synthesize(i,e.length)}),null!=e&&this.setSong(e)}static warmUpSynthesizer(t){if(null!=t)for(let e=0;e<t.getChannelCount();e++)for(let i=0;i<t.instrumentsPerChannel;i++)m.getInstrumentSynthFunction(t.channels[e].instruments[i]),t.channels[e].instruments[i].warmUp()}static operatorAmplitudeCurve(t){return(Math.pow(16,t/15)-1)/15}get playing(){return!this.paused}get playhead(){return this.playheadInternal}set playhead(e){if(null!=this.song){this.playheadInternal=Math.max(0,Math.min(this.song.barCount,e));let i=this.playheadInternal;this.bar=Math.floor(i),i=this.song.beatsPerBar*(i-this.bar),this.beat=Math.floor(i),i=t.Config.partsPerBeat*(i-this.beat),this.part=Math.floor(i),i=t.Config.ticksPerPart*(i-this.part),this.tick=Math.floor(i);const s=this.getSamplesPerTick();i=s*(i-this.tick),this.tickSampleCountdown=Math.floor(s-i),this.bar<this.song.loopStart&&(this.enableIntro=!0),this.bar>this.song.loopStart+this.song.loopLength&&(this.enableOutro=!0)}}get totalSamples(){if(null==this.song)return 0;const e=this.getSamplesPerTick()*t.Config.ticksPerPart*t.Config.partsPerBeat*this.song.beatsPerBar;let i=this.loopCount;i<0&&(i=1);let s=this.song.loopLength*i;return this.enableIntro&&(s+=this.song.loopStart),this.enableOutro&&(s+=this.song.barCount-(this.song.loopStart+this.song.loopLength)),s*e}get totalSeconds(){return this.totalSamples/this.samplesPerSecond}get totalBars(){return null==this.song?0:this.song.barCount}setSong(t){"string"==typeof t?this.song=new u(t):t instanceof u&&(this.song=t)}play(){if(!this.paused)return;this.paused=!1,m.warmUpSynthesizer(this.song);const t=window.AudioContext||window.webkitAudioContext;this.audioCtx=this.audioCtx||new t,this.scriptNode=this.audioCtx.createScriptProcessor?this.audioCtx.createScriptProcessor(2048,0,1):this.audioCtx.createJavaScriptNode(2048,0,1),this.scriptNode.onaudioprocess=this.audioProcessCallback,this.scriptNode.channelCountMode="explicit",this.scriptNode.channelInterpretation="speakers",this.scriptNode.connect(this.audioCtx.destination),this.samplesPerSecond=this.audioCtx.sampleRate}pause(){this.paused||(this.paused=!0,this.scriptNode.disconnect(this.audioCtx.destination),this.audioCtx.close&&this.audioCtx.close(),this.audioCtx=null,this.scriptNode=null)}snapToStart(){this.bar=0,this.enableIntro=!0,this.snapToBar()}snapToBar(t){void 0!==t&&(this.bar=t),this.playheadInternal=this.bar,this.beat=0,this.part=0,this.tick=0,this.tickSampleCountdown=0,this.reverbDelayPos=0,this.reverbFeedback0=0,this.reverbFeedback1=0,this.reverbFeedback2=0,this.reverbFeedback3=0,this.freeAllTones();for(let t=0;t<this.reverbDelayLine.length;t++)this.reverbDelayLine[t]=0;for(let t=0;t<this.chorusDelayLine.length;t++)this.chorusDelayLine[t]=0}nextBar(){if(!this.song)return;const t=this.bar;this.bar++,this.enableOutro?this.bar>=this.song.barCount&&(this.bar=this.enableIntro?0:this.song.loopStart):(this.bar>=this.song.loopStart+this.song.loopLength||this.bar>=this.song.barCount)&&(this.bar=this.song.loopStart),this.playheadInternal+=this.bar-t}prevBar(){if(!this.song)return;const t=this.bar;this.bar--,this.bar<0&&(this.bar=this.song.loopStart+this.song.loopLength-1),this.bar>=this.song.barCount&&(this.bar=this.song.barCount-1),this.bar<this.song.loopStart&&(this.enableIntro=!0),!this.enableOutro&&this.bar>=this.song.loopStart+this.song.loopLength&&(this.bar=this.song.loopStart+this.song.loopLength-1),this.playheadInternal+=this.bar-t}synthesize(e,i){if(null==this.song){for(let t=0;t<i;t++)e[t]=0;return}const s=this.song.getChannelCount();for(let e=this.activeTones.length;e<s;e++)this.activeTones[e]=new t.Deque,this.releasedTones[e]=new t.Deque;this.activeTones.length=s,this.releasedTones.length=s;const n=this.getSamplesPerTick();let o=0,h=!1;(0==this.tickSampleCountdown||this.tickSampleCountdown>n)&&(this.tickSampleCountdown=n),this.beat>=this.song.beatsPerBar&&(this.bar++,this.beat=0,this.part=0,this.tick=0,this.tickSampleCountdown=n,-1==this.loopCount&&(this.bar<this.song.loopStart&&!this.enableIntro&&(this.bar=this.song.loopStart),this.bar>=this.song.loopStart+this.song.loopLength&&!this.enableOutro&&(this.bar=this.song.loopStart))),this.bar>=this.song.barCount&&(this.enableOutro?(this.bar=0,this.enableIntro=!0,h=!0,this.pause()):this.bar=this.song.loopStart),this.bar>=this.song.loopStart&&(this.enableIntro=!1),(null==this.samplesForChorus||this.samplesForChorus.length<i)&&(this.samplesForChorus=new Float32Array(i)),(null==this.samplesForChorusReverb||this.samplesForChorusReverb.length<i)&&(this.samplesForChorusReverb=new Float32Array(i)),(null==this.samplesForReverb||this.samplesForReverb.length<i)&&(this.samplesForReverb=new Float32Array(i));const r=this.samplesForChorus,a=this.samplesForChorusReverb,l=this.samplesForReverb;for(let t=0;t<i;)e[t++]=0,e[t++]=0,e[t++]=0,e[t++]=0,e[t++]=0,e[t++]=0,e[t++]=0,e[t++]=0;const c=+this.volume,f=this.chorusDelayLine,u=this.reverbDelayLine,d=2*Math.PI/(2*this.samplesPerSecond),m=150*this.samplesPerSecond/44100,p=1024-1.51*m,y=1024-2.1*m,g=1024-3.35*m;let v=this.chorusPhase%(2*Math.PI),b=1023&this.chorusDelayPos,w=16383&this.reverbDelayPos,M=+this.reverbFeedback0,k=+this.reverbFeedback1,x=+this.reverbFeedback2,E=+this.reverbFeedback3;const A=.425*Math.pow(this.song.reverb/t.Config.reverbRange,.667),C=1-Math.pow(.5,4/this.samplesPerSecond),q=1-Math.pow(.5,4e3/this.samplesPerSecond);let N=+this.limit;const R=[e,l,r,a];for(;o<i&&!h;)for(;o<i;){const s=i-o,P=this.tickSampleCountdown<=s?this.tickSampleCountdown:s;for(let e=0;e<this.song.getChannelCount();e++){if(e==this.liveInputChannel){this.determineLiveInputTones(this.song);for(let t=0;t<this.liveInputTones.count();t++){const i=this.liveInputTones.get(t);this.playTone(this.song,o,R,e,n,P,i,!1,!1)}}this.determineCurrentActiveTones(this.song,e);for(let t=0;t<this.activeTones[e].count();t++){const i=this.activeTones[e].get(t);this.playTone(this.song,o,R,e,n,P,i,!1,!1)}for(let i=0;i<this.releasedTones[e].count();i++){const s=this.releasedTones[e].get(i);if(s.ticksSinceReleased>=s.instrument.getTransition().releaseTicks){this.freeReleasedTone(e,i),i--;continue}const h=i+this.activeTones[e].count()>=t.Config.maximumTonesPerChannel;this.playTone(this.song,o,R,e,n,P,s,!0,h)}}let S=b+p-m*Math.sin(v+0),T=b+y-m*Math.sin(v+2.1),z=b+g-m*Math.sin(v+4.2);v+=d*P;const B=(b+P+p-m*Math.sin(v+0)-S)/P,F=(b+P+y-m*Math.sin(v+2.1)-T)/P,I=(b+P+g-m*Math.sin(v+4.2)-z)/P,L=o+P;for(let t=o;t<L;t++){const i=r[t];r[t]=0;const s=a[t];a[t]=0;const n=l[t];l[t]=0;const o=i+s,h=S%1,d=T%1,m=z%1,p=f[1023&S],y=f[S+1&1023],g=f[1023&T],v=f[T+1&1023],R=f[1023&z],P=.5*(o-(p+(y-p)*h)+(g+(v-g)*d)-(R+(f[z+1&1023]-R)*m));f[b]=o,b=b+1&1023,S+=B,T+=F,z+=I;const L=w+3041&16383,H=w+6426&16383,D=w+10907&16383,U=u[w]+n,Z=u[L],G=u[H],O=u[D],j=U+s,W=-j+Z,V=-j-Z,Y=-G+O,J=-G-O;M+=.5*((W+Y)*A-M),k+=.5*((V+J)*A-k),x+=.5*((W-Y)*A-x),E+=.5*((V-J)*A-E),u[L]=M,u[H]=k,u[D]=x,u[w]=E,w=w+1&16383;const Q=e[t]+P+U+Z+G+O,X=Q<0?-Q:Q;N+=(X-N)*(N<X?q:C),e[t]=Q/(N>=1?1.05*N:.8*N+.25)*c}if(o+=P,this.tickSampleCountdown-=P,this.tickSampleCountdown<=0){for(let e=0;e<this.song.getChannelCount();e++)for(let i=0;i<this.releasedTones[e].count();i++){this.releasedTones[e].get(i).ticksSinceReleased++,i+this.activeTones[e].count()>=t.Config.maximumTonesPerChannel&&(this.freeReleasedTone(e,i),i--)}if(this.tick++,this.tickSampleCountdown=n,this.tick==t.Config.ticksPerPart){this.tick=0,this.part++;for(let e=0;e<this.song.getChannelCount();e++)for(let i=0;i<this.activeTones[e].count();i++){const s=this.activeTones[e].get(i),n=s.instrument.getTransition();n.isSeamless||null==s.note||s.note.end!=this.part+this.beat*t.Config.partsPerBeat||(n.releases?this.releaseTone(e,s):this.freeTone(s),this.activeTones[e].remove(i),i--)}if(this.part==t.Config.partsPerBeat&&(this.part=0,this.beat++,this.beat==this.song.beatsPerBar)){this.beat=0,this.bar++,this.bar<this.song.loopStart?this.enableIntro||(this.bar=this.song.loopStart):this.enableIntro=!1,this.bar>=this.song.loopStart+this.song.loopLength&&(this.loopCount>0&&this.loopCount--,(this.loopCount>0||!this.enableOutro)&&(this.bar=this.song.loopStart)),this.bar>=this.song.barCount&&(this.bar=0,this.enableIntro=!0,h=!0,this.pause());break}}}}-1e-24<M&&M<1e-24&&(M=0),-1e-24<k&&k<1e-24&&(k=0),-1e-24<x&&x<1e-24&&(x=0),-1e-24<E&&E<1e-24&&(E=0),-1e-24<N&&N<1e-24&&(N=0),this.chorusPhase=v,this.chorusDelayPos=b,this.reverbDelayPos=w,this.reverbFeedback0=M,this.reverbFeedback1=k,this.reverbFeedback2=x,this.reverbFeedback3=E,this.limit=N,this.playheadInternal=(((this.tick+1-this.tickSampleCountdown/n)/2+this.part)/t.Config.partsPerBeat+this.beat)/this.song.beatsPerBar+this.bar}freeTone(t){this.tonePool.pushBack(t)}newTone(){if(this.tonePool.count()>0){const t=this.tonePool.popBack();return t.reset(),t.active=!1,t}return new d}releaseTone(t,e){this.releasedTones[t].pushFront(e)}freeReleasedTone(t,e){this.freeTone(this.releasedTones[t].get(e)),this.releasedTones[t].remove(e)}freeAllTones(){for(;this.liveInputTones.count()>0;)this.freeTone(this.liveInputTones.popBack());for(let t=0;t<this.activeTones.length;t++)for(;this.activeTones[t].count()>0;)this.freeTone(this.activeTones[t].popBack());for(let t=0;t<this.releasedTones.length;t++)for(;this.releasedTones[t].count()>0;)this.freeTone(this.releasedTones[t].popBack())}determineLiveInputTones(t){if(this.liveInputPressed){const e=t.channels[this.liveInputChannel].instruments[t.getPatternInstrument(this.liveInputChannel,this.bar)];let i;0==this.liveInputTones.count()?(i=this.newTone(),this.liveInputTones.pushBack(i)):e.getTransition().isSeamless||this.liveInputTones.peakFront().pitches[0]==this.liveInputPitches[0]?i=this.liveInputTones.get(0):(this.releaseTone(this.liveInputChannel,this.liveInputTones.popFront()),i=this.newTone(),this.liveInputTones.pushBack(i));for(let t=0;t<this.liveInputPitches.length;t++)i.pitches[t]=this.liveInputPitches[t];i.pitchCount=this.liveInputPitches.length,i.chordSize=1,i.instrument=e,i.note=i.prevNote=i.nextNote=null}else for(;this.liveInputTones.count()>0;)this.releaseTone(this.liveInputChannel,this.liveInputTones.popBack())}determineCurrentActiveTones(e,i){const s=e.channels[i].instruments[e.getPatternInstrument(i,this.bar)],n=e.getPattern(i,this.bar),o=this.part+this.beat*t.Config.partsPerBeat;let h=null,r=null,a=null;if(null!=n)for(let t=0;t<n.notes.length;t++)if(n.notes[t].end<=o)r=n.notes[t];else if(n.notes[t].start<=o&&n.notes[t].end>o)h=n.notes[t];else if(n.notes[t].start>o){a=n.notes[t];break}const l=this.activeTones[i];if(null!=h)null!=r&&r.end!=h.start&&(r=null),null!=a&&a.start!=h.end&&(a=null),this.syncTones(i,l,s,h.pitches,h,r,a,o);else for(;l.count()>0;)l.peakBack().instrument.getTransition().releases?this.releaseTone(i,l.popBack()):this.freeTone(l.popBack())}syncTones(e,i,s,n,o,h,r,a){let l=0;if(s.getChord().arpeggiates){let t;0==i.count()?(t=this.newTone(),i.pushBack(t)):t=i.get(0),l=1;for(let e=0;e<n.length;e++)t.pitches[e]=n[e];t.pitchCount=n.length,t.chordSize=1,t.instrument=s,t.note=o,t.noteStart=o.start,t.noteEnd=o.end,t.prevNote=h,t.nextNote=r,t.prevNotePitchIndex=0,t.nextNotePitchIndex=0}else{const e=s.getTransition();for(let c=0;c<n.length;c++){const n=c*s.getChord().strumParts;let f=h&&h.pitches.length>c?h:null,u=o,d=r&&r.pitches.length>c?r:null,m=u.start+n;if(m>a){if(!(i.count()>c&&e.isSeamless&&null!=f))break;d=u,u=f,f=null,m=u.start+n}let p,y=u.end;e.isSeamless&&null!=d&&(y=Math.min(t.Config.partsPerBeat*this.song.beatsPerBar,y+n)),i.count()>c?p=i.get(c):(p=this.newTone(),i.pushBack(p)),l++,p.pitches[0]=u.pitches[c],p.pitchCount=1,p.chordSize=u.pitches.length,p.instrument=s,p.note=u,p.noteStart=m,p.noteEnd=y,p.prevNote=f,p.nextNote=d,p.prevNotePitchIndex=c,p.nextNotePitchIndex=c}}for(;i.count()>l;)i.peakBack().instrument.getTransition().releases?this.releaseTone(e,i.popBack()):this.freeTone(i.popBack())}playTone(t,e,i,s,n,o,h,r,a){m.computeTone(this,t,s,n,o,h,r,a);const l=i[h.instrument.effects];m.getInstrumentSynthFunction(h.instrument)(this,l,e,o,h,h.instrument)}static computeEnvelope(t,e,i,s){switch(t.type){case 0:return s;case 1:return 1;case 4:return 1/(1+e*t.speed);case 5:return 1-1/(1+e*t.speed);case 6:return.5-.5*Math.cos(2*i*Math.PI*t.speed);case 7:return.75-.25*Math.cos(2*i*Math.PI*t.speed);case 2:return Math.max(1,2-10*e);case 3:const n=t.speed,o=.25/Math.sqrt(n);return e<o?e/o:1/(1+(e-o)*n);case 8:return Math.pow(2,-t.speed*e);default:throw new Error("Unrecognized operator envelope type.")}}static computeChordVolume(t){return 1/(.25*(t-1)+1)}static computeTone(e,i,s,n,o,h,r,a){const l=h.instrument,f=l.getTransition(),u=l.getChord(),d=u.arpeggiates?1:m.computeChordVolume(h.chordSize),p=i.getChannelIsNoise(s),y=p?t.Config.noiseInterval:1,g=t.Config.ticksPerPart*n/e.samplesPerSecond,v=1/t.Config.partsPerBeat,b=h.active,w=e.tickSampleCountdown,M=1-w/n,k=1-(w-o)/n,x=(e.beat*t.Config.partsPerBeat+e.part)*t.Config.ticksPerPart+e.tick,E=x/t.Config.ticksPerPart,A=(x+1)/t.Config.ticksPerPart,C=E+(A-E)*M,q=E+(A-E)*k;h.phaseDeltaScale=0,h.filter=1,h.filterScale=1,h.vibratoScale=0,h.intervalMult=1,h.intervalVolumeMult=1,h.active=!1;let N,R,P,S,T=!0,z=0,B=0,F=0,I=1,L=1,H=d,D=d,U=0,Z=0,G=0,O=0;if(3==l.type)p?(R=t.Config.spectrumBasePitch,P=.6):(R=t.Config.keys[i.key].basePitch,P=.3),N=t.Config.spectrumBasePitch,S=28;else if(4==l.type)P=.45,N=R=t.Config.spectrumBasePitch,S=48;else if(2==l.type)P=.19,N=R=t.Config.chipNoises[l.chipNoise].basePitch,S=t.Config.chipNoises[l.chipNoise].isSoft?24:60;else if(1==l.type)R=t.Config.keys[i.key].basePitch,P=.03,N=16,S=48;else if(0==l.type)R=t.Config.keys[i.key].basePitch,P=.03375,N=16,S=48;else if(5==l.type)R=t.Config.keys[i.key].basePitch,P=.025,N=16,S=48;else{if(6!=l.type)throw new Error("Unknown instrument type in computeTone.");R=t.Config.keys[i.key].basePitch,P=.04725,N=16,S=48}for(let e=0;e<t.Config.operatorCount;e++)h.phaseDeltas[e]=0,h.volumeStarts[e]=0,h.volumeDeltas[e]=0;if(r){const e=h.noteLengthTicks+h.ticksSinceReleased,i=h.ticksSinceReleased+M,s=h.ticksSinceReleased+k,n=h.noteLengthTicks+i,o=h.noteLengthTicks+s,r=h.instrument.getTransition();T=!1,z=Math.floor(e/t.Config.ticksPerPart),B=F=h.lastInterval,U=Z=m.expressionToVolumeMult(h.lastVolume),I=m.expressionToVolumeMult(3*(1-i/r.releaseTicks)),L=m.expressionToVolumeMult(3*(1-s/r.releaseTicks)),G=n/t.Config.ticksPerPart,O=o/t.Config.ticksPerPart,a&&(I*=1-M,L*=1-k)}else if(null==h.note){I=L=1,U=Z=1,h.lastInterval=0,h.lastVolume=3,h.ticksSinceReleased=0,T=!1;const e=h.liveInputSamplesHeld/n;h.liveInputSamplesHeld+=o;const i=h.liveInputSamplesHeld/n;h.noteLengthTicks=i;const s=e/t.Config.ticksPerPart,r=i/t.Config.ticksPerPart;z=Math.floor(s),G=s,O=r}else{const s=h.note,n=h.prevNote,o=h.nextNote,r=e.part+e.beat*t.Config.partsPerBeat,a=t.Config.partsPerBeat*i.beatsPerBar,l=h.noteStart,c=h.noteEnd;let p;for(z=r-l,p=1;p<s.pins.length-1&&!(s.pins[p].time+s.start>r);p++);const y=s.pins[p-1],g=s.pins[p],v=l*t.Config.ticksPerPart,w=c*t.Config.ticksPerPart-v,x=(s.start+y.time)*t.Config.ticksPerPart,C=(s.start+g.time)*t.Config.ticksPerPart;h.lastInterval=s.pins[s.pins.length-1].interval,h.lastVolume=s.pins[s.pins.length-1].volume,h.ticksSinceReleased=0,h.noteLengthTicks=w;const q=r*t.Config.ticksPerPart+e.tick,N=r*t.Config.ticksPerPart+e.tick+1,R=q-v,P=N-v,S=Math.min(1,(q-x)/(C-x)),j=Math.min(1,(N-x)/(C-x));let W=y.volume+(g.volume-y.volume)*S,V=y.volume+(g.volume-y.volume)*j,Y=1,J=1,Q=d,X=d,K=y.interval+(g.interval-y.interval)*S,_=y.interval+(g.interval-y.interval)*j,$=E-l,tt=A-l;T=q+M-v==0||!b;const et=.5*w;if(f.isSeamless&&!f.slides&&0==s.start)T=!b;else if(f.isSeamless&&null!=n&&(T=!b,f.slides)){const t=Math.min(et,f.slideTicks),e=Math.max(0,1-R/t),i=Math.max(0,1-P/t),o=.5*(n.pitches[h.prevNotePitchIndex]+n.pins[n.pins.length-1].interval-h.pitches[0]),r=.5*(n.pins[n.pins.length-1].volume-s.pins[0].volume),a=.5*(n.end-n.start);if(K+=e*o,_+=i*o,W+=e*r,V+=i*r,$+=e*a,tt+=i*a,!u.arpeggiates){const t=.5*(n.pitches.length-h.chordSize);Q=m.computeChordVolume(h.chordSize+e*t),X=m.computeChordVolume(h.chordSize+i*t)}}if(f.isSeamless&&!f.slides&&s.end==a);else if(f.isSeamless&&null!=o){if(f.slides){const t=Math.min(et,f.slideTicks),e=Math.max(0,1-(w-R)/t),i=Math.max(0,1-(w-P)/t),n=.5*(o.pitches[h.nextNotePitchIndex]-(h.pitches[0]+s.pins[s.pins.length-1].interval)),r=.5*(o.pins[0].volume-s.pins[s.pins.length-1].volume),a=.5*-(c-l);if(K+=e*n,_+=i*n,W+=e*r,V+=i*r,$+=e*a,tt+=i*a,!u.arpeggiates){const t=.5*(o.pitches.length-h.chordSize);Q=m.computeChordVolume(h.chordSize+e*t),X=m.computeChordVolume(h.chordSize+i*t)}}}else if(!f.releases){const t=f.releaseTicks;t>0&&(Y*=Math.min(1,(w-R)/t),J*=Math.min(1,(w-P)/t))}B=K+(_-K)*M,F=K+(_-K)*k,U=m.expressionToVolumeMult(W+(V-W)*M),Z=m.expressionToVolumeMult(W+(V-W)*k),I=Y+(J-Y)*M,L=Y+(J-Y)*k,H=Q+(X-Q)*M,D=Q+(X-Q)*k,G=$+(tt-$)*M,O=$+(tt-$)*k}const j=1/e.samplesPerSecond;if(h.active=!0,0==l.type||1==l.type||5==l.type||6==l.type){const e=m.getLFOAmplitude(l,g*C),i=m.getLFOAmplitude(l,g*q),s=z<t.Config.vibratos[l.vibrato].delayParts?0:t.Config.vibratos[l.vibrato].amplitude;B+=s*e,F+=s*i}if(!f.isSeamless||(f.slides||null==h.note||0!=h.note.start)&&null==h.prevNote){const t=f.attackSeconds;t>0&&(I*=Math.min(1,g*G/t),L*=Math.min(1,g*O/t))}const W=m.instrumentVolumeToVolumeMult(l.volume);4==l.type&&(h.drumsetPitch=h.pitches[0],null!=h.note&&(h.drumsetPitch+=h.note.pickMainInterval()),h.drumsetPitch=Math.max(0,Math.min(t.Config.drumCount-1,h.drumsetPitch)));const V=l.getFilterCutoffOctaves(),Y=4==l.type?l.getDrumsetEnvelope(h.drumsetPitch):l.getFilterEnvelope(),J=t.Config.filterCutoffMaxHz*Math.pow(2,V),Q=2*Math.sin(Math.PI*J/e.samplesPerSecond),X=2*Math.sin(Math.PI*t.Config.filterCutoffMinHz/e.samplesPerSecond);h.filter=Q*m.computeEnvelope(Y,g*G,v*C,U);let K=Q*m.computeEnvelope(Y,g*O,v*q,Z);h.filter=Math.min(t.Config.filterMax,Math.max(X,h.filter)),K=Math.min(t.Config.filterMax,Math.max(X,K)),h.filterScale=Math.pow(K/h.filter,1/o);let _=Math.pow(.5,.35*V);if(l.filterResonance>0&&(_=Math.pow(_,1.7)*Math.pow(.5,.125*(l.filterResonance-1))),8==Y.type?_*=1.25+.025*Y.speed:4==Y.type&&(_*=1+.02*Y.speed),T&&h.reset(),1==l.type){let s=1,n=0,r=0;if(h.pitchCount>1&&!u.harmonizes){const s=Math.floor((e.tick+e.part*t.Config.ticksPerPart)/t.Config.rhythms[i.rhythm].ticksPerArpeggio),n=t.Config.rhythms[i.rhythm].arpeggioPatterns[h.pitchCount-1];r=h.pitches[n[s%n.length]]-h.pitches[0]}const a=t.Config.algorithms[l.algorithm].carrierCount;for(let e=0;e<t.Config.operatorCount;e++){const i=t.Config.algorithms[l.algorithm].associatedCarrier[e]-1,f=h.pitches[u.harmonizes?e<h.pitchCount?e:i<h.pitchCount?i:0:0],d=t.Config.operatorFrequencies[l.operators[e].frequency].mult,p=t.Config.operatorCarrierInterval[i]+r,b=R+(f+B)*y+p,w=d*c.frequencyFromPitch(b)+t.Config.operatorFrequencies[l.operators[e].frequency].hzOffset;h.phaseDeltas[e]=w*j*t.Config.sineWaveLength;const M=m.operatorAmplitudeCurve(l.operators[e].amplitude),k=M*t.Config.operatorFrequencies[l.operators[e].frequency].amplitudeSign;let x=k,E=k;if(e<a){const t=R+(f+F)*y+p,e=Math.pow(2,-(b-N)/S),i=Math.pow(2,-(t-N)/S);x*=e,E*=i,n+=M}else x*=1.5*t.Config.sineWaveLength,E*=1.5*t.Config.sineWaveLength,s*=1-Math.min(1,l.operators[e].amplitude/15);const A=t.Config.envelopes[l.operators[e].envelope];x*=m.computeEnvelope(A,g*G,v*C,U),E*=m.computeEnvelope(A,g*O,v*q,Z),h.volumeStarts[e]=x,h.volumeDeltas[e]=(E-x)/o}const f=.3*t.Config.sineWaveLength*l.feedbackAmplitude/15,d=t.Config.envelopes[l.feedbackEnvelope];let p=f*m.computeEnvelope(d,g*G,v*C,U),b=f*m.computeEnvelope(d,g*O,v*q,Z);h.feedbackMult=p,h.feedbackDelta=(b-h.feedbackMult)/o;const w=P*W;h.volumeStart=_*w*I*H;const M=_*w*L*D;h.volumeDelta=(M-h.volumeStart)/o,s*=(Math.pow(2,2-1.4*l.feedbackAmplitude/15)-1)/3,s*=1-Math.min(1,Math.max(0,n-1)/2),h.volumeStart*=1+3*s,h.volumeDelta*=1+3*s}else{let s=h.pitches[0];if(h.pitchCount>1){const n=Math.floor((e.tick+e.part*t.Config.ticksPerPart)/t.Config.rhythms[i.rhythm].ticksPerArpeggio);if(u.harmonizes){const e=t.Config.rhythms[i.rhythm].arpeggioPatterns[h.pitchCount-2],s=h.pitches[1+e[n%e.length]]-h.pitches[0];h.intervalMult=Math.pow(2,s/12),h.intervalVolumeMult=Math.pow(2,-s/S)}else{const e=t.Config.rhythms[i.rhythm].arpeggioPatterns[h.pitchCount-1];s=h.pitches[e[n%e.length]]}}const n=R+(s+B)*y,r=R+(s+F)*y,a=c.frequencyFromPitch(n),f=Math.pow(2,-(n-N)/S),d=Math.pow(2,-(r-N)/S);let p=P*_;if(2==l.type&&(p*=t.Config.chipNoises[l.chipNoise].volume),0==l.type&&(p*=t.Config.chipWaves[l.chipWave].volume),0!=l.type&&5!=l.type||(p*=t.Config.intervals[l.interval].volume),6==l.type){const e=t.Config.envelopes[l.pulseEnvelope],i=.5*Math.pow(.5,.5*(t.Config.pulseWidthRange-l.pulseWidth-1)),s=i*m.computeEnvelope(e,g*G,v*C,U),n=i*m.computeEnvelope(e,g*O,v*q,Z);h.pulseWidth=s,h.pulseWidthDelta=(n-s)/o}h.phaseDeltas[0]=a*j,h.volumeStart=I*H*f*p*W;let b=L*D*d*p*W;0==Y.type||6==l.type&&0==t.Config.envelopes[l.pulseEnvelope].type||(h.volumeStart*=U,b*=Z),h.volumeDelta=(b-h.volumeStart)/o}h.phaseDeltaScale=Math.pow(2,(F-B)*y/12/o)}static getLFOAmplitude(e,i){let s=0;for(const n of t.Config.vibratos[e.vibrato].periodsSeconds)s+=Math.sin(2*Math.PI*i/n);return s}static getInstrumentSynthFunction(e){if(1==e.type){const i=e.algorithm+"_"+e.feedbackType;if(void 0==m.fmSynthFunctionCache[i]){const s=[];for(const i of m.fmSourceTemplate)if(-1!=i.indexOf("// CARRIER OUTPUTS")){const n=[];for(let i=0;i<t.Config.algorithms[e.algorithm].carrierCount;i++)n.push("operator"+i+"Scaled");s.push(i.replace("/*operator#Scaled*/",n.join(" + ")))}else if(-1!=i.indexOf("// INSERT OPERATOR COMPUTATION HERE"))for(let i=t.Config.operatorCount-1;i>=0;i--)for(const n of m.operatorSourceTemplate)if(-1!=n.indexOf("/* + operator@Scaled*/")){let o="";for(const s of t.Config.algorithms[e.algorithm].modulatedBy[i])o+=" + operator"+(s-1)+"Scaled";const h=t.Config.feedbacks[e.feedbackType].indices[i];if(h.length>0){o+=" + feedbackMult * (";const t=[];for(const e of h)t.push("operator"+(e-1)+"Output");o+=t.join(" + ")+")"}s.push(n.replace(/\#/g,i+"").replace("/* + operator@Scaled*/",o))}else s.push(n.replace(/\#/g,i+""));else if(-1!=i.indexOf("#"))for(let e=0;e<t.Config.operatorCount;e++)s.push(i.replace(/\#/g,e+""));else s.push(i);m.fmSynthFunctionCache[i]=new Function("synth","data","bufferIndex","runLength","tone","instrument",s.join("\n"))}return m.fmSynthFunctionCache[i]}if(0==e.type)return m.chipSynth;if(5==e.type)return m.harmonicsSynth;if(6==e.type)return m.pulseWidthSynth;if(2==e.type)return m.noiseSynth;if(3==e.type)return m.spectrumSynth;if(4==e.type)return m.drumsetSynth;throw new Error("Unrecognized instrument type: "+e.type)}static chipSynth(e,i,s,n,o,h){const r=t.Config.chipWaves[h.chipWave].samples,a=+r.length-1,l=+Math.pow(2,(t.Config.intervals[h.interval].offset+t.Config.intervals[h.interval].spread)/12),c=Math.pow(2,(t.Config.intervals[h.interval].offset-t.Config.intervals[h.interval].spread)/12)*o.intervalMult,f=o.intervalVolumeMult*t.Config.intervals[h.interval].sign;0!=h.interval||h.getChord().customInterval||(o.phases[1]=o.phases[0]);const u=c/l;let d=o.phaseDeltas[0]*l*a,m=d*u;const p=+o.phaseDeltaScale;let y=+o.volumeStart;const g=+o.volumeDelta;let v=o.phases[0]%1*a,b=o.phases[1]%1*a,w=+o.filter,M=h.getFilterIsFirstOrder()?1:w;const k=+o.filterScale,x=h.getFilterIsFirstOrder()?1:k,E=t.Config.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(t.Config.filterResonanceRange-2),.5);let A=+o.filterSample0,C=+o.filterSample1;const q=0|v,N=0|b,R=q%a,P=N%a,S=v-q,T=b-N;let z=r[R],B=r[P];z+=(r[R+1]-z)*S,B+=(r[P+1]-B)*T;const F=s+n;for(;s<F;){const t=0|(v+=d),e=0|(b+=m),n=t%a,o=e%a;let h=r[n],l=r[o];const c=v-t,u=b-e;let q=((h+=(r[n+1]-h)*c)-z)/d,N=((l+=(r[o+1]-l)*u)-B)/m;z=h,B=l,C+=M*((A+=w*(q+N*f-A+(E+E/(1-w))*(A-C)))-C),w*=k,M*=x,d*=p,m*=p,i[s]+=C*y,y+=g,s++}o.phases[0]=v/a,o.phases[1]=b/a;-1e-24<A&&A<1e-24&&(A=0),-1e-24<C&&C<1e-24&&(C=0),o.filterSample0=A,o.filterSample1=C}static harmonicsSynth(e,i,s,n,o,h){const r=h.harmonicsWave.getCustomWave(),a=+r.length-1,l=+Math.pow(2,(t.Config.intervals[h.interval].offset+t.Config.intervals[h.interval].spread)/12),c=Math.pow(2,(t.Config.intervals[h.interval].offset-t.Config.intervals[h.interval].spread)/12)*o.intervalMult,f=o.intervalVolumeMult*t.Config.intervals[h.interval].sign;0!=h.interval||h.getChord().customInterval||(o.phases[1]=o.phases[0]);const u=c/l;let d=o.phaseDeltas[0]*l*a,m=d*u;const p=+o.phaseDeltaScale;let y=+o.volumeStart;const g=+o.volumeDelta;let v=o.phases[0]%1*a,b=o.phases[1]%1*a,w=+o.filter,M=h.getFilterIsFirstOrder()?1:w;const k=+o.filterScale,x=h.getFilterIsFirstOrder()?1:k,E=t.Config.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(t.Config.filterResonanceRange-2),.5);let A=+o.filterSample0,C=+o.filterSample1;const q=0|v,N=0|b,R=q%a,P=N%a,S=v-q,T=b-N;let z=r[R],B=r[P];z+=(r[R+1]-z)*S,B+=(r[P+1]-B)*T;const F=s+n;for(;s<F;){const t=0|(v+=d),e=0|(b+=m),n=t%a,o=e%a;let h=r[n],l=r[o];const c=v-t,u=b-e;let q=((h+=(r[n+1]-h)*c)-z)/d,N=((l+=(r[o+1]-l)*u)-B)/m;z=h,B=l,C+=M*((A+=w*(q+N*f-A+(E+E/(1-w))*(A-C)))-C),w*=k,M*=x,d*=p,m*=p,i[s]+=C*y,y+=g,s++}o.phases[0]=v/a,o.phases[1]=b/a;-1e-24<A&&A<1e-24&&(A=0),-1e-24<C&&C<1e-24&&(C=0),o.filterSample0=A,o.filterSample1=C}static pulseWidthSynth(e,i,s,n,o,h){let r=o.phaseDeltas[0];const a=+o.phaseDeltaScale;let l=+o.volumeStart;const c=+o.volumeDelta;let f=o.phases[0]%1,u=o.pulseWidth;const d=o.pulseWidthDelta;let m=+o.filter,p=h.getFilterIsFirstOrder()?1:m;const y=+o.filterScale,g=h.getFilterIsFirstOrder()?1:y,v=t.Config.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(t.Config.filterResonanceRange-2),.5);let b=+o.filterSample0,w=+o.filterSample1;const M=s+n;for(;s<M;){const t=f%1,e=(f+u)%1;let n=e-t;if(t<r)n+=.5*((k=t/r)+k-k*k-1);else if(t>1-r){n+=.5*((k=(t-1)/r)+k+k*k+1)}if(e<r)n-=.5*((k=e/r)+k-k*k-1);else if(e>1-r){var k;n-=.5*((k=(e-1)/r)+k+k*k+1)}w+=p*((b+=m*(n-b+(v+v/(1-m))*(b-w)))-w),m*=y,p*=g,f+=r,r*=a,u+=d,i[s]+=w*l,l+=c,s++}o.phases[0]=f;-1e-24<b&&b<1e-24&&(b=0),-1e-24<w&&w<1e-24&&(w=0),o.filterSample0=b,o.filterSample1=w}static noiseSynth(e,i,s,n,o,h){let r=h.getDrumWave(),a=+o.phaseDeltas[0];const l=+o.phaseDeltaScale;let c=+o.volumeStart;const f=+o.volumeDelta;let u=o.phases[0]%1*t.Config.chipNoiseLength;0==o.phases[0]&&(u=Math.random()*t.Config.chipNoiseLength);let d=+o.sample,m=+o.filter,p=h.getFilterIsFirstOrder()?1:m;const y=+o.filterScale,g=h.getFilterIsFirstOrder()?1:y,v=t.Config.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(t.Config.filterResonanceRange-2),.5);let b=+o.filterSample0,w=+o.filterSample1;const M=Math.min(1,o.phaseDeltas[0]*t.Config.chipNoises[h.chipNoise].pitchFilterMult),k=s+n;for(;s<k;){w+=p*((b+=m*((d+=(r[32767&u]-d)*M)-b+(v+v/(1-m))*(b-w)))-w),u+=a,m*=y,p*=g,a*=l,i[s]+=w*c,c+=f,s++}o.phases[0]=u/t.Config.chipNoiseLength,o.sample=d;-1e-24<b&&b<1e-24&&(b=0),-1e-24<w&&w<1e-24&&(w=0),o.filterSample0=b,o.filterSample1=w}static spectrumSynth(e,i,s,n,o,h){let r=h.getDrumWave(),a=128*o.phaseDeltas[0];const l=+o.phaseDeltaScale;let c=+o.volumeStart;const f=+o.volumeDelta;let u=+o.sample,d=+o.filter,p=h.getFilterIsFirstOrder()?1:d;const y=+o.filterScale,g=h.getFilterIsFirstOrder()?1:y,v=t.Config.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(t.Config.filterResonanceRange-2),.5);let b=+o.filterSample0,w=+o.filterSample1,M=o.phases[0]%1*t.Config.chipNoiseLength;0==o.phases[0]&&(M=m.findRandomZeroCrossing(r)+a);const k=Math.min(1,a),x=s+n;for(;s<x;){const t=0|M,e=32767&t;let n=r[e];const o=M-t;w+=p*((b+=d*((u+=((n+=(r[e+1]-n)*o)-u)*k)-b+(v+v/(1-d))*(b-w)))-w),M+=a,d*=y,p*=g,a*=l,i[s]+=w*c,c+=f,s++}o.phases[0]=M/t.Config.chipNoiseLength,o.sample=u;-1e-24<b&&b<1e-24&&(b=0),-1e-24<w&&w<1e-24&&(w=0),o.filterSample0=b,o.filterSample1=w}static drumsetSynth(e,i,s,n,o,h){let r=h.getDrumsetWave(o.drumsetPitch),a=o.phaseDeltas[0]/c.drumsetIndexReferenceDelta(o.drumsetPitch);const l=+o.phaseDeltaScale;let f=+o.volumeStart;const u=+o.volumeDelta;let d=+o.sample,p=+o.filter,y=h.getFilterIsFirstOrder()?1:p;const g=+o.filterScale,v=h.getFilterIsFirstOrder()?1:g,b=t.Config.filterMaxResonance*Math.pow(Math.max(0,h.getFilterResonance()-1)/(t.Config.filterResonanceRange-2),.5);let w=+o.filterSample0,M=+o.filterSample1,k=o.phases[0]%1*t.Config.chipNoiseLength;0==o.phases[0]&&(k=m.findRandomZeroCrossing(r)+a);const x=s+n;for(;s<x;){const t=0|k,e=32767&t;d=r[e];const n=k-t;M+=y*((w+=p*((d+=(r[e+1]-d)*n)-w+(b+b/(1-p))*(w-M)))-M),k+=a,p*=g,y*=v,a*=l,i[s]+=M*f,f+=u,s++}o.phases[0]=k/t.Config.chipNoiseLength,o.sample=d;-1e-24<w&&w<1e-24&&(w=0),-1e-24<M&&M<1e-24&&(M=0),o.filterSample0=w,o.filterSample1=M}static findRandomZeroCrossing(e){let i=Math.random()*t.Config.chipNoiseLength,s=32767&i,n=e[s];for(let o=128;o>0;o--){const o=s+16&32767,h=e[o];if(n*h<=0){for(let o=0;o<16;o++){const o=s+1&32767,h=e[o];if(n*h<=0){const e=h-n;i=s,Math.abs(e)>1e-8&&(i+=-n/e),i=Math.max(0,i)%t.Config.chipNoiseLength;break}s=o,n=h}break}s=o,n=h}return i}static instrumentVolumeToVolumeMult(e){return e==t.Config.volumeRange-1?0:Math.pow(2,t.Config.volumeLogScale*e)}static volumeMultToInstrumentVolume(e){return e<=0?t.Config.volumeRange-1:Math.min(t.Config.volumeRange-2,Math.log(e)/Math.LN2/t.Config.volumeLogScale)}static expressionToVolumeMult(t){return Math.pow(Math.max(0,t)/3,1.5)}static volumeMultToExpression(t){return 3*Math.pow(Math.max(0,t),1/1.5)}getSamplesPerTick(){if(null==this.song)return 0;const e=this.song.getBeatsPerMinute()/60*t.Config.partsPerBeat*t.Config.ticksPerPart;return Math.floor(this.samplesPerSecond/e)}}m.fmSynthFunctionCache={},m.fmSourceTemplate=("\n\t\t\tvar sineWave = beepbox.Config.sineWave;\n\t\t\t\n\t\t\tvar phaseDeltaScale = +tone.phaseDeltaScale;\n\t\t\t// I'm adding 1000 to the phase to ensure that it's never negative even when modulated by other waves because negative numbers don't work with the modulus operator very well.\n\t\t\tvar operator#Phase       = +((tone.phases[#] % 1) + 1000) * beepbox.Config.sineWaveLength;\n\t\t\tvar operator#PhaseDelta  = +tone.phaseDeltas[#];\n\t\t\tvar operator#OutputMult  = +tone.volumeStarts[#];\n\t\t\tvar operator#OutputDelta = +tone.volumeDeltas[#];\n\t\t\tvar operator#Output      = +tone.feedbackOutputs[#];\n\t\t\tvar feedbackMult         = +tone.feedbackMult;\n\t\t\tvar feedbackDelta        = +tone.feedbackDelta;\n\t\t\tvar volume = +tone.volumeStart;\n\t\t\tvar volumeDelta = +tone.volumeDelta;\n\t\t\t\n\t\t\tvar filter1 = +tone.filter;\n\t\t\tvar filter2 = instrument.getFilterIsFirstOrder() ? 1.0 : filter1;\n\t\t\tvar filterScale1 = +tone.filterScale;\n\t\t\tvar filterScale2 = instrument.getFilterIsFirstOrder() ? 1.0 : filterScale1;\n\t\t\tvar filterResonance = beepbox.Config.filterMaxResonance * Math.pow(Math.max(0, instrument.getFilterResonance() - 1) / (beepbox.Config.filterResonanceRange - 2), 0.5);\n\t\t\tvar filterSample0 = +tone.filterSample0;\n\t\t\tvar filterSample1 = +tone.filterSample1;\n\t\t\t\n\t\t\tvar stopIndex = bufferIndex + runLength;\n\t\t\twhile (bufferIndex < stopIndex) {\n\t\t\t\t// INSERT OPERATOR COMPUTATION HERE\n\t\t\t\tvar fmOutput = (/*operator#Scaled*/); // CARRIER OUTPUTS\n\t\t\t\t\n\t\t\t\tvar feedback = filterResonance + filterResonance / (1.0 - filter1);\n\t\t\t\tfilterSample0 += filter1 * (fmOutput - filterSample0 + feedback * (filterSample0 - filterSample1));\n\t\t\t\tfilterSample1 += filter2 * (filterSample0 - filterSample1);\n\t\t\t\t\n\t\t\t\tfeedbackMult += feedbackDelta;\n\t\t\t\toperator#OutputMult += operator#OutputDelta;\n\t\t\t\toperator#Phase += operator#PhaseDelta;\n\t\t\t\toperator#PhaseDelta *= phaseDeltaScale;\n\t\t\t\tfilter1 *= filterScale1;\n\t\t\t\tfilter2 *= filterScale2;\n\t\t\t\t\n\t\t\t\tdata[bufferIndex] += filterSample1 * volume;\n\t\t\t\tvolume += volumeDelta;\n\t\t\t\tbufferIndex++;\n\t\t\t}\n\t\t\t\n\t\t\ttone.phases[#] = operator#Phase / "+t.Config.sineWaveLength+";\n\t\t\ttone.feedbackOutputs[#] = operator#Output;\n\t\t\t\n\t\t\tvar epsilon = (1.0e-24);\n\t\t\tif (-epsilon < filterSample0 && filterSample0 < epsilon) filterSample0 = 0.0;\n\t\t\tif (-epsilon < filterSample1 && filterSample1 < epsilon) filterSample1 = 0.0;\n\t\t\ttone.filterSample0 = filterSample0;\n\t\t\ttone.filterSample1 = filterSample1;\n\t\t").split("\n"),m.operatorSourceTemplate=("\n\t\t\t\tvar operator#PhaseMix = operator#Phase/* + operator@Scaled*/;\n\t\t\t\tvar operator#PhaseInt = operator#PhaseMix|0;\n\t\t\t\tvar operator#Index    = operator#PhaseInt & "+t.Config.sineWaveMask+";\n\t\t\t\tvar operator#Sample   = sineWave[operator#Index];\n\t\t\t\toperator#Output       = operator#Sample + (sineWave[operator#Index + 1] - operator#Sample) * (operator#PhaseMix - operator#PhaseInt);\n\t\t\t\tvar operator#Scaled   = operator#OutputMult * operator#Output;\n\t\t").split("\n"),t.Synth=m}(beepbox||(beepbox={})),function(t){t.ChangeNotifier=class{constructor(){this.T=[],this.I=!1}watch(t){-1==this.T.indexOf(t)&&this.T.push(t)}unwatch(t){const e=this.T.indexOf(t);-1!=e&&this.T.splice(e,1)}changed(){this.I=!0}notifyWatchers(){if(this.I){this.I=!1;for(const t of this.T.concat())t()}}}}(beepbox||(beepbox={})),function(t){t.SongDocument=class{constructor(e){this.notifier=new t.ChangeNotifier,this.channel=0,this.bar=0,this.volume=75,this.trackVisibleBars=16,this.barScrollPos=0,this.prompt=null,this.L=null,this.H=0,this.U=0,this.Z=0,this.O=!1,this.j=!1,this.W=(()=>{let e=window.history.state;e&&e.sequenceNumber==this.H||(null==e?(this.H++,e={canUndo:!0,sequenceNumber:this.H,bar:this.bar,channel:this.channel,prompt:this.prompt},new t.ChangeSong(this,location.hash),window.history.replaceState(e,"","#"+this.song.toBase64String())):(e.sequenceNumber==this.H-1?(this.bar=this.U,this.channel=this.Z):e.sequenceNumber!=this.H&&(this.bar=e.bar,this.channel=e.channel),this.H=e.sequenceNumber,this.prompt=e.prompt,new t.ChangeSong(this,location.hash)),this.U=e.bar,this.Z=e.channel,this.forgetLastChange(),this.notifier.notifyWatchers())}),this.V=(()=>{this.notifier.notifyWatchers()}),this.Y=(()=>{this.j=!1;const t="#"+this.song.toBase64String();let e;this.O?(this.H++,e={canUndo:!0,sequenceNumber:this.H,bar:this.bar,channel:this.channel,prompt:this.prompt},window.history.pushState(e,"",t)):(e={canUndo:!0,sequenceNumber:this.H,bar:this.bar,channel:this.channel,prompt:this.prompt},window.history.replaceState(e,"",t)),this.U=e.bar,this.Z=e.channel,this.O=!1}),this.song=new t.Song(e),""!=e&&void 0!=e||t.setDefaultInstruments(this.song),this.synth=new t.Synth(this.song),this.autoPlay="true"==localStorage.getItem("autoPlay"),this.autoFollow="true"==localStorage.getItem("autoFollow"),this.showFifth="true"==localStorage.getItem("showFifth"),this.showLetters="true"==localStorage.getItem("showLetters"),this.showChannels="true"==localStorage.getItem("showChannels"),this.showScrollBar="true"==localStorage.getItem("showScrollBar"),this.alwaysShowSettings="true"==localStorage.getItem("alwaysShowSettings"),null!=localStorage.getItem("volume")&&(this.volume=Number(localStorage.getItem("volume"))),this.synth.volume=this.J();let i=window.history.state;null==i&&(i={canUndo:!1,sequenceNumber:0,bar:0,channel:0,prompt:null},window.history.replaceState(i,"","#"+this.song.toBase64String())),window.addEventListener("hashchange",this.W),window.addEventListener("popstate",this.W),this.bar=i.bar,this.channel=i.channel,this.U=i.bar,this.Z=i.channel,this.barScrollPos=Math.max(0,this.bar-(this.trackVisibleBars-6)),this.prompt=i.prompt;for(const t of["input","change","click","keyup","keydown","mousedown","mousemove","mouseup","touchstart","touchmove","touchend","touchcancel"])window.addEventListener(t,this.V)}record(t,e=!1){t.isNoop()?(this.L=null,e&&window.history.back()):(t.commit(),this.L=t,e||(this.O=!0),this.j||(window.requestAnimationFrame(this.Y),this.j=!0))}openPrompt(t){this.prompt=t;const e="#"+this.song.toBase64String();this.H++;const i={canUndo:!0,sequenceNumber:this.H,bar:this.bar,channel:this.channel,prompt:this.prompt};window.history.pushState(i,"",e)}undo(){window.history.state.canUndo&&window.history.back()}redo(){window.history.forward()}setProspectiveChange(t){this.L=t}forgetLastChange(){this.L=null}lastChangeWas(t){return null!=t&&t==this.L}goBackToStart(){this.channel=0,this.bar=0,this.barScrollPos=0,this.notifier.changed(),this.synth.snapToStart(),this.notifier.changed()}savePreferences(){localStorage.setItem("autoPlay",this.autoPlay?"true":"false"),localStorage.setItem("autoFollow",this.autoFollow?"true":"false"),localStorage.setItem("showFifth",this.showFifth?"true":"false"),localStorage.setItem("showLetters",this.showLetters?"true":"false"),localStorage.setItem("showChannels",this.showChannels?"true":"false"),localStorage.setItem("showScrollBar",this.showScrollBar?"true":"false"),localStorage.setItem("alwaysShowSettings",this.alwaysShowSettings?"true":"false"),localStorage.setItem("volume",String(this.volume))}setVolume(t){this.volume=t,this.savePreferences(),this.synth.volume=this.J()}J(){return Math.min(1,Math.pow(this.volume/50,.5))*Math.pow(2,(this.volume-75)/25)}getCurrentPattern(){return this.song.getPattern(this.channel,this.bar)}getCurrentInstrument(){const t=this.getCurrentPattern();return null==t?0:t.instrument}getChannelColorDim(e){return e<this.song.pitchChannelCount?t.EditorConfig.pitchColors[e%t.EditorConfig.pitchColors.length].channelDim:t.EditorConfig.noiseColors[(e-this.song.pitchChannelCount)%t.EditorConfig.noiseColors.length].channelDim}getChannelColorBright(e){return e<this.song.pitchChannelCount?t.EditorConfig.pitchColors[e%t.EditorConfig.pitchColors.length].channelBright:t.EditorConfig.noiseColors[(e-this.song.pitchChannelCount)%t.EditorConfig.noiseColors.length].channelBright}getNoteColorDim(e){return e<this.song.pitchChannelCount?t.EditorConfig.pitchColors[e%t.EditorConfig.pitchColors.length].noteDim:t.EditorConfig.noiseColors[(e-this.song.pitchChannelCount)%t.EditorConfig.noiseColors.length].noteDim}getNoteColorBright(e){return e<this.song.pitchChannelCount?t.EditorConfig.pitchColors[e%t.EditorConfig.pitchColors.length].noteBright:t.EditorConfig.noiseColors[(e-this.song.pitchChannelCount)%t.EditorConfig.noiseColors.length].noteBright}}}(beepbox||(beepbox={})),function(t){const e={class:!0,classList:!0,className:!0};function i(t,s){for(const n of s)if(Array.isArray(n))i(t,n);else if(n instanceof Node)t.appendChild(n);else if(n&&n.constructor===Object)for(const i of Object.keys(n)){const s=n[i];if(e[i])if("classList"===i){const e=Array.isArray(s)?s:s.split(" ");for(const i of e)t.classList.add(i)}else t.setAttribute("class",Array.isArray(s)?s.join(" "):s);else if("style"===i)if(s&&s.constructor===Object)for(const e of Object.keys(s))e.startsWith("--")?t.style.setProperty(e,s[e]):t.style.hasOwnProperty(e)?t.style[e]=s[e]:console.log("Unrecognized style property name: "+e);else t.setAttribute(i,s);else"function"==typeof s?t[i]=s:"boolean"==typeof s?s?t.setAttribute(i,""):t.removeAttribute(i):t.setAttribute(i,s)}else t.appendChild(document.createTextNode(n));return t}const s="http://www.w3.org/2000/svg";t.HTML=function(){},t.HTML.element=function(t,...e){return i(document.createElement(t),e)},t.SVG=function(){},t.SVG.element=function(t,...e){return i(document.createElementNS(s,t),e)};for(const e of"a abbr address area article aside audio b base bdi bdo blockquote br button canvas caption cite code col colgroup datalist dd del details dfn dialog div dl dt em embed fieldset figcaption figure footer form h1 h2 h3 h4 h5 h6 header hr i iframe img input ins kbd label legend li link main map mark menu menuitem meta meter nav noscript object ol optgroup option output p param picture pre progress q rp rt ruby s samp script section select small source span strong style sub summary sup table tbody td template textarea tfoot th thead time title tr track u ul var video wbr".split(" "))t.HTML[e]=function(...t){return i(document.createElement(e),t)};for(const e of"a altGlyph altGlyphDef altGlyphItem animate animateMotion animateTransform circle clipPath color-profile cursor defs desc discard ellipse feBlend feColorMatrix feComponentTransfer feComposite feConvolveMatrix feDiffuseLighting feDisplacementMap feDistantLight feDropShadow feFlood feFuncA feFuncB feFuncG feFuncR feGaussianBlur feImage feMerge feMergeNode feMorphology feOffset fePointLight feSpecularLighting feSpotLight feTile feTurbulence filter font font-face font-face-format font-face-name font-face-src font-face-uri foreignObject g glyph glyphRef hkern image line linearGradient marker mask metadata missing-glyph mpath path pattern polygon polyline radialGradient rect script set stop style svg switch symbol text textPath title tref tspan use view vkern".split(" "))t.SVG[e]=function(...t){return i(document.createElementNS(s,e),t)};t.prettyNumber=function(t){return t.toFixed(2).replace(/\.?0*$/,"")}}(beepbox||(beepbox={})),function(t){const e=document.createElement("style");e.type="text/css",e.appendChild(document.createTextNode('\n\n.beepboxEditor {\n\tdisplay: flex;\n\tposition: relative;\n\ttouch-action: manipulation;\n\tcursor: default;\n\tfont-size: small;\n\toverflow: hidden;\n}\n\n.beepboxEditor .noSelection {\n\t-webkit-touch-callout: none;\n\t-webkit-user-select: none;\n\t-moz-user-select: none;\n\t-ms-user-select: none;\n\tuser-select: none;\n}\n\n.beepboxEditor div {\n\tmargin: 0;\n\tpadding: 0;\n}\n\n.beepboxEditor .tip {\n\tcursor: help;\n}\n\n.beepboxEditor .tip:hover {\n\tcolor: #98f;\n\ttext-decoration: underline;\n}\n.beepboxEditor .tip:active {\n\tcolor: white;\n}\n\n.beepboxEditor .promptContainer {\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 100%;\n\tbackground: rgba(0,0,0,0.5);\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-items: center;\n}\n\n.beepboxEditor .prompt {\n\tmargin: auto;\n\ttext-align: center;\n\tbackground: #000;\n\tborder-radius: 15px;\n\tborder: 4px solid #444;\n\tcolor: #fff;\n\tpadding: 20px;\n\tdisplay: flex;\n\tflex-direction: column;\n\tposition: relative;\n}\n\n.beepboxEditor .prompt > *:not(:first-child):not(.cancelButton) {\n\tmargin-top: 1.5em;\n}\n\n.beepboxEditor .prompt h2 {\n\tfont-size: 2em;\n\tmargin: 0 16px;\n\tfont-weight: normal;\n}\n\n.beepboxEditor .prompt p {\n\ttext-align: left;\n\tmargin: 1em 0;\n}\n\n/* Use psuedo-elements to add cross-browser up & down arrows to select elements: */\n.beepboxEditor .selectContainer {\n\tposition: relative;\n}\n.beepboxEditor .selectContainer:not(.menu)::before {\n\tcontent: "";\n\tposition: absolute;\n\tright: 0.3em;\n\ttop: 0.4em;\n\tborder-bottom: 0.4em solid currentColor;\n\tborder-left: 0.3em solid transparent;\n\tborder-right: 0.3em solid transparent;\n\tpointer-events: none;\n}\n.beepboxEditor .selectContainer:not(.menu)::after {\n\tcontent: "";\n\tposition: absolute;\n\tright: 0.3em;\n\tbottom: 0.4em;\n\tborder-top: 0.4em solid currentColor;\n\tborder-left: 0.3em solid transparent;\n\tborder-right: 0.3em solid transparent;\n\tpointer-events: none;\n}\n.beepboxEditor .selectContainer.menu::after {\n\tcontent: "";\n\tposition: absolute;\n\tright: 0.7em;\n\tmargin: auto;\n\ttop: 0;\n\tbottom: 0;\n\theight: 0;\n\tborder-top: 0.4em solid currentColor;\n\tborder-left: 0.3em solid transparent;\n\tborder-right: 0.3em solid transparent;\n\tpointer-events: none;\n}\n.beepboxEditor select {\n\tmargin: 0;\n\tpadding: 0 0.3em;\n\tdisplay: block;\n\theight: 2em;\n\tborder: none;\n\tborder-radius: 0.4em;\n\tbackground: #444444;\n\tcolor: inherit;\n\tfont-size: inherit;\n\tcursor: pointer;\n\tfont-family: inherit;\n\n\t-webkit-appearance:none;\n\t-moz-appearance: none;\n\tappearance: none;\n}\n.beepboxEditor .menu select {\n\tpadding: 0 2em;\n}\n.beepboxEditor select:focus {\n\tbackground: #777777;\n\toutline: none;\n}\n.beepboxEditor .menu select {\n\ttext-align: center;\n\ttext-align-last: center;\n}\n.beepboxEditor .editor-settings select {\n\twidth: 100%;\n}\n\n/* This makes it look better in firefox on my computer... What about others?\n@-moz-document url-prefix() {\n\t.beepboxEditor select { padding: 0 2px; }\n}\n*/\n.beepboxEditor button {\n\tmargin: 0;\n\tposition: relative;\n\theight: 2em;\n\tborder: none;\n\tborder-radius: 0.4em;\n\tbackground: #444;\n\tcolor: inherit;\n\tfont-size: inherit;\n\tfont-family: inherit;\n\tcursor: pointer;\n}\n.beepboxEditor button:focus {\n\tbackground: #777;\n\toutline: none;\n}\n\n.beepboxEditor button.cancelButton {\n\tfloat: right;\n\twidth: 2em;\n\tposition: absolute;\n\ttop: 8px;\n\tright: 8px;\n}\n\n.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.okayButton, .beepboxEditor button.exportButton {\n\tpadding-left: 2em;\n}\n.beepboxEditor button.playButton::before {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 0.7em;\n\ttop: 50%;\n\tmargin-top: -0.65em;\n\tborder-left: 1em solid currentColor;\n\tborder-top: 0.65em solid transparent;\n\tborder-bottom: 0.65em solid transparent;\n\tpointer-events: none;\n}\n.beepboxEditor button.pauseButton::before {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 0.7em;\n\ttop: 50%;\n\tmargin-top: -0.65em;\n\twidth: 0.3em;\n\theight: 1.3em;\n\tbackground: currentColor;\n\tpointer-events: none;\n}\n.beepboxEditor button.pauseButton::after {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 1.4em;\n\ttop: 50%;\n\tmargin-top: -0.65em;\n\twidth: 0.3em;\n\theight: 1.3em;\n\tbackground: currentColor;\n\tpointer-events: none;\n}\n\n.beepboxEditor button.prevBarButton::before {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\tmargin-left: -0.5em;\n\tmargin-top: -0.5em;\n\twidth: 0.2em;\n\theight: 1em;\n\tbackground: currentColor;\n\tpointer-events: none;\n}\n.beepboxEditor button.prevBarButton::after {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\tmargin-left: -0.3em;\n\tmargin-top: -0.5em;\n\tborder-right: 0.8em solid currentColor;\n\tborder-top: 0.5em solid transparent;\n\tborder-bottom: 0.5em solid transparent;\n\tpointer-events: none;\n}\n\n.beepboxEditor button.nextBarButton::before {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\tmargin-left: -0.5em;\n\tmargin-top: -0.5em;\n\tborder-left: 0.8em solid currentColor;\n\tborder-top: 0.5em solid transparent;\n\tborder-bottom: 0.5em solid transparent;\n\tpointer-events: none;\n}\n.beepboxEditor button.nextBarButton::after {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\tmargin-left: 0.3em;\n\tmargin-top: -0.5em;\n\twidth: 0.2em;\n\theight: 1em;\n\tbackground: currentColor;\n\tpointer-events: none;\n}\n\n.beepboxEditor button.cancelButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: 2em;\n\theight: 2em;\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground-image: url(\'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="white" d="M -8 -6 L -6 -8 L 0 -2  L 6 -8 L 8 -6 L 2 0 L 8 6 L 6 8 L 0 2 L -6 8 L -8 6 L -2 0 z"></path></svg>\');\n\tbackground-repeat: no-repeat;\n}\n\n.beepboxEditor button.okayButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: 2em;\n\theight: 2em;\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground-image: url(\'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="white" d="M -9 -2 L -8 -3 L -3 2 L 9 -8 L 10 -7 L -3 8 z"></path></svg>\');\n\tbackground-repeat: no-repeat;\n}\n\n.beepboxEditor button.exportButton::before {\n\tcontent: "";\n\tposition: absolute;\n\twidth: 2em;\n\theight: 2em;\n\tleft: 0;\n\ttop: 0;\n\tpointer-events: none;\n\tbackground-image: url(\'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="white" d="M -8 3 L -8 8 L 8 8 L 8 3 L 6 3 L 6 6 L -6 6 L -6 3 z M 0 2 L -4 -2 L -1 -2 L -1 -8 L 1 -8 L 1 -2 L 4 -2 z"></path></svg>\');\n\tbackground-repeat: no-repeat;\n}\n\n.beepboxEditor canvas {\n\toverflow: hidden;\n\tposition: absolute;\n\tdisplay: block;\n}\n\n.beepboxEditor .trackContainer {\n\toverflow-x: hidden;\n}\n\n.beepboxEditor .selectRow {\n\tmargin: 2px 0;\n\theight: 2em;\n\tdisplay: flex;\n\tflex-direction: row;\n\talign-items: center;\n\tjustify-content: space-between;\n}\n\n.beepboxEditor .selectRow > span:first-child {\n\tcolor: #999;\n}\n\n.beepboxEditor .operatorRow {\n\tmargin: 2px 0;\n\theight: 2em;\n\tdisplay: flex;\n\tflex-direction: row;\n\talign-items: center;\n}\n\n.beepboxEditor .operatorRow > * {\n\tflex-grow: 1;\n\tflex-shrink: 1;\n}\n\n.beepboxEditor .editor-widget-column {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-widgets {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-controls {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-menus {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n.beepboxEditor .editor-menus > * {\n\tflex-grow: 1;\n\tmargin: 2px 0;\n}\n.beepboxEditor .editor-menus > button {\n\tpadding: 0 2em;\n\twhite-space: nowrap;\n}\n\n.beepboxEditor .editor-settings {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-song-settings {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-instrument-settings {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-right-side-top > *, .beepboxEditor .editor-right-side-bottom > * {\n\tflex-shrink: 0;\n}\n\n.beepboxEditor input[type=text], .beepboxEditor input[type=number] {\n\tfont-size: inherit;\n\tbackground: transparent;\n\tborder: 1px solid #777;\n\tcolor: white;\n}\n\n.beepboxEditor input[type=text]::selection, .beepboxEditor input[type=number]::selection {\n\t/*background: #7744ff; ugh browsers override the alpha. */\n\tbackground-color: rgba(119,68,255,0.99);\n\tcolor: white;\n}\n\n.beepboxEditor input[type=checkbox] {\n  transform: scale(1.5);\n}\n\n.beepboxEditor input[type=range] {\n\t-webkit-appearance: none;\n\tcolor: inherit;\n\twidth: 100%;\n\theight: 2em;\n\tfont-size: inherit;\n\tmargin: 0;\n\tcursor: pointer;\n\tbackground-color: black;\n\ttouch-action: pan-y;\n}\n.beepboxEditor input[type=range]:focus {\n\toutline: none;\n}\n.beepboxEditor input[type=range]::-webkit-slider-runnable-track {\n\twidth: 100%;\n\theight: 0.5em;\n\tcursor: pointer;\n\tbackground: #444;\n}\n.beepboxEditor input[type=range]::-webkit-slider-thumb {\n\theight: 2em;\n\twidth: 0.5em;\n\tborder-radius: 0.25em;\n\tbackground: currentColor;\n\tcursor: pointer;\n\t-webkit-appearance: none;\n\tmargin-top: -0.75em;\n}\n.beepboxEditor input[type=range]:focus::-webkit-slider-runnable-track {\n\tbackground: #777;\n}\n.beepboxEditor input[type=range]::-moz-range-track {\n\twidth: 100%;\n\theight: 0.5em;\n\tcursor: pointer;\n\tbackground: #444;\n}\n.beepboxEditor input[type=range]:focus::-moz-range-track {\n\tbackground: #777;\n}\n.beepboxEditor input[type=range]::-moz-range-thumb {\n\theight: 2em;\n\twidth: 0.5em;\n\tborder-radius: 0.25em;\n\tborder: none;\n\tbackground: currentColor;\n\tcursor: pointer;\n}\n.beepboxEditor input[type=range]::-ms-track {\n\twidth: 100%;\n\theight: 0.5em;\n\tcursor: pointer;\n\tbackground: #444;\n\tborder-color: transparent;\n}\n.beepboxEditor input[type=range]:focus::-ms-track {\n\tbackground: #777;\n}\n.beepboxEditor input[type=range]::-ms-thumb {\n\theight: 2em;\n\twidth: 0.5em;\n\tborder-radius: 0.25em;\n\tbackground: currentColor;\n\tcursor: pointer;\n}\n.beepboxEditor .hintButton {\n\tborder: 1px solid currentColor;\n\tborder-radius: 50%;\n\ttext-decoration: none;\n\twidth: 1em;\n\theight: 1em;\n\ttext-align: center;\n\tmargin-left: auto;\n\tmargin-right: .4em;\n\tcursor: pointer;\n}\n\n/* wide screen */\n@media (min-width: 701px) {\n\t#beepboxEditorContainer {\n\t\tdisplay: table;\n\t}\n\t.beepboxEditor {\n\t\tflex-direction: row;\n\t}\n\t.beepboxEditor:focus-within {\n\t\toutline: 3px solid #555;\n\t}\n\t.beepboxEditor .trackContainer {\n\t\twidth: 512px;\n\t}\n\t.beepboxEditor .trackSelectBox {\n\t\tdisplay: none;\n\t}\n\t.beepboxEditor .playback-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t}\n\t.beepboxEditor .playback-bar-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmargin: 2px 0;\n\t}\n\t.beepboxEditor .playback-volume-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmargin: 2px 0;\n\t\talign-items: center;\n\t}\n\t.beepboxEditor .pauseButton, .beepboxEditor .playButton {\n\t\tflex-grow: 1;\n\t}\n\t.beepboxEditor .nextBarButton, .beepboxEditor .prevBarButton {\n\t\tflex-grow: 1;\n\t\tmargin-left: 10px;\n\t}\n\t.beepboxEditor .editor-widget-column {\n\t\tmargin-left: 6px;\n\t\twidth: 14em;\n\t\tflex-direction: column;\n\t}\n\t.beepboxEditor .editor-widgets {\n\t\tflex-grow: 1;\n\t}\n\t.beepboxEditor .selectRow > :nth-child(2) {\n\t\twidth: 8.6em;\n\t}\n}\n\n/* narrow screen */\n@media (max-width: 700px) {\n\t.beepboxEditor {\n\t\tflex-direction: column;\n\t}\n\t.beepboxEditor:focus-within {\n\t\toutline: none;\n\t}\n\t.beepboxEditor .editorBox {\n\t\tmax-height: 75vh;\n\t}\n\t.beepboxEditor .trackContainer {\n\t\toverflow-x: auto;\n\t}\n\t.beepboxEditor .barScrollBar {\n\t\tdisplay: none;\n\t}\n\t.beepboxEditor .playback-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmargin: 2px 0;\n\t}\n\t.beepboxEditor .playback-bar-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tflex-grow: 1;\n\t}\n\t.beepboxEditor .playback-volume-controls {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\talign-items: center;\n\t\tflex-grow: 1;\n\t\tmargin: 0 2px;\n\t}\n\t.beepboxEditor .editor-widget-column {\n\t\tflex-direction: column-reverse;\n\t}\n\t.beepboxEditor .editor-settings {\n\t\tflex-direction: row;\n\t}\n\t.beepboxEditor .pauseButton, .beepboxEditor .playButton,\n\t.beepboxEditor .nextBarButton, .beepboxEditor .prevBarButton {\n\t\tflex-grow: 1;\n\t\tmargin: 0 2px;\n\t}\n\t.beepboxEditor .editor-song-settings, .beepboxEditor .editor-instrument-settings {\n\t\tflex-grow: 1;\n\t\tflex-basis: 0;\n\t\tmargin: 0 4px;\n\t}\n\t.beepboxEditor .selectRow > :nth-child(2) {\n\t\twidth: 60%;\n\t}\n\t.fullWidthOnly {\n\t\tdisplay: none;\n\t}\n}\n\n')),document.head.appendChild(e)}(beepbox||(beepbox={})),function(t){const{button:e,div:i,p:s,h2:n}=t.HTML;t.TipPrompt=class{constructor(t,o){let h;switch(this.X=t,this.K=e({className:"cancelButton"}),this._=(()=>{this.X.undo()}),this.cleanUp=(()=>{this.K.removeEventListener("click",this._)}),o){case"scale":h=i(n("Scale"),s("This setting limits the available pitches for adding notes. You may think that there's no point in limiting your choices, but the set of pitches you use has a strong influence on the mood and feel of your song, and these scales serve as guides to help you choose appropriate pitches. Don't worry, you can change the scale at any time, so you're not locked into it. Try making little melodies using all the available notes of a scale to get a sense for how it sounds."),s('Most of the scales have a major version, marked with a smiley face, and a minor version, marked with a sad face. Major scales tend to sound more playful or optimistic if you emphasize "tonic" notes (the brown rows in the pattern editor) at various points in your melody, whereas minor scales sound more serious or sad if you emphasize "tonic" notes.'));break;case"key":h=i(n("Song Key"),s('This setting can shift the frequency of every note in your entire song up or down to align the tonic notes (the brown rows) with the selected "key" pitch.'));break;case"tempo":h=i(n("Song Tempo"),s("This setting controls the speed of your song, measured in beats-per-minute."));break;case"reverb":h=i(n("Reverb"),s("Reverb is a kind of echo effect. You can use this slider to control the amount of reverb for instruments that enable it. A little bit helps instruments sound more natural. Adding a lot of reverb can add sense of depth or mystery."));break;case"rhythm":h=i(n("Rhythm"),s("This setting determines how beats are divided. The pattern editor helps you align notes to fractions of a beat based on this setting."));break;case"instrumentIndex":h=i(n("Instrument Number"),s("BeepBox can have multiple instruments per channel, but it can only play one instrument at a time in each channel. This setting determines which of the instruments should be used to play the currently selected pattern. Different patterns in the channel can use different instruments."));break;case"instrumentVolume":h=i(n("Instrument Volume"),s("This setting controls the volume of the selected instrument without affecting the volume of the other instruments. This allows you to balance the loudness of each instrument relative to each other."));break;case"instrumentType":h=i(n("Instrument Type"),s("BeepBox comes with many instrument presets. You can also create your own custom instruments, or even generate random ones!"));break;case"filterCutoff":h=i(n("Low-Pass Filter Cutoff Frequency"),s('The lowest setting feels "muffled" or "dark", and the highest setting feels "harsh" or "bright".'),s("Most sounds include a range of frequencies from low to high. BeepBox instruments have a filter that allows the lowest frequencies to pass through at full volume, but can reduce the volume of the higher frequencies that are above a cutoff frequency. This setting controls the cutoff frequency and thus the range of higher frequencies that are reduced."),s("This cutoff setting also determines which frequency resonates when the resonance peak setting is used."));break;case"filterResonance":h=i(n("Low-Pass Filter Resonance Peak"),s("Increasing this setting emphasizes a narrow range of frequencies, based on the position of the filter cutoff setting. This can be used to imitate the resonant bodies of acoustic instruments and other interesting effects."),s("The filter preserves the volume of frequencies that are below the cutoff frequency, and reduces the volume of frequencies that are above the cutoff. If this setting is used, the filter also increases the volume of frequencies that are near the cutoff."));break;case"filterEnvelope":h=i(n("Low-Pass Filter Envelope"),s("This setting can dynamically change the filter cutoff frequency over time. Try the different options to see how they sound!"),s('The "custom" option uses the note volume as drawn in the pattern editor as the cutoff envelope.'));break;case"transition":h=i(n("Transition"),s("This setting controls how quickly notes begin and end."),s("Hard transitions start suddenly and sound like instruments that are played by hitting or plucking, whereas soft transitions start gradually and sound like instruments that are played by blowing air. Some transitions stop suddenly, but some fade out slowly after the end of the note."),s('The "seamless" and "slide" transitions connect the end of a note with the start of the next note.'));break;case"chipWave":h=i(n("Chip Wave"),s("BeepBox comes with some sound waves based on classic electronic sound chips, as well as several unique waves."));break;case"chipNoise":h=i(n("Noise"),s("BeepBox comes with several basic noise sounds. These do not have any distinct musical pitch, and can be used like drums to create beats and emphasize your song's rhythm."));break;case"pulseEnvelope":h=i(n("Pulse Wave Envelope"),s("This setting can dynamically change the pulse width over time. Try the different options to see how they sound!"),s('The "custom" option uses the note volume as drawn in the pattern editor as the pulse width envelope.'));break;case"pulseWidth":h=i(n("Pulse Wave Width"),s("This setting controls the shape and sound of a pulse wave. At the minimum width, it sounds light and buzzy. At the maximum width, it is shaped like a classic square wave."));break;case"interval":h=i(n("Instrument Interval"),s('Some BeepBox instrument types can play two waves at slightly different frequencies. The difference between the frequencies is called an "interval", and this setting controls how large it is.'),s("When two similar waves play at slightly different frequencies, they move in and out of phase with each other over time as different parts of the waves line up. This creates a dynamic, shifting sound. Pianos are a common example of this kind of sound, because each piano key strikes multiple strings that are tuned to slightly different frequencies."),s('If the interval is large, then the waves can sound out-of-tune and "dissonant". If the interval is even larger, then the two frequencies can even be distinct pitches.'));break;case"chords":h=i(n("Chords"),s("When multiple notes occur at the same time, this is called a chord. Chords can be created in BeepBox's pattern editor by adding notes above or below another note."),s('This setting determines how chords are played. The standard option is "harmony" which plays all of the notes out loud simultaneously. The "strum" option is similar, but plays the notes starting at slightly different times. The "arpeggio" option is used in "chiptune" style music and plays a single tone that rapidly alternates between all of the pitches in the chord.'),s('Some BeepBox instruments have an option called "custom interval" which uses the chord notes to control the interval between the waves of a single tone. This can create strange sound effects when combined with FM modulators.'));break;case"vibrato":h=i(n("Vibrato"),s("This setting causes the frequency of a note to wobble slightly. Singers and violinists often use vibrato."));break;case"algorithm":h=i(n("FM Algorithm"),s("FM Synthesis is a mysterious but powerful technique for crafting sounds, popularized by Yamaha keyboards and the Sega Genesis/Mega Drive. It may seem confusing, but try playing around with the options until you get a feel for it, or check out some of the preset examples!"),s("This FM synthesizer uses up to four waves, numbered 1, 2, 3, and 4. Each wave may have its own frequency, volume, and volume envelope to control its effect over time."),s('There are two kinds of waves: "carrier" waves play a tone out loud, but "modulator" waves distort other waves instead. Wave 1 is always a carrier and plays a tone, but other waves may distort it. The "Algorithm" setting determines which waves are modulators, and which other waves those modulators distort. For example, "1←2" means that wave 2 is modulating wave 1, and wave 1 is played out loud.'));break;case"feedbackType":h=i(n("Feedback"),s("Modulators distort in one direction (like 1←2), but you can also use the feedback setting to make any wave distort in the opposite direction (1→2), or even itself (1⟲)."));break;case"operatorFrequency":h=i(n("Operator Frequency"),s('This setting controls the frequency of an individual FM wave. The fundamental frequency (1×) is determined by the pitch of the note, and the frequency (2×) is an octave (12 semitones) above it. The frequencies with a "~" are slightly detuned and shift in and out of phase over time compared to the other frequencies.'),s('Try different combinations of a "carrier" wave and a "modulator" wave with different frequencies to get a feel for how they sound together.'));break;case"operatorVolume":h=i(n("Operator Volume"),s('This setting controls the volume of "carrier" waves, or the amount of distortion that "modulator" waves apply to other waves.'));break;case"operatorEnvelope":h=i(n("Operator Envelope"),s("This setting can dynamically change the FM wave volume over time. Try the different options to see how they sound!"),s('The "custom" option uses the note volume as drawn in the pattern editor as the FM wave envelope.'));break;case"spectrum":h=i(n("Spectrum"),s("This setting allows you to draw your own noise spectrum! This is good for making drum sounds when combined with a hard transition and a falling filter cutoff envelope."),s("If you only use certain frequencies and a soft transition, it's also possible to make howling wind sounds or even musical blown bottle sounds."),s("The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies."));break;case"harmonics":h=i(n("Harmonics"),s("This setting allows you to design your own sound wave! Most musical waves are actually a combination of sine waves at certain frequencies, and this lets you control the volume of each sine wave individually."),s("The left side of the harmonics editor controls the sine wave volumes at lower frequencies, and the right side controls higher frequencies."));break;case"effects":h=i(n("Effects"),s("BeepBox has two special effects you can add to instruments. You can turn on either effect, or both at once."),s('Reverb is a kind of echo effect. You can use the "reverb" slider in the "Song Settings" section above to control the amount of reverb for instruments that enable it. A little bit helps instruments sound more natural. Adding a lot of reverb can add sense of depth or mystery.'),s("The chorus effect combines multiple copies of the instrument's sound and adds a bit of vibrato to simulate an ensemble of instruments or voices."));break;case"drumsetEnvelope":h=i(n("Drumset Envelope"),s("This setting can dynamically change the filter cutoff frequency over time. Each row in the pattern editor gets its own envelope."),s('The "custom" option uses the note volume as drawn in the pattern editor as the drumset cutoff envelope.'));break;case"drumsetSpectrum":h=i(n("Drumset Spectrum"),s("This setting allows you to draw your own noise spectrum! This is good for making drumsets. Each row in the pattern editor gets its own spectrum."),s("The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies."));break;default:throw new Error("Unhandled TipPrompt type: "+o)}this.container=i({className:"prompt",style:"width: 250px;"},h,this.K),setTimeout(()=>this.K.focus()),this.K.addEventListener("click",this._)}}}(beepbox||(beepbox={})),function(t){class e{constructor(){this.$=!0}tt(){this.$=!1}isNoop(){return this.$}commit(){}}t.Change=e;class i extends e{constructor(t){super(),this.et=t,this.it=!t}undo(){this.et?(this.st(),this.it=!0):(this.nt(),this.it=!1)}redo(){this.et?(this.nt(),this.it=!1):(this.st(),this.it=!0)}ot(){return this.it}st(){throw new Error("Change.doForwards(): Override me.")}nt(){throw new Error("Change.doBackwards(): Override me.")}}t.UndoableChange=i;t.ChangeGroup=class extends e{constructor(){super()}append(t){t.isNoop()||this.tt()}};t.ChangeSequence=class extends i{constructor(t){super(!1),this.ht=void 0==t?[]:t.concat()}append(t){t.isNoop()||(this.ht[this.ht.length]=t,this.tt())}st(){for(let t=0;t<this.ht.length;t++)this.ht[t].redo()}nt(){for(let t=this.ht.length-1;t>=0;t--)this.ht[t].undo()}}}(beepbox||(beepbox={})),function(t){function e(e,i,s,n,o){const h=new t.Note(-1,s,n,3,!1);o.push(h),h.pins.length=0,h.pitches.length=0;const r=n-s;for(const t of e.pitches)h.pitches.push(t);for(let s=0;s<e.pins.length;s++){const n=e.pins[s],o=n.time+i;if(o<0){if(s+1>=e.pins.length)throw new Error("Error converting pins in note overflow.");const r=e.pins[s+1],a=r.time+i;if(a>0){const e=-o/(a-o);h.pins.push(t.makeNotePin(Math.round(n.interval+e*(r.interval-n.interval)),0,Math.round(n.volume+e*(r.volume-n.volume))))}}else if(o<=r)h.pins.push(t.makeNotePin(n.interval,o,n.volume));else{if(s<1)throw new Error("Error converting pins in note overflow.");const a=e.pins[s-1],l=a.time+i;if(l<r){const e=(r-l)/(o-l);h.pins.push(t.makeNotePin(Math.round(a.interval+e*(n.interval-a.interval)),r,Math.round(a.volume+e*(n.volume-a.volume))))}}}}class i extends t.ChangeGroup{constructor(i,s,n){super();const o=[],h=[];for(let r=0;r<i.song.getChannelCount();r++){const a=i.song.channels[r],l=new t.Channel;r<i.song.pitchChannelCount?o.push(l):h.push(l),l.octave=a.octave;for(const t of a.instruments)l.instruments.push(t);const c=t.Config.partsPerBeat*i.song.beatsPerBar,f=t.Config.partsPerBeat*s;let u=-1,d=null;for(let s=0;s<i.song.barCount;s++){const o=i.song.getPattern(r,s);if(null!=o){const i=s*c;for(const s of o.notes){const h=s.start+i+n,r=s.end+i+n,a=Math.floor(h/f),c=Math.ceil(r/f);for(let i=a;i<c;i++){const n=i*f,a=Math.max(0,h-n),c=Math.min(f,r-n);if(a<c){if(u!=i||null==d){for(u++;u<i;)l.bars[u]=0,u++;d=new t.Pattern,l.patterns.push(d),l.bars[u]=l.patterns.length,d.instrument=o.instrument}e(s,h-n-a,a,c,d.notes)}}}}}}c(o),c(h),this.append(new l(i,o,h))}}t.ChangeMoveAndOverflowNotes=i;class s extends t.UndoableChange{constructor(t,e){super(!1),this.X=t,this.rt=e,this.at=this.rt.start,this.lt=this.rt.end,this.ct=this.rt.start,this.ft=this.rt.end,this.ut=this.rt.pins,this.dt=[],this.pt=this.rt.pitches,this.yt=[]}gt(){for(let t=0;t<this.dt.length-1;)this.dt[t].time>=this.dt[t+1].time?this.dt.splice(t,1):t++;for(let t=1;t<this.dt.length-1;)this.dt[t-1].interval==this.dt[t].interval&&this.dt[t].interval==this.dt[t+1].interval&&this.dt[t-1].volume==this.dt[t].volume&&this.dt[t].volume==this.dt[t+1].volume?this.dt.splice(t,1):t++;const t=this.dt[0].interval,e=this.dt[0].time;for(let e=0;e<this.pt.length;e++)this.yt[e]=this.pt[e]+t;for(let i=0;i<this.dt.length;i++)this.dt[i].interval-=t,this.dt[i].time-=e;this.ct=this.at+e,this.ft=this.ct+this.dt[this.dt.length-1].time,this.st(),this.tt()}st(){this.rt.pins=this.dt,this.rt.pitches=this.yt,this.rt.start=this.ct,this.rt.end=this.ft,this.X.notifier.changed()}nt(){this.rt.pins=this.ut,this.rt.pitches=this.pt,this.rt.start=this.at,this.rt.end=this.lt,this.X.notifier.changed()}}t.ChangePins=s;t.ChangeCustomizeInstrument=class extends t.Change{constructor(t){super();const e=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];e.preset!=e.type&&(e.preset=e.type,t.notifier.changed(),this.tt())}};t.ChangePreset=class extends t.Change{constructor(e,i){super();const s=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];if(s.preset!=i){const n=t.EditorConfig.valueToPreset(i);if(null!=n)if(void 0!=n.customType)s.type=n.customType,!t.Config.instrumentTypeHasSpecialInterval[s.type]&&t.Config.chords[s.chord].isCustomInterval&&(s.chord=0),t.Config.instrumentTypeHasChorus[s.type]||-1==t.Config.effectsNames[s.effects].indexOf("chorus")||(s.effects-=2);else if(void 0!=n.settings){const t=s.volume;s.fromJsonObject(n.settings,e.song.getChannelIsNoise(e.channel)),s.volume=t}s.preset=i,e.notifier.changed(),this.tt()}}};t.ChangeRandomGeneratedInstrument=class extends t.Change{constructor(e){function i(t){let e=0;for(const i of t)e+=i.weight;let i=Math.random()*e;for(const e of t)if((i-=e.weight)<=0)return e.item;return t[Math.random()*t.length|0].item}function s(t,e,s,n){const o=[];for(let i=t;i<=e;i++)o.push({item:i,weight:1/(Math.pow((i-s)/n,2)+1)});return i(o)}super();const n=e.song.getChannelIsNoise(e.channel),o=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];if(n){const e=i([{item:2,weight:1},{item:3,weight:3}]);function h(e){let i=0;for(const t of e)t>i&&(i=t);for(let s=0;s<e.length;s++)e[s]=t.Config.harmonicsMax*e[s]/i}switch(o.preset=o.type=e,o.filterCutoff=s(4,t.Config.filterCutoffRange-1,t.Config.filterCutoffRange-2,2),o.filterResonance=s(0,t.Config.filterResonanceRange-1,1,2),o.filterEnvelope=t.Config.envelopes.dictionary[i([{item:"steady",weight:2},{item:"punch",weight:4},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:8},{item:"twang 2",weight:8},{item:"twang 3",weight:8},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:4},{item:"decay 2",weight:4},{item:"decay 3",weight:4}])].index,o.transition=t.Config.transitions.dictionary[i([{item:"seamless",weight:1},{item:"hard",weight:4},{item:"soft",weight:2},{item:"slide",weight:1},{item:"cross fade",weight:2},{item:"hard fade",weight:8},{item:"medium fade",weight:2},{item:"soft fade",weight:1}])].index,o.effects=t.Config.effectsNames.indexOf(i([{item:"none",weight:1},{item:"reverb",weight:3}])),o.chord=t.Config.chords.dictionary[i([{item:"harmony",weight:4},{item:"strum",weight:2},{item:"arpeggio",weight:1}])].index,e){case 2:o.chipNoise=Math.random()*t.Config.chipNoises.length|0;break;case 3:{const e=[()=>{const e=[];for(let i=0;i<t.Config.spectrumControlPoints;i++)e[i]=Math.random()<.5?Math.random():0;return e},()=>{let e=1;const i=[e];for(let s=1;s<t.Config.spectrumControlPoints;s++)e*=Math.pow(2,Math.random()-.52),i[s]=e;return i},()=>{let e=1;const i=[e];for(let s=1;s<t.Config.spectrumControlPoints;s++)e*=Math.pow(2,Math.random()-.52),i[s]=e*Math.random();return i}],i=(0,e[Math.random()*e.length|0])();h(i);for(let e=0;e<t.Config.spectrumControlPoints;e++)o.spectrumWave.spectrum[e]=Math.round(i[e]);o.spectrumWave.markCustomWaveDirty()}break;default:throw new Error("Unhandled noise instrument type in random generator.")}}else{const e=i([{item:0,weight:4},{item:6,weight:4},{item:5,weight:6},{item:3,weight:1},{item:1,weight:4}]);function h(e){let i=0;for(const t of e)t>i&&(i=t);for(let s=0;s<e.length;s++)e[s]=t.Config.harmonicsMax*e[s]/i}switch(o.preset=o.type=e,o.filterCutoff=s(2,t.Config.filterCutoffRange-1,7,1.5),o.filterResonance=s(0,t.Config.filterResonanceRange-1,1,2),o.filterEnvelope=t.Config.envelopes.dictionary[i([{item:"steady",weight:10},{item:"punch",weight:6},{item:"flare 1",weight:2},{item:"flare 2",weight:4},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:4},{item:"twang 3",weight:4},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:2},{item:"decay 3",weight:2}])].index,o.transition=t.Config.transitions.dictionary[i([{item:"seamless",weight:1},{item:"hard",weight:4},{item:"soft",weight:4},{item:"slide",weight:2},{item:"cross fade",weight:4},{item:"hard fade",weight:4},{item:"medium fade",weight:2},{item:"soft fade",weight:2}])].index,o.effects=t.Config.effectsNames.indexOf(i([{item:"none",weight:1},{item:"reverb",weight:10},{item:"chorus",weight:t.Config.instrumentTypeHasChorus[e]?2:0},{item:"chorus & reverb",weight:t.Config.instrumentTypeHasChorus[e]?2:0}])),o.chord=t.Config.chords.dictionary[i([{item:"harmony",weight:7},{item:"strum",weight:2},{item:"arpeggio",weight:1}])].index,3!=e&&(o.vibrato=t.Config.vibratos.dictionary[i([{item:"none",weight:6},{item:"light",weight:2},{item:"delayed",weight:2},{item:"heavy",weight:1},{item:"shaky",weight:2}])].index),0!=e&&5!=e||(o.interval=t.Config.intervals.dictionary[i([{item:"union",weight:10},{item:"shimmer",weight:5},{item:"hum",weight:4},{item:"honky tonk",weight:3},{item:"dissonant",weight:1},{item:"fifth",weight:1},{item:"octave",weight:2},{item:"bowed",weight:2}])].index),e){case 0:o.chipWave=Math.random()*t.Config.chipWaves.length|0;break;case 6:o.pulseEnvelope=t.Config.envelopes.dictionary[i([{item:"steady",weight:10},{item:"punch",weight:6},{item:"flare 1",weight:2},{item:"flare 2",weight:4},{item:"flare 3",weight:2},{item:"twang 1",weight:4},{item:"twang 2",weight:4},{item:"twang 3",weight:4},{item:"swell 1",weight:4},{item:"swell 2",weight:4},{item:"swell 3",weight:4},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:2},{item:"tremolo5",weight:2},{item:"tremolo6",weight:2},{item:"decay 1",weight:2},{item:"decay 2",weight:2},{item:"decay 3",weight:2}])].index,o.pulseWidth=s(0,t.Config.pulseWidthRange-1,t.Config.pulseWidthRange-1,2);break;case 5:{const e=[()=>{const e=[];for(let i=0;i<t.Config.harmonicsControlPoints;i++)e[i]=Math.random()<.4?Math.random():0;return e[8*Math.random()|0]=Math.pow(Math.random(),.25),e},()=>{let e=1;const i=[e];for(let s=1;s<t.Config.harmonicsControlPoints;s++)e*=Math.pow(2,Math.random()-.55),i[s]=e;return i},()=>{let e=1;const i=[e];for(let s=1;s<t.Config.harmonicsControlPoints;s++)e*=Math.pow(2,Math.random()-.55),i[s]=e*Math.random();return i}],i=(0,e[Math.random()*e.length|0])();h(i);for(let e=0;e<t.Config.harmonicsControlPoints;e++)o.harmonicsWave.harmonics[e]=Math.round(i[e]);o.harmonicsWave.markCustomWaveDirty()}break;case 3:{const e=[];for(let i=0;i<t.Config.spectrumControlPoints;i++){const t=0==i||7==i||11==i||14==i||16==i||18==i||21==i;e[i]=t?Math.pow(Math.random(),.25):.5*Math.pow(Math.random(),3)}h(e);for(let i=0;i<t.Config.spectrumControlPoints;i++)o.spectrumWave.spectrum[i]=Math.round(e[i]);o.spectrumWave.markCustomWaveDirty()}break;case 1:{o.algorithm=Math.random()*t.Config.algorithms.length|0,o.feedbackType=Math.random()*t.Config.feedbacks.length|0;const e=t.Config.algorithms[o.algorithm];for(let i=0;i<e.carrierCount;i++)o.operators[i].frequency=s(0,t.Config.operatorFrequencies.length-1,0,3),o.operators[i].amplitude=s(0,t.Config.operatorAmplitudeMax,t.Config.operatorAmplitudeMax-1,2),o.operators[i].envelope=t.Config.envelopes.dictionary.custom.index;for(let n=e.carrierCount;n<t.Config.operatorCount;n++)o.operators[n].frequency=s(3,t.Config.operatorFrequencies.length-1,0,3),o.operators[n].amplitude=Math.pow(Math.random(),2)*t.Config.operatorAmplitudeMax|0,o.operators[n].envelope=t.Config.envelopes.dictionary[i([{item:"steady",weight:6},{item:"punch",weight:2},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:2},{item:"twang 3",weight:2},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:2},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index;o.feedbackAmplitude=Math.pow(Math.random(),3)*t.Config.operatorAmplitudeMax|0,o.feedbackEnvelope=t.Config.envelopes.dictionary[i([{item:"steady",weight:4},{item:"punch",weight:2},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:2},{item:"twang 3",weight:2},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:2},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index}break;default:throw new Error("Unhandled pitched instrument type in random generator.")}}e.notifier.changed(),this.tt()}};t.ChangeTransition=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.transition!=e&&(this.tt(),i.transition=e,i.preset=i.type,t.notifier.changed())}};t.ChangeEffects=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.effects!=e&&(this.tt(),i.effects=e,i.preset=i.type,t.notifier.changed())}};t.ChangePattern=class extends t.Change{constructor(t,e,i){if(super(),this.oldValue=e,i>t.song.patternsPerChannel)throw new Error("invalid pattern");t.song.channels[t.channel].bars[t.bar]=i,t.notifier.changed(),e!=i&&this.tt()}};t.ChangeBarCount=class extends t.Change{constructor(t,e,i){if(super(),t.song.barCount!=e){for(const s of t.song.channels)if(i){for(;s.bars.length<e;)s.bars.unshift(0);t.song.barCount>e&&s.bars.splice(0,t.song.barCount-e)}else{for(;s.bars.length<e;)s.bars.push(0);s.bars.length=e}if(i){const i=e-t.song.barCount;t.bar=Math.max(0,t.bar+i),(i<0||t.barScrollPos>0)&&(t.barScrollPos=Math.max(0,t.barScrollPos+i)),t.song.loopStart=Math.max(0,t.song.loopStart+i)}t.bar=Math.min(t.bar,e-1),t.barScrollPos=Math.max(0,Math.min(e-t.trackVisibleBars,t.barScrollPos)),t.song.loopLength=Math.min(e,t.song.loopLength),t.song.loopStart=Math.min(e-t.song.loopLength,t.song.loopStart),t.song.barCount=e,t.notifier.changed(),this.tt()}}};t.ChangeChannelCount=class extends t.Change{constructor(e,i,s){if(super(),e.song.pitchChannelCount!=i||e.song.noiseChannelCount!=s){const o=[];function n(i,s,n,r,a,l){for(let c=0;c<i;c++){const i=c+n,f=c+r;if(c<s)o[i]=e.song.channels[f];else{o[i]=new t.Channel,o[i].octave=a;for(let s=0;s<e.song.instrumentsPerChannel;s++){const e=new t.Instrument(l),n=h(l),r=t.EditorConfig.valueToPreset(n);e.fromJsonObject(r.settings,l),e.preset=n,o[i].instruments[s]=e}for(let s=0;s<e.song.patternsPerChannel;s++)o[i].patterns[s]=new t.Pattern;for(let t=0;t<e.song.barCount;t++)o[i].bars[t]=1}}}n(i,e.song.pitchChannelCount,0,0,2,!1),n(s,e.song.noiseChannelCount,i,e.song.pitchChannelCount,0,!0),e.song.pitchChannelCount=i,e.song.noiseChannelCount=s;for(let t=0;t<e.song.getChannelCount();t++)e.song.channels[t]=o[t];e.song.channels.length=e.song.getChannelCount(),e.channel=Math.min(e.channel,i+s-1),e.notifier.changed(),this.tt()}}};t.ChangeChannelBar=class extends t.Change{constructor(t,e,i){super();const s=t.channel,n=t.bar;t.channel=e,t.bar=i,t.barScrollPos=Math.min(t.bar,Math.max(t.bar-(t.trackVisibleBars-1),t.barScrollPos)),t.notifier.changed(),s==e&&n==i||this.tt()}};t.ChangeInterval=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.interval!=e&&(this.tt(),i.interval=e,i.preset=i.type,t.notifier.changed())}};t.ChangeChord=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.chord!=e&&(this.tt(),i.chord=e,i.preset=i.type,t.notifier.changed())}};t.ChangeVibrato=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.vibrato!=e&&(i.vibrato=e,i.preset=i.type,t.notifier.changed(),this.tt())}};t.ChangeSpectrum=class extends t.Change{constructor(t,e,i){super(),i.markCustomWaveDirty(),e.preset=e.type,t.notifier.changed(),this.tt()}};t.ChangeHarmonics=class extends t.Change{constructor(t,e,i){super(),i.markCustomWaveDirty(),e.preset=e.type,t.notifier.changed(),this.tt()}};t.ChangeDrumsetEnvelope=class extends t.Change{constructor(t,e,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.drumsetEnvelopes[e]!=i&&(s.drumsetEnvelopes[e]=i,s.preset=s.type,t.notifier.changed(),this.tt())}};class n extends t.Change{constructor(t){super(),this.X=t,this.vt=this.X.song.channels[this.X.channel].instruments[this.X.getCurrentInstrument()]}commit(){this.isNoop()||(this.vt.preset=this.vt.type,this.X.notifier.changed())}}t.ChangePulseWidth=class extends n{constructor(t,e,i){super(t),this.vt.pulseWidth=i,t.notifier.changed(),e!=i&&this.tt()}};t.ChangePulseEnvelope=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.pulseEnvelope!=e&&(i.pulseEnvelope=e,i.preset=i.type,t.notifier.changed(),this.tt())}};t.ChangeFilterCutoff=class extends n{constructor(t,e,i){super(t),this.vt.filterCutoff=i,t.notifier.changed(),e!=i&&this.tt()}};t.ChangeFilterResonance=class extends n{constructor(t,e,i){super(t),this.vt.filterResonance=i,t.notifier.changed(),e!=i&&this.tt()}};t.ChangeFilterEnvelope=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.filterEnvelope!=e&&(i.filterEnvelope=e,i.preset=i.type,t.notifier.changed(),this.tt())}};t.ChangeAlgorithm=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.algorithm!=e&&(i.algorithm=e,i.preset=i.type,t.notifier.changed(),this.tt())}};t.ChangeFeedbackType=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.feedbackType!=e&&(i.feedbackType=e,i.preset=i.type,t.notifier.changed(),this.tt())}};t.ChangeFeedbackEnvelope=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.feedbackEnvelope!=e&&(i.feedbackEnvelope=e,i.preset=i.type,t.notifier.changed(),this.tt())}};t.ChangeOperatorEnvelope=class extends t.Change{constructor(t,e,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.operators[e].envelope!=i&&(s.operators[e].envelope=i,s.preset=s.type,t.notifier.changed(),this.tt())}};t.ChangeOperatorFrequency=class extends t.Change{constructor(t,e,i){super();const s=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];s.operators[e].frequency!=i&&(s.operators[e].frequency=i,s.preset=s.type,t.notifier.changed(),this.tt())}};t.ChangeOperatorAmplitude=class extends n{constructor(t,e,i,s){super(t),this.vt.operators[e].amplitude=s,t.notifier.changed(),i!=s&&this.tt()}};t.ChangeFeedbackAmplitude=class extends n{constructor(t,e,i){super(t),this.vt.feedbackAmplitude=i,t.notifier.changed(),e!=i&&this.tt()}};t.ChangeInstrumentsPerChannel=class extends t.Change{constructor(e,i){if(super(),e.song.instrumentsPerChannel!=i){for(let s=0;s<e.song.getChannelCount();s++){const n=e.song.channels[s].instruments[e.song.instrumentsPerChannel-1],o=n.toJsonObject();for(let h=e.song.instrumentsPerChannel;h<i;h++){const i=new t.Instrument(e.song.getChannelIsNoise(s));4==n.type?i.setTypeAndReset(3,!0):i.fromJsonObject(o,e.song.getChannelIsNoise(s)),e.song.channels[s].instruments[h]=i}e.song.channels[s].instruments.length=i;for(let t=0;t<e.song.patternsPerChannel;t++)e.song.channels[s].patterns[t].instrument>=i&&(e.song.channels[s].patterns[t].instrument=0)}e.song.instrumentsPerChannel=i,e.notifier.changed(),this.tt()}}};t.ChangeKey=class extends t.Change{constructor(t,e){super(),t.song.key!=e&&(t.song.key=e,t.notifier.changed(),this.tt())}};t.ChangeLoop=class extends t.Change{constructor(t,e,i,s,n){super(),this.X=t,this.oldStart=e,this.oldLength=i,this.newStart=s,this.newLength=n,this.X.song.loopStart=this.newStart,this.X.song.loopLength=this.newLength,this.X.notifier.changed(),this.oldStart==this.newStart&&this.oldLength==this.newLength||this.tt()}};t.ChangePitchAdded=class extends t.UndoableChange{constructor(t,e,i,s,n=!1){super(n),this.X=t,this.rt=e,this.bt=i,this.wt=s,this.tt(),this.redo()}st(){this.rt.pitches.splice(this.wt,0,this.bt),this.X.notifier.changed()}nt(){this.rt.pitches.splice(this.wt,1),this.X.notifier.changed()}};t.ChangeOctave=class extends t.Change{constructor(t,e,i){super(),this.oldValue=e,t.song.channels[t.channel].octave=i,t.notifier.changed(),e!=i&&this.tt()}};t.ChangeRhythm=class extends t.ChangeGroup{constructor(t,e){super(),t.song.rhythm!=e&&(t.song.rhythm=e,t.notifier.changed(),this.tt())}};t.ChangePaste=class extends t.ChangeGroup{constructor(e,i,s,n){super(),i.notes.length=0;for(const e of s){const s=new t.Note(e.pitches[0],e.start,e.end,e.pins[0].volume,!1);s.pitches.length=0;for(const t of e.pitches)s.pitches.push(t);s.pins.length=0;for(const i of e.pins)s.pins.push(t.makeNotePin(i.interval,i.time,i.volume));i.notes.push(s)}e.song.beatsPerBar<n&&this.append(new d(e,i,e.song.beatsPerBar*t.Config.partsPerBeat,n*t.Config.partsPerBeat)),e.notifier.changed(),this.tt()}};t.ChangePasteInstrument=class extends t.ChangeGroup{constructor(t,e,i){super(),e.fromJsonObject(i,i.isDrum),t.notifier.changed(),this.tt()}};t.ChangePatternInstrument=class extends t.Change{constructor(t,e,i){super(),i.instrument!=e&&(i.instrument=e,t.notifier.changed(),this.tt())}};t.ChangePatternsPerChannel=class extends t.Change{constructor(e,i){if(super(),e.song.patternsPerChannel!=i){for(let s=0;s<e.song.getChannelCount();s++){const n=e.song.channels[s].bars,o=e.song.channels[s].patterns;for(let t=0;t<n.length;t++)n[t]>i&&(n[t]=0);for(let e=o.length;e<i;e++)o[e]=new t.Pattern;o.length=i}e.song.patternsPerChannel=i,e.notifier.changed(),this.tt()}}};t.ChangePinTime=class extends s{constructor(e,i,s,n){super(e,i),n-=this.at;const o=this.ut[s].time,h=Math.min(o,n),r=Math.max(o,n);let a=!1;for(let e=0;e<this.ut.length;e++){const o=i.pins[e],l=o.time;l<h?this.dt.push(t.makeNotePin(o.interval,l,o.volume)):l>r&&(a||(this.dt.push(t.makeNotePin(this.ut[s].interval,n,this.ut[s].volume)),a=!0),this.dt.push(t.makeNotePin(o.interval,l,o.volume)))}a||this.dt.push(t.makeNotePin(this.ut[s].interval,n,this.ut[s].volume)),this.gt()}};t.ChangePitchBend=class extends s{constructor(e,i,s,n,o,h){super(e,i),s-=this.at,n-=this.at,o-=i.pitches[h];let r,a,l,c,f=!1,u=!1,d=0,m=3,p=!0;for(n>s?(r=0,a=1,l=i.pins.length,c=(t=>{this.dt.push(t)})):(r=i.pins.length-1,a=-1,l=-1,c=(t=>{this.dt.unshift(t)}));r!=l;r+=a){const e=i.pins[r],h=e.time;for(;;)if(f){if(u){if(h*a==n*a)break;e.interval!=d&&(p=!1),c(t.makeNotePin(p?o:e.interval,h,e.volume));break}if(h*a<=n*a&&(d=e.interval,m=e.volume),h*a<n*a)break;c(t.makeNotePin(o,n,m)),u=!0}else{if(h*a<=s*a&&(d=e.interval,m=e.volume),h*a<s*a){c(t.makeNotePin(e.interval,h,e.volume));break}c(t.makeNotePin(d,s,m)),f=!0}}u||c(t.makeNotePin(o,n,m)),this.gt()}};t.ChangeForceRhythm=class extends t.ChangeSequence{constructor(e){super();const i=t.Config.partsPerBeat/t.Config.rhythms[e.song.rhythm].stepsPerBeat,s=function(s){let n=t.Config.rhythms[e.song.rhythm].roundUpThresholds;if(null!=n){const e=Math.floor(s/t.Config.partsPerBeat)*t.Config.partsPerBeat,o=s-e;let h=e;for(const t of n){if(!(o>=t))break;h+=i}return h}return Math.round(s/i)*i};for(const t of e.song.channels)for(const i of t.patterns){let t=0;for(;t<i.notes.length;){const n=i.notes[t];s(n.start)>=s(n.end)?this.append(new f(e,i,n,t,!0)):(this.append(new o(e,n,s)),t++)}}}};class o extends s{constructor(e,i,s){super(e,i);for(const e of this.ut)this.dt.push(t.makeNotePin(e.interval,s(e.time+this.at)-this.at,e.volume));this.gt()}}t.ChangeMoveNotesSideways=class extends t.ChangeGroup{constructor(s,n,o){super();let h=Math.round(n%s.song.beatsPerBar*t.Config.partsPerBeat);if(h<0&&(h+=s.song.beatsPerBar*t.Config.partsPerBeat),0!=h){switch(o){case"wrapAround":{const i=t.Config.partsPerBeat*s.song.beatsPerBar;for(const t of s.song.channels)for(const s of t.patterns){const t=[];for(let n=1;n>=0;n--){const o=n*i;for(const n of s.notes){const s=n.start+h,r=n.end+h,a=Math.max(0,s-o),l=Math.min(i,r-o);a<l&&e(n,s-o-a,a,l,t)}}s.notes=t}}break;case"overflow":{let t=s.song.barCount,e=s.song.loopStart,o=s.song.loopLength;if(this.append(new i(s,s.song.beatsPerBar,h)),n<0){let i=!0;for(const t of s.song.channels)0!=t.bars[0]&&(i=!1);if(i){for(const t of s.song.channels)t.bars.shift();s.song.barCount--}else t++,e++,s.bar++}for(;s.song.barCount<t;){for(const t of s.song.channels)t.bars.push(0);s.song.barCount++}s.song.loopStart=e,s.song.loopLength=o}break;default:throw new Error("Unrecognized beats-per-bar conversion strategy.")}s.notifier.changed(),this.tt()}}};t.ChangeBeatsPerBar=class extends t.ChangeGroup{constructor(e,s,n){if(super(),e.song.beatsPerBar!=s){switch(n){case"splice":if(e.song.beatsPerBar>s){const i=new t.ChangeSequence;for(let n=0;n<e.song.getChannelCount();n++)for(let o=0;o<e.song.channels[n].patterns.length;o++)i.append(new d(e,e.song.channels[n].patterns[o],s*t.Config.partsPerBeat,e.song.beatsPerBar*t.Config.partsPerBeat))}break;case"stretch":{const t=function(t){return Math.round(t*s/e.song.beatsPerBar)};for(let i=0;i<e.song.getChannelCount();i++)for(let s=0;s<e.song.channels[i].patterns.length;s++){const n=e.song.channels[i].patterns[s];let h=0;for(;h<n.notes.length;){const i=n.notes[h];t(i.start)>=t(i.end)?this.append(new f(e,n,i,h,!0)):(this.append(new o(e,i,t)),h++)}}}break;case"overflow":this.append(new i(e,s,0)),e.song.loopStart=0,e.song.loopLength=e.song.barCount;break;default:throw new Error("Unrecognized beats-per-bar conversion strategy.")}e.song.beatsPerBar=s,e.notifier.changed(),this.tt()}}};t.ChangeScale=class extends t.ChangeGroup{constructor(t,e){super(),t.song.scale!=e&&(t.song.scale=e,t.notifier.changed(),this.tt())}};t.ChangeForceScale=class extends t.ChangeGroup{constructor(e){super();const i=function(e,i){const s=t.Config.scales[i].flags,n=[],o=[];for(let t=0;t<12;t++)e[t]&&n.push(t),s[t]&&o.push(t);const h=n.length>o.length,r=h?o:n,a=h?n:o,l=["root","second","second","third","third","fourth","tritone","fifth","sixth","sixth","seventh","seventh","root"];let c=Number.MAX_SAFE_INTEGER,f=[];const u=[[0]];for(;u.length>0;){const t=u.pop();if(t.length==r.length){let e=0;for(let i=0;i<t.length;i++)e+=Math.abs(r[i]-a[t[i]]),l[r[i]]!=l[a[t[i]]]&&(e+=.75);c>e&&(c=e,f=t)}else{const e=t[t.length-1]+1,i=a.length-r.length+t.length;for(let s=e;s<=i;s++)u.push(t.concat(s))}}const d=[];for(let t=0;t<f.length;t++){const e=r[t],i=a[f[t]];d[t]=h?[i,e]:[e,i]}d.push([12,12]),o.push(12);let m=0;const p=[];for(let t=0;t<12;t++){const e=d[m][0],i=d[m][1],s=d[m+1][0],n=d[m+1][1];t==s-1&&m++;const h=(t-e)*(n-i)/(s-e)+i;let r=0,a=Number.MAX_SAFE_INTEGER;for(const e of o){let i=Math.abs(e-h);l[e]!=l[t]&&(i+=.1),a>i&&(a=i,r=e)}p[t]=r}return p}(function(t){const e=[!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];for(let i=0;i<t.pitchChannelCount;i++){const s=t.channels[i];for(const t of s.patterns)for(const i of t.notes)for(const t of i.pitches)for(const s of i.pins){const i=(t+s.interval)%12;e[i]||(e[i]=!0)}}return e}(e.song),e.song.scale);for(let t=0;t<e.song.pitchChannelCount;t++)for(let s=0;s<e.song.channels[t].patterns.length;s++)this.append(new y(e,e.song.channels[t].patterns[s],i));e.notifier.changed(),this.tt()}};function h(e){const i=[];for(let s=0;s<t.EditorConfig.presetCategories.length;s++){const n=t.EditorConfig.presetCategories[s];if("Novelty Presets"!=n.name)for(let t=0;t<n.presets.length;t++){const o=n.presets[t];void 0!=o.settings&&1==o.isNoise==e&&i.push((s<<6)+t)}}return i[Math.random()*i.length|0]}function r(e){for(let i=0;i<e.channels.length;i++)for(const s of e.channels[i].instruments){const n=e.getChannelIsNoise(i);if(0==i||i==e.pitchChannelCount){const e=t.EditorConfig.presetCategories.dictionary["Retro Presets"],i=e.presets.dictionary[n?"chip noise":"square wave"];s.fromJsonObject(i.settings,n),s.preset=(e.index<<6)+i.index}else{const e=h(n),i=t.EditorConfig.valueToPreset(e);s.fromJsonObject(i.settings,n),s.preset=e}}}t.ChangeDetectKey=class extends t.ChangeGroup{constructor(e){super();const i=e.song,s=t.Config.keys[i.key].basePitch,n=[0,0,0,0,0,0,0,0,0,0,0,0];for(let e=0;e<i.pitchChannelCount;e++)for(let o=0;o<i.barCount;o++){const h=i.getPattern(e,o);if(null!=h)for(const e of h.notes){const i=e.pins[0];for(let o=1;o<e.pins.length;o++){const h=e.pins[o];if(i.interval==h.interval){let o=h.time-i.time;o+=Math.max(0,Math.min(t.Config.partsPerBeat,h.time+e.start)-(i.time+e.start)),o*=h.volume+i.volume;for(const t of e.pitches)n[(s+i.interval+t)%12]+=o}}}}let o=0,h=0;for(let t=0;t<12;t++){const e=n[t]+.6*n[(t+7)%12]+.2*n[(t+4)%12]+.2*n[(t+3)%12];h<e&&(h=e,o=t)}if(o!=i.key){const t=i.key-o,s=Math.abs(t);for(let n=0;n<i.pitchChannelCount;n++)for(const o of i.channels[n].patterns)for(let i=0;i<s;i++)this.append(new p(e,o,t>0,!0));i.key=o,e.notifier.changed(),this.tt()}}},t.pickRandomPresetValue=h,t.setDefaultInstruments=r;t.ChangeSong=class extends t.ChangeGroup{constructor(t,e){super(),t.song.fromBase64String(e),this.append(new a(t)),""==e&&r(t.song),t.notifier.changed(),this.tt()}};class a extends t.Change{constructor(t){super();const e=Math.min(t.channel,t.song.getChannelCount()-1),i=Math.max(0,Math.min(t.song.barCount-1,t.bar)),s=Math.min(t.bar,Math.max(t.bar-(t.trackVisibleBars-1),Math.max(0,Math.min(t.song.barCount-t.trackVisibleBars,t.barScrollPos))));t.channel==e&&t.bar==i&&t.barScrollPos==s||(t.channel=e,t.bar=i,t.barScrollPos=s,t.notifier.changed(),this.tt())}}t.ChangeValidateDoc=a;class l extends t.ChangeGroup{constructor(e,i,s){super();const n=e.song;function o(t,e){for(;t.length>e;){let e=t.length-1,i=0;for(let s=0;s<t.length-1;s++){let n=0;for(const e of t[s].bars)0==e&&n++;n>=i&&(e=s,i=n)}t.splice(e,1)}}for(o(i,t.Config.pitchChannelCountMax),o(s,t.Config.noiseChannelCountMax);i.length<t.Config.pitchChannelCountMin;)i.push(new t.Channel);for(;s.length<t.Config.noiseChannelCountMin;)s.push(new t.Channel);n.barCount=1,n.instrumentsPerChannel=1,n.patternsPerChannel=8;const h=i.concat(s);for(let t=0;t<h.length;t++){const e=h[t];n.barCount=Math.max(n.barCount,e.bars.length),n.patternsPerChannel=Math.max(n.patternsPerChannel,e.patterns.length),n.instrumentsPerChannel=Math.max(n.instrumentsPerChannel,e.instruments.length),n.channels[t]=e}n.channels.length=h.length,n.pitchChannelCount=i.length,n.noiseChannelCount=s.length,n.barCount=Math.min(t.Config.barCountMax,n.barCount),n.patternsPerChannel=Math.min(t.Config.patternsPerChannelMax,n.patternsPerChannel),n.instrumentsPerChannel=Math.min(t.Config.instrumentsPerChannelMax,n.instrumentsPerChannel);for(let i=0;i<n.channels.length;i++){const s=n.channels[i];for(let t=0;t<s.bars.length;t++)(s.bars[t]>n.patternsPerChannel||s.bars[t]<0)&&(s.bars[t]=0);for(const t of s.patterns)(t.instrument>=n.instrumentsPerChannel||t.instrument<0)&&(t.instrument=0);for(;s.bars.length<n.barCount;)s.bars.push(0);for(;s.patterns.length<n.patternsPerChannel;)s.patterns.push(new t.Pattern);for(;s.instruments.length<n.instrumentsPerChannel;){const o=new t.Instrument(e.song.getChannelIsNoise(i));n.getChannelIsNoise(i)?o.setTypeAndReset(2,!0):o.setTypeAndReset(0,!1),s.instruments.push(o)}s.bars.length=n.barCount,s.patterns.length=n.patternsPerChannel,s.instruments.length=n.instrumentsPerChannel}n.loopStart=Math.max(0,Math.min(n.barCount-1,n.loopStart)),n.loopLength=Math.min(n.barCount-n.loopStart,n.loopLength),this.append(new a(e)),e.notifier.changed(),this.tt()}}function c(t){for(const e of t){const t=[];for(let i=0;i<e.bars.length;i++){if(0==e.bars[i])continue;const s=e.patterns[e.bars[i]-1];let n=!1;for(let o=0;o<t.length;o++){const h=t[o];if(h.instrument!=s.instrument||h.notes.length!=s.notes.length)continue;let r=!1;for(let t=0;t<s.notes.length;t++){const e=s.notes[t],i=h.notes[t];if(i.start!=e.start||i.end!=e.end||i.pitches.length!=e.pitches.length||i.pins.length!=e.pins.length){r=!0;break}for(let t=0;t<e.pitches.length;t++)if(i.pitches[t]!=e.pitches[t]){r=!0;break}if(r)break;for(let t=0;t<e.pins.length;t++)if(i.pins[t].interval!=e.pins[t].interval||i.pins[t].time!=e.pins[t].time||i.pins[t].volume!=e.pins[t].volume){r=!0;break}if(r)break}if(!r){n=!0,e.bars[i]=o+1;break}}n||(t.push(s),e.bars[i]=t.length)}for(let i=0;i<t.length;i++)e.patterns[i]=t[i];e.patterns.length=t.length}}t.ChangeReplacePatterns=l,t.removeDuplicatePatterns=c;t.ChangeTempo=class extends t.Change{constructor(e,i,s){super(),e.song.tempo=Math.max(t.Config.tempoMin,Math.min(t.Config.tempoMax,s)),e.notifier.changed(),i!=s&&this.tt()}};t.ChangeReverb=class extends t.Change{constructor(t,e,i){super(),t.song.reverb=i,t.notifier.changed(),e!=i&&this.tt()}};class f extends t.UndoableChange{constructor(t,e,i,s,n=!1){super(n),this.X=t,this.Mt=e,this.rt=i,this.wt=s,this.tt(),this.redo()}st(){this.Mt.notes.splice(this.wt,0,this.rt),this.X.notifier.changed()}nt(){this.Mt.notes.splice(this.wt,1),this.X.notifier.changed()}}t.ChangeNoteAdded=f;class u extends s{constructor(e,i,s,n){super(e,i),s-=this.at,n-=this.at;let o,h=!1,r=this.ut[0].volume,a=this.ut[0].interval,l=!0;for(o=0;o<this.ut.length;o++){const e=this.ut[o];if(e.time<s)r=e.volume,a=e.interval;else{if(!(e.time<=n))break;if(e.time>s&&!h&&this.dt.push(t.makeNotePin(a,s,r)),this.dt.push(t.makeNotePin(e.interval,e.time,e.volume)),h=!0,e.time==n){l=!1;break}}}l&&this.dt.push(t.makeNotePin(this.ut[o].interval,n,this.ut[o].volume)),this.gt()}}t.ChangeNoteLength=u;class d extends t.ChangeSequence{constructor(t,e,i,s,n){super();let o=0;for(;o<e.notes.length;){const h=e.notes[o];if(h==n&&void 0!=n)o++;else if(h.end<=i)o++;else{if(h.start>=s)break;h.start<i?(this.append(new u(t,h,h.start,i)),o++):h.end>s?(this.append(new u(t,h,s,h.end)),o++):this.append(new f(t,e,h,o,!0))}}}}t.ChangeNoteTruncate=d;class m extends t.UndoableChange{constructor(e,i,s,n=!1){super(!1),this.X=e,this.rt=i,this.ut=i.pins,this.dt=[],this.pt=i.pitches,this.yt=[];const o=e.song.getChannelIsNoise(e.channel)?t.Config.drumCount-1:t.Config.maxPitch;for(let i=0;i<this.pt.length;i++){let h=this.pt[i];if(s){for(let i=h+1;i<=o;i++)if(e.song.getChannelIsNoise(e.channel)||n||t.Config.scales[e.song.scale].flags[i%12]){h=i;break}}else for(let i=h-1;i>=0;i--)if(e.song.getChannelIsNoise(e.channel)||n||t.Config.scales[e.song.scale].flags[i%12]){h=i;break}let r=!1;for(let t=0;t<this.yt.length;t++)if(this.yt[t]==h){r=!0;break}r||this.yt.push(h)}let h=0,r=o;for(let t=1;t<this.yt.length;t++){const e=this.yt[0]-this.yt[t];h<e&&(h=e),r>e+o&&(r=e+o)}for(const i of this.ut){let o=i.interval+this.pt[0];if(o<h&&(o=h),o>r&&(o=r),s){for(let i=o+1;i<=r;i++)if(e.song.getChannelIsNoise(e.channel)||n||t.Config.scales[e.song.scale].flags[i%12]){o=i;break}}else for(let i=o-1;i>=h;i--)if(e.song.getChannelIsNoise(e.channel)||n||t.Config.scales[e.song.scale].flags[i%12]){o=i;break}o-=this.yt[0],this.dt.push(t.makeNotePin(o,i.time,i.volume))}if(0!=this.dt[0].interval)throw new Error("wrong pin start interval");for(let t=1;t<this.dt.length-1;)this.dt[t-1].interval==this.dt[t].interval&&this.dt[t].interval==this.dt[t+1].interval&&this.dt[t-1].volume==this.dt[t].volume&&this.dt[t].volume==this.dt[t+1].volume?this.dt.splice(t,1):t++;this.st(),this.tt()}st(){this.rt.pins=this.dt,this.rt.pitches=this.yt,this.X.notifier.changed()}nt(){this.rt.pins=this.ut,this.rt.pitches=this.pt,this.X.notifier.changed()}}class p extends t.ChangeSequence{constructor(t,e,i,s=!1){super();for(let n=0;n<e.notes.length;n++)this.append(new m(t,e.notes[n],i,s))}}t.ChangeTranspose=p;class y extends t.Change{constructor(e,i,s){super();const n=t.Config.maxPitch;for(const e of i.notes){const i=[],o=[];for(let t=0;t<e.pitches.length;t++){const n=e.pitches[t],o=s[n%12]+(n-n%12);-1==i.indexOf(o)&&i.push(o)}let h=0,r=n;for(let t=1;t<i.length;t++){const e=i[0]-i[t];h<e&&(h=e),r>e+n&&(r=e+n)}for(const n of e.pins){let a=n.interval+e.pitches[0];a<h&&(a=h),a>r&&(a=r);const l=s[a%12]+(a-a%12);o.push(t.makeNotePin(l-i[0],n.time,n.volume))}if(0!=o[0].interval)throw new Error("wrong pin start interval");for(let t=1;t<o.length-1;)o[t-1].interval==o[t].interval&&o[t].interval==o[t+1].interval&&o[t-1].volume==o[t].volume&&o[t].volume==o[t+1].volume?o.splice(t,1):t++;e.pitches=i,e.pins=o}this.tt(),e.notifier.changed()}}t.ChangePatternScale=y;t.ChangeVolume=class extends t.Change{constructor(t,e,i){super(),t.song.channels[t.channel].instruments[t.getCurrentInstrument()].volume=i,t.notifier.changed(),e!=i&&this.tt()}};t.ChangeVolumeBend=class extends t.UndoableChange{constructor(e,i,s,n,o){super(!1),this.X=e,this.rt=i,this.ut=i.pins,this.dt=[];let h=!1;for(const e of i.pins)e.time<s?this.dt.push(e):e.time==s?(this.dt.push(t.makeNotePin(o,s,n)),h=!0):(h||(this.dt.push(t.makeNotePin(o,s,n)),h=!0),this.dt.push(e));for(let t=1;t<this.dt.length-1;)this.dt[t-1].interval==this.dt[t].interval&&this.dt[t].interval==this.dt[t+1].interval&&this.dt[t-1].volume==this.dt[t].volume&&this.dt[t].volume==this.dt[t+1].volume?this.dt.splice(t,1):t++;this.st(),this.tt()}st(){this.rt.pins=this.dt,this.X.notifier.changed()}nt(){this.rt.pins=this.ut,this.X.notifier.changed()}};t.ChangeChipWave=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.chipWave!=e&&(i.chipWave=e,i.preset=i.type,t.notifier.changed(),this.tt())}};t.ChangeNoiseWave=class extends t.Change{constructor(t,e){super();const i=t.song.channels[t.channel].instruments[t.getCurrentInstrument()];i.chipNoise!=e&&(i.chipNoise=e,i.preset=i.type,t.notifier.changed(),this.tt())}}}(beepbox||(beepbox={})),function(t){class e{constructor(){this.valid=!1,this.prevNote=null,this.curNote=null,this.nextNote=null,this.pitch=0,this.pitchIndex=-1,this.curIndex=0,this.start=0,this.end=0,this.part=0,this.notePart=0,this.nearPinIndex=0,this.pins=[]}}t.PatternEditor=class{constructor(i){this.X=i,this.kt=t.SVG.pattern({id:"patternEditorNoteBackground",x:"0",y:"0",width:"64",height:"156",patternUnits:"userSpaceOnUse"}),this.xt=t.SVG.pattern({id:"patternEditorDrumBackground",x:"0",y:"0",width:"64",height:"40",patternUnits:"userSpaceOnUse"}),this.Et=t.SVG.rect({x:"0",y:"0",width:"512",height:"481","pointer-events":"none",fill:"url(#patternEditorNoteBackground)"}),this.At=t.SVG.svg(),this.Ct=t.SVG.rect({id:"",x:"0",y:"0",width:"4",height:"481",fill:"white","pointer-events":"none"}),this.qt=t.SVG.path({fill:"none",stroke:"white","stroke-width":"2","pointer-events":"none"}),this.Nt=t.SVG.svg({style:"background-color: #000000; touch-action: none; position: absolute;",width:"100%",height:"100%",viewBox:"0 0 512 481",preserveAspectRatio:"none"},t.SVG.defs(this.kt,this.xt),this.Et,this.At,this.qt,this.Ct),this.container=t.HTML.div({style:"height: 100%; overflow:hidden; position: relative; flex-grow: 1;"},this.Nt),this.Rt=13,this.Pt=40,this.St=[],this.Tt=t.SVG.rect(),this.zt=481,this.Bt=0,this.Ft=0,this.It=!1,this.Lt=!1,this.Ht=!1,this.Dt=!1,this.Ut=!1,this.Zt=[],this.Gt=0,this.Ot=0,this.jt=0,this.Wt=0,this.Vt=0,this.Yt=!1,this.Jt=null,this.Qt=new e,this.Mt=null,this.Xt=0,this.Kt=0,this._t=-1,this.$t=-1,this.te=!1,this.ee=!1,this.ie=-1,this.se=-1,this.ne=-1,this.oe=-1,this.resetCopiedPins=(()=>{const e=this.he();this.Zt.length=this.X.song.getChannelCount();for(let i=0;i<this.X.song.pitchChannelCount;i++)this.Zt[i]=[t.makeNotePin(0,0,3),t.makeNotePin(0,e,3)];for(let i=this.X.song.pitchChannelCount;i<this.X.song.getChannelCount();i++)this.Zt[i]=[t.makeNotePin(0,0,3),t.makeNotePin(0,e,0)]}),this.re=(e=>{const i=Math.floor(this.X.synth.playhead);if(this.X.synth.playing&&null!=this.Mt&&this.X.song.getPattern(this.X.channel,Math.floor(this.X.synth.playhead))==this.Mt){this.Ct.setAttribute("visibility","visible");const e=this.X.synth.playhead-i;Math.abs(e-this.Xt)>.1?this.Xt=e:this.Xt+=.2*(e-this.Xt),this.Ct.setAttribute("x",""+t.prettyNumber(this.Xt*this.ae-2))}else this.Ct.setAttribute("visibility","hidden");this.X.synth.playing&&this.X.autoFollow&&this.oe!=i&&(new t.ChangeChannelBar(this.X,this.X.channel,i),this.X.notifier.notifyWatchers()),this.oe=i,window.requestAnimationFrame(this.re)}),this.le=(t=>{this.Lt||(this.Lt=!0,this.Ut=!1)}),this.ce=(t=>{this.Lt&&(this.Lt=!1)}),this.fe=(t=>{if(t.preventDefault(),null==this.Mt)return;const e=this.Nt.getBoundingClientRect();this.Bt=((t.clientX||t.pageX)-e.left)*this.ae/(e.right-e.left),this.Ft=((t.clientY||t.pageY)-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.Ut=!1,this.ue()}),this.de=(t=>{if(t.preventDefault(),null==this.Mt)return;const e=this.Nt.getBoundingClientRect();this.Bt=(t.touches[0].clientX-e.left)*this.ae/(e.right-e.left),this.Ft=(t.touches[0].clientY-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.Ut=!0,this.ue()}),this.me=(t=>{const e=this.Nt.getBoundingClientRect();this.Bt=((t.clientX||t.pageX)-e.left)*this.ae/(e.right-e.left),this.Ft=((t.clientY||t.pageY)-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.Ut=!1,this.pe()}),this.ye=(t=>{if(!this.It)return;t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Bt=(t.touches[0].clientX-e.left)*this.ae/(e.right-e.left),this.Ft=(t.touches[0].clientY-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.pe()}),this.ge=(e=>{if(!this.Qt.valid)return;if(null==this.Mt)return;const i=this.X.lastChangeWas(this.Jt);if(this.Ht&&i)null!=this.Jt&&(this.X.record(this.Jt),this.Jt=null);else if(this.It&&i)if(null==this.Qt.curNote){const e=new t.Note(this.Qt.pitch,this.Qt.start,this.Qt.end,3,this.X.song.getChannelIsNoise(this.X.channel));e.pins=[];for(const i of this.Qt.pins)e.pins.push(t.makeNotePin(0,i.time,i.volume));this.X.record(new t.ChangeNoteAdded(this.X,this.Mt,e,this.Qt.curIndex))}else if(-1==this.Qt.pitchIndex){const e=new t.ChangeSequence;4==this.Qt.curNote.pitches.length&&e.append(new t.ChangePitchAdded(this.X,this.Qt.curNote,this.Qt.curNote.pitches[0],0,!0)),e.append(new t.ChangePitchAdded(this.X,this.Qt.curNote,this.Qt.pitch,this.Qt.curNote.pitches.length)),this.X.record(e),this.ve(this.Qt.curNote)}else 1==this.Qt.curNote.pitches.length?this.X.record(new t.ChangeNoteAdded(this.X,this.Mt,this.Qt.curNote,this.Qt.curIndex,!0)):this.X.record(new t.ChangePitchAdded(this.X,this.Qt.curNote,this.Qt.pitch,this.Qt.curNote.pitches.indexOf(this.Qt.pitch),!0));this.It=!1,this.Ht=!1,this.be(),this.we()}),this.Me=(()=>{const e=this.X.getCurrentPattern();this.Mt!=e&&(this.ge(null),this.Jt=null),this.Mt=e,this.ae=this.X.showLetters?this.X.showScrollBar?460:480:this.X.showScrollBar?492:512,this.ke=this.ae/(this.X.song.beatsPerBar*t.Config.partsPerBeat),this.xe=this.X.song.getChannelIsNoise(this.X.channel)?this.Pt:this.Rt,this.Ee=this.X.song.getChannelIsNoise(this.X.channel)?t.Config.drumCount:t.Config.windowPitchCount,this.Kt=12*this.X.song.channels[this.X.channel].octave,this.ie==this.X.song.rhythm&&this.se==this.X.song.pitchChannelCount&&this.ne==this.X.song.noiseChannelCount||(this.ie=this.X.song.rhythm,this.se=this.X.song.pitchChannelCount,this.ne=this.X.song.noiseChannelCount,this.resetCopiedPins()),this.Ae=this.Zt[this.X.channel],this._t!=this.ae&&(this._t=this.ae,this.Nt.setAttribute("viewBox","0 0 "+this.ae+" 481"),this.Et.setAttribute("width",""+this.ae));const i=this.ae/this.X.song.beatsPerBar;if(this.$t!=i){this.$t=i,this.kt.setAttribute("width",""+i),this.xt.setAttribute("width",""+i),this.Tt.setAttribute("width",""+(i-2));for(let t=0;t<12;t++)this.St[t].setAttribute("width",""+(i-2))}this.It||this.be(),this.At=function(t){const e=t.cloneNode(!1);return t.parentNode.replaceChild(e,t),e}(this.At),this.we(),this.te!=this.X.showFifth&&(this.te=this.X.showFifth,this.St[7].setAttribute("fill",this.X.showFifth?"#446688":"#444444"));for(let e=0;e<12;e++)this.St[e].style.visibility=t.Config.scales[this.X.song.scale].flags[e]?"visible":"hidden";if(this.X.song.getChannelIsNoise(this.X.channel)?this.ee||(this.ee=!0,this.Et.setAttribute("fill","url(#patternEditorDrumBackground)"),this.Et.setAttribute("height",""+this.Pt*t.Config.drumCount)):this.ee&&(this.ee=!1,this.Et.setAttribute("fill","url(#patternEditorNoteBackground)"),this.Et.setAttribute("height",""+this.zt)),this.X.showChannels)for(let e=this.X.song.getChannelCount()-1;e>=0;e--){if(e==this.X.channel)continue;if(this.X.song.getChannelIsNoise(e)!=this.X.song.getChannelIsNoise(this.X.channel))continue;const i=this.X.song.getPattern(e,this.X.bar);if(null!=i)for(const s of i.notes)for(const i of s.pitches){const n=t.SVG.path();n.setAttribute("fill",this.X.getNoteColorDim(e)),n.setAttribute("pointer-events","none"),this.Ce(n,i,s.start,s.pins,.19*this.xe,!1,12*this.X.song.channels[e].octave),this.At.appendChild(n)}}if(null!=this.Mt){for(const e of this.Mt.notes)for(let i=0;i<e.pitches.length;i++){const s=e.pitches[i];let n=t.SVG.path();if(n.setAttribute("fill",this.X.getNoteColorDim(this.X.channel)),n.setAttribute("pointer-events","none"),this.Ce(n,s,e.start,e.pins,this.xe/2+1,!1,this.Kt),this.At.appendChild(n),(n=t.SVG.path()).setAttribute("fill",this.X.getNoteColorBright(this.X.channel)),n.setAttribute("pointer-events","none"),this.Ce(n,s,e.start,e.pins,this.xe/2+1,!0,this.Kt),this.At.appendChild(n),e.pitches.length>1){const n=this.X.song.channels[this.X.channel].instruments[this.X.getCurrentInstrument()].getChord();if(!n.harmonizes||n.arpeggiates||n.strumParts>0){let n=t.SVG.text();n.setAttribute("x",""+t.prettyNumber(this.ke*e.start+2)),n.setAttribute("y",""+t.prettyNumber(this.qe(s-this.Kt))),n.setAttribute("width","30"),n.setAttribute("fill","black"),n.setAttribute("text-anchor","start"),n.setAttribute("dominant-baseline","central"),n.setAttribute("pointer-events","none"),n.textContent=""+(i+1),this.At.appendChild(n)}}}this.Et.style.visibility="visible"}else this.Et.style.visibility="hidden"});for(let e=0;e<12;e++){const i=(12-e)%12,s=t.SVG.rect();s.setAttribute("x","1"),s.setAttribute("y",""+(i*this.Rt+1)),s.setAttribute("height",""+(this.Rt-2)),s.setAttribute("fill",0==e?"#886644":"#444444"),this.kt.appendChild(s),this.St[e]=s}this.Tt.setAttribute("x","1"),this.Tt.setAttribute("y","1"),this.Tt.setAttribute("height",""+(this.Pt-2)),this.Tt.setAttribute("fill","#444444"),this.xt.appendChild(this.Tt),this.X.notifier.watch(this.Me),this.Me(),this.be(),this.we(),window.requestAnimationFrame(this.re),this.Nt.addEventListener("mousedown",this.fe),document.addEventListener("mousemove",this.me),document.addEventListener("mouseup",this.ge),this.Nt.addEventListener("mouseover",this.le),this.Nt.addEventListener("mouseout",this.ce),this.Nt.addEventListener("touchstart",this.de),this.Nt.addEventListener("touchmove",this.ye),this.Nt.addEventListener("touchend",this.ge),this.Nt.addEventListener("touchcancel",this.ge),this.resetCopiedPins()}he(){const e=t.Config.rhythms[this.X.song.rhythm].stepsPerBeat;return e%4==0?t.Config.partsPerBeat/2:e%3==0?t.Config.partsPerBeat/3:e%2==0?t.Config.partsPerBeat/2:t.Config.partsPerBeat}Ne(){return t.Config.partsPerBeat/t.Config.rhythms[this.X.song.rhythm].stepsPerBeat}Re(t){const e=this.Ne();return Math.floor(t/e)*e}be(){if(null==this.Mt)return;if(this.Qt=new e,this.Bt<0||this.Bt>this.ae||this.Ft<0||this.Ft>this.zt)return;const i=this.Ne(),s=this.Bt/this.ke;this.Qt.part=Math.floor(Math.max(0,Math.min(this.X.song.beatsPerBar*t.Config.partsPerBeat-i,s))/i)*i;for(const t of this.Mt.notes)if(t.end<=s)this.Qt.prevNote=t,this.Qt.curIndex++;else if(t.start<=s&&t.end>s)this.Qt.curNote=t;else if(t.start>s){this.Qt.nextNote=t;break}let n=this.Pe(this.Ft);if(null!=this.Qt.curNote){this.Qt.start=this.Qt.curNote.start,this.Qt.end=this.Qt.curNote.end,this.Qt.pins=this.Qt.curNote.pins;let e,i=0,s=0,o=this.Qt.curNote.pins[0];for(let t=1;t<this.Qt.curNote.pins.length;t++){e=o,o=this.Qt.curNote.pins[t];const n=this.ke*(this.Qt.curNote.start+e.time),h=this.ke*(this.Qt.curNote.start+o.time);if(this.Bt>h)continue;if(this.Bt<n)throw new Error;const r=(this.Bt-n)/(h-n),a=Math.sqrt(1/Math.sqrt(4)-Math.pow(r-.5,2))-.5,l=Math.abs(o.interval-e.interval);i=e.interval*(1-r)+o.interval*r,s=a*l+.95;break}let h=Number.MAX_VALUE,r=-Number.MAX_VALUE,a=Number.MAX_VALUE;for(const t of this.Qt.curNote.pins){h>t.interval&&(h=t.interval),r<t.interval&&(r=t.interval);const e=Math.abs(this.Qt.curNote.start+t.time-this.Bt/this.ke);a>e&&(a=e,this.Qt.nearPinIndex=this.Qt.curNote.pins.indexOf(t))}if(n-=i,this.Qt.pitch=this.Se(n,-h,(this.X.song.getChannelIsNoise(this.X.channel)?t.Config.drumCount-1:t.Config.maxPitch)-r),!this.X.song.getChannelIsNoise(this.X.channel)){let t=s;for(let e=0;e<this.Qt.curNote.pitches.length;e++){const i=Math.abs(this.Qt.curNote.pitches[e]-n+.5);i>t||(t=i,this.Qt.pitch=this.Qt.curNote.pitches[e])}}for(let t=0;t<this.Qt.curNote.pitches.length;t++)if(this.Qt.curNote.pitches[t]==this.Qt.pitch){this.Qt.pitchIndex=t;break}}else{this.Qt.pitch=this.Se(n,0,t.Config.maxPitch);const e=this.Ae[this.Ae.length-1].time,i=Math.floor(this.Qt.part/t.Config.partsPerBeat),s=this.he(),o=this.Qt.part%t.Config.partsPerBeat;if(1==e)this.Qt.start=this.Qt.part;else if(e>t.Config.partsPerBeat)this.Qt.start=i*t.Config.partsPerBeat;else if(e==t.Config.partsPerBeat)this.Qt.start=i*t.Config.partsPerBeat,s<t.Config.partsPerBeat&&o>s&&(this.Qt.start+=Math.floor(o/s)*s);else{this.Qt.start=i*t.Config.partsPerBeat;let n=t.Config.partsPerBeat%e==0?e:Math.min(e,s);for(;n<s&&t.Config.partsPerBeat%n!=0;)n++;this.Qt.start+=Math.floor(o/n)*n}this.Qt.end=this.Qt.start+e;let h=0,r=this.X.song.beatsPerBar*t.Config.partsPerBeat;if(null!=this.Qt.prevNote&&(h=this.Qt.prevNote.end),null!=this.Qt.nextNote&&(r=this.Qt.nextNote.start),this.Qt.start<h?(this.Qt.start=h,this.Qt.end=this.Qt.start+e,this.Qt.end>r&&(this.Qt.end=r)):this.Qt.end>r&&(this.Qt.end=r,this.Qt.start=this.Qt.end-e,this.Qt.start<h&&(this.Qt.start=h)),this.Qt.end-this.Qt.start==e)this.Qt.pins=this.Ae;else{this.Qt.pins=[];for(const e of this.Ae){if(!(e.time<=this.Qt.end-this.Qt.start)){this.Qt.pins.push(t.makeNotePin(0,this.Qt.end-this.Qt.start,e.volume));break}if(this.Qt.pins.push(t.makeNotePin(0,e.time,e.volume)),e.time==this.Qt.end-this.Qt.start)break}}}this.Qt.valid=!0}Pe(t){return Math.max(0,Math.min(this.Ee-1,this.Ee-t/this.xe))+this.Kt}Se(e,i,s){e<i&&(e=i),e>s&&(e=s);const n=t.Config.scales[this.X.song.scale].flags;if(n[Math.floor(e)%12]||this.X.song.getChannelIsNoise(this.X.channel))return Math.floor(e);{let t=Math.floor(e)+1,o=Math.floor(e)-1;for(;!n[t%12];)t++;for(;!n[o%12];)o--;if(t>s)return o<i?i:o;if(o<i)return t;let h=t,r=o+1;return t%12!=0&&t%12!=7||(h-=.5),o%12!=0&&o%12!=7||(r+=.5),e-r>h-e?t:o}}ve(e){this.Ae=[];for(const i of e.pins)this.Ae.push(t.makeNotePin(0,i.time,i.volume));for(let t=1;t<this.Ae.length-1;)this.Ae[t-1].volume==this.Ae[t].volume&&this.Ae[t].volume==this.Ae[t+1].volume?this.Ae.splice(t,1):t++;this.Zt[this.X.channel]=this.Ae}ue(){this.It=!0,this.Gt=this.Bt,this.Ot=this.Ft,this.be(),this.we(),this.Jt=new t.ChangeSequence,this.X.setProspectiveChange(this.Jt)}pe(){let e,i;if(null==this.Mt)return;const s=this.X.lastChangeWas(this.Jt);if(this.It&&this.Qt.valid&&s){const s=this.Ne();if(!this.Ht){const t=this.Bt-this.Gt,e=this.Ft-this.Ot;Math.sqrt(t*t+e*e)>5&&(this.Ht=!0,this.Dt=Math.abs(t)>=Math.abs(e))}if(this.Ht){null!=this.Jt&&this.Jt.undo();const n=this.Re(this.Bt/this.ke),o=new t.ChangeSequence;if(this.Jt=o,this.X.setProspectiveChange(this.Jt),null==this.Qt.curNote){let h,r;n<this.Qt.start?(h=!0,r=this.Qt.start-n):(h=!1,r=n-this.Qt.start+s);let a=s;for(let e=s;e<=this.X.song.beatsPerBar*t.Config.partsPerBeat;e+=s){if(1==s){if(e<5);else if(e<=t.Config.partsPerBeat/2){if(e%3!=0&&e%4!=0)continue}else if(e<=1.5*t.Config.partsPerBeat){if(e%6!=0&&e%8!=0)continue}else if(e%t.Config.partsPerBeat!=0)continue}else if(e>=5*s&&e%t.Config.partsPerBeat!=0&&e!=3*t.Config.partsPerBeat/4&&e!=3*t.Config.partsPerBeat/2&&e!=4*t.Config.partsPerBeat/3)continue;if(e==r){a=e;break}if(e<r&&(a=e),e>r){a<r-s&&(a=e);break}}if(h?e=(i=this.Qt.start)-a:i=(e=this.Qt.start)+a,e<0&&(e=0),i>this.X.song.beatsPerBar*t.Config.partsPerBeat&&(i=this.X.song.beatsPerBar*t.Config.partsPerBeat),e<i){let s;for(o.append(new t.ChangeNoteTruncate(this.X,this.Mt,e,i)),s=0;s<this.Mt.notes.length&&!(this.Mt.notes[s].start>=i);s++);const n=new t.Note(this.Qt.pitch,e,i,3,this.X.song.getChannelIsNoise(this.X.channel));o.append(new t.ChangeNoteAdded(this.X,this.Mt,n,s)),this.ve(n),this.jt=h?e:i,this.Wt=this.Qt.pitch,this.Vt=n.pins[h?0:1].volume,this.Yt=!0}}else if(this.Dt){const n=(this.Bt-this.Gt)/this.ke,h=this.Qt.curNote.pins[this.Qt.nearPinIndex];let r=Math.round((this.Qt.curNote.start+h.time+n)/s)*s;r<0&&(r=0),r>this.X.song.beatsPerBar*t.Config.partsPerBeat&&(r=this.X.song.beatsPerBar*t.Config.partsPerBeat),r<=this.Qt.curNote.start&&this.Qt.nearPinIndex==this.Qt.curNote.pins.length-1||r>=this.Qt.curNote.end&&0==this.Qt.nearPinIndex?(o.append(new t.ChangeNoteAdded(this.X,this.Mt,this.Qt.curNote,this.Qt.curIndex,!0)),this.Yt=!1):(e=Math.min(this.Qt.curNote.start,r),i=Math.max(this.Qt.curNote.end,r),this.jt=r,this.Wt=this.Qt.curNote.pitches[-1==this.Qt.pitchIndex?0:this.Qt.pitchIndex]+this.Qt.curNote.pins[this.Qt.nearPinIndex].interval,this.Vt=this.Qt.curNote.pins[this.Qt.nearPinIndex].volume,this.Yt=!0,o.append(new t.ChangeNoteTruncate(this.X,this.Mt,e,i,this.Qt.curNote)),o.append(new t.ChangePinTime(this.X,this.Qt.curNote,this.Qt.nearPinIndex,r)),this.ve(this.Qt.curNote))}else if(-1==this.Qt.pitchIndex){const e=Math.max(this.Qt.curNote.start,Math.min(this.Qt.curNote.end,Math.round(this.Bt/(this.ke*s))*s))-this.Qt.curNote.start;let i,n=this.Qt.curNote.pins[0],h=0,r=0;for(let s=1;s<this.Qt.curNote.pins.length;s++){if(i=n,e>(n=this.Qt.curNote.pins[s]).time)continue;if(e<i.time)throw new Error;const o=(e-i.time)/(n.time-i.time);(h=Math.round(i.volume*(1-o)+n.volume*o+(this.Ot-this.Ft)/25))<0&&(h=0),h>3&&(h=3),r=this.Se(i.interval*(1-o)+n.interval*o+this.Qt.curNote.pitches[0],0,t.Config.maxPitch)-this.Qt.curNote.pitches[0];break}this.jt=this.Qt.curNote.start+e,this.Wt=this.Qt.curNote.pitches[-1==this.Qt.pitchIndex?0:this.Qt.pitchIndex]+r,this.Vt=h,this.Yt=!0,o.append(new t.ChangeVolumeBend(this.X,this.Qt.curNote,e,h,r)),this.ve(this.Qt.curNote)}else{let e,i;this.Vt=this.Qt.curNote.pins[this.Qt.nearPinIndex].volume,this.Bt>=this.Gt?(e=Math.max(this.Qt.curNote.start,this.Qt.part),i=n+s):(e=Math.min(this.Qt.curNote.end,this.Qt.part+s),i=n),i<0&&(i=0),i>this.X.song.beatsPerBar*t.Config.partsPerBeat&&(i=this.X.song.beatsPerBar*t.Config.partsPerBeat),i>this.Qt.curNote.end&&o.append(new t.ChangeNoteTruncate(this.X,this.Mt,this.Qt.curNote.start,i,this.Qt.curNote)),i<this.Qt.curNote.start&&o.append(new t.ChangeNoteTruncate(this.X,this.Mt,i,this.Qt.curNote.end,this.Qt.curNote));let h=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(const t of this.Qt.curNote.pitches)h>t&&(h=t),r<t&&(r=t);h-=this.Qt.curNote.pitches[this.Qt.pitchIndex],r-=this.Qt.curNote.pitches[this.Qt.pitchIndex];const a=this.Se(this.Pe(this.Ft),-h,(this.X.song.getChannelIsNoise(this.X.channel)?t.Config.drumCount-1:t.Config.maxPitch)-r);o.append(new t.ChangePitchBend(this.X,this.Qt.curNote,e,i,a,this.Qt.pitchIndex)),this.ve(this.Qt.curNote),this.jt=i,this.Wt=a,this.Yt=!0}}}else this.be(),this.we()}we(){if(this.Ut)if(this.It&&this.Qt.valid&&this.Ht&&this.Yt&&null!=this.Mt){this.qt.setAttribute("visibility","visible");const e=this.ke*this.jt,i=this.qe(this.Wt-this.Kt),s=this.xe/2,n=80,o=60;let h="";h+="M "+t.prettyNumber(e)+" "+t.prettyNumber(i-s*(this.Vt/3))+" ",h+="L "+t.prettyNumber(e)+" "+t.prettyNumber(i-s*(this.Vt/3)-o)+" ",h+="M "+t.prettyNumber(e)+" "+t.prettyNumber(i+s*(this.Vt/3))+" ",h+="L "+t.prettyNumber(e)+" "+t.prettyNumber(i+s*(this.Vt/3)+o)+" ",h+="M "+t.prettyNumber(e)+" "+t.prettyNumber(i-s*(this.Vt/3))+" ",h+="L "+t.prettyNumber(e+n)+" "+t.prettyNumber(i-s*(this.Vt/3))+" ",h+="M "+t.prettyNumber(e)+" "+t.prettyNumber(i+s*(this.Vt/3))+" ",h+="L "+t.prettyNumber(e+n)+" "+t.prettyNumber(i+s*(this.Vt/3))+" ",h+="M "+t.prettyNumber(e)+" "+t.prettyNumber(i-s*(this.Vt/3))+" ",h+="L "+t.prettyNumber(e-n)+" "+t.prettyNumber(i-s*(this.Vt/3))+" ",h+="M "+t.prettyNumber(e)+" "+t.prettyNumber(i+s*(this.Vt/3))+" ",h+="L "+t.prettyNumber(e-n)+" "+t.prettyNumber(i+s*(this.Vt/3))+" ",this.qt.setAttribute("d",h)}else this.qt.setAttribute("visibility","hidden");else this.Lt&&!this.It&&this.Qt.valid&&null!=this.Mt?(this.qt.setAttribute("visibility","visible"),this.Ce(this.qt,this.Qt.pitch,this.Qt.start,this.Qt.pins,this.xe/2+1,!0,this.Kt)):this.qt.setAttribute("visibility","hidden")}Ce(e,i,s,n,o,h,r){const a=this.ke*(n[n.length-1].time+n[0].time),l=.5*Math.min(2,a-1);let c=n[0],f="M "+t.prettyNumber(this.ke*(s+c.time)+l)+" "+t.prettyNumber(this.qe(i-r)+o*(h?c.volume/3:1))+" ";for(let e=1;e<n.length;e++){let a=c;c=n[e];let u=this.ke*(s+a.time)+(1==e?l:0),d=this.ke*(s+c.time)-(e==n.length-1?l:0),m=this.qe(i+a.interval-r),p=this.qe(i+c.interval-r),y=h?a.volume/3:1,g=h?c.volume/3:1;f+="L "+t.prettyNumber(u)+" "+t.prettyNumber(m-o*y)+" ",a.interval>c.interval&&(f+="L "+t.prettyNumber(u+1)+" "+t.prettyNumber(m-o*y)+" "),a.interval<c.interval&&(f+="L "+t.prettyNumber(d-1)+" "+t.prettyNumber(p-o*g)+" "),f+="L "+t.prettyNumber(d)+" "+t.prettyNumber(p-o*g)+" "}for(let e=n.length-2;e>=0;e--){let a=c;c=n[e];let u=this.ke*(s+a.time)-(e==n.length-2?l:0),d=this.ke*(s+c.time)+(0==e?l:0),m=this.qe(i+a.interval-r),p=this.qe(i+c.interval-r),y=h?a.volume/3:1,g=h?c.volume/3:1;f+="L "+t.prettyNumber(u)+" "+t.prettyNumber(m+o*y)+" ",a.interval<c.interval&&(f+="L "+t.prettyNumber(u-1)+" "+t.prettyNumber(m+o*y)+" "),a.interval>c.interval&&(f+="L "+t.prettyNumber(d+1)+" "+t.prettyNumber(p+o*g)+" "),f+="L "+t.prettyNumber(d)+" "+t.prettyNumber(p+o*g)+" "}f+="z",e.setAttribute("d",f)}qe(t){return this.xe*(this.Ee-t-.5)}}}(beepbox||(beepbox={})),function(t){class e{constructor(e,i,s,n){this.Te=document.createTextNode("1"),this.ze=t.SVG.text({x:16,y:23,"font-family":"sans-serif","font-size":20,"text-anchor":"middle","font-weight":"bold",fill:"red"},this.Te),this.Be=t.SVG.rect({width:30,height:30,x:1,y:1}),this.container=t.SVG.svg(this.Be,this.ze),this.Fe=1,this.Ie=!0,this.Le=!1,this.He="",this.container.setAttribute("x",""+32*i),this.container.setAttribute("y",""+32*s),this.Be.setAttribute("fill","#444444"),this.ze.setAttribute("fill",n)}setSquashed(t,e){t?(this.container.setAttribute("y",""+27*e),this.Be.setAttribute("height","25"),this.ze.setAttribute("y","21")):(this.container.setAttribute("y",""+32*e),this.Be.setAttribute("height","30"),this.ze.setAttribute("y","23"))}setIndex(t,e,i,s,n){this.Fe!=t&&(this.Le||0==t==(0==this.Fe)||this.Be.setAttribute("fill",0==t?"#000000":"#444444"),this.Fe=t,this.Te.data=""+t),this.Ie==e&&this.He==n||(this.Ie=e,i?this.ze.setAttribute("fill","#000000"):this.ze.setAttribute("fill",n)),this.Le==i&&this.He==n||(this.Le=i,i?(this.Be.setAttribute("fill",n),this.ze.setAttribute("fill","#000000")):(this.Be.setAttribute("fill",0==this.Fe?"#000000":"#444444"),this.ze.setAttribute("fill",n))),this.He=n}}t.TrackEditor=class{constructor(e){this.X=e,this.De=32,this.Nt=t.SVG.svg({style:"background-color: #000000; position: absolute;",height:128}),this.Ue=t.HTML.select({className:"trackSelectBox",style:"width: 32px; height: 32px; background: none; border: none; appearance: none; color: transparent; position: absolute;"}),this.container=t.HTML.div({style:"height: 128px; position: relative; overflow:hidden;"},this.Nt,this.Ue),this.Ze=t.SVG.g(),this.Ge=t.SVG.rect({fill:"white",x:0,y:0,width:4,height:128}),this.Oe=t.SVG.rect({fill:"none",stroke:"white","stroke-width":2,"pointer-events":"none",x:1,y:1,width:30,height:30}),this.je=t.SVG.path({fill:"black",stroke:"black","stroke-width":1,"pointer-events":"none"}),this.We=t.SVG.path({fill:"black",stroke:"black","stroke-width":1,"pointer-events":"none"}),this.Ve=[],this.Bt=0,this.Ft=0,this.Lt=!1,this.Ye="",this.zt=128,this.Je=32,this.Qe=0,this.Xe=0,this.Ke=0,this._e=-1,this.$e=!1,this.ti=null,this.ei=(()=>{this.ii(this.Ue.selectedIndex)}),this.re=(t=>{const e=this.De*this.X.synth.playhead-2;this._e!=e&&(this._e=e,this.Ge.setAttribute("x",""+e)),window.requestAnimationFrame(this.re)}),this.le=(t=>{this.Lt||(this.Lt=!0)}),this.ce=(t=>{this.Lt&&(this.Lt=!1)}),this.fe=(t=>{t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Bt=(t.clientX||t.pageX)-e.left,this.Ft=(t.clientY||t.pageY)-e.top;const i=Math.floor(Math.min(this.X.song.getChannelCount()-1,Math.max(0,this.Ft/this.Je))),s=Math.floor(Math.min(this.X.song.barCount-1,Math.max(0,this.Bt/this.De)));if(this.X.channel==i&&this.X.bar==s){const t=this.Ft%this.Je<this.Je/2,e=this.X.song.patternsPerChannel;this.ii((this.X.song.channels[i].bars[s]+(t?1:e))%(e+1))}else this.si(i,s)}),this.me=(t=>{const e=this.Nt.getBoundingClientRect();this.Bt=(t.clientX||t.pageX)-e.left,this.Ft=(t.clientY||t.pageY)-e.top,this.we()}),this.ni=(t=>{}),this.Nt.appendChild(this.Ze),this.Nt.appendChild(this.Oe),this.Nt.appendChild(this.je),this.Nt.appendChild(this.We),this.Nt.appendChild(this.Ge),window.requestAnimationFrame(this.re),this.Nt.addEventListener("mousedown",this.fe),document.addEventListener("mousemove",this.me),document.addEventListener("mouseup",this.ni),this.Nt.addEventListener("mouseover",this.le),this.Nt.addEventListener("mouseout",this.ce),this.Ue.addEventListener("change",this.ei)}si(e,i){new t.ChangeChannelBar(this.X,e,i),this.Ye="",this.X.forgetLastChange()}ii(e){const i=this.X.song.channels[this.X.channel].bars[this.X.bar],s=this.X.lastChangeWas(this.ti),n=s?this.ti.oldValue:i;e!=i&&(this.ti=new t.ChangePattern(this.X,n,e),this.X.record(this.ti,s))}onKeyPressed(t){switch(t.keyCode){case 38:this.si((this.X.channel-1+this.X.song.getChannelCount())%this.X.song.getChannelCount(),this.X.bar),t.preventDefault();break;case 40:this.si((this.X.channel+1)%this.X.song.getChannelCount(),this.X.bar),t.preventDefault();break;case 37:this.si(this.X.channel,(this.X.bar+this.X.song.barCount-1)%this.X.song.barCount),t.preventDefault();break;case 39:this.si(this.X.channel,(this.X.bar+1)%this.X.song.barCount),t.preventDefault();break;case 48:this.oi("0"),t.preventDefault();break;case 49:this.oi("1"),t.preventDefault();break;case 50:this.oi("2"),t.preventDefault();break;case 51:this.oi("3"),t.preventDefault();break;case 52:this.oi("4"),t.preventDefault();break;case 53:this.oi("5"),t.preventDefault();break;case 54:this.oi("6"),t.preventDefault();break;case 55:this.oi("7"),t.preventDefault();break;case 56:this.oi("8"),t.preventDefault();break;case 57:this.oi("9"),t.preventDefault();break;default:this.Ye=""}}oi(t){this.Ye+=t;let e=parseInt(this.Ye);e<=this.X.song.patternsPerChannel?this.ii(e):(this.Ye=t,(e=parseInt(this.Ye))<=this.X.song.patternsPerChannel?this.ii(e):this.Ye="")}we(){let e=Math.floor(Math.min(this.X.song.getChannelCount()-1,Math.max(0,this.Ft/this.Je))),i=Math.floor(Math.min(this.X.song.barCount-1,Math.max(0,this.Bt/this.De)));const s=window.innerWidth>700;s||(i=this.X.bar,e=this.X.channel);const n=i==this.X.bar&&e==this.X.channel;if(this.Lt&&!n?(this.Oe.setAttribute("x",""+(1+this.De*i)),this.Oe.setAttribute("y",""+(1+this.Je*e)),this.Oe.setAttribute("height",""+(this.Je-2)),this.Oe.style.visibility="visible"):this.Oe.style.visibility="hidden",!this.Lt&&s||!n)this.je.style.visibility="hidden",this.We.style.visibility="hidden";else{const t=this.Ft%this.Je<this.Je/2,n=this.De*(i+.8),o=this.Je*(e+.5),h=.1*this.Je,r=.4*this.Je,a=.175*this.Je;this.je.setAttribute("fill",t&&s?"#fff":"#000"),this.We.setAttribute("fill",!t&&s?"#fff":"#000"),this.je.setAttribute("d",`M ${n} ${o-r} L ${n+a} ${o-h} L ${n-a} ${o-h} z`),this.We.setAttribute("d",`M ${n} ${o+r} L ${n+a} ${o+h} L ${n-a} ${o+h} z`),this.je.style.visibility="visible",this.We.style.visibility="visible"}this.Ue.style.left=this.De*this.X.bar+"px",this.Ue.style.top=this.Je*this.X.channel+"px",this.Ue.style.height=this.Je+"px";const o=this.X.song.patternsPerChannel+1;for(let e=this.Ke;e<o;e++)this.Ue.appendChild(t.HTML.option({value:e},e));for(let t=o;t<this.Ke;t++)this.Ue.removeChild(this.Ue.lastChild);this.Ke=o;const h=this.X.song.channels[this.X.channel].bars[this.X.bar];this.Ue.selectedIndex!=h&&(this.Ue.selectedIndex=h)}render(){const t=!(window.innerWidth>700)||this.X.song.getChannelCount()>4||this.X.song.barCount>this.X.trackVisibleBars&&this.X.song.getChannelCount()>3;if(this.Je=t?27:32,this.Qe!=this.X.song.getChannelCount()){for(let i=this.Qe;i<this.X.song.getChannelCount();i++){this.Ve[i]=[];for(let s=0;s<this.Xe;s++){const n=new e(i,s,i,this.X.getChannelColorDim(i));n.setSquashed(t,i),this.Ze.appendChild(n.container),this.Ve[i][s]=n}}for(let t=this.X.song.getChannelCount();t<this.Qe;t++)for(let e=0;e<this.Xe;e++)this.Ze.removeChild(this.Ve[t][e].container);this.Ve.length=this.X.song.getChannelCount()}if(this.Xe!=this.X.song.barCount){for(let i=0;i<this.X.song.getChannelCount();i++){for(let s=this.Xe;s<this.X.song.barCount;s++){const n=new e(i,s,i,this.X.getChannelColorDim(i));n.setSquashed(t,i),this.Ze.appendChild(n.container),this.Ve[i][s]=n}for(let t=this.X.song.barCount;t<this.Xe;t++)this.Ze.removeChild(this.Ve[i][t].container);this.Ve[i].length=this.X.song.barCount}this.Xe=this.X.song.barCount;const i=32*this.X.song.barCount;this.container.style.width=i+"px",this.Nt.setAttribute("width",i+"")}if(this.$e!=t)for(let e=0;e<this.X.song.getChannelCount();e++)for(let i=0;i<this.Xe;i++)this.Ve[e][i].setSquashed(t,e);this.$e==t&&this.Qe==this.X.song.getChannelCount()||(this.$e=t,this.Qe=this.X.song.getChannelCount(),this.zt=this.X.song.getChannelCount()*this.Je,this.Nt.setAttribute("height",""+this.zt),this.Ge.setAttribute("height",""+this.zt),this.container.style.height=this.zt+"px");for(let t=0;t<this.X.song.getChannelCount();t++)for(let e=0;e<this.Xe;e++){const i=this.X.song.getPattern(t,e),s=e==this.X.bar&&t==this.X.channel,n=null==i||0==i.notes.length,o=this.Ve[t][e];e<this.X.song.barCount?(o.setIndex(this.X.song.channels[t].bars[e],n,s,t,n&&!s?this.X.getChannelColorDim(t):this.X.getChannelColorBright(t)),o.container.style.visibility="visible"):o.container.style.visibility="hidden"}this.we()}}}(beepbox||(beepbox={})),function(t){t.LoopEditor=class{constructor(e){this.X=e,this.De=32,this.zt=20,this.hi=0,this.ri=1,this.ai=2,this.li=t.SVG.path({fill:"none",stroke:"#7744ff","stroke-width":4}),this.ci=t.SVG.path({fill:"white","pointer-events":"none"}),this.Nt=t.SVG.svg({style:"background-color: #000000; touch-action: pan-y; position: absolute;",height:this.zt},this.li,this.ci),this.container=t.HTML.div({style:"height: 20px; position: relative; margin: 5px 0;"},this.Nt),this.fi=null,this.Qt={startBar:-1,mode:-1},this.Bt=0,this.ui=0,this.di=0,this.mi=!1,this.pi=!1,this.It=!1,this.Lt=!1,this.yi=-1,this.gi=-1,this.Xe=0,this.le=(t=>{this.Lt||(this.Lt=!0,this.we())}),this.ce=(t=>{this.Lt&&(this.Lt=!1,this.we())}),this.fe=(t=>{t.preventDefault(),this.It=!0;const e=this.Nt.getBoundingClientRect();this.Bt=(t.clientX||t.pageX)-e.left,this.be(),this.we(),this.me(t)}),this.de=(t=>{this.It=!0;const e=this.Nt.getBoundingClientRect();this.Bt=t.touches[0].clientX-e.left,this.be(),this.we(),this.ui=t.touches[0].clientX,this.di=t.touches[0].clientY,this.pi=!1,this.mi=!1}),this.me=(t=>{const e=this.Nt.getBoundingClientRect();this.Bt=(t.clientX||t.pageX)-e.left,this.pe()}),this.ye=(t=>{if(!this.It)return;const e=this.Nt.getBoundingClientRect();this.Bt=t.touches[0].clientX-e.left,this.pi||this.mi||(Math.abs(t.touches[0].clientY-this.di)>10?this.mi=!0:Math.abs(t.touches[0].clientX-this.ui)>10&&(this.pi=!0)),this.pi&&(this.pe(),t.preventDefault())}),this.vi=(t=>{t.preventDefault(),this.mi||(this.pe(),this.Lt=!1,this.ge(t),this.we())}),this.ge=(t=>{null!=this.fi&&this.X.record(this.fi),this.fi=null,this.It=!1,this.be(),this.bi()}),this.Me=(()=>{this.bi()}),this.be(),this.bi(),this.X.notifier.watch(this.Me),this.container.addEventListener("mousedown",this.fe),document.addEventListener("mousemove",this.me),document.addEventListener("mouseup",this.ge),this.container.addEventListener("mouseover",this.le),this.container.addEventListener("mouseout",this.ce),this.container.addEventListener("touchstart",this.de),this.container.addEventListener("touchmove",this.ye),this.container.addEventListener("touchend",this.vi),this.container.addEventListener("touchcancel",this.vi)}be(){const t=this.Bt/this.De;this.Qt.startBar=t,t>this.X.song.loopStart-.25&&t<this.X.song.loopStart+this.X.song.loopLength+.25?t-this.X.song.loopStart<.5*this.X.song.loopLength?this.Qt.mode=this.hi:this.Qt.mode=this.ri:this.Qt.mode=this.ai}wi(t){let e=Math.round(t-this.X.song.loopLength/2),i=e+this.X.song.loopLength;return e<0&&(i-=e,e=0),i>this.X.song.barCount&&(e-=i-this.X.song.barCount,i=this.X.song.barCount),{start:e,length:i-e}}pe(){if(this.It){let e=this.X.song.loopStart,i=this.X.song.loopStart+this.X.song.loopLength;null!=this.fi&&this.X.lastChangeWas(this.fi)&&(i=(e=this.fi.oldStart)+this.fi.oldLength);const s=this.Bt/this.De;let n,o,h;if(this.Qt.mode==this.hi)n=e+Math.round(s-this.Qt.startBar),o=i,n<0&&(n=0),n>=this.X.song.barCount&&(n=this.X.song.barCount),n==o?n=o-1:n>o&&(h=n,n=o,o=h),this.fi=new t.ChangeLoop(this.X,e,i-e,n,o-n);else if(this.Qt.mode==this.ri)n=e,(o=i+Math.round(s-this.Qt.startBar))<0&&(o=0),o>=this.X.song.barCount&&(o=this.X.song.barCount),o==n?o=n+1:o<n&&(h=n,n=o,o=h),this.fi=new t.ChangeLoop(this.X,e,i-e,n,o-n);else if(this.Qt.mode==this.ai){const n=this.wi(s);this.fi=new t.ChangeLoop(this.X,e,i-e,n.start,n.length)}this.X.setProspectiveChange(this.fi)}else this.be(),this.we()}we(){const t=this.Lt&&!this.It;if(this.ci.style.visibility=t?"visible":"hidden",t){const t=this.zt/2;let e=this.X.song.loopStart*this.De,i=(this.X.song.loopStart+this.X.song.loopLength)*this.De;if(this.Qt.mode==this.hi)i=this.X.song.loopStart*this.De+2*t;else if(this.Qt.mode==this.ri)e=(this.X.song.loopStart+this.X.song.loopLength)*this.De-2*t;else{const t=this.wi(this.Qt.startBar);e=t.start*this.De,i=(t.start+t.length)*this.De}this.ci.setAttribute("d",`M ${e+t} 4 `+`L ${i-t} 4 `+`A ${t-4} ${t-4} 0 0 1 ${i-t} ${this.zt-4} `+`L ${e+t} ${this.zt-4} `+`A ${t-4} ${t-4} 0 0 1 ${e+t} 4 `+"z")}}bi(){const t=this.zt/2,e=this.X.song.loopStart*this.De,i=(this.X.song.loopStart+this.X.song.loopLength)*this.De;if(this.Xe!=this.X.song.barCount){this.Xe=this.X.song.barCount;const t=32*this.X.song.barCount;this.container.style.width=t+"px",this.Nt.setAttribute("width",t+"")}this.yi==e&&this.gi==i||(this.yi=e,this.gi=i,this.li.setAttribute("d",`M ${e+t} 2 `+`L ${i-t} 2 `+`A ${t-2} ${t-2} 0 0 1 ${i-t} ${this.zt-2} `+`L ${e+t} ${this.zt-2} `+`A ${t-2} ${t-2} 0 0 1 ${e+t} 2 `+"z")),this.we()}}}(beepbox||(beepbox={})),function(t){t.SpectrumEditor=class{constructor(e,i){this.X=e,this.Mi=i,this.ae=112,this.zt=26,this.ki=t.SVG.path({fill:"#444444","pointer-events":"none"}),this.xi=t.SVG.svg({"pointer-events":"none"}),this.Ei=t.SVG.svg({"pointer-events":"none"}),this.Ai=t.SVG.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}),this.Ci=t.SVG.path({fill:"currentColor","pointer-events":"none"}),this.Nt=t.SVG.svg({style:"background-color: #000000; touch-action: none; cursor: crosshair;",width:"100%",height:"100%",viewBox:"0 0 "+this.ae+" "+this.zt,preserveAspectRatio:"none"},this.ki,this.xi,this.Ei,this.Ai,this.Ci),this.container=t.HTML.div({className:"spectrum",style:"height: 2em;"},this.Nt),this.Bt=0,this.Ft=0,this.qi=0,this.Ni=0,this.It=!1,this.fi=null,this.Ri="",this.te=!0,this.fe=(t=>{t.preventDefault(),this.It=!0;const e=this.Nt.getBoundingClientRect();this.Bt=((t.clientX||t.pageX)-e.left)*this.ae/(e.right-e.left),this.Ft=((t.clientY||t.pageY)-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.qi=this.Pi(this.Bt),this.Ni=this.Si(this.Ft),this.pe()}),this.de=(t=>{t.preventDefault(),this.It=!0;const e=this.Nt.getBoundingClientRect();this.Bt=(t.touches[0].clientX-e.left)*this.ae/(e.right-e.left),this.Ft=(t.touches[0].clientY-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.qi=this.Pi(this.Bt),this.Ni=this.Si(this.Ft),this.pe()}),this.me=(t=>{if(null==this.container.offsetParent)return;const e=this.Nt.getBoundingClientRect();this.Bt=((t.clientX||t.pageX)-e.left)*this.ae/(e.right-e.left),this.Ft=((t.clientY||t.pageY)-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.pe()}),this.ye=(t=>{if(null==this.container.offsetParent)return;if(!this.It)return;t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Bt=(t.touches[0].clientX-e.left)*this.ae/(e.right-e.left),this.Ft=(t.touches[0].clientY-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.pe()}),this.ge=(t=>{this.It&&(this.X.record(this.fi),this.fi=null),this.It=!1});for(let e=0;e<t.Config.spectrumControlPoints;e+=t.Config.spectrumControlPointsPerOctave)this.xi.appendChild(t.SVG.rect({fill:"#886644",x:(e+1)*this.ae/(t.Config.spectrumControlPoints+2)-1,y:0,width:2,height:this.zt}));for(let e=4;e<=t.Config.spectrumControlPoints;e+=t.Config.spectrumControlPointsPerOctave)this.Ei.appendChild(t.SVG.rect({fill:"#446688",x:(e+1)*this.ae/(t.Config.spectrumControlPoints+2)-1,y:0,width:2,height:this.zt}));this.container.addEventListener("mousedown",this.fe),document.addEventListener("mousemove",this.me),document.addEventListener("mouseup",this.ge),this.container.addEventListener("touchstart",this.de),this.container.addEventListener("touchmove",this.ye),this.container.addEventListener("touchend",this.ge),this.container.addEventListener("touchcancel",this.ge)}Pi(e){return(t.Config.spectrumControlPoints+2)*e/this.ae-1}Si(e){return t.Config.spectrumMax*(1-(e-1)/(this.zt-2))}pe(){if(this.It){const e=this.Pi(this.Bt),i=this.Si(this.Ft),s=this.X.song.channels[this.X.channel].instruments[this.X.getCurrentInstrument()],n=null==this.Mi?s.spectrumWave:s.drumsetSpectrumWaves[this.Mi];if(e!=this.qi){const s=(i-this.Ni)/(e-this.qi),o=this.Ni-this.qi*s,h=Math.ceil(Math.min(this.qi,e)),r=Math.floor(Math.max(this.qi,e));for(let e=h;e<=r;e++)e<0||e>=t.Config.spectrumControlPoints||(n.spectrum[e]=Math.max(0,Math.min(t.Config.spectrumMax,Math.round(e*s+o))))}n.spectrum[Math.max(0,Math.min(t.Config.spectrumControlPoints-1,Math.round(e)))]=Math.max(0,Math.min(t.Config.spectrumMax,Math.round(i))),this.qi=e,this.Ni=i,this.fi=new t.ChangeSpectrum(this.X,s,n),this.X.setProspectiveChange(this.fi)}}render(){const e=this.X.song.channels[this.X.channel].instruments[this.X.getCurrentInstrument()],i=null==this.Mi?e.spectrumWave:e.drumsetSpectrumWaves[this.Mi],s=e=>(1-e/t.Config.spectrumMax)*(this.zt-1)+1;let n=0,o="M 0 "+t.prettyNumber(this.zt)+" ";for(let e=0;e<t.Config.spectrumControlPoints;e++){let h=i.spectrum[e];o+=0!=n||0!=h?"L ":"M ",o+=t.prettyNumber((e+1)*this.ae/(t.Config.spectrumControlPoints+2))+" "+t.prettyNumber(s(h))+" ",n=h}const h=s(n);n>0&&(o+="L "+(this.ae-1)+" "+t.prettyNumber(h)+" "),this.Ri!=o&&(this.Ri=o,this.Ai.setAttribute("d",o),this.ki.setAttribute("d",o+"L "+this.ae+" "+t.prettyNumber(h)+" L "+this.ae+" "+t.prettyNumber(this.zt)+" L 0 "+t.prettyNumber(this.zt)+" z "),this.Ci.setAttribute("d","M "+this.ae+" "+t.prettyNumber(h)+" L "+(this.ae-4)+" "+t.prettyNumber(h-4)+" L "+(this.ae-4)+" "+t.prettyNumber(h+4)+" z"),this.Ci.style.display=n>0?"":"none"),this.te!=this.X.showFifth&&(this.te=this.X.showFifth,this.Ei.style.display=this.X.showFifth?"":"none")}}}(beepbox||(beepbox={})),function(t){t.HarmonicsEditor=class{constructor(e){this.X=e,this.ae=112,this.zt=26,this.xi=t.SVG.svg({"pointer-events":"none"}),this.Ei=t.SVG.svg({"pointer-events":"none"}),this.Ai=t.SVG.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}),this.Ti=[],this.zi=t.SVG.svg({"pointer-events":"none"}),this.Nt=t.SVG.svg({style:"background-color: #000000; touch-action: none; cursor: crosshair;",width:"100%",height:"100%",viewBox:"0 0 "+this.ae+" "+this.zt,preserveAspectRatio:"none"},this.xi,this.Ei,this.Ai,this.zi),this.container=t.HTML.div({className:"harmonics",style:"height: 2em;"},this.Nt),this.Bt=0,this.Ft=0,this.qi=0,this.Ni=0,this.It=!1,this.fi=null,this.Ri="",this.te=!0,this.fe=(t=>{t.preventDefault(),this.It=!0;const e=this.Nt.getBoundingClientRect();this.Bt=((t.clientX||t.pageX)-e.left)*this.ae/(e.right-e.left),this.Ft=((t.clientY||t.pageY)-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.qi=this.Pi(this.Bt),this.Ni=this.Si(this.Ft),this.pe()}),this.de=(t=>{t.preventDefault(),this.It=!0;const e=this.Nt.getBoundingClientRect();this.Bt=(t.touches[0].clientX-e.left)*this.ae/(e.right-e.left),this.Ft=(t.touches[0].clientY-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.qi=this.Pi(this.Bt),this.Ni=this.Si(this.Ft),this.pe()}),this.me=(t=>{if(null==this.container.offsetParent)return;const e=this.Nt.getBoundingClientRect();this.Bt=((t.clientX||t.pageX)-e.left)*this.ae/(e.right-e.left),this.Ft=((t.clientY||t.pageY)-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.pe()}),this.ye=(t=>{if(null==this.container.offsetParent)return;if(!this.It)return;t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Bt=(t.touches[0].clientX-e.left)*this.ae/(e.right-e.left),this.Ft=(t.touches[0].clientY-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Bt)&&(this.Bt=0),isNaN(this.Ft)&&(this.Ft=0),this.pe()}),this.ge=(t=>{this.It&&(this.X.record(this.fi),this.fi=null),this.It=!1});for(let e=1;e<=t.Config.harmonicsControlPoints;e*=2)this.xi.appendChild(t.SVG.rect({fill:"#886644",x:(e-.5)*(this.ae-8)/(t.Config.harmonicsControlPoints-1)-1,y:0,width:2,height:this.zt}));for(let e=3;e<=t.Config.harmonicsControlPoints;e*=2)this.Ei.appendChild(t.SVG.rect({fill:"#446688",x:(e-.5)*(this.ae-8)/(t.Config.harmonicsControlPoints-1)-1,y:0,width:2,height:this.zt}));for(let e=0;e<4;e++){const i=t.SVG.rect({fill:"currentColor",x:this.ae-2*e-1,y:0,width:1,height:this.zt});this.Ti.push(i),this.zi.appendChild(i)}this.container.addEventListener("mousedown",this.fe),document.addEventListener("mousemove",this.me),document.addEventListener("mouseup",this.ge),this.container.addEventListener("touchstart",this.de),this.container.addEventListener("touchmove",this.ye),this.container.addEventListener("touchend",this.ge),this.container.addEventListener("touchcancel",this.ge)}Pi(e){return(t.Config.harmonicsControlPoints-1)*e/(this.ae-8)-.5}Si(e){return t.Config.harmonicsMax*(1-e/this.zt)}pe(){if(this.It){const e=this.Pi(this.Bt),i=this.Si(this.Ft),s=this.X.song.channels[this.X.channel].instruments[this.X.getCurrentInstrument()],n=s.harmonicsWave;if(e!=this.qi){const s=(i-this.Ni)/(e-this.qi),o=this.Ni-this.qi*s,h=Math.ceil(Math.min(this.qi,e)),r=Math.floor(Math.max(this.qi,e));for(let e=h;e<=r;e++)e<0||e>=t.Config.harmonicsControlPoints||(n.harmonics[e]=Math.max(0,Math.min(t.Config.harmonicsMax,Math.round(e*s+o))))}n.harmonics[Math.max(0,Math.min(t.Config.harmonicsControlPoints-1,Math.round(e)))]=Math.max(0,Math.min(t.Config.harmonicsMax,Math.round(i))),this.qi=e,this.Ni=i,this.fi=new t.ChangeHarmonics(this.X,s,n),this.X.setProspectiveChange(this.fi)}}render(){const e=this.X.song.channels[this.X.channel].instruments[this.X.getCurrentInstrument()].harmonicsWave,i=e=>(1-e/t.Config.harmonicsMax)*this.zt;let s=t.prettyNumber(this.zt),n="";for(let o=0;o<t.Config.harmonicsControlPoints-1;o++){if(0==e.harmonics[o])continue;let h=t.prettyNumber((o+.5)*(this.ae-8)/(t.Config.harmonicsControlPoints-1));n+="M "+h+" "+s+" ",n+="L "+h+" "+t.prettyNumber(i(e.harmonics[o]))+" "}const o=i(e.harmonics[t.Config.harmonicsControlPoints-1]);for(let e=0;e<4;e++){const i=this.Ti[e];i.setAttribute("y",t.prettyNumber(o)),i.setAttribute("height",t.prettyNumber(this.zt-o))}this.Ri!=n&&(this.Ri=n,this.Ai.setAttribute("d",n)),this.te!=this.X.showFifth&&(this.te=this.X.showFifth,this.Ei.style.display=this.X.showFifth?"":"none")}}}(beepbox||(beepbox={})),function(t){t.BarScrollBar=class{constructor(e,i){this.X=e,this.Bi=i,this.ae=512,this.zt=20,this.Fi=t.SVG.svg({"pointer-events":"none"}),this.Ii=t.SVG.rect({fill:"#444444",x:0,y:2,width:10,height:this.zt-4}),this.Li=t.SVG.rect({fill:"none",stroke:"white","stroke-width":2,"pointer-events":"none",x:0,y:1,width:10,height:this.zt-2}),this.Hi=t.SVG.path({fill:"white","pointer-events":"none"}),this.Di=t.SVG.path({fill:"white","pointer-events":"none"}),this.Nt=t.SVG.svg({style:"background-color: #000000; touch-action: pan-y; position: absolute;",width:this.ae,height:this.zt},this.Fi,this.Ii,this.Li,this.Hi,this.Di),this.container=t.HTML.div({className:"barScrollBar",style:"width: 512px; height: 20px; overflow: hidden; position: relative;"},this.Nt),this.Bt=0,this.It=!1,this.Lt=!1,this.Ui=!1,this.Zi=-1,this.Gi=-1,this.Oi=(t=>{this.X.barScrollPos=this.Bi.scrollLeft/32}),this.le=(t=>{this.Lt||(this.Lt=!0,this.we())}),this.ce=(t=>{this.Lt&&(this.Lt=!1,this.we())}),this.fe=(t=>{t.preventDefault(),this.It=!0;const e=this.Nt.getBoundingClientRect();this.Bt=(t.clientX||t.pageX)-e.left,this.we(),this.Bt>=this.X.barScrollPos*this.De&&this.Bt<=(this.X.barScrollPos+this.X.trackVisibleBars)*this.De&&(this.Ui=!0,this.ji=this.Bt)}),this.de=(t=>{t.preventDefault(),this.It=!0;const e=this.Nt.getBoundingClientRect();this.Bt=t.touches[0].clientX-e.left,this.we(),this.Bt>=this.X.barScrollPos*this.De&&this.Bt<=(this.X.barScrollPos+this.X.trackVisibleBars)*this.De&&(this.Ui=!0,this.ji=this.Bt)}),this.me=(t=>{const e=this.Nt.getBoundingClientRect();this.Bt=(t.clientX||t.pageX)-e.left,this.pe()}),this.ye=(t=>{if(!this.It)return;t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Bt=t.touches[0].clientX-e.left,this.pe()}),this.ge=(t=>{!this.Ui&&this.It&&(this.Bt<(this.X.barScrollPos+8)*this.De?(this.X.barScrollPos>0&&this.X.barScrollPos--,this.X.notifier.changed()):(this.X.barScrollPos<this.X.song.barCount-this.X.trackVisibleBars&&this.X.barScrollPos++,this.X.notifier.changed())),this.It=!1,this.Ui=!1,this.we()});const s=.5*this.zt;this.Hi.setAttribute("d",`M 9 ${s} L 20 ${s+6} L 20 ${s-6} z`),this.Di.setAttribute("d",`M ${this.ae-9} ${s} L ${this.ae-20} ${s+6} L ${this.ae-20} ${s-6} z`),this.container.addEventListener("mousedown",this.fe),document.addEventListener("mousemove",this.me),document.addEventListener("mouseup",this.ge),this.container.addEventListener("mouseover",this.le),this.container.addEventListener("mouseout",this.ce),this.container.addEventListener("touchstart",this.de),this.container.addEventListener("touchmove",this.ye),this.container.addEventListener("touchend",this.ge),this.container.addEventListener("touchcancel",this.ge),this.Bi.addEventListener("scroll",this.Oi,{capture:!1,passive:!0})}pe(){if(this.Ui){for(;this.Bt-this.ji<.5*-this.De&&this.X.barScrollPos>0;)this.X.barScrollPos--,this.ji-=this.De,this.X.notifier.changed();for(;this.Bt-this.ji>.5*this.De&&this.X.barScrollPos<this.X.song.barCount-this.X.trackVisibleBars;)this.X.barScrollPos++,this.ji+=this.De,this.X.notifier.changed()}this.Lt&&this.we()}we(){let t=!1,e=!1,i=!1;this.Lt&&!this.It&&(this.Bt<this.X.barScrollPos*this.De?t=!0:this.Bt>(this.X.barScrollPos+this.X.trackVisibleBars)*this.De?e=!0:i=!0),this.Hi.style.visibility=t?"visible":"hidden",this.Di.style.visibility=e?"visible":"hidden",this.Li.style.visibility=i?"visible":"hidden"}render(){this.De=(this.ae-1)/Math.max(this.X.trackVisibleBars,this.X.song.barCount);const e=this.Zi!=this.X.song.barCount;if(e){for(this.Zi=this.X.song.barCount;this.Fi.firstChild;)this.Fi.removeChild(this.Fi.firstChild);for(let e=0;e<=this.X.song.barCount;e++){const i=e%16==0?0:e%4==0?this.zt/8:this.zt/3;this.Fi.appendChild(t.SVG.rect({fill:"#444444",x:e*this.De-1,y:i,width:2,height:this.zt-2*i}))}}(e||this.Gi!=this.X.barScrollPos)&&(this.Gi=this.X.barScrollPos,this.Ii.setAttribute("x",""+this.De*this.X.barScrollPos),this.Ii.setAttribute("width",""+this.De*this.X.trackVisibleBars),this.Li.setAttribute("x",""+this.De*this.X.barScrollPos),this.Li.setAttribute("width",""+this.De*this.X.trackVisibleBars)),this.we(),this.Bi.scrollLeft=32*this.X.barScrollPos}}}(beepbox||(beepbox={})),function(t){t.OctaveScrollBar=class{constructor(e){this.X=e,this.ae=20,this.zt=481,this.Wi=4,this.Vi=t.Config.pitchOctaves,this.Yi=(this.zt-this.Wi)/this.Vi,this.Ji=this.Yi*t.Config.windowOctaves+this.Wi,this.Ii=t.SVG.rect({fill:"#444444",x:2,y:0,width:this.ae-4,height:this.Ji}),this.Li=t.SVG.rect({fill:"none",stroke:"white","stroke-width":2,"pointer-events":"none",x:1,y:0,width:this.ae-2,height:this.Ji}),this.je=t.SVG.path({fill:"white","pointer-events":"none"}),this.We=t.SVG.path({fill:"white","pointer-events":"none"}),this.Nt=t.SVG.svg({style:"background-color: #000000; touch-action: pan-x; position: absolute;",width:this.ae,height:"100%",viewBox:"0 0 20 481",preserveAspectRatio:"none"}),this.container=t.HTML.div({id:"octaveScrollBarContainer",style:"width: 20px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0;"},this.Nt),this.Ft=0,this.It=!1,this.Lt=!1,this.Ui=!1,this.Qi=-1,this.fi=null,this.le=(t=>{this.Lt||(this.Lt=!0,this.we())}),this.ce=(t=>{this.Lt&&(this.Lt=!1,this.we())}),this.fe=(t=>{t.preventDefault(),this.It=!0;const e=this.Nt.getBoundingClientRect();this.Ft=((t.clientY||t.pageY)-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Ft)&&(this.Ft=0),this.X.song.getChannelIsNoise(this.X.channel)||(this.we(),this.Ft>=this.Xi-this.Ji&&this.Ft<=this.Xi&&(this.Ui=!0,this.fi=null,this.ji=this.Ft))}),this.de=(t=>{t.preventDefault(),this.It=!0;const e=this.Nt.getBoundingClientRect();this.Ft=(t.touches[0].clientY-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Ft)&&(this.Ft=0),this.X.song.getChannelIsNoise(this.X.channel)||(this.we(),this.Ft>=this.Xi-this.Ji&&this.Ft<=this.Xi&&(this.Ui=!0,this.fi=null,this.ji=this.Ft))}),this.me=(t=>{const e=this.Nt.getBoundingClientRect();this.Ft=((t.clientY||t.pageY)-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Ft)&&(this.Ft=0),this.pe()}),this.ye=(t=>{if(!this.It)return;t.preventDefault();const e=this.Nt.getBoundingClientRect();this.Ft=(t.touches[0].clientY-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Ft)&&(this.Ft=0),this.pe()}),this.ge=(e=>{if(!this.X.song.getChannelIsNoise(this.X.channel)&&this.It)if(this.Ui)null!=this.fi&&this.X.record(this.fi);else{const e=this.X.lastChangeWas(this.fi),i=e?this.fi.oldValue:this.X.song.channels[this.X.channel].octave,s=this.X.song.channels[this.X.channel].octave;this.Ft<this.Xi-.5*this.Ji?s<t.Config.scrollableOctaves&&(this.fi=new t.ChangeOctave(this.X,i,s+1),this.X.record(this.fi,e)):s>0&&(this.fi=new t.ChangeOctave(this.X,i,s-1),this.X.record(this.fi,e))}this.It=!1,this.Ui=!1,this.we()}),this.Me=(()=>{this.Xi=this.zt-this.Yi*this.X.song.channels[this.X.channel].octave,this.bi()}),this.X.notifier.watch(this.Me),this.Me(),this.Nt.appendChild(this.Ii);for(let e=0;e<=this.Vi;e++)this.Nt.appendChild(t.SVG.rect({fill:"#886644",x:0,y:e*this.Yi,width:this.ae,height:this.Wi}));this.Nt.appendChild(this.Li),this.Nt.appendChild(this.je),this.Nt.appendChild(this.We);const i=.5*this.ae;this.je.setAttribute("d",`M ${i} 9 L ${i+6} 20 L ${i-6} 20 z`),this.We.setAttribute("d",`M ${i} ${this.zt-9} L ${i+6} ${this.zt-20} L ${i-6} ${this.zt-20} z`),this.container.addEventListener("mousedown",this.fe),document.addEventListener("mousemove",this.me),document.addEventListener("mouseup",this.ge),this.container.addEventListener("mouseover",this.le),this.container.addEventListener("mouseout",this.ce),this.container.addEventListener("touchstart",this.de),this.container.addEventListener("touchmove",this.ye),this.container.addEventListener("touchend",this.ge),this.container.addEventListener("touchcancel",this.ge)}pe(){if(!this.X.song.getChannelIsNoise(this.X.channel)){if(this.Ui){const e=this.X.song.channels[this.X.channel].octave,i=this.X.lastChangeWas(this.fi)?this.fi.oldValue:e;let s=e;for(;this.Ft-this.ji<.5*-this.Yi&&s<t.Config.scrollableOctaves;)s++,this.ji-=this.Yi;for(;this.Ft-this.ji>.5*this.Yi&&s>0;)s--,this.ji+=this.Yi;this.fi=new t.ChangeOctave(this.X,i,s),this.X.setProspectiveChange(this.fi)}this.Lt&&this.we()}}we(){let t=!1,e=!1,i=!1;this.Lt&&!this.It&&(this.Ft<this.Xi-this.Ji?t=!0:this.Ft>this.Xi?e=!0:i=!0),this.je.style.visibility=t?"inherit":"hidden",this.We.style.visibility=e?"inherit":"hidden",this.Li.style.visibility=i?"inherit":"hidden"}bi(){this.Nt.style.visibility=this.X.song.getChannelIsNoise(this.X.channel)?"hidden":"visible",this.Qi!=this.Xi&&(this.Qi=this.Xi,this.Ii.setAttribute("y",""+(this.Xi-this.Ji)),this.Li.setAttribute("y",""+(this.Xi-this.Ji))),this.we()}}}(beepbox||(beepbox={})),function(t){let e=0,i=!1;function s(){--e<=0&&(i=!0)}function n(t){i=!1,e++;const n=document.createElement("img");return n.onload=s,n.src=t,n}const o=n("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NEU3RTM2RTg0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NEU3RTM2RTk0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozMzYxN0U3RDQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozMzYxN0U3RTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PomGIaQAAABgSURBVHjaYpSWlmZhYWFmZgaSTExMQAYTGGAyIICRkRFIMhANWISFhdlggAUHANrBysoKNBfuCGKMvnjx4r59+xhp5wOg6UCSBM+SB0YtGLVgCFgAzDeMeOSGgAUAAQYAGgwJrOg8pdQAAAAASUVORK5CYII="),h=n("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NEU3RTM2RUM0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NEU3RTM2RUQ0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo0RTdFMzZFQTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo0RTdFMzZFQjQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PhURscAAAAB1SURBVHja7NPBCoAgDAZgnaMX8Oj7P2KKldXPhiR4CwwCv4PInPvxoA0hMLNzDisRYUPCCiMucVallJzzJnaBih5pp2mw936puKEZ2qQ3MeUQmLiKGGNKCZ1IQr2fDnb0C8gMNgNmwA8Cnt/0Tv91vw64BRgALUuP70jrlrwAAAAASUVORK5CYII="),r=n("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzM2MTdFNzc0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzM2MTdFNzg0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozMzYxN0U3NTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozMzYxN0U3NjQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgBmMXoAAACTSURBVHja7JQ7CgMhGIT3920M2Hko7+RJPYWViE0myi5sEXAhKQL7FcP8PmawkWKMjx2llNb60MNIKY0xnPPphRDbMsJ7/xw458wAodZa6PRQ5GIF0RjlYCU655xSEqWU3ntrrdb63RcgHcq2H3MX3AV/UEAhBL7DBkTEzmAFuzSY44UC/BDHtU+8z539esFLgAEAkZ4XCDjZXPEAAAAASUVORK5CYII="),a=n("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzM2MTdFN0I0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzM2MTdFN0M0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozMzYxN0U3OTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozMzYxN0U3QTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PlZjoH4AAADHSURBVHja7JTNDoMgEIRBGq21iTcfyvd/DeNvJBYBp7uFEE+99NDE70AMMDPLYZRt2z4CeZ4XRcFrRkgphRD7vnvvX8RGdF03DEPf99M0LcuitcamMcZa6wkRuNV1/SSqqroTcC/LEu5KKQ6AEhq21oRzDl5bAME8DUjd3wHjOELPyu9fgNnneV7XNQ6OyNPsTCZ+zBVwBfxBgGyaRgViuWIt+ZIPuAAaZwh00BKxaKeuSfwhUsfI55g+WOMT2DEl3jm94BBgAAtY6T6d3wTNAAAAAElFTkSuQmCC"),l=n("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAArCAIAAACW3x1gAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowMTgwMTE3NDA3MjA2ODExOUJCOEEzOUJCMkI3MTdFNCIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5NzVEOTA1QzQ5MjMxMUUxOTM3RDhDNEI4QkIxQkFCNSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5NzVEOTA1QjQ5MjMxMUUxOTM3RDhDNEI4QkIxQkFCNSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjAxODAxMTc0MDcyMDY4MTE5QkI4QTM5QkIyQjcxN0U0IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjAxODAxMTc0MDcyMDY4MTE5QkI4QTM5QkIyQjcxN0U0Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+dtFK5QAACbRJREFUeNrcV0lsG9cZnnmzcJdIcRHFRZtly5IVSVYSOcriNY7jqHHTBE2bJkCRNijQQ9re2kOBAj30kByKAm1PvQVF0RYIkLRpkiZuLMqyLVm7bGvlIpKiuHOGyww52+ubIbXYCYLk2P4ccobz3nzf+9f3D4b9rwv+5cOXL5x48crDT54b8Pr6jOZWQJoxKIi13WJ+Oziz+Z/r6x9N3AvMhb42gcWkf/P1Mz/40fkWz2iuAAsFrljkOK5crVYwTNTrcaMRNDURNhtl1Slrn9x55x+zf/5ooVIVvhLBq1ce+eXPLpt6RnZ22EIBmk1Oi8VuMFoMBgNF6RUMF2tcrVqscPlSKcGV4zaC85qNd25u/PHdm/+8tf5lBBRJ/Oan49/98cVEDmcYg9PZ09LSrjcYSRzHcAAxDGBQQfMgJiuyAiFUFMSUT23mtu9YxYxVgX/6YPa3796QZGUfk9i/Mhvo3//8W99443wwKtB0T1fXqM3m0en0iJUgSIIkKYoiKBL9A4QqAEcCSFJnbnI3uboqIpHP7D7T73WYDbfW4+IexwHB22+OX3zpsfAu5nI96vUM0gY9wqN0JEJG2AAATFs7hlABrhKgk3qJQwwCgrY4/ZiuaSceO+VvslkM11Yi9xG8+dLj33/tdDgLPB1POB09JE0RAOESFEEiVOWQaIZBPxCtX2MBUKVRMAXTWZyk2RaPRp440lIV5PngboPgZE/br16/kBJwR9dTTtdxQkejBzUOoHxO4P2CCAgcV+8iDSHUWWyA0ieDa4N++1J4N8VUVMVfvTCEm/S0vc/Z1g9IoKIjU6PHkCBvyrJ63hMJffZ+tQkyDnDVPThR18beM6zvHmky0i8/OYDAwTGvfXz0WKoCXL5BFVv1p0qgmULRMJTD0HVKWdqj1EZVS2meV+MNU1zHTmZE6tLJ7qOeFvLMQ504TRkt3SarC00j1aOBrhmksUxFu4PuNxytAqHAhZj2Bw2h6Kprgym40d5m9PXqmbXTA53gzIA/V+KaXZ3aTBSCuKrpniDMOo+yv/bGr3qCyv46VE8jDVCmIBT0t7mtK1fkn+rzgpPdrWy5arS2qloCXHMWdp8flYatZGVPm7rd7nc6psUV0BgQgsnhYbnacGcr8DltXE3UGZsxFNA4JAgcUzU/RHDoWsOFh2Pp8ES0OnX9anWAtNnK1wSf00paTIZG0UAhV19+4/uAHNCqc2Hj3n2CDCxDWRvU1FCLJuB43qijahyLiFG2wEZ5wr+gLOKac7USUX/+gVlQ1pahsdZKjEFHcxwPWIZpNus5JgUhPICqY+1B4XvAQItHrUjsDR6aiRRT9gAq2USzUccyLNhNpe0WI5uOYFrEoAPDDqHvoSJMcJ8Q+7f3J6rxIGP1hbKJsN1iQOAgtJNutZu5bKjEpmU1HNXQeABcKzsNIfeKqVbv8H0OLbCgamQIuXySS6y7rOZQIgO2M2WsxrealHRsSdEiW5Kkfez6uV47Dyg0+ANzgUbqIAfXDZBZn3eSoiJUorkyoMzW9bW1Tk+LkFtNJ1YQPApESZFAAxqAQ9jEYZK6aKPItJJaPdRPdmupGlnocDWvra4hcHCi7/jdxXtihe3yWFKx2+lsUJZESVKLxAH2F1A0wNEAsrooC5Ko5ggb38wsBbps+mqZXVxZHeg7Dvq7vYlo+c78vN9t7fSARPxmMrmuCKIgSfUqRnwxeEOQZQRBRnpDWcxur6QWPm3XcT67eX5uLrHD93V5SSOsWk2ttwMLNp9rePwiyZbC0Vs8X/R5T+gNFog41F2SOEjdevRrXhVFUS2sklTjSsmt21xw7ogZ8za3XEcyvdzS3KOXeeInlx9iC3IikqkKCZ2ROjr6kKXJVCjsRqMx9CRBGpHBkWXrW1g9nRG0pNpRRGav8Gw6thy995mhuHW81eSxmK4HpiYnrzNFU9+xXp/XQLz8aIel2RqeTZZrNVHYJYDi7u7s6OqkaaJQSEajYYbJ8xwvSgJaLDI3YuW5EsNkc7lIYmchEbtJC9tHHFS/z6GUuclrE4GJwG6BBpJ1bKy3WGXJ5WDs+WfOOX0t+UgmaqieOM1uXP2Xb/iUv+Nhv7+DYYRstlIoZLYj259rvMg2D+mwuq2ohjL81vTC8tQ0hyk7eRpyTd52W09P6/uBKXLmXuSlK7D3VM+tSAZugv7Lb3349otCOe3OxW3+oWb7gNXqwDAdhqHdX0I1BsNQ+8ZjWBXDOHQh88XY3EpoZml1ZjGdLP/ivX9cffcVtKcPDXdStHJ7bZtcjGS2Ntb7xwbDs2F2K4UX37rzMcOOQoN5RSpuNbnnjPYjlMkP6DaIm1AfpDZdQqlWSVVyMSYeTm5sJtZCHMOHd2q7O2T449+hXdPvd5wc7tpYX12OZslIEd6YWe4a7h+8PHT9D5/GVxhXEiTey2eC1aOnnINnUUuUx2vLtIGUqlKVq/FlgWf5ClstM1yF4Zk0F4zUIiGhkiLNgNxeLaDUfvzxXkAIgfmV7TJGcBJGSJUeFz36wllBlP/+6+suknQSlCGthGfyK7PpWKhcydckUYtRHBN5KZ/m4qHS+jK7OFNYmC6mNyRzlTIRSDlseT537uzApUvDk4HAX29s3C2olsUWk9K/r06jPBj94WmlJu68v4RuNpGEkzLCNJbbza98mL4qiowsj35vOLZVWL8VpnFcDwA6/AQt62FVwQSo7iVjj/WOP/fwzVs3PpicvVuAjcarJKhrawM5i8My+NoFqSxVtlKEApE1DQA4KKqd1nXrdb1Gw/jf/jL2/KPyO5+00bSVotCoorkexS9OkWPnB158eWxpbnYiEPgsrmyyh1rHGCOhztkF07SJOHrlrMnTVo3nFKaCdmgSRxs56kXU3a79lZ3NTz/JLORFXkG4yGwSVNFt7Y6nvzM2dubo7NTUxLVrEzH5Zgo+2PyGswJqarwUq0gV92ivf/wSbbFIGRayZVSP1WqM47pHbKH5TC3MCRW5TmBpt498e/TZN85RRHn6s4mF2flAVJ5Mavb6/K6K2pZvPuZ45ZK364jTfXzE2j5EQn95LsyvbJXWQ+VofDIci4vC00d9lMdlOuZ2DHndI242EgqjPJheiCdLE1vVqYSswC99wznVZ33hvOfKxQ5Ts6HJ3X0oD8xaHlQVoVCrJCq5OLMTSm5sJO4FObY6tVqcCnJrWfkrvaPpaXBxzP3sOd9zT3fYXSa9kab0lFhFVRPlAepAahUWJUEV5UE2XZ5azE6vl+YivCDDr/2WOdzfcmqkdWTINXDC4XXpzTqiWq7F42wwyKxuFO5sMneDxc0Ej/0/y38FGACBHjS0mkQ17AAAAABJRU5ErkJggg==");t.Piano=class{constructor(e){this.X=e,this.Ki=t.HTML.canvas({width:"32",height:"481",style:"width: 100%; height: 100%;"}),this._i=t.HTML.canvas({width:"32",height:"40"}),this.container=t.HTML.div({style:"width: 32px; height: 100%; overflow:hidden; position: relative; flex-shrink: 0; touch-action: none;"},this.Ki,this._i),this.$i=this.Ki.getContext("2d"),this.ts=this._i.getContext("2d"),this.ae=32,this.zt=481,this.Ft=0,this.It=!1,this.Lt=!1,this.es=-1,this.ee=!1,this.ss=-1,this.le=(t=>{this.Lt||(this.Lt=!0,this.we())}),this.ce=(t=>{this.Lt&&(this.Lt=!1,this.we())}),this.fe=(t=>{t.preventDefault(),this.It=!0;const e=this.Ki.getBoundingClientRect();this.Ft=((t.clientY||t.pageY)-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Ft)&&(this.Ft=0),this.X.synth.liveInputPressed=!0,this.we()}),this.me=(t=>{const e=this.Ki.getBoundingClientRect();this.Ft=((t.clientY||t.pageY)-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Ft)&&(this.Ft=0),this.ns(),this.X.synth.liveInputPitches[0]=this.os+12*this.X.song.channels[this.X.channel].octave,this.we()}),this.ni=(t=>{this.It=!1,this.X.synth.liveInputPressed=!1,this.we()}),this.de=(t=>{t.preventDefault(),this.It=!0;const e=this.Ki.getBoundingClientRect();this.Ft=(t.touches[0].clientY-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Ft)&&(this.Ft=0),this.ns(),this.X.synth.liveInputPressed=!0,this.X.synth.liveInputPitches[0]=this.os+12*this.X.song.channels[this.X.channel].octave}),this.ye=(t=>{t.preventDefault();const e=this.Ki.getBoundingClientRect();this.Ft=(t.touches[0].clientY-e.top)*this.zt/(e.bottom-e.top),isNaN(this.Ft)&&(this.Ft=0),this.ns(),this.X.synth.liveInputPitches[0]=this.os+12*this.X.song.channels[this.X.channel].octave}),this.vi=(t=>{t.preventDefault(),this.X.synth.liveInputPressed=!1}),this.Me=(()=>{const e=this.X.song.getChannelIsNoise(this.X.channel);this.xe=e?40:13,this.Ee=e?t.Config.drumCount:t.Config.windowPitchCount,this.ns(),this.X.synth.liveInputPitches[0]=this.os+12*this.X.song.channels[this.X.channel].octave,this.X.synth.liveInputChannel=this.X.channel,this.bi()}),this.bi=(()=>{if(!i)return void window.requestAnimationFrame(this.bi);if(!this.X.showLetters)return;const e=this.X.song.getChannelIsNoise(this.X.channel);if(this.es==this.X.song.scale&&this.ss==this.X.song.key&&this.ee==e)return;let s;this.es=this.X.song.scale,this.ss=this.X.song.key,this.ee=e,this.$i.clearRect(0,0,this.ae,this.zt);for(let i=0;i<this.Ee;i++){const n=(i+t.Config.keys[this.X.song.key].basePitch)%12;if(e){s=l;const t=1-i/this.Ee*.35,e=.5*(1-t),n=s.width*e,o=s.height*e+this.xe*(this.Ee-i-1),h=s.width*t,r=s.height*t;this.$i.drawImage(s,n,o,h,r);const a=1+(i-this.Ee/2)/this.Ee*.5,c=this.$i.getImageData(n,o,h,r),f=c.data;for(let t=0;t<f.length;t+=4)f[t+0]*=a,f[t+1]*=a,f[t+2]*=a;this.$i.putImageData(c,n,o)}else if(t.Config.scales[this.X.song.scale].flags[i%12]){let e;if(t.Config.keys[n].isWhiteKey)e=t.Config.keys[n].name;else{const s=t.Config.blackKeyNameParents[i%12];e=t.Config.keys[(n+12+s)%12].name,1==s?e+="♭":-1==s&&(e+="♯")}const h=t.Config.keys[n].isWhiteKey?"#000000":"#ffffff";s=t.Config.keys[n].isWhiteKey?r:o,this.$i.drawImage(s,0,this.xe*(this.Ee-i-1)),this.$i.font="bold 11px sans-serif",this.$i.fillStyle=h,this.$i.fillText(e,15,this.xe*(this.Ee-i)-3)}else s=t.Config.keys[n].isWhiteKey?a:h,this.$i.drawImage(s,0,this.xe*(this.Ee-i-1))}this.we()}),this.X.notifier.watch(this.Me),this.Me(),this.container.addEventListener("mousedown",this.fe),document.addEventListener("mousemove",this.me),document.addEventListener("mouseup",this.ni),this.container.addEventListener("mouseover",this.le),this.container.addEventListener("mouseout",this.ce),this.container.addEventListener("touchstart",this.de),this.container.addEventListener("touchmove",this.ye),this.container.addEventListener("touchend",this.vi),this.container.addEventListener("touchcancel",this.vi)}ns(){const e=t.Config.scales[this.X.song.scale].flags,i=Math.max(0,Math.min(this.Ee-1,this.Ee-this.Ft/this.xe));if(e[Math.floor(i)%12]||this.X.song.getChannelIsNoise(this.X.channel))this.os=Math.floor(i);else{let t=Math.floor(i)+1,s=Math.floor(i)-1;for(;!e[t%12];)t++;for(;!e[s%12];)s--;let n=t,o=s+1;t%12!=0&&t%12!=7||(n-=.5),s%12!=0&&s%12!=7||(o+=.5),this.os=i-o>n-i?t:s}}we(){this._i.style.visibility=!this.Lt||this.It?"hidden":"visible",this.Lt&&!this.It&&(this.ts.clearRect(0,0,32,40),this._i.style.left="0px",this._i.style.top=this.xe*(this.Ee-this.os-1)+"px",this.ts.lineWidth=2,this.ts.strokeStyle="#ffffff",this.ts.strokeRect(1,1,this.ae-2,this.xe-2))}}}(beepbox||(beepbox={})),function(t){const{button:e,div:i,span:s,h2:n,input:o,br:h,select:r,option:a}=t.HTML;class l{constructor(c){this.X=c,this.hs=o({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.rs=r({style:"width: 100%;"},a({value:"splice"},"Splice beats at end of bars."),a({value:"stretch"},"Stretch notes to fit in bars."),a({value:"overflow"},"Overflow notes across bars.")),this.as=e({className:"cancelButton"}),this.ls=e({className:"okayButton",style:"width:45%;"},"Okay"),this.container=i({className:"prompt noSelection",style:"width: 250px;"},n("Beats Per Bar"),i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},i({style:"text-align: right;"},"Beats per bar:",h(),s({style:"font-size: smaller; color: #888888;"},"(Multiples of 3 or 4 are recommended)")),this.hs),i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},i({className:"selectContainer",style:"width: 100%;"},this.rs)),i({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.ls),this.as),this._=(()=>{this.X.undo()}),this.cleanUp=(()=>{this.ls.removeEventListener("click",this.cs),this.as.removeEventListener("click",this._),this.hs.removeEventListener("keypress",l.fs),this.hs.removeEventListener("blur",l.us),this.container.removeEventListener("keydown",this.ds)}),this.ds=(t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.cs()}),this.cs=(()=>{window.localStorage.setItem("beatCountStrategy",this.rs.value),this.X.prompt=null,this.X.record(new t.ChangeBeatsPerBar(this.X,l.ms(this.hs),this.rs.value),!0)}),this.hs.value=this.X.song.beatsPerBar+"",this.hs.min=t.Config.beatsPerBarMin+"",this.hs.max=t.Config.beatsPerBarMax+"";const f=window.localStorage.getItem("beatCountStrategy");null!=f&&(this.rs.value=f),this.hs.select(),setTimeout(()=>this.hs.focus()),this.ls.addEventListener("click",this.cs),this.as.addEventListener("click",this._),this.hs.addEventListener("keypress",l.fs),this.hs.addEventListener("blur",l.us),this.container.addEventListener("keydown",this.ds)}static fs(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static us(t){const e=t.target;e.value=Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))+""}static ms(t){return Math.floor(Number(t.value))}}t.BeatsPerBarPrompt=l}(beepbox||(beepbox={})),function(t){const{button:e,div:i,span:s,h2:n,input:o,br:h,select:r,option:a}=t.HTML;class l{constructor(c){this.X=c,this.hs=o({style:"width: 3em; margin-left: 1em;",type:"number",step:"0.01",value:"0"}),this.rs=r({style:"width: 100%;"},a({value:"overflow"},"Overflow notes across bars."),a({value:"wrapAround"},"Wrap notes around within bars.")),this.as=e({className:"cancelButton"}),this.ls=e({className:"okayButton",style:"width:45%;"},"Okay"),this.container=i({className:"prompt noSelection",style:"width: 250px;"},n("Move Notes Sideways"),i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},i({style:"text-align: right;"},"Beats to move:",h(),s({style:"font-size: smaller; color: #888888;"},"(Negative is left, positive is right)")),this.hs),i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},i({className:"selectContainer",style:"width: 100%;"},this.rs)),i({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.ls),this.as),this._=(()=>{this.X.undo()}),this.cleanUp=(()=>{this.ls.removeEventListener("click",this.cs),this.as.removeEventListener("click",this._),this.hs.removeEventListener("blur",l.us),this.container.removeEventListener("keydown",this.ds)}),this.ds=(t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.cs()}),this.cs=(()=>{window.localStorage.setItem("moveNotesSidewaysStrategy",this.rs.value),this.X.prompt=null,this.X.record(new t.ChangeMoveNotesSideways(this.X,+this.hs.value,this.rs.value),!0)}),this.hs.min=-this.X.song.beatsPerBar+"",this.hs.max=this.X.song.beatsPerBar+"";const f=window.localStorage.getItem("moveNotesSidewaysStrategy");null!=f&&(this.rs.value=f),this.hs.select(),setTimeout(()=>this.hs.focus()),this.ls.addEventListener("click",this.cs),this.as.addEventListener("click",this._),this.hs.addEventListener("blur",l.us),this.container.addEventListener("keydown",this.ds)}static us(e){const i=e.target;let s=+i.value;s=Math.round(s*t.Config.partsPerBeat)/t.Config.partsPerBeat,s=Math.round(100*s)/100,i.value=Math.max(+i.min,Math.min(+i.max,s))+""}}t.MoveNotesSidewaysPrompt=l}(beepbox||(beepbox={})),function(t){const{button:e,div:i,span:s,h2:n,input:o,br:h,select:r,option:a}=t.HTML;class l{constructor(c){this.X=c,this.ps=o({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.ys=r({style:"width: 100%;"},a({value:"end"},"Apply change at end of song."),a({value:"beginning"},"Apply change at beginning of song.")),this.as=e({className:"cancelButton"}),this.ls=e({className:"okayButton",style:"width:45%;"},"Okay"),this.container=i({className:"prompt noSelection",style:"width: 250px;"},n("Song Length"),i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},i({style:"display: inline-block; text-align: right;"},"Bars per song:",h(),s({style:"font-size: smaller; color: #888888;"},"(Multiples of 4 are recommended)")),this.ps),i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},i({className:"selectContainer",style:"width: 100%;"},this.ys)),i({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.ls),this.as),this._=(()=>{this.X.undo()}),this.cleanUp=(()=>{this.ls.removeEventListener("click",this.cs),this.as.removeEventListener("click",this._),this.ps.removeEventListener("keypress",l.fs),this.ps.removeEventListener("blur",l.us),this.container.removeEventListener("keydown",this.ds)}),this.ds=(t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.cs()}),this.cs=(()=>{window.localStorage.setItem("barCountPosition",this.ys.value);const e=new t.ChangeGroup;e.append(new t.ChangeBarCount(this.X,l.ms(this.ps),"beginning"==this.ys.value)),this.X.prompt=null,this.X.record(e,!0)}),this.ps.value=this.X.song.barCount+"",this.ps.min=t.Config.barCountMin+"",this.ps.max=t.Config.barCountMax+"";const f=window.localStorage.getItem("barCountPosition");null!=f&&(this.ys.value=f),this.ps.select(),setTimeout(()=>this.ps.focus()),this.ls.addEventListener("click",this.cs),this.as.addEventListener("click",this._),this.ps.addEventListener("keypress",l.fs),this.ps.addEventListener("blur",l.us),this.container.addEventListener("keydown",this.ds)}static fs(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static us(t){const e=t.target;e.value=Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))+""}static ms(t){return Math.floor(Number(t.value))}}t.SongDurationPrompt=l}(beepbox||(beepbox={})),function(t){const{button:e,div:i,h2:s,input:n}=t.HTML;class o{constructor(h){this.X=h,this.gs=n({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.vs=n({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.bs=n({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.ws=n({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}),this.as=e({className:"cancelButton"}),this.ls=e({className:"okayButton",style:"width:45%;"},"Okay"),this.container=i({className:"prompt noSelection",style:"width: 250px;"},s("Channel Settings"),i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Pitch channels:",this.bs),i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Drum channels:",this.ws),i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Patterns per channel:",this.gs),i({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Instruments per channel:",this.vs),i({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.ls),this.as),this._=(()=>{this.X.undo()}),this.cleanUp=(()=>{this.ls.removeEventListener("click",this.cs),this.as.removeEventListener("click",this._),this.gs.removeEventListener("keypress",o.fs),this.vs.removeEventListener("keypress",o.fs),this.bs.removeEventListener("keypress",o.fs),this.ws.removeEventListener("keypress",o.fs),this.gs.removeEventListener("blur",o.us),this.vs.removeEventListener("blur",o.us),this.bs.removeEventListener("blur",o.us),this.ws.removeEventListener("blur",o.us),this.container.removeEventListener("keydown",this.ds)}),this.ds=(t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.cs()}),this.cs=(()=>{const e=new t.ChangeGroup;e.append(new t.ChangePatternsPerChannel(this.X,o.ms(this.gs))),e.append(new t.ChangeInstrumentsPerChannel(this.X,o.ms(this.vs))),e.append(new t.ChangeChannelCount(this.X,o.ms(this.bs),o.ms(this.ws))),this.X.prompt=null,this.X.record(e,!0)}),this.gs.value=this.X.song.patternsPerChannel+"",this.gs.min=t.Config.patternsPerChannelMin+"",this.gs.max=t.Config.patternsPerChannelMax+"",this.vs.value=this.X.song.instrumentsPerChannel+"",this.vs.min=t.Config.instrumentsPerChannelMin+"",this.vs.max=t.Config.instrumentsPerChannelMax+"",this.bs.value=this.X.song.pitchChannelCount+"",this.bs.min=t.Config.pitchChannelCountMin+"",this.bs.max=t.Config.pitchChannelCountMax+"",this.ws.value=this.X.song.noiseChannelCount+"",this.ws.min=t.Config.noiseChannelCountMin+"",this.ws.max=t.Config.noiseChannelCountMax+"",this.bs.select(),setTimeout(()=>this.bs.focus()),this.ls.addEventListener("click",this.cs),this.as.addEventListener("click",this._),this.gs.addEventListener("keypress",o.fs),this.vs.addEventListener("keypress",o.fs),this.bs.addEventListener("keypress",o.fs),this.ws.addEventListener("keypress",o.fs),this.gs.addEventListener("blur",o.us),this.vs.addEventListener("blur",o.us),this.bs.addEventListener("blur",o.us),this.ws.addEventListener("blur",o.us),this.container.addEventListener("keydown",this.ds)}static fs(t){const e=t.which?t.which:t.keyCode;return 46!=e&&e>31&&(e<48||e>57)&&(t.preventDefault(),!0)}static us(t){const e=t.target;e.value=Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))+""}static ms(t){return Math.floor(Number(t.value))}}t.ChannelSettingsPrompt=o}(beepbox||(beepbox={})),function(t){function e(t,e){const i=new ArrayBuffer(e);let s=0,n=Math.min(t.byteLength,i.byteLength);const o=[8,4,2,1];for(const e of o)if(n>=e){const o=h(e,t,i,s,n);s=o.nextOffset,n=o.leftBytes}return i;function h(t,e,i,s,n){let o=Uint8Array;switch(t){case 8:o=Float64Array;break;case 4:o=Float32Array;break;case 2:o=Uint16Array;break;case 1:default:o=Uint8Array}const h=new o(e,s,n/t|0),r=new o(i,s,n/t|0);for(let t=0;t<r.length;t++)r[t]=h[t];return{nextOffset:h.byteOffset+h.byteLength,leftBytes:n-r.length*t}}}t.ArrayBufferWriter=class{constructor(t){this.Ms=0,this.ks=0,this.xs=new ArrayBuffer(t),this.Es=new DataView(this.xs)}As(t){this.ks+=t,this.ks>this.xs.byteLength&&(this.xs=e(this.xs,Math.max(2*this.xs.byteLength,this.ks)),this.Es=new DataView(this.xs))}getWriteIndex(){return this.Ms}rewriteUint32(t,e){this.Es.setUint32(t,e>>>0,!1)}writeUint32(t){t>>>=0,this.As(4),this.Es.setUint32(this.Ms,t,!1),this.Ms=this.ks}writeUint24(t){t>>>=0,this.As(3),this.Es.setUint8(this.Ms,t>>16&255),this.Es.setUint8(this.Ms+1,t>>8&255),this.Es.setUint8(this.Ms+2,255&t),this.Ms=this.ks}writeUint16(t){t>>>=0,this.As(2),this.Es.setUint16(this.Ms,t,!1),this.Ms=this.ks}writeUint8(t){t>>>=0,this.As(1),this.Es.setUint8(this.Ms,t),this.Ms=this.ks}writeInt8(t){t|=0,this.As(1),this.Es.setInt8(this.Ms,t),this.Ms=this.ks}writeMidi7Bits(t){if((t>>>=0)>=128)throw new Error("7 bit value contained 8th bit!");this.As(1),this.Es.setUint8(this.Ms,t),this.Ms=this.ks}writeMidiVariableLength(t){if((t>>>=0)>268435455)throw new Error("writeVariableLength value too big.");let e=!1;for(let i=0;i<4;i++){const s=t>>>21-7*i&127;0==s&&3!=i||(e=!0),e&&this.writeUint8((3==i?0:128)|s)}}writeMidiAscii(t){this.writeMidiVariableLength(t.length);for(let e=0;e<t.length;e++){const i=t.charCodeAt(e);if(i>127)throw new Error("Trying to write unicode character as ascii.");this.writeUint8(i)}}toCompactArrayBuffer(){return e(this.xs,this.ks)}}}(beepbox||(beepbox={})),function(t){t.defaultMidiExpression=127,t.defaultMidiPitchBend=8192,t.analogousDrumMap={35:{frequency:0,duration:2,volume:3},36:{frequency:0,duration:2,volume:3},37:{frequency:5,duration:1,volume:3},38:{frequency:4,duration:2,volume:3},39:{frequency:5,duration:2,volume:3},40:{frequency:4,duration:2,volume:3},41:{frequency:1,duration:2,volume:3},42:{frequency:8,duration:1,volume:3},43:{frequency:1,duration:2,volume:3},44:{frequency:8,duration:1,volume:2},45:{frequency:2,duration:2,volume:3},46:{frequency:8,duration:4,volume:3},47:{frequency:2,duration:2,volume:3},48:{frequency:3,duration:2,volume:3},49:{frequency:7,duration:4,volume:3},50:{frequency:3,duration:2,volume:3},51:{frequency:6,duration:4,volume:2},52:{frequency:7,duration:4,volume:3},53:{frequency:6,duration:2,volume:3},54:{frequency:11,duration:2,volume:3},55:{frequency:9,duration:4,volume:3},56:{frequency:7,duration:1,volume:2},57:{frequency:7,duration:4,volume:3},58:{frequency:10,duration:2,volume:2},59:{frequency:6,duration:4,volume:3},69:{frequency:10,duration:2,volume:3},70:{frequency:10,duration:2,volume:3},73:{frequency:10,duration:1,volume:2},74:{frequency:10,duration:2,volume:2}},t.midiVolumeToVolumeMult=function(t){return Math.pow(t/127,4)/.3844015376046128},t.volumeMultToMidiVolume=function(t){return 127*Math.pow(.3844015376046128*t,.25)},t.midiExpressionToVolumeMult=function(t){return Math.pow(t/127,4)},t.volumeMultToMidiExpression=function(t){return 127*Math.pow(t,.25)}}(beepbox||(beepbox={})),function(t){const{button:e,div:i,h2:s,input:n,select:o,option:h}=t.HTML;function r(t,e,i){return t+i*(e-t)}function a(t,e){if(navigator.msSaveOrOpenBlob)return void navigator.msSaveOrOpenBlob(t,e);const i=document.createElement("a");if(void 0!=i.download){const s=URL.createObjectURL(t);setTimeout(function(){URL.revokeObjectURL(s)},6e4),i.href=s,i.download=e,setTimeout(function(){i.dispatchEvent(new MouseEvent("click"))},0)}else{const e=URL.createObjectURL(t);setTimeout(function(){URL.revokeObjectURL(e)},6e4),window.open(e,"_blank")||(window.location.href=e)}}class l{constructor(t){this.X=t,this.Cs=n({type:"text",style:"width: 10em;",value:"BeepBox-Song",maxlength:250,autofocus:"autofocus"}),this.qs=n({type:"checkbox"}),this.Ns=n({style:"width: 2em;",type:"number",min:"1",max:"4",step:"1"}),this.Rs=n({type:"checkbox"}),this.Ps=o({style:"width: 100%;"},h({value:"wav"},"Export to .wav file."),h({value:"midi"},"Export to .mid file."),h({value:"json"},"Export to .json file.")),this.as=e({className:"cancelButton"}),this.Ss=e({className:"exportButton",style:"width:45%;"},"Export"),this.container=i({className:"prompt noSelection",style:"width: 200px;"},s("Export Options"),i({style:"display: flex; flex-direction: row; align-items: center; justify-content: space-between;"},"File name:",this.Cs),i({style:"display: table; width: 100%;"},i({style:"display: table-row;"},i({style:"display: table-cell;"},"Intro:"),i({style:"display: table-cell;"},"Loop Count:"),i({style:"display: table-cell;"},"Outro:")),i({style:"display: table-row;"},i({style:"display: table-cell; vertical-align: middle;"},this.qs),i({style:"display: table-cell; vertical-align: middle;"},this.Ns),i({style:"display: table-cell; vertical-align: middle;"},this.Rs))),i({className:"selectContainer",style:"width: 100%;"},this.Ps),i({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this.Ss),this.as),this._=(()=>{this.X.undo()}),this.cleanUp=(()=>{this.Cs.removeEventListener("input",l.Ts),this.Ns.removeEventListener("blur",l.us),this.Ss.removeEventListener("click",this.zs),this.as.removeEventListener("click",this._),this.container.removeEventListener("keydown",this.ds)}),this.ds=(t=>{"BUTTON"!=t.target.tagName&&13==t.keyCode&&this.zs()}),this.zs=(()=>{switch(window.localStorage.setItem("exportFormat",this.Ps.value),this.Ps.value){case"wav":this.Bs();break;case"midi":this.Fs();break;case"json":this.Is();break;default:throw new Error("Unhandled file export type.")}}),this.Ns.value="1",0==this.X.song.loopStart?(this.qs.checked=!1,this.qs.disabled=!0):(this.qs.checked=!0,this.qs.disabled=!1),this.X.song.loopStart+this.X.song.loopLength==this.X.song.barCount?(this.Rs.checked=!1,this.Rs.disabled=!0):(this.Rs.checked=!0,this.Rs.disabled=!1);const r=window.localStorage.getItem("exportFormat");null!=r&&(this.Ps.value=r),this.Cs.select(),setTimeout(()=>this.Cs.focus()),this.Cs.addEventListener("input",l.Ts),this.Ns.addEventListener("blur",l.us),this.Ss.addEventListener("click",this.zs),this.as.addEventListener("click",this._),this.container.addEventListener("keydown",this.ds)}static Ts(t){const e=t.target,i=/[\+\*\$\?\|\{\}\\\/<>#%!`&'"=:@]/gi;if(i.test(e.value)){let t=e.selectionStart;e.value=e.value.replace(i,""),t--,e.setSelectionRange(t,t)}}static us(t){const e=t.target;e.value=Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))+""}Bs(){const e=new t.Synth(this.X.song);if(e.enableIntro=this.qs.checked,e.enableOutro=this.Rs.checked,e.loopCount=Number(this.Ns.value),!e.enableIntro)for(let t=0;t<this.X.song.loopStart;t++)e.nextBar();const i=e.totalSamples,s=new Float32Array(i);e.synthesize(s,i);const n=1*i;let o=0;const h=new ArrayBuffer(44+2*n),r=new DataView(h);let l,c,f;r.setUint32(o,1380533830,!1),o+=4,r.setUint32(o,36+2*n,!0),o+=4,r.setUint32(o,1463899717,!1),o+=4,r.setUint32(o,1718449184,!1),o+=4,r.setUint32(o,16,!0),o+=4,r.setUint16(o,1,!0),o+=2,r.setUint16(o,1,!0),o+=2,r.setUint32(o,44100,!0),o+=4,r.setUint32(o,88200,!0),o+=4,r.setUint16(o,2,!0),o+=2,r.setUint16(o,16,!0),o+=2,r.setUint32(o,1684108385,!1),o+=4,r.setUint32(o,2*n,!0),o+=4,l=1,c=1;for(let t=0;t<i;t++){f=Math.floor(32767*Math.max(-1,Math.min(1,s[t*l])));for(let t=0;t<c;t++)r.setInt16(o,f,!0),o+=2}a(new Blob([h],{type:"audio/wav"}),this.Cs.value.trim()+".wav"),this._()}Fs(){const e=this.X.song,i=2*t.Config.ticksPerPart*t.Config.partsPerBeat,s=2*t.Config.ticksPerPart,n=e.getBeatsPerMinute(),o=Math.round(6e7/n),h=i*e.beatsPerBar,c=[];if(this.qs.checked)for(let t=0;t<e.loopStart;t++)c.push(t);for(let t=0;t<Number(this.Ns.value);t++)for(let t=e.loopStart;t<e.loopStart+e.loopLength;t++)c.push(t);if(this.Rs.checked)for(let t=e.loopStart+e.loopLength;t<e.barCount;t++)c.push(t);const f=[{isMeta:!0,channel:-1,midiChannel:-1,isNoise:!1,isDrumset:!1}];let u=0,d=!1;for(let t=0;t<this.X.song.getChannelCount();t++)d||4!=this.X.song.channels[t].instruments[0].type?(f.push({isMeta:!1,channel:t,midiChannel:u++,isNoise:this.X.song.getChannelIsNoise(t),isDrumset:!1}),9==u&&u++):(f.push({isMeta:!1,channel:t,midiChannel:9,isNoise:!0,isDrumset:!0}),d=!0);const m=new t.ArrayBufferWriter(1024);m.writeUint32(1297377380),m.writeUint32(6),m.writeUint16(1),m.writeUint16(f.length),m.writeUint16(i);for(const n of f){m.writeUint32(1297379947);const{isMeta:a,channel:f,midiChannel:u,isNoise:d,isDrumset:y}=n,g=m.getWriteIndex();m.writeUint32(0);let v=0,b=0;const w=function(t){if(t<v)throw new Error("Midi event time cannot go backwards.");m.writeMidiVariableLength(t-v),v=t},M=function(t,e){if(!(e>=0&&e<=127))throw new Error("Midi control event value out of range: "+e);m.writeUint8(176|u),m.writeMidi7Bits(t),m.writeMidi7Bits(0|e)};if(a){w(0),m.writeUint8(255),m.writeMidi7Bits(1),m.writeMidiAscii("Composed with beepbox.co"),w(0),m.writeUint8(255),m.writeMidi7Bits(81),m.writeMidiVariableLength(3),m.writeUint24(o),w(0),m.writeUint8(255),m.writeMidi7Bits(88),m.writeMidiVariableLength(4),m.writeUint8(e.beatsPerBar),m.writeUint8(2),m.writeUint8(24),m.writeUint8(8);const i=t.Config.scales[e.scale].flags[3]&&!t.Config.scales[e.scale].flags[4],s=e.key;let n=s;for(1==(1&s)&&(n+=6),i&&(n+=9);n>6;)n-=12;w(0),m.writeUint8(255),m.writeMidi7Bits(89),m.writeMidiVariableLength(2),m.writeInt8(n),m.writeUint8(i?1:0),this.qs.checked&&(b+=h*e.loopStart),w(b),m.writeUint8(255),m.writeMidi7Bits(6),m.writeMidiAscii("Loop Start");for(let t=0;t<parseInt(this.Ns.value);t++)b+=h*e.loopLength,w(b),m.writeUint8(255),m.writeMidi7Bits(6),m.writeMidiAscii(t<Number(this.Ns.value)-1?"Loop Repeat":"Loop End");if(this.Rs.checked&&(b+=h*(e.barCount-e.loopStart-e.loopLength)),b!=h*c.length)throw new Error("Miscalculated number of bars.")}else{let n=d?t.EditorConfig.noiseColors[(f-e.pitchChannelCount)%t.EditorConfig.noiseColors.length].name+" channel":t.EditorConfig.pitchColors[f%t.EditorConfig.pitchColors.length].name+" channel";w(0),m.writeUint8(255),m.writeMidi7Bits(3),m.writeMidiAscii(n),w(0),M(101,0),w(0),M(100,0),w(0),M(6,24),w(0),M(38,0),w(0),M(101,127),w(0),M(100,127);let o=-1;function p(i){const s=e.channels[f].instruments[i],n=t.EditorConfig.valueToPreset(s.preset);if(o!=i){if(o=i,w(b),m.writeUint8(255),m.writeMidi7Bits(4),m.writeMidiAscii("Instrument "+(i+1)),!y){let t=81;if(null!=n&&void 0!=n.midiProgram)t=n.midiProgram;else if(4==s.type)t=116;else{const e=s.getFilterEnvelope().type,i=8==e||4==e;if(2==s.type||3==s.type)t=d?116:i?47:75;else if(0==s.type){const e=i?l.midiDecayInstruments:l.midiSustainInstruments;e.length>s.chipWave&&(t=e[s.chipWave])}else if(6==s.type)t=i?25:81;else{if(1!=s.type&&5!=s.type)throw new Error("Unrecognized instrument type.");t=i?2:81}}w(b),m.writeUint8(192|u),m.writeMidi7Bits(t)}w(b);let e=t.volumeMultToMidiVolume(t.Synth.instrumentVolumeToVolumeMult(s.volume));M(7,Math.min(127,Math.round(e)))}}null==e.getPattern(f,0)&&p(0);let a=t.defaultMidiPitchBend,g=t.defaultMidiExpression,v=!1;const k=d?t.Config.spectrumBasePitch:t.Config.keys[e.key].basePitch,x=d?t.Config.noiseInterval:1;for(const n of c){const o=e.getPattern(f,n);if(null!=o){const n=o.instrument,h=e.channels[f].instruments[n],l=t.EditorConfig.valueToPreset(h.preset);p(n);let c=!1,E=!0,A=1;c=h.getChord().harmonizes,(E=h.getChord().arpeggiates)?c&&(0==h.type?A=2:1==h.type?A=4:console.error("Unrecognized instrument type for harmonizing arpeggio: "+h.type)):A=4;for(let n=0;n<o.notes.length;n++){const h=o.notes[n],c=b+h.start*s;let f=c,p=h.pins[0].volume,C=h.pins[0].interval;const q=[-1,-1,-1,-1],N=[-1,-1,-1,-1],R=Math.min(A,h.pitches.length),P=y?Math.max(1,Math.round(90*h.pins[0].volume/3)):90;let S=h.pickMainInterval()*x;if(!y){let t=24,e=-24;for(let i=1;i<h.pins.length;i++){const s=h.pins[i].interval*x;t=Math.min(t,s+24),e=Math.max(e,s-24)}S=Math.min(t,Math.max(e,S))}for(let n=1;n<h.pins.length;n++){const o=c+h.pins[n].time*s,v=h.pins[n].volume,A=h.pins[n].interval,T=o-f;for(let n=0;n<T;n++){const o=f+n,z=r(p,v,n/T),B=r(C,A,n/T)*x-S,F=Math.max(0,Math.min(16383,Math.round(8192*(1+B/24)))),I=Math.min(127,Math.round(t.volumeMultToMidiExpression(t.Synth.expressionToVolumeMult(z))));F!=a&&(w(o),m.writeUint8(224|u),m.writeMidi7Bits(127&F),m.writeMidi7Bits(F>>7&127),a=F),I==g||y||(w(o),M(11,I),g=I);const L=o==c;for(let n=0;n<R;n++){let r=h.pitches[n];if(y){const t=[36,41,45,48,40,39,59,49,46,55,69,54];if((r+=S)<0||r>=t.length)throw new Error("Could not find corresponding drumset pitch. "+r);r=t[r]}else{if(E&&h.pitches.length>n+1&&n==R-1){const a=(o-b)%i,l=t.Config.rhythms[e.rhythm].ticksPerArpeggio*s/t.Config.ticksPerPart,c=Math.floor(a/l),f=t.Config.rhythms[e.rhythm].arpeggioPatterns[h.pitches.length-1-n];r=h.pitches[n+f[c%f.length]]}r=k+r*x+S,null!=l&&void 0!=l.midiSubharmonicOctaves?r+=12*l.midiSubharmonicOctaves:d&&(r+=12*+t.EditorConfig.presetCategories.dictionary["Drum Presets"].presets.dictionary["taiko drum"].midiSubharmonicOctaves),d&&(r*=2)}r=Math.max(0,Math.min(127,r)),N[n]=r,L||q[n]==N[n]||(w(o),m.writeUint8(128|u),m.writeMidi7Bits(q[n]),m.writeMidi7Bits(P))}for(let t=0;t<R;t++)(L||q[t]!=N[t])&&(w(o),m.writeUint8(144|u),m.writeMidi7Bits(N[t]),m.writeMidi7Bits(P),q[t]=N[t])}f=o,p=v,C=A}const T=b+h.end*s;for(let t=0;t<R;t++)w(T),m.writeUint8(128|u),m.writeMidi7Bits(q[t]),m.writeMidi7Bits(P);v=!0}}else v&&(v=!1,g!=t.defaultMidiExpression&&(g=t.defaultMidiExpression,w(b),M(11,g)),a!=t.defaultMidiPitchBend&&(a=t.defaultMidiPitchBend,w(b),m.writeUint8(224|u),m.writeMidi7Bits(127&a),m.writeMidi7Bits(a>>7&127)));b+=h}}w(b),m.writeUint8(255),m.writeMidi7Bits(47),m.writeMidiVariableLength(0),m.rewriteUint32(g,m.getWriteIndex()-g-4)}a(new Blob([m.toCompactArrayBuffer()],{type:"audio/midi"}),this.Cs.value.trim()+".mid"),this._()}Is(){const t=this.X.song.toJsonObject(this.qs.checked,Number(this.Ns.value),this.Rs.checked),e=JSON.stringify(t,null,"\t");a(new Blob([e],{type:"application/json"}),this.Cs.value.trim()+".json"),this._()}}l.midiSustainInstruments=[74,71,80,70,70,68,68,81,81,81,81,81,81],l.midiDecayInstruments=[33,46,46,6,6,24,24,25,25,25,25,106,106],t.ExportPrompt=l}(beepbox||(beepbox={})),function(t){class e{constructor(t){this.m=0,this.Es=t}getReadIndex(){return this.m}readUint32(){if(this.m+4>this.Es.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.Es.getUint32(this.m,!1);return this.m+=4,t}readUint24(){return this.readUint8()<<16|this.readUint8()<<8|this.readUint8()}readUint16(){if(this.m+2>this.Es.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.Es.getUint16(this.m,!1);return this.m+=2,t}readUint8(){if(this.m+1>this.Es.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.Es.getUint8(this.m);return this.m++,t}readInt8(){if(this.m+1>this.Es.byteLength)throw new Error("Reading past the end of the buffer.");const t=this.Es.getInt8(this.m);return this.m++,t}peakUint8(){if(this.m+1>this.Es.byteLength)throw new Error("Reading past the end of the buffer.");return this.Es.getUint8(this.m)}readMidi7Bits(){const t=this.readUint8();return t>=128&&console.log("7 bit value contained 8th bit! value "+t+", index "+this.m),127&t}readMidiVariableLength(){let t=0;for(let e=0;e<4;e++){const e=this.readUint8();if(t+=127&e,!(128&e))break;t<<=7}return t}skipBytes(t){this.m+=t}hasMore(){return this.Es.byteLength>this.m}getReaderForNextBytes(t){if(this.m+t>this.Es.byteLength)throw new Error("Reading past the end of the buffer.");const i=new e(new DataView(this.Es.buffer,this.Es.byteOffset+this.m,t));return this.skipBytes(t),i}}t.ArrayBufferReader=e}(beepbox||(beepbox={})),function(t){const{button:e,p:i,div:s,h2:n,input:o}=t.HTML;t.ImportPrompt=class{constructor(h){this.X=h,this.Ls=o({type:"file",accept:".json,application/json,.mid,.midi,audio/midi,audio/x-midi"}),this.as=e({className:"cancelButton"}),this.container=s({className:"prompt noSelection",style:"width: 300px;"},n("Import"),i({style:"text-align: left; margin: 0.5em 0;"},"BeepBox songs can be exported and re-imported as .json files. You could also use other means to make .json files for BeepBox as long as they follow the same structure."),i({style:"text-align: left; margin: 0.5em 0;"},"BeepBox can also (crudely) import .mid files. There are many tools available for creating .mid files. Shorter and simpler songs are more likely to work well."),this.Ls,this.as),this._=(()=>{this.X.undo()}),this.cleanUp=(()=>{this.Ls.removeEventListener("change",this.Hs),this.as.removeEventListener("click",this._)}),this.Hs=(()=>{const e=this.Ls.files[0];if(!e)return;const i=e.name.slice(2+(e.name.lastIndexOf(".")-1>>>0));if("json"==i){const i=new FileReader;i.addEventListener("load",e=>{this.X.prompt=null,this.X.goBackToStart(),this.X.record(new t.ChangeSong(this.X,i.result),!0)}),i.readAsText(e)}else if("midi"==i||"mid"==i){const t=new FileReader;t.addEventListener("load",e=>{this.X.prompt=null,this.X.goBackToStart(),this.Ds(t.result)}),t.readAsArrayBuffer(e)}else console.error("Unrecognized file extension."),this._()}),this.Ls.select(),setTimeout(()=>this.Ls.focus()),this.Ls.addEventListener("change",this.Hs),this.as.addEventListener("click",this._)}Ds(e){const i=new t.ArrayBufferReader(new DataView(e));let s=null;const n=[];for(;i.hasMore();){const t=i.readUint32(),e=i.readUint32();if(1297377380==t)null==s?s=i.getReaderForNextBytes(e):console.error("This MIDI file has more than one header chunk.");else if(1297379947==t){const t=i.getReaderForNextBytes(e);t.hasMore()&&n.push({reader:t,nextEventMidiTick:t.readMidiVariableLength(),ended:!1,runningStatus:-1})}else i.skipBytes(e)}if(null==s)return console.error("No header chunk found in this MIDI file."),void this._();const o=s.readUint16();s.readUint16();const h=s.readUint16();let r=0;const a=[],l=2==o;if(l)a.push(r);else for(let t=0;t<n.length;t++)a.push(t);const c=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],f=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],u=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],m=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],p=[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],y=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],g=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],v=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];let b=5e5,w=8,M=0,k=!1,x=0;for(;;){let e=Number.MAX_VALUE,i=!1;for(const s of a){const o=n[s];for(;!o.ended&&o.nextEventMidiTick==x;){const s=128&o.reader.peakUint8()?o.reader.readUint8():o.runningStatus,h=240&s,E=15&s;240!=h&&(o.runningStatus=s);let A=!1;switch(h){case 128:{const t=o.reader.readMidi7Bits();o.reader.readMidi7Bits(),y[E].push({midiTick:x,pitch:t,velocity:0,program:-1,instrumentVolume:-1,on:!1})}break;case 144:{const e=o.reader.readMidi7Bits(),i=o.reader.readMidi7Bits();if(0==i)y[E].push({midiTick:x,pitch:e,velocity:0,program:-1,instrumentVolume:-1,on:!1});else{const s=Math.max(0,Math.min(t.Config.volumeRange-1,Math.round(t.Synth.volumeMultToInstrumentVolume(t.midiVolumeToVolumeMult(p[E])))));y[E].push({midiTick:x,pitch:e,velocity:Math.max(0,Math.min(1,(i+14)/90)),program:m[E],instrumentVolume:s,on:!0})}}break;case 160:o.reader.readMidi7Bits(),o.reader.readMidi7Bits();break;case 176:{const e=o.reader.readMidi7Bits(),i=o.reader.readMidi7Bits();switch(e){case 6:0==c[E]&&0==f[E]&&(u[E]=i);break;case 7:p[E]=i;break;case 11:v[E].push({midiTick:x,volume:t.Synth.volumeMultToExpression(t.midiExpressionToVolumeMult(i))});break;case 38:0==c[E]&&0==f[E]&&(d[E]=i);break;case 100:f[E]=i;break;case 101:c[E]=i}}break;case 192:{const t=o.reader.readMidi7Bits();m[E]=t}break;case 208:o.reader.readMidi7Bits();break;case 224:{const t=o.reader.readMidi7Bits(),e=((o.reader.readMidi7Bits()<<7|t)/8192-1)*(u[E]+.01*d[E]);g[E].push({midiTick:x,interval:e})}break;case 240:if(255==s){const e=o.reader.readMidi7Bits(),i=o.reader.readMidiVariableLength();if(47==e)A=!0,o.reader.skipBytes(i);else if(81==e)b=o.reader.readUint24(),o.reader.skipBytes(i-3);else if(88==e){const e=o.reader.readUint8();let s=o.reader.readUint8();for(o.reader.readUint8(),o.reader.readUint8(),o.reader.skipBytes(i-4),w=4*e;0==(1&w)&&(s>0||w>t.Config.beatsPerBarMax)&&w>=2*t.Config.beatsPerBarMin;)w>>=1,s-=1;w=Math.max(t.Config.beatsPerBarMin,Math.min(t.Config.beatsPerBarMax,w))}else 89==e?(M=o.reader.readInt8(),k=1==o.reader.readUint8(),o.reader.skipBytes(i-2)):o.reader.skipBytes(i)}else{if(240!=s&&247!=s)return console.error("Unrecognized event status: "+s),void this._();{const t=o.reader.readMidiVariableLength();o.reader.skipBytes(t)}}break;default:return console.error("Unrecognized event type: "+h),void this._()}!A&&o.reader.hasMore()?o.nextEventMidiTick=x+o.reader.readMidiVariableLength():(o.ended=!0,l&&++r<n.length&&(a[0]=r,n[r].nextEventMidiTick+=x,e=Math.min(e,n[r].nextEventMidiTick),i=!0))}o.ended||(i=!0,e=Math.min(e,o.nextEventMidiTick))}if(!i)break;x=e}const E=6e7/b,A=h/t.Config.partsPerBeat,C=t.Config.partsPerBeat*w,q=Math.ceil(x/A/C);function N(t){return Math.round(t/A)}let R=M;for(k&&(R+=3),1==(1&R)&&(R+=6);R<0;)R+=12;R%=12;const P=[],S=[];for(let e=0;e<16;e++){if(0==y[e].length)continue;const i=new t.Channel,s=t.EditorConfig.midiProgramToPresetValue(y[e][0].program),n=null==s?null:t.EditorConfig.valueToPreset(s),o=9==e,r=o||null!=n&&1==n.isNoise,a=r?t.Config.spectrumBasePitch:t.Config.keys[R].basePitch,l=r?t.Config.noiseInterval:1,c=r?.5:1,f=r?t.Config.drumCount-1:t.Config.maxPitch;r?o?S.unshift(i):S.push(i):P.push(i);let u=1,d=0,m=0;if(o){const s=[];let n=-1,o=null,h=0,r=!1;const a=t.EditorConfig.nameToPresetValue("standard drumset"),l=t.EditorConfig.valueToPreset(a),c=new t.Instrument(!1);c.fromJsonObject(l.settings,!1),c.preset=a,i.instruments.push(c);for(let a=0;a<=y[e].length;a++){const l=a==y[e].length?null:y[e][a],d=null==l?Number.MAX_SAFE_INTEGER:N(l.midiTick);if(s.length>0&&d>h&&(null==l||l.on)){const e=Math.floor(h/C),a=e*C;if(n!=e||null==o){for(n++;n<e;)i.bars[n]=0,n++;o=new t.Pattern,i.patterns.push(o),i.bars[n]=i.patterns.length,o.instrument=0}(!r||c.volume>m)&&(c.volume=m,r=!0);const l=[];let p=f,y=0,g=1;for(const e of s){const i=t.analogousDrumMap[e];-1==l.indexOf(i.frequency)&&l.push(i.frequency),g=Math.max(g,Math.round(i.volume*u)),p=Math.min(p,i.duration),y=Math.max(y,i.duration)}const v=Math.min(y,Math.max(p,2)),b=h-a,w=Math.min(C,Math.min(d-a,b+6*v)),M=new t.Note(-1,b,w,g,!0);M.pitches.length=0;for(let t=0;t<Math.min(4,l.length);t++){const e=l[t+Math.max(0,l.length-4)];-1==M.pitches.indexOf(e)&&M.pitches.push(e)}o.notes.push(M),s.length=0}null!=l&&l.on&&void 0!=t.analogousDrumMap[l.pitch]&&(s.push(l.pitch),h=d,u=l.velocity,m=l.instrumentVolume)}}else{let s=0,n=3,o=0,p=0;function T(t){for(;o<g[e].length&&g[e][o].midiTick<=t;)s=g[e][o].interval,o++}function z(t){for(;p<v[e].length&&v[e][p].midiTick<=t;)n=v[e][p].volume,p++}const b=[],M=[];let k=-1,x=null,E=0,q=0,R=0,P=0;for(let o of y[e]){const e=o.midiTick,p=N(e);if(M.length>0&&p>q){const o=Math.floor(q/C),y=Math.ceil(p/C);for(let g=o;g<y;g++){const o=g*C,y=g*w*h,v=(g+1)*w*h,N=Math.max(0,q-o),S=Math.min(C,p-o),B=Math.max(y,E),F=Math.min(v,e);if(N<S){const e=t.EditorConfig.midiProgramToPresetValue(d),h=null==e?null:t.EditorConfig.valueToPreset(e);if(k!=g||null==x){for(k++;k<g;)i.bars[k]=0,k++;if(x=new t.Pattern,i.patterns.push(x),i.bars[k]=i.patterns.length,void 0==b[d]){const s=new t.Instrument(r);b[d]=s,null!=e&&null!=h&&1==h.isNoise==r?(s.fromJsonObject(h.settings,r),s.preset=e):(s.setTypeAndReset(r?2:0,r),s.chord=0),s.volume=m,i.instruments.push(s)}x.instrument=i.instruments.indexOf(b[d])}void 0!=b[d]&&(b[d].volume=Math.min(b[d].volume,m));const p=new t.Note(-1,N,S,3,!1);p.pins.length=0,T(B),z(B);const y=M[0]*c-a,v=Math.round((y+s)/l),w=Math.round(s-a);let E=t.makeNotePin(0,0,Math.round(u*n));p.pins.push(E);const C=[{part:0,pitch:v,volume:E.volume,keyPitch:!1,keyVolume:!1}];let q=0,I=(y+s)/l,L=u*n;for(let e=N+1;e<=S;e++){const i=Math.max(B,Math.min(F-1,Math.round(A*(e+o)))),h=e-N,r=e==S;T(i),z(i);const a=(s+y)/l,c=u*n,f=Math.round(a),d=Math.abs(a-f)<.01,m=Math.abs(I-Math.round(I))<.01?Math.abs(a-I)>=1:Math.floor(a)!=Math.floor(I),g=d||m,b=Math.round(c),w=Math.abs(c-b)<.01,M=Math.abs(L-Math.round(L))?Math.abs(c-L)>=1:Math.floor(c)!=Math.floor(L),k=w||M;if(I=a,L=c,g||k||r){const e={part:h,pitch:f,volume:b,keyPitch:g||r,keyVolume:k||r},i=C[q];let s=!1,n=Number.MAX_VALUE;if(e.keyPitch){const t=(e.pitch-i.pitch)/(e.part-i.part);let o=Math.abs(t),h=!1,r=Number.MAX_VALUE;for(let e=q+1;e<C.length;e++){const s=C[e];if(s.keyPitch){const n=i.pitch+t*(s.part-i.part),a=Math.abs(n-s.pitch);o<a&&(o=a,h=!0,r=e)}}h&&(s=!0,n=Math.min(n,r))}if(e.keyVolume){const t=(e.volume-i.volume)/(e.part-i.part);let o=Math.abs(t),h=!1,r=Number.MAX_VALUE;for(let e=q+1;e<C.length;e++){const s=C[e];if(s.keyVolume){const n=i.volume+t*(s.part-i.part),a=Math.abs(n-s.volume);o<a&&(o=a,h=!0,r=e)}}h&&(s=!0,n=Math.min(n,r))}if(s){const e=C[n];p.pins.push(t.makeNotePin(e.pitch-v,e.part,e.volume)),q=n}C.push(e)}}const H=C[C.length-1];p.pins.push(t.makeNotePin(H.pitch-v,H.part,H.volume));let D=f,U=0;for(const t of p.pins)D=Math.min(D,f-t.interval),U=Math.min(U,-t.interval);p.pitches.length=0;for(let t=0;t<Math.min(4,M.length);t++){let e=M[t+Math.max(0,M.length-4)]*c;null!=h&&void 0!=h.midiSubharmonicOctaves&&(e-=12*h.midiSubharmonicOctaves);const i=Math.max(U,Math.min(D,Math.round((e+w)/l)));if(-1==p.pitches.indexOf(i)){p.pitches.push(i);const t=p.end-p.start;R+=i*t,P+=t}}x.notes.push(p)}}}-1!=M.indexOf(o.pitch)&&M.splice(M.indexOf(o.pitch),1),o.on&&(M.push(o.pitch),u=o.velocity,d=o.program,m=o.instrumentVolume),E=e,q=p}const S=R/P;i.octave=r?0:Math.max(0,Math.min(t.Config.scrollableOctaves,Math.round(S/12-1.5)))}for(;i.bars.length<q;)i.bars.push(0)}function B(t,e){for(;t.length>e;){let e=t.length-2,i=t.length-1,s=Number.MAX_VALUE,n=Number.MAX_VALUE;for(let o=0;o<t.length-1;o++)for(let h=o+1;h<t.length;h++){const r=t[o],a=t[h];let l=0,c=0;for(let t=0;t<r.bars.length&&t<a.bars.length;t++)0!=r.bars[t]&&0!=a.bars[t]&&l++,0==r.bars[t]&&0==a.bars[t]&&c++;l<=s&&(l<s||c<n)&&(e=o,i=h,s=l,n=c)}const o=t[e],h=t[i],r=o.instruments.length,a=o.patterns.length;for(const t of h.instruments)o.instruments.push(t);for(const t of h.patterns)t.instrument+=r,o.patterns.push(t);for(let t=0;t<o.bars.length&&t<h.bars.length;t++)0==o.bars[t]&&0!=h.bars[t]&&(o.bars[t]=h.bars[t]+a);t.splice(i,1)}}B(P,t.Config.pitchChannelCountMax),B(S,t.Config.noiseChannelCountMax),this.X.goBackToStart(),this.X.prompt=null,this.X.record(new class extends t.ChangeGroup{constructor(e){super();const i=e.song;i.tempo=Math.max(t.Config.tempoMin,Math.min(t.Config.tempoMax,E)),i.beatsPerBar=w,i.key=R,i.scale=11,i.reverb=1,i.rhythm=1,t.removeDuplicatePatterns(P),t.removeDuplicatePatterns(S),this.append(new t.ChangeReplacePatterns(e,P,S)),i.loopStart=0,i.loopLength=i.barCount,this.tt(),e.notifier.changed()}}(this.X),!0)}}}(beepbox||(beepbox={})),function(t){const{button:e,div:i,span:s,select:n,option:o,optgroup:h,input:r}=t.HTML,a=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent);function l(t,e){for(let i=0;i<e.length;i++)t.appendChild(o({value:i},e[i]));return t}function c(e){const i=n();i.appendChild(h({label:"Edit"},o({value:"copyInstrument"},"Copy Instrument"),o({value:"pasteInstrument"},"Paste Instrument"),o({value:"randomPreset"},"Random Preset"),o({value:"randomGenerated"},"Random Generated")));const s=h({label:t.EditorConfig.presetCategories[0].name});e?(s.appendChild(o({value:2},t.EditorConfig.valueToPreset(2).name)),s.appendChild(o({value:3},t.EditorConfig.valueToPreset(3).name)),s.appendChild(o({value:4},t.EditorConfig.valueToPreset(4).name))):(s.appendChild(o({value:0},t.EditorConfig.valueToPreset(0).name)),s.appendChild(o({value:6},t.EditorConfig.valueToPreset(6).name)),s.appendChild(o({value:5},t.EditorConfig.valueToPreset(5).name)),s.appendChild(o({value:3},t.EditorConfig.valueToPreset(3).name)),s.appendChild(o({value:1},t.EditorConfig.valueToPreset(1).name))),i.appendChild(s);for(let s=1;s<t.EditorConfig.presetCategories.length;s++){const n=t.EditorConfig.presetCategories[s],r=h({label:n.name});let a=!1;for(let t=0;t<n.presets.length;t++){const i=n.presets[t];1==i.isNoise==e&&(r.appendChild(o({value:(s<<6)+t},i.name)),a=!0)}a&&i.appendChild(r)}return i}function f(t,e){const i=e.toString();t.value!=i&&(t.value=i)}class u{constructor(t,e,i){this.input=t,this.X=e,this.Us=i,this.fi=null,this.Zs=0,this.Gs=0,this.Os=(()=>{this.X.lastChangeWas(this.fi)||(this.Gs=this.Zs),this.fi=this.Us(this.Gs,parseInt(this.input.value)),this.X.setProspectiveChange(this.fi)}),this.js=(()=>{this.X.record(this.fi),this.fi=null}),t.addEventListener("input",this.Os),t.addEventListener("change",this.js)}updateValue(t){this.Zs=t,this.input.value=String(t)}}class d{constructor(h){this.X=h,this.prompt=null,this.Ws=new t.PatternEditor(this.X),this.Vs=new t.TrackEditor(this.X),this.Ys=new t.LoopEditor(this.X),this.Bi=i({className:"trackContainer"},this.Vs.container,this.Ys.container),this.Js=new t.BarScrollBar(this.X,this.Bi),this.Qs=new t.OctaveScrollBar(this.X),this.Xs=new t.Piano(this.X),this.Ks=i(i({className:"editorBox noSelection",style:"height: 481px; display: flex; flex-direction: row; margin-bottom: 6px;"},this.Xs.container,this.Ws.container,this.Qs.container),this.Bi,this.Js.container),this._s=e({style:"width: 80px;",type:"button"}),this.$s=e({className:"prevBarButton",style:"width: 40px;",type:"button",title:"Previous Bar (left bracket)"}),this.tn=e({className:"nextBarButton",style:"width: 40px;",type:"button",title:"Next Bar (right bracket)"}),this.en=r({title:"main volume",style:"width: 5em; flex-grow: 1; margin: 0;",type:"range",min:"0",max:"100",value:"50",step:"1"}),this.in=n({style:"width: 100%;"},o({selected:!0,disabled:!0,hidden:!1},"File"),o({value:"new"},"+ New Blank Song"),o({value:"import"},"↑ Import..."),o({value:"export"},"↓ Export...")),this.sn=n({style:"width: 100%;"},o({selected:!0,disabled:!0,hidden:!1},"Edit"),o({value:"undo"},"Undo (Z)"),o({value:"redo"},"Redo (Y)"),o({value:"copy"},"Copy Pattern Notes (C)"),o({value:"paste"},"Paste Pattern Notes (V)"),o({value:"transposeUp"},"Move Pattern Notes Up (+)"),o({value:"transposeDown"},"Move Pattern Notes Down (-)"),o({value:"forceScale"},"Snap All Notes To Scale"),o({value:"forceRhythm"},"Snap All Notes To Rhythm"),o({value:"moveNotesSideways"},"Move All Notes Sideways..."),o({value:"beatsPerBar"},"Change Beats Per Bar..."),o({value:"barCount"},"Change Song Length..."),o({value:"channelSettings"},"Channel Settings..."),o({value:"detectKey"},"Detect Key")),this.nn=n({style:"width: 100%;"},o({selected:!0,disabled:!0,hidden:!1},"Preferences"),o({value:"autoPlay"},"Auto Play On Load"),o({value:"autoFollow"},"Auto Follow Track"),o({value:"showLetters"},"Show Piano Keys"),o({value:"showFifth"},'Highlight "Fifth" Notes'),o({value:"showChannels"},"Show All Channels"),o({value:"showScrollBar"},"Octave Scroll Bar"),o({value:"alwaysShowSettings"},"Customize All Instruments")),this.hn=l(n(),t.Config.scales.map(t=>t.name)),this.rn=l(n(),t.Config.keys.map(t=>t.name).reverse()),this.an=new u(r({style:"margin: 0; width: 4em; flex-grow: 1; vertical-align: middle;",type:"range",min:"0",max:"14",value:"7",step:"1"}),this.X,(e,i)=>new t.ChangeTempo(this.X,e,Math.round(120*Math.pow(2,(-4+i)/9)))),this.ln=r({style:"width: 3em; margin-left: 0.4em; vertical-align: middle;",type:"number",step:"1"}),this.cn=new u(r({style:"margin: 0;",type:"range",min:"0",max:t.Config.reverbRange-1,value:"0",step:"1"}),this.X,(e,i)=>new t.ChangeReverb(this.X,e,i)),this.fn=l(n(),t.Config.rhythms.map(t=>t.name)),this.un=c(!1),this.dn=c(!0),this.mn=l(n(),t.Config.algorithms.map(t=>t.name)),this.pn=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("algorithm")},"Algorithm: "),i({className:"selectContainer"},this.mn)),this.gn=n(),this.vn=i({className:"selectRow",style:"display: none;"},s({class:"tip",onclick:()=>this.yn("instrumentIndex")},"Instrument: "),i({className:"selectContainer"},this.gn)),this.bn=new u(r({style:"margin: 0;",type:"range",min:-(t.Config.volumeRange-1),max:"0",value:"0",step:"1"}),this.X,(e,i)=>new t.ChangeVolume(this.X,e,-i)),this.wn=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("instrumentVolume")},"Volume: "),this.bn.input),this.Mn=l(n(),t.Config.chipWaves.map(t=>t.name)),this.kn=l(n(),t.Config.chipNoises.map(t=>t.name)),this.xn=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("chipWave")},"Wave: "),i({className:"selectContainer"},this.Mn)),this.En=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("chipNoise")},"Noise: "),i({className:"selectContainer"},this.kn)),this.An=l(n(),t.Config.transitions.map(t=>t.name)),this.Cn=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("transition")},"Transition:"),i({className:"selectContainer"},this.An)),this.qn=l(n(),t.Config.effectsNames),this.Nn=new u(r({style:"margin: 0;",type:"range",min:"0",max:t.Config.filterCutoffRange-1,value:"6",step:"1"}),this.X,(e,i)=>new t.ChangeFilterCutoff(this.X,e,i)),this.Rn=i({className:"selectRow",title:"Low-pass Filter Cutoff Frequency"},s({class:"tip",onclick:()=>this.yn("filterCutoff")},"Filter Cut:"),this.Nn.input),this.Pn=new u(r({style:"margin: 0;",type:"range",min:"0",max:t.Config.filterResonanceRange-1,value:"6",step:"1"}),this.X,(e,i)=>new t.ChangeFilterResonance(this.X,e,i)),this.Sn=i({className:"selectRow",title:"Low-pass Filter Peak Resonance"},s({class:"tip",onclick:()=>this.yn("filterResonance")},"Filter Peak:"),this.Pn.input),this.Tn=l(n(),t.Config.envelopes.map(t=>t.name)),this.zn=i({className:"selectRow",title:"Low-pass Filter Envelope"},s({class:"tip",onclick:()=>this.yn("filterEnvelope")},"Filter Env:"),i({className:"selectContainer"},this.Tn)),this.Bn=l(n(),t.Config.envelopes.map(t=>t.name)),this.Fn=i({className:"selectRow",title:"Pulse Width Modulator Envelope"},s({class:"tip",onclick:()=>this.yn("pulseEnvelope")},"Pulse Env:"),i({className:"selectContainer"},this.Bn)),this.In=new u(r({style:"margin: 0;",type:"range",min:"0",max:t.Config.pulseWidthRange-1,value:"0",step:"1"}),this.X,(e,i)=>new t.ChangePulseWidth(this.X,e,i)),this.Ln=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("pulseWidth")},"Pulse Width:"),this.In.input),this.Hn=l(n(),t.Config.intervals.map(t=>t.name)),this.Dn=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("interval")},"Interval:"),i({className:"selectContainer"},this.Hn)),this.Un=l(n(),t.Config.chords.map(t=>t.name)),this.Zn=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("chords")},"Chords:"),i({className:"selectContainer"},this.Un)),this.Gn=l(n(),t.Config.vibratos.map(t=>t.name)),this.On=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("vibrato")},"Vibrato:"),i({className:"selectContainer"},this.Gn)),this.jn=i({className:"editor-controls"}),this.Wn=l(n(),t.Config.feedbacks.map(t=>t.name)),this.Vn=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("feedbackType")},"Feedback:"),i({className:"selectContainer"},this.Wn)),this.Yn=new t.SpectrumEditor(this.X,null),this.Jn=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("spectrum")},"Spectrum:"),this.Yn.container),this.Qn=new t.HarmonicsEditor(this.X),this.Xn=i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("harmonics")},"Harmonics:"),this.Qn.container),this.Kn=i({className:"editor-controls"}),this._n=new u(r({style:"margin: 0; width: 4em;",type:"range",min:"0",max:t.Config.operatorAmplitudeMax,value:"0",step:"1",title:"Feedback Amplitude"}),this.X,(e,i)=>new t.ChangeFeedbackAmplitude(this.X,e,i)),this.$n=l(n({style:"width: 100%;",title:"Feedback Envelope"}),t.Config.envelopes.map(t=>t.name)),this.to=i({className:"operatorRow"},i({style:"margin-right: .1em; visibility: hidden;"},"1."),i({style:"width: 3em; margin-right: .3em;"}),this._n.input,i({className:"selectContainer",style:"width: 5em; margin-left: .3em;"},this.$n)),this.eo=e({type:"button",style:"margin: 2px 0"},"Customize Instrument",t.SVG.svg({style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"-13 -13 26 26"},t.SVG.g({transform:"translate(0,1)"},t.SVG.circle({cx:"0",cy:"0",r:"6.5",stroke:"currentColor","stroke-width":"1",fill:"none"}),t.SVG.rect({x:"-1",y:"-5",width:"2",height:"4",fill:"currentColor",transform:"rotate(30)"}),t.SVG.circle({cx:"-7.79",cy:"4.5",r:"0.75",fill:"currentColor"}),t.SVG.circle({cx:"-9",cy:"0",r:"0.75",fill:"currentColor"}),t.SVG.circle({cx:"-7.79",cy:"-4.5",r:"0.75",fill:"currentColor"}),t.SVG.circle({cx:"-4.5",cy:"-7.79",r:"0.75",fill:"currentColor"}),t.SVG.circle({cx:"0",cy:"-9",r:"0.75",fill:"currentColor"}),t.SVG.circle({cx:"4.5",cy:"-7.79",r:"0.75",fill:"currentColor"}),t.SVG.circle({cx:"7.79",cy:"-4.5",r:"0.75",fill:"currentColor"}),t.SVG.circle({cx:"9",cy:"0",r:"0.75",fill:"currentColor"}),t.SVG.circle({cx:"7.79",cy:"4.5",r:"0.75",fill:"currentColor"})))),this.io=i({className:"editor-controls"},this.Rn,this.Sn,this.zn,this.Cn,i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("effects")},"Effects:"),i({className:"selectContainer"},this.qn)),this.Zn,this.On,this.Dn,this.xn,this.En,this.pn,this.jn,this.Vn,this.to,this.Jn,this.Xn,this.Kn,this.Fn,this.Ln),this.so=i({className:"editor-controls"},this.vn,this.wn,i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("instrumentType")},"Type: "),i({className:"selectContainer"},this.un,this.dn)),this.eo,this.io),this.no=i({className:"promptContainer",style:"display: none;"}),this.mainLayer=i({className:"beepboxEditor",tabIndex:"0"},this.Ks,i({className:"editor-widget-column noSelection"},i({style:"text-align: center; color: #999;"},t.Config.versionDisplayName),i({className:"editor-widgets"},i({className:"editor-controls"},i({className:"playback-controls"},i({className:"playback-bar-controls"},this._s,this.$s,this.tn),i({className:"playback-volume-controls"},t.SVG.svg({style:"flex-shrink: 0;",width:"2em",height:"2em",viewBox:"0 0 26 26"},t.SVG.path({d:"M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z",fill:"#777"})),this.en))),i({className:"editor-settings"},i({className:"editor-song-settings"},i({className:"editor-menus"},i({className:"selectContainer menu"},this.in,t.SVG.svg({style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"-5 -21 26 26"},t.SVG.path({d:"M 2 0 L 2 -16 L 10 -16 L 14 -12 L 14 0 z M 3 -1 L 13 -1 L 13 -11 L 9 -11 L 9 -15 L 3 -15 z",fill:"currentColor"}))),i({className:"selectContainer menu"},this.sn,t.SVG.svg({style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"-5 -21 26 26"},t.SVG.path({d:"M 0 0 L 1 -4 L 4 -1 z M 2 -5 L 10 -13 L 13 -10 L 5 -2 zM 11 -14 L 13 -16 L 14 -16 L 16 -14 L 16 -13 L 14 -11 z",fill:"currentColor"}))),i({className:"selectContainer menu"},this.nn,t.SVG.svg({style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"-13 -13 26 26"},t.SVG.path({d:"M 5.78 -1.6 L 7.93 -0.94 L 7.93 0.94 L 5.78 1.6 L 4.85 3.53 L 5.68 5.61 L 4.21 6.78 L 2.36 5.52 L 0.27 5.99 L -0.85 7.94 L -2.68 7.52 L -2.84 5.28 L -4.52 3.95 L -6.73 4.28 L -7.55 2.59 L -5.9 1.07 L -5.9 -1.07 L -7.55 -2.59 L -6.73 -4.28 L -4.52 -3.95 L -2.84 -5.28 L -2.68 -7.52 L -0.85 -7.94 L 0.27 -5.99 L 2.36 -5.52 L 4.21 -6.78 L 5.68 -5.61 L 4.85 -3.53 M 2.92 0.67 L 2.92 -0.67 L 2.35 -1.87 L 1.3 -2.7 L 0 -3 L -1.3 -2.7 L -2.35 -1.87 L -2.92 -0.67 L -2.92 0.67 L -2.35 1.87 L -1.3 2.7 L -0 3 L 1.3 2.7 L 2.35 1.87 z",fill:"currentColor"})))),i({style:"margin: 3px 0; text-align: center; color: #999;"},"Song Settings"),i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("scale")},"Scale: "),i({className:"selectContainer"},this.hn)),i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("key")},"Key: "),i({className:"selectContainer"},this.rn)),i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("tempo")},"Tempo: "),s({style:"display: flex;"},this.an.input,this.ln)),i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("reverb")},"Reverb: "),this.cn.input),i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("rhythm")},"Rhythm: "),i({className:"selectContainer"},this.fn))),i({className:"editor-instrument-settings"},i({style:"margin: 3px 0; text-align: center; color: #999;"},"Instrument Settings"),this.so)))),this.no),this.oo=!1,this.ho=null,this.ro=null,this.ao=[],this.lo=[],this.co=[],this.fo=[],this.uo=[],this.do=[],this.mo=(()=>{this.mainLayer.focus()}),this.whenUpdated=(()=>{const e=this.Bi.getBoundingClientRect();this.X.trackVisibleBars=Math.floor((e.right-e.left)/32),this.Js.render(),this.Vs.render();const i=[(this.X.autoPlay?"✓ ":"")+"Auto Play On Load",(this.X.autoFollow?"✓ ":"")+"Auto Follow Track",(this.X.showLetters?"✓ ":"")+"Show Piano Keys",(this.X.showFifth?"✓ ":"")+'Highlight "Fifth" Notes',(this.X.showChannels?"✓ ":"")+"Show All Channels",(this.X.showScrollBar?"✓ ":"")+"Octave Scroll Bar",(this.X.alwaysShowSettings?"✓ ":"")+"Customize All Instruments"];for(let t=0;t<i.length;t++){const e=this.nn.children[t+1];e.innerText!=i[t]&&(e.innerText=i[t])}const s=this.X.song.channels[this.X.channel],n=this.X.getCurrentPattern(),o=this.X.getCurrentInstrument(),h=s.instruments[o],r=this.mainLayer.contains(document.activeElement),a=document.activeElement;if(f(this.hn,this.X.song.scale),f(this.rn,t.Config.keys.length-1-this.X.song.key),this.an.updateValue(Math.max(0,Math.min(28,Math.round(4+9*Math.log(this.X.song.tempo/120)/Math.LN2)))),this.ln.value=this.X.song.tempo.toString(),this.cn.updateValue(this.X.song.reverb),f(this.fn,this.X.song.rhythm),this.X.song.getChannelIsNoise(this.X.channel)?(this.un.style.display="none",this.dn.style.display="",f(this.dn,h.preset)):(this.un.style.display="",this.dn.style.display="none",f(this.un,h.preset)),this.X.alwaysShowSettings||h.preset==h.type){if(this.eo.style.display="none",this.io.style.display="",2==h.type?(this.En.style.display="",f(this.kn,h.chipNoise)):this.En.style.display="none",3==h.type?(this.Jn.style.display="",this.Yn.render()):this.Jn.style.display="none",5==h.type?(this.Xn.style.display="",this.Qn.render()):this.Xn.style.display="none",4==h.type){this.Kn.style.display="",this.Cn.style.display="none",this.Zn.style.display="none",this.Rn.style.display="none",this.Sn.style.display="none",this.zn.style.display="none";for(let e=0;e<t.Config.drumCount;e++)f(this.do[e],h.drumsetEnvelopes[e]),this.uo[e].render()}else this.Kn.style.display="none",this.Cn.style.display="",this.Zn.style.display="",this.Rn.style.display="",this.Sn.style.display="",this.zn.style.display="";if(0==h.type?(this.xn.style.display="",f(this.Mn,h.chipWave)):this.xn.style.display="none",1==h.type){this.pn.style.display="",this.jn.style.display="",this.Vn.style.display="",this.to.style.display="",f(this.mn,h.algorithm),f(this.Wn,h.feedbackType),this._n.updateValue(h.feedbackAmplitude),f(this.$n,h.feedbackEnvelope),this.$n.parentElement.style.color=h.feedbackAmplitude>0?"":"#999";for(let e=0;e<t.Config.operatorCount;e++){const i=e<t.Config.algorithms[h.algorithm].carrierCount;this.ao[e].style.color=i?"white":"",f(this.fo[e],h.operators[e].frequency),this.lo[e].updateValue(h.operators[e].amplitude),f(this.co[e],h.operators[e].envelope);const s=(i?"Voice ":"Modulator ")+(e+1);this.fo[e].title=s+" Frequency",this.lo[e].input.title=s+(i?" Volume":" Amplitude"),this.co[e].title=s+" Envelope",this.co[e].parentElement.style.color=h.operators[e].amplitude>0?"":"#999"}}else this.pn.style.display="none",this.jn.style.display="none",this.Vn.style.display="none",this.to.style.display="none";if(6==h.type?(this.Fn.style.display="",this.Ln.style.display="",this.In.input.title=t.prettyNumber(50*Math.pow(.5,.5*(t.Config.pulseWidthRange-h.pulseWidth-1)))+"%",f(this.Bn,h.pulseEnvelope),this.In.updateValue(h.pulseWidth)):(this.Fn.style.display="none",this.Ln.style.display="none"),2==h.type)this.On.style.display="none",this.Dn.style.display="none";else if(3==h.type)this.On.style.display="none",this.Dn.style.display="none";else if(4==h.type)this.On.style.display="none",this.Dn.style.display="none";else if(0==h.type)this.On.style.display="",this.Dn.style.display="";else if(1==h.type)this.On.style.display="",this.Dn.style.display="none";else if(5==h.type)this.On.style.display="",this.Dn.style.display="";else{if(6!=h.type)throw new Error("Unrecognized instrument type: "+h.type);this.On.style.display="",this.Dn.style.display="none"}}else this.eo.style.display="",this.io.style.display="none";for(let e=0;e<t.Config.chords.length;e++){const i=!t.Config.instrumentTypeHasSpecialInterval[h.type]&&t.Config.chords[e].isCustomInterval,s=this.Un.children[e];i?s.hasAttribute("hidden")||s.setAttribute("hidden",""):s.removeAttribute("hidden")}for(let e=0;e<t.Config.effectsNames.length;e++){const i=!t.Config.instrumentTypeHasChorus[h.type]&&-1!=t.Config.effectsNames[e].indexOf("chorus"),s=this.qn.children[e];i?s.hasAttribute("hidden")||s.setAttribute("hidden",""):s.removeAttribute("hidden")}if(this.vn.style.display=this.X.song.instrumentsPerChannel>1?"":"none",this.vn.style.visibility=null==n?"hidden":"",this.gn.children.length!=this.X.song.instrumentsPerChannel){for(;this.gn.firstChild;)this.gn.removeChild(this.gn.firstChild);const t=[];for(let e=0;e<this.X.song.instrumentsPerChannel;e++)t.push(e+1);l(this.gn,t)}this.so.style.color=this.X.getNoteColorBright(this.X.channel),this.Nn.updateValue(h.filterCutoff),this.Pn.updateValue(h.filterResonance),f(this.Tn,h.filterEnvelope),f(this.An,h.transition),f(this.qn,h.effects),f(this.Gn,h.vibrato),f(this.Hn,h.interval),f(this.Un,h.chord),this.bn.updateValue(-h.volume),f(this.gn,o),this.Xs.container.style.display=this.X.showLetters?"":"none",this.Qs.container.style.display=this.X.showScrollBar?"":"none",this.Js.container.style.display=this.X.song.barCount>this.X.trackVisibleBars?"":"none";let c=512;this.X.showLetters&&(c-=32),this.X.showScrollBar&&(c-=20),this.Ws.container.style.width=String(c)+"px",this.en.value=String(this.X.volume),r&&null!=a&&0==a.clientWidth&&this.mo(),this.po(this.X.prompt),this.X.autoFollow&&!this.X.synth.playing&&this.X.synth.snapToBar(this.X.bar)}),this.yo=(t=>{switch(t.keyCode){case 38:case 40:case 37:case 39:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:t.stopPropagation()}}),this.ds=(e=>{if(this.prompt)27==e.keyCode&&window.history.back();else switch(this.Vs.onKeyPressed(e),e.keyCode){case 32:this.vo(),e.preventDefault();break;case 90:e.shiftKey?this.X.redo():this.X.undo(),e.preventDefault();break;case 89:this.X.redo(),e.preventDefault();break;case 67:this.bo(),e.preventDefault();break;case 86:this.wo(),e.preventDefault();break;case 73:if(e.shiftKey){const t=this.X.song.channels[this.X.channel].instruments[this.X.getCurrentInstrument()].toJsonObject();delete t.volume,delete t.preset,this.Mo(JSON.stringify(t))}break;case 219:this.X.synth.prevBar(),this.X.autoFollow&&new t.ChangeChannelBar(this.X,this.X.channel,Math.floor(this.X.synth.playhead)),e.preventDefault();break;case 221:this.X.synth.nextBar(),this.X.autoFollow&&new t.ChangeChannelBar(this.X,this.X.channel,Math.floor(this.X.synth.playhead)),e.preventDefault();break;case 189:case 173:this.ko(!1),e.preventDefault();break;case 187:case 61:this.ko(!0),e.preventDefault()}}),this.xo=(()=>{this.X.synth.prevBar()}),this.Eo=(()=>{this.X.synth.nextBar()}),this.vo=(()=>{this.X.synth.playing?this.Ao():this.Co()}),this.qo=(()=>{this.X.setVolume(Number(this.en.value))}),this.No=(()=>{this.X.record(new t.ChangeTempo(this.X,-1,0|parseInt(this.ln.value)))}),this.Ro=(()=>{this.X.record(new t.ChangeScale(this.X,this.hn.selectedIndex))}),this.Po=(()=>{this.X.record(new t.ChangeKey(this.X,t.Config.keys.length-1-this.rn.selectedIndex))}),this.So=(()=>{this.X.record(new t.ChangeRhythm(this.X,this.fn.selectedIndex))}),this.To=(()=>{this.zo(this.un.value)}),this.Bo=(()=>{this.zo(this.dn.value)}),this.Fo=(()=>{this.X.record(new t.ChangeFeedbackType(this.X,this.Wn.selectedIndex))}),this.Io=(()=>{this.X.record(new t.ChangeFeedbackEnvelope(this.X,this.$n.selectedIndex))}),this.Lo=(()=>{this.X.record(new t.ChangeAlgorithm(this.X,this.mn.selectedIndex))}),this.Ho=(()=>{const e=this.X.getCurrentPattern();null!=e&&this.X.record(new t.ChangePatternInstrument(this.X,this.gn.selectedIndex,e))}),this.Do=(()=>{this.X.record(new t.ChangeCustomizeInstrument(this.X))}),this.Uo=(()=>{this.X.record(new t.ChangeChipWave(this.X,this.Mn.selectedIndex))}),this.Zo=(()=>{this.X.record(new t.ChangeNoiseWave(this.X,this.kn.selectedIndex))}),this.Go=(()=>{this.X.record(new t.ChangeFilterEnvelope(this.X,this.Tn.selectedIndex))}),this.Oo=(()=>{this.X.record(new t.ChangePulseEnvelope(this.X,this.Bn.selectedIndex))}),this.jo=(()=>{this.X.record(new t.ChangeTransition(this.X,this.An.selectedIndex))}),this.Wo=(()=>{this.X.record(new t.ChangeEffects(this.X,this.qn.selectedIndex))}),this.Vo=(()=>{this.X.record(new t.ChangeVibrato(this.X,this.Gn.selectedIndex))}),this.Yo=(()=>{this.X.record(new t.ChangeInterval(this.X,this.Hn.selectedIndex))}),this.Jo=(()=>{this.X.record(new t.ChangeChord(this.X,this.Un.selectedIndex))}),this.Qo=(e=>{switch(this.in.value){case"new":this.X.goBackToStart(),this.X.record(new t.ChangeSong(this.X,""));break;case"export":this.yn("export");break;case"import":this.yn("import")}this.in.selectedIndex=0}),this.Xo=(e=>{switch(this.sn.value){case"undo":this.X.undo();break;case"redo":this.X.redo();break;case"copy":this.bo();break;case"paste":this.wo();break;case"transposeUp":this.ko(!0);break;case"transposeDown":this.ko(!1);break;case"detectKey":this.X.record(new t.ChangeDetectKey(this.X));break;case"forceScale":this.X.record(new t.ChangeForceScale(this.X));break;case"forceRhythm":this.X.record(new t.ChangeForceRhythm(this.X));break;case"barCount":this.yn("barCount");break;case"beatsPerBar":this.yn("beatsPerBar");break;case"moveNotesSideways":this.yn("moveNotesSideways");break;case"channelSettings":this.yn("channelSettings")}this.sn.selectedIndex=0}),this.Ko=(t=>{switch(this.nn.value){case"autoPlay":this.X.autoPlay=!this.X.autoPlay;break;case"autoFollow":this.X.autoFollow=!this.X.autoFollow;break;case"showLetters":this.X.showLetters=!this.X.showLetters;break;case"showFifth":this.X.showFifth=!this.X.showFifth;break;case"showChannels":this.X.showChannels=!this.X.showChannels;break;case"showScrollBar":this.X.showScrollBar=!this.X.showScrollBar;break;case"alwaysShowSettings":this.X.alwaysShowSettings=!this.X.alwaysShowSettings}this.nn.selectedIndex=0,this.X.notifier.changed(),this.X.savePreferences()}),this.X.notifier.watch(this.whenUpdated),this.jn.appendChild(i({className:"operatorRow",style:"color: #999; height: 1em; margin-top: 0.5em;"},i({style:"margin-right: .1em; visibility: hidden;"},"1."),i({style:"width: 3em; margin-right: .3em;",class:"tip",onclick:()=>this.yn("operatorFrequency")},"Freq:"),i({style:"width: 4em; margin: 0;",class:"tip",onclick:()=>this.yn("operatorVolume")},"Volume:"),i({style:"width: 5em; margin-left: .3em;",class:"tip",onclick:()=>this.yn("operatorEnvelope")},"Envelope:")));for(let e=0;e<t.Config.operatorCount;e++){const s=e,o=i({style:"margin-right: .1em; color: #999;"},e+1+"."),h=l(n({style:"width: 100%;",title:"Frequency"}),t.Config.operatorFrequencies.map(t=>t.name)),a=new u(r({style:"margin: 0; width: 4em;",type:"range",min:"0",max:t.Config.operatorAmplitudeMax,value:"0",step:"1",title:"Volume"}),this.X,(e,i)=>new t.ChangeOperatorAmplitude(this.X,s,e,i)),c=l(n({style:"width: 100%;",title:"Envelope"}),t.Config.envelopes.map(t=>t.name)),f=i({className:"operatorRow"},o,i({className:"selectContainer",style:"width: 3em; margin-right: .3em;"},h),a.input,i({className:"selectContainer",style:"width: 5em; margin-left: .3em;"},c));this.jn.appendChild(f),this.ao[e]=f,this.lo[e]=a,this.co[e]=c,this.fo[e]=h,c.addEventListener("change",()=>{this.X.record(new t.ChangeOperatorEnvelope(this.X,s,c.selectedIndex))}),h.addEventListener("change",()=>{this.X.record(new t.ChangeOperatorFrequency(this.X,s,h.selectedIndex))})}this.Kn.appendChild(i({className:"selectRow"},s({class:"tip",onclick:()=>this.yn("drumsetEnvelope")},"Envelope:"),s({class:"tip",onclick:()=>this.yn("drumsetSpectrum")},"Spectrum:")));for(let e=t.Config.drumCount-1;e>=0;e--){const s=e,o=new t.SpectrumEditor(this.X,s);o.container.addEventListener("mousedown",this.mo),this.uo[e]=o;const h=l(n({style:"width: 100%;",title:"Filter Envelope"}),t.Config.envelopes.map(t=>t.name));this.do[e]=h,h.addEventListener("change",()=>{this.X.record(new t.ChangeDrumsetEnvelope(this.X,s,h.selectedIndex))});const r=i({className:"selectRow"},i({className:"selectContainer",style:"width: 5em; margin-right: .3em;"},h),this.uo[e].container);this.Kn.appendChild(r)}this.in.addEventListener("change",this.Qo),this.sn.addEventListener("change",this.Xo),this.nn.addEventListener("change",this.Ko),this.ln.addEventListener("change",this.No),this.hn.addEventListener("change",this.Ro),this.rn.addEventListener("change",this.Po),this.fn.addEventListener("change",this.So),this.un.addEventListener("change",this.To),this.dn.addEventListener("change",this.Bo),this.mn.addEventListener("change",this.Lo),this.gn.addEventListener("change",this.Ho),this.eo.addEventListener("click",this.Do),this.Wn.addEventListener("change",this.Fo),this.$n.addEventListener("change",this.Io),this.Mn.addEventListener("change",this.Uo),this.kn.addEventListener("change",this.Zo),this.An.addEventListener("change",this.jo),this.qn.addEventListener("change",this.Wo),this.Tn.addEventListener("change",this.Go),this.Bn.addEventListener("change",this.Oo),this.Hn.addEventListener("change",this.Yo),this.Un.addEventListener("change",this.Jo),this.Gn.addEventListener("change",this.Vo),this._s.addEventListener("click",this.vo),this.$s.addEventListener("click",this.xo),this.tn.addEventListener("click",this.Eo),this.en.addEventListener("input",this.qo),this.Ks.addEventListener("mousedown",this.mo),this.Yn.container.addEventListener("mousedown",this.mo),this.Qn.container.addEventListener("mousedown",this.mo),this.ln.addEventListener("keydown",this.yo,!1),this.mainLayer.addEventListener("keydown",this.ds),this.no.addEventListener("click",t=>{t.target==this.no&&this.X.undo()}),a&&(this.nn.children[1].disabled=!0)}yn(t){this.X.openPrompt(t),this.po(t)}po(e){if(this.ho!=e&&(this.ho=e,this.prompt&&(!this.oo||this.prompt instanceof t.TipPrompt||this.Co(),this.oo=!1,this.no.style.display="none",this.no.removeChild(this.prompt.container),this.prompt.cleanUp(),this.prompt=null,this.mainLayer.focus()),e)){switch(e){case"export":this.prompt=new t.ExportPrompt(this.X);break;case"import":this.prompt=new t.ImportPrompt(this.X);break;case"barCount":this.prompt=new t.SongDurationPrompt(this.X);break;case"beatsPerBar":this.prompt=new t.BeatsPerBarPrompt(this.X);break;case"moveNotesSideways":this.prompt=new t.MoveNotesSidewaysPrompt(this.X);break;case"channelSettings":this.prompt=new t.ChannelSettingsPrompt(this.X);break;default:this.prompt=new t.TipPrompt(this.X,e)}this.prompt&&(this.prompt instanceof t.TipPrompt||(this.oo=this.X.synth.playing,this.Ao()),this.no.style.display=null,this.no.appendChild(this.prompt.container))}}updatePlayButton(){this.X.synth.playing?(this._s.classList.remove("playButton"),this._s.classList.add("pauseButton"),this._s.title="Pause (Space)",this._s.innerText="Pause"):(this._s.classList.remove("pauseButton"),this._s.classList.add("playButton"),this._s.title="Play (Space)",this._s.innerText="Play")}Mo(t){const e=document.createElement("textarea");e.innerText=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),e.remove(),this.mo()}Co(){this.X.synth.play(),this.updatePlayButton()}Ao(){this.X.synth.pause(),this.X.autoFollow?this.X.synth.snapToBar(this.X.bar):this.X.synth.snapToBar(),this.updatePlayButton()}bo(){const t=this.X.getCurrentPattern();if(null==t)return;const e={notes:t.notes,beatsPerBar:this.X.song.beatsPerBar,drums:this.X.song.getChannelIsNoise(this.X.channel)};window.localStorage.setItem("patternCopy",JSON.stringify(e))}wo(){const e=this.X.getCurrentPattern();if(null==e)return;const i=JSON.parse(String(window.localStorage.getItem("patternCopy")));null!=i&&i.drums==this.X.song.getChannelIsNoise(this.X.channel)&&this.X.record(new t.ChangePaste(this.X,e,i.notes,i.beatsPerBar))}_o(){const t=this.X.song.channels[this.X.channel].instruments[this.X.getCurrentInstrument()].toJsonObject();t.isDrum=this.X.song.getChannelIsNoise(this.X.channel),window.localStorage.setItem("instrumentCopy",JSON.stringify(t))}$o(){const e=this.X.song.channels[this.X.channel].instruments[this.X.getCurrentInstrument()],i=JSON.parse(String(window.localStorage.getItem("instrumentCopy")));delete i.volume,null!=i&&i.isDrum==this.X.song.getChannelIsNoise(this.X.channel)&&this.X.record(new t.ChangePasteInstrument(this.X,e,i))}th(){const e=this.X.song.getChannelIsNoise(this.X.channel);this.X.record(new t.ChangePreset(this.X,t.pickRandomPresetValue(e)))}eh(){this.X.record(new t.ChangeRandomGeneratedInstrument(this.X))}ko(e){const i=this.X.getCurrentPattern();if(null==i)return;const s=this.X.lastChangeWas(this.ro);this.ro=new t.ChangeTranspose(this.X,i,e),this.X.record(this.ro,s)}zo(e){if(isNaN(e)){switch(e){case"copyInstrument":this._o();break;case"pasteInstrument":this.$o();break;case"randomPreset":this.th();break;case"randomGenerated":this.eh()}this.X.notifier.changed()}else this.X.record(new t.ChangePreset(this.X,parseInt(e)))}}t.SongEditor=d;const m=new t.SongDocument(location.hash),p=new d(m);if(document.getElementById("beepboxEditorContainer").appendChild(p.mainLayer),p.whenUpdated(),p.mainLayer.focus(),!a&&m.autoPlay){function y(){document.hidden||(m.synth.play(),p.updatePlayButton(),window.removeEventListener("visibilitychange",y))}document.hidden?window.addEventListener("visibilitychange",y):y()}"scrollRestoration"in history&&(history.scrollRestoration="manual"),p.updatePlayButton()}(beepbox||(beepbox={}));
	</script>
</body></html>
